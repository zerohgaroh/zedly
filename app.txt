// Import Chart.js for statistics
import Chart from 'chart.js/auto';

// Debug logging control
const DEBUG_LOGS = false;
if (!DEBUG_LOGS) {
    console.log = () => {};
}

// ========================================
// TRANSLATIONS (i18n)
// ========================================
const translations = {
    ru: {
        // Common
        login: '–í—Ö–æ–¥',
        logout: '–í—ã–π—Ç–∏',
        save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
        cancel: '–û—Ç–º–µ–Ω–∞',
        delete: '–£–¥–∞–ª–∏—Ç—å',
        edit: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
        add: '–î–æ–±–∞–≤–∏—Ç—å',
        back: '–ù–∞–∑–∞–¥',
        next: '–î–∞–ª–µ–µ',
        submit: '–û—Ç–ø—Ä–∞–≤–∏—Ç—å',
        loading: '–ó–∞–≥—Ä—É–∑–∫–∞...',
        error: '–û—à–∏–±–∫–∞',
        success: '–£—Å–ø–µ—à–Ω–æ',
        
        // Login Page
        selectRole: '–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å',
        loginAsStudent: '–í–æ–π—Ç–∏ –∫–∞–∫ –£—á–µ–Ω–∏–∫',
        loginAsTeacher: '–í–æ–π—Ç–∏ –∫–∞–∫ –£—á–∏—Ç–µ–ª—å',
        loginAsAdmin: '–í–æ–π—Ç–∏ –∫–∞–∫ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        username: '–õ–æ–≥–∏–Ω',
        password: '–ü–∞—Ä–æ–ª—å',
        changePassword: '–°–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å',
        currentPassword: '–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å',
        newPassword: '–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å',
        confirmPassword: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å',
        mustChangePassword: '–í—ã –¥–æ–ª–∂–Ω—ã —Å–º–µ–Ω–∏—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å',
        
        // Student
        student: '–£—á–µ–Ω–∏–∫',
        dashboard: '–ì–ª–∞–≤–Ω–∞—è',
        subjects: '–ü—Ä–µ–¥–º–µ—Ç—ã',
        subjectTests: '–¢–µ—Å—Ç—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º',
        interestTest: '–¢–µ—Å—Ç –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤',
        myProfile: '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å',
        firstName: '–ò–º—è',
        lastName: '–§–∞–º–∏–ª–∏—è',
        school: '–®–∫–æ–ª–∞',
        grade: '–ö–ª–∞—Å—Å',
        interests: '–ò–Ω—Ç–µ—Ä–µ—Å—ã',
        welcome: '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å',
        
        // Teacher
        teacher: '–£—á–∏—Ç–µ–ª—å',
        classes: '–ö–ª–∞—Å—Å—ã',
        manageTests: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏',
        
        // Modules & Tests
        modules: '–ú–æ–¥—É–ª–∏',
        module: '–ú–æ–¥—É–ª—å',
        createModule: '–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å',
        moduleName: '–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è',
        moduleDescription: '–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è',
        tests: '–¢–µ—Å—Ç—ã',
        test: '–¢–µ—Å—Ç',
        createTest: '–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç',
        testName: '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞',
        testDuration: '–í—Ä–µ–º—è –Ω–∞ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ (–º–∏–Ω—É—Ç—ã)',
        maxScore: '–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–ª',
        questions: '–í–æ–ø—Ä–æ—Å—ã',
        question: '–í–æ–ø—Ä–æ—Å',
        addQuestion: '–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å',
        questionText: '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞',
        questionType: '–¢–∏–ø –≤–æ–ø—Ä–æ—Å–∞',
        singleChoice: '–û–¥–∏–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç',
        multipleChoice: '–ù–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤',
        answers: '–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤',
        correctAnswer: '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç',
        addAnswer: '–î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç',
        publish: '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å',
        draft: '–ß–µ—Ä–Ω–æ–≤–∏–∫',
        published: '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω',
        status: '–°—Ç–∞—Ç—É—Å',
        notStarted: '–ù–µ –Ω–∞—á–∞—Ç',
        inProgress: '–í –ø—Ä–æ—Ü–µ—Å—Å–µ',
        completed: '–ó–∞–≤–µ—Ä—à—ë–Ω',
        result: '–†–µ–∑—É–ª—å—Ç–∞—Ç',
        score: '–ë–∞–ª–ª—ã',
        percentage: '–ü—Ä–æ—Ü–µ–Ω—Ç',
        attempts: '–ü–æ–ø—ã—Ç–∫–∏',
        startTest: '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç',
        continueTest: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Ç–µ—Å—Ç',
        submitTest: '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç',
        viewResults: '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã',
        analytics: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
        averageScore: '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª',
        completionRate: '–ü—Ä–æ—Ü–µ–Ω—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è',
        
        // Control Tests
        controlTests: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã',
        controlTest: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞',
        noControlTests: '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã',
        
        // Admin
        admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
        adminPanel: '–ê–¥–º–∏–Ω –ü–∞–Ω–µ–ª—å',
        adminManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–æ–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª—å',
        userManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',
        users: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        addUser: '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è',
        role: '–†–æ–ª—å',
        actions: '–î–µ–π—Å—Ç–≤–∏—è',
        analytics: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
        analyticsDesc: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –º–µ—Ç—Ä–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã',
        classes: '–ö–ª–∞—Å—Å—ã',
        classesManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞–º–∏ –∏ –≥—Ä—É–ø–ø–∞–º–∏',
        teacherTests: '–¢–µ—Å—Ç—ã —É—á–∏—Ç–µ–ª–µ–π',
        teacherTestsDesc: '–¢–µ—Å—Ç—ã –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π',
        newUser: '–ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
        newUserDesc: '–î–æ–±–∞–≤–∏—Ç—å —É—á–µ–Ω–∏–∫–∞ –∏–ª–∏ —É—á–∏—Ç–µ–ª—è',
        passwords: '–ü–∞—Ä–æ–ª–∏',
        passwordsManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        students: '–£—á–µ–Ω–∏–∫–∏',
        teachers: '–£—á–∏—Ç–µ–ª—è',
        classFilter: '–§–∏–ª—å—Ç—Ä –ø–æ –∫–ª–∞—Å—Å—É',
        allClasses: '–í—Å–µ –∫–ª–∞—Å—Å—ã',
        noStudents: '–£—á–µ–Ω–∏–∫–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        noTeachers: '–£—á–∏—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ',
        subjectsManagement: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏',
        subjectsManagementDesc: '–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ —à–∫–æ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã',
        addSubject: '–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç',
        editSubject: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç',
        subjectNameRu: '–ù–∞–∑–≤–∞–Ω–∏–µ (RU)',
        subjectNameUz: '–ù–∞–∑–≤–∞–Ω–∏–µ (UZ)',
        noSubjects: '–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã',
    },
    uz: {
        // Common
        login: 'Kirish',
        logout: 'Chiqish',
        save: 'Saqlash',
        cancel: 'Bekor qilish',
        delete: 'O\'chirish',
        edit: 'Tahrirlash',
        add: 'Qo\'shish',
        back: 'Orqaga',
        next: 'Keyingi',
        submit: 'Yuborish',
        loading: 'Yuklanmoqda...',
        error: 'Xato',
        success: 'Muvaffaqiyatli',
        
        // Login Page
        selectRole: 'Rolni tanlang',
        loginAsStudent: 'O\'quvchi sifatida kirish',
        loginAsTeacher: 'O\'qituvchi sifatida kirish',
        loginAsAdmin: 'Administrator sifatida kirish',
        username: 'Login',
        password: 'Parol',
        changePassword: 'Parolni o\'zgartirish',
        currentPassword: 'Joriy parol',
        newPassword: 'Yangi parol',
        confirmPassword: 'Parolni tasdiqlang',
        mustChangePassword: 'Vaqtinchalik parolingizni o\'zgartirishingiz kerak',
        
        // Student
        student: 'O\'quvchi',
        dashboard: 'Bosh sahifa',
        subjects: 'Fanlar',
        subjectTests: 'Fan testlari',
        interestTest: 'Qiziqishlarni aniqlash testi',
        myProfile: 'Mening profilim',
        firstName: 'Ism',
        lastName: 'Familiya',
        school: 'Maktab',
        grade: 'Sinf',
        interests: 'Qiziqishlar',
        welcome: 'Xush kelibsiz',
        
        // Teacher
        teacher: 'O\'qituvchi',
        classes: 'Sinflar',
        manageTests: 'Testlarni boshqarish',
        
        // Modules & Tests
        modules: 'Modullar',
        module: 'Modul',
        createModule: 'Modul yaratish',
        moduleName: 'Modul nomi',
        moduleDescription: 'Modul tavsifi',
        tests: 'Testlar',
        test: 'Test',
        createTest: 'Test yaratish',
        testName: 'Test nomi',
        testDuration: 'Test vaqti (daqiqalar)',
        maxScore: 'Maksimal ball',
        questions: 'Savollar',
        question: 'Savol',
        addQuestion: 'Savol qo\'shish',
        questionText: 'Savol matni',
        questionType: 'Savol turi',
        singleChoice: 'Bitta to\'g\'ri javob',
        multipleChoice: 'Bir nechta to\'g\'ri javob',
        answers: 'Javob variantlari',
        correctAnswer: 'To\'g\'ri javob',
        addAnswer: 'Variant qo\'shish',
        publish: 'Nashr qilish',
        draft: 'Qoralama',
        published: 'Nashr qilingan',
        status: 'Holat',
        notStarted: 'Boshlanmagan',
        inProgress: 'Jarayonda',
        completed: 'Tugallangan',
        result: 'Natija',
        score: 'Ballar',
        percentage: 'Foiz',
        attempts: 'Urinishlar',
        startTest: 'Testni boshlash',
        continueTest: 'Testni davom ettirish',
        submitTest: 'Testni yakunlash',
        viewResults: 'Natijalarni ko\'rish',
        analytics: 'Analitika',
        averageScore: 'O\'rtacha ball',
        completionRate: 'Bajarilish foizi',
        controlTests: 'Nazorat isbotlari',
        controlTest: 'Nazorat isbo\'ti',
        noControlTests: 'Nazorat isbotlari tayinlanmagan',
        
        // Admin
        admin: 'Administrator',
        adminPanel: 'Admin Panel',
        adminManagement: "Tizimni boshqarish va nazorat",
        userManagement: 'Foydalanuvchilarni boshqarish',
        users: 'Foydalanuvchilar',
        addUser: 'Foydalanuvchi qo\'shish',
        role: 'Rol',
        actions: 'Harakatlar',
        analytics: 'Analitika',
        analyticsDesc: 'Statistika va tizim metrikalari',
        classes: 'Sinflar',
        classesManagement: 'Sinflar va guruhlarni boshqarish',
        teacherTests: "O'qituvchi testlari",
        teacherTestsDesc: 'Kompetensiyalarni baholash testlari',
        newUser: 'Yangi foydalanuvchi',
        newUserDesc: "O'quvchi yoki o'qituvchi qo'shish",
        passwords: 'Parollar',
        passwordsManagement: 'Foydalanuvchi parollarini boshqarish',
        students: "O'quvchilar",
        teachers: "O'qituvchilar",
        classFilter: 'Sinf bo\'yicha filtrlash',
        allClasses: 'Barcha sinflar',
        noStudents: "O'quvchilar topilmadi",
        noTeachers: "O'qituvchilar topilmadi",
        subjectsManagement: 'Fanlarni boshqarish',
        subjectsManagementDesc: 'Fanlarni qo\'shing va tahrirlang',
        addSubject: 'Fan qo\'shish',
        editSubject: 'Fanni tahrirlash',
        subjectNameRu: 'Nomi (RU)',
        subjectNameUz: 'Nomi (UZ)',
        noSubjects: 'Fanlar topilmadi',
    }
};

// ========================================
// STATE MANAGEMENT
// ========================================
class Store {
    constructor() {
        this.state = this.loadState();
        this.listeners = [];
    }

    loadState() {
        try {
            const stored = localStorage.getItem('auth-storage');
            if (stored) {
                const state = JSON.parse(stored);
                if (state.token) {
                    // Set default authorization header
                    this.setAuthHeader(state.token);
                    console.log('üîë Token loaded from localStorage');
                } else {
                    console.log('‚ö†Ô∏è No token in localStorage');
                }
                console.log('üì¶ State loaded:', {
                    isAuthenticated: state.isAuthenticated,
                    user: state.user?.username,
                    hasToken: !!state.token
                });
                return state;
            } else {
                console.log('üì¶ No saved state in localStorage');
            }
        } catch (error) {
            console.error('Error loading state:', error);
        }
        return {
            user: null,
            token: null,
            isAuthenticated: false,
            language: 'ru'
        };
    }

    saveState() {
        try {
            localStorage.setItem('auth-storage', JSON.stringify(this.state));
        } catch (error) {
            console.error('Error saving state:', error);
        }
    }

    setState(newState) {
        this.state = { ...this.state, ...newState };
        this.saveState();
        this.notify();
    }

    getState() {
        return this.state;
    }

    subscribe(listener) {
        this.listeners.push(listener);
        return () => {
            this.listeners = this.listeners.filter(l => l !== listener);
        };
    }

    notify() {
        this.listeners.forEach(listener => listener(this.state));
    }

    setAuthHeader(token) {
        // Store for future API calls
        this.authToken = token;
    }

    async login(username, password, role) {
        try {
            const response = await fetch('http://localhost:5001/api/auth/login', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password, role })
            });

            const data = await response.json();

            if (!response.ok) {
                return { success: false, error: data.message || 'Login failed' };
            }

            this.setAuthHeader(data.token);
            this.setState({
                user: data.user,
                token: data.token,
                isAuthenticated: true
            });

            return { 
                success: true, 
                user: data.user,
                requirePasswordChange: data.requirePasswordChange || data.user.isTemporaryPassword || false
            };
        } catch (error) {
            console.error('Login error:', error);
            return { success: false, error: 'Network error' };
        }
    }

    async changePassword(currentPassword, newPassword) {
        try {
            const response = await fetch('http://localhost:5001/api/auth/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${this.state.token}`
                },
                body: JSON.stringify({ currentPassword, newPassword })
            });

            const data = await response.json();

            if (!response.ok) {
                return { success: false, error: data.message || 'Password change failed' };
            }

            // Update user state
            const updatedUser = { ...this.state.user, isTemporaryPassword: false };
            this.setState({ user: updatedUser });

            return { success: true };
        } catch (error) {
            console.error('Change password error:', error);
            return { success: false, error: 'Network error' };
        }
    }

    logout() {
        console.log('üîê Logging out...');
        this.setState({
            user: null,
            token: null,
            isAuthenticated: false
        });
        this.authToken = null;
        localStorage.removeItem('auth-storage');
        console.log('‚úÖ Logout complete, localStorage cleared');
    }

    setLanguage(lang) {
        this.setState({ language: lang });
    }
}

const store = new Store();

// ========================================
// API HELPER
// ========================================
const API_BASE_URL = import.meta.env.VITE_API_URL || window.location.origin;

let apiOfflineUntil = 0;

async function apiRequest(url, methodOrOptions = 'GET', body = null) {
    const token = store.getState().token;
    console.log('üîë API Request to:', url, '| Token exists:', !!token);
    
    // Handle both signatures: apiRequest(url, options) and apiRequest(url, method, body)
    let options;
    if (typeof methodOrOptions === 'string') {
        // Called as apiRequest(url, method, body)
        options = {
            method: methodOrOptions,
            ...(body && { body: JSON.stringify(body) })
        };
    } else {
        // Called as apiRequest(url, options)
        options = methodOrOptions || {};
    }
    
    const headers = {
        'Content-Type': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` }),
        ...options.headers
    };

    try {
        if (apiOfflineUntil && Date.now() < apiOfflineUntil) {
            return { success: false, error: 'Backend unavailable' };
        }

        const fullUrl = url.startsWith('http') ? url : `${API_BASE_URL}${url}`;
        let response;

        try {
            response = await fetch(fullUrl, { ...options, headers });
        } catch (networkError) {
            const shouldRetry = !url.startsWith('http') && API_BASE_URL === window.location.origin;
            if (shouldRetry) {
                try {
                    const fallbackUrl = `http://localhost:5001${url}`;
                    response = await fetch(fallbackUrl, { ...options, headers });
                } catch (fallbackError) {
                    apiOfflineUntil = Date.now() + 5000;
                    throw fallbackError;
                }
            } else {
                apiOfflineUntil = Date.now() + 5000;
                throw networkError;
            }
        }

        const rawText = await response.text();
        let data = null;

        if (rawText) {
            try {
                data = JSON.parse(rawText);
            } catch (parseError) {
                console.error('‚ùå API JSON parse error:', parseError);
                if (response.ok) {
                    return { success: false, error: 'Invalid JSON response' };
                }
            }
        }

        if (!response.ok) {
            console.error('‚ùå API Error:', response.status, data);
            // –ï—Å–ª–∏ 401/403 - –ø—Ä–æ–±–ª–µ–º–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π
            if (response.status === 401 || response.status === 403) {
                console.error('üö´ Authorization failed. Token:', store.getState().token ? 'exists' : 'missing');
                store.logout();
                if (window.location.pathname !== '/login') {
                    router.navigate('/login');
                }
            }
            throw new Error(data?.message || data?.error || 'Request failed');
        }

        if (data === null || data === undefined) {
            return { success: true, data: null };
        }

        // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä —É–∂–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç {success, data}, –ø—Ä–æ—Å—Ç–æ –≤–µ—Ä–Ω—É—Ç—å –∫–∞–∫ –µ—Å—Ç—å
        if (data.success !== undefined) {
            return data;
        }
        return { success: true, data };
    } catch (error) {
        console.error('API Error:', error);
        return { success: false, error: error.message };
    }
}

// ========================================
// CUSTOM ALERTS
// ========================================
function showAlert(message, type = 'info', duration = 4000) {
    // Check if we should show toast or modal
    const useToast = duration > 0; // Auto-close toast
    
    if (useToast) {
        const containerId = 'toastContainer';
        let container = document.getElementById(containerId);
        if (!container) {
            container = document.createElement('div');
            container.id = containerId;
            container.className = 'toast-container';
            document.body.appendChild(container);
        }

        // Modern toast notification
        const alertDiv = document.createElement('div');
        alertDiv.id = 'modernAlert-' + Date.now();
        alertDiv.className = `alert-notification alert-${type}`;
        
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        
        alertDiv.innerHTML = `
            <span style="font-size: 1.5rem; flex-shrink: 0;">${icons[type] || icons.info}</span>
            <span>${message}</span>
            <button class="closeAlert" aria-label="Close">‚úï</button>
        `;

        container.appendChild(alertDiv);

        // Close button
        alertDiv.querySelector('.closeAlert')?.addEventListener('click', () => {
            alertDiv.remove();
        });

        // Auto-remove after duration
        if (duration > 0) {
            setTimeout(() => {
                if (document.body.contains(alertDiv)) {
                    alertDiv.style.animation = 'fadeOut 0.3s ease-out';
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, duration);
        }
        
        return Promise.resolve(true);
    } else {
        // Modal dialog (original behavior)
        const modal = document.createElement('div');
        modal.className = 'modal';
        
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        
        const colors = {
            success: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
            error: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
            warning: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)',
            info: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)'
        };
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 400px; text-align: center;">
                <div style="background: ${colors[type]}; color: white; padding: 2rem; border-radius: 12px 12px 0 0; margin: -1.5rem -1.5rem 1.5rem -1.5rem;">
                    <div style="font-size: 3rem; margin-bottom: 0.5rem;">${icons[type]}</div>
                    <p style="margin: 0; font-size: 1.1rem; font-weight: 500;">${message}</p>
                </div>
                <button class="button button-primary" id="alertOkBtn" style="width: 100%; padding: 0.75rem;">OK</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
        
        const closeAlert = () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        };
        
        document.getElementById('alertOkBtn').addEventListener('click', closeAlert);
        
        return new Promise(resolve => {
            document.getElementById('alertOkBtn').addEventListener('click', () => resolve(true));
        });
    }
}

function showConfirm(message, title = '') {
    const lang = store.getState().language;
    const modal = document.createElement('div');
    modal.className = 'modal modal--centered add-user-modal';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 450px;">
            ${title ? `<h2 style="margin: 0 0 1rem 0;">${title}</h2>` : ''}
            <p style="color: var(--text-secondary); margin: 0 0 2rem 0; font-size: 1.05rem;">${message}</p>
            <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                <button class="button button-secondary" id="confirmNoBtn">${lang === 'uz' ? 'Yo\'q' : '–ù–µ—Ç'}</button>
                <button class="button button-primary" id="confirmYesBtn">${lang === 'uz' ? 'Ha' : '–î–∞'}</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
    
    return new Promise(resolve => {
        const closeModal = (result) => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
            resolve(result);
        };
        
        document.getElementById('confirmYesBtn').addEventListener('click', () => closeModal(true));
        document.getElementById('confirmNoBtn').addEventListener('click', () => closeModal(false));
    });
}

// ========================================
// TRANSLATION HELPER
// ========================================
// ========================================
// UTILITY FUNCTIONS
// ========================================

function t(key) {
    const lang = store.getState().language;
    return translations[lang]?.[key] || key;
}

const chartPalette = ['#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4', '#F97316'];

const DEFAULT_SUBJECT_ORDER = [
    { id: '1', nameRu: '–ê–ª–≥–µ–±—Ä–∞', nameUz: 'Algebra' },
    { id: '2', nameRu: '–ì–µ–æ–º–µ—Ç—Ä–∏—è', nameUz: 'Geometriya' },
    { id: '3', nameRu: '–§–∏–∑–∏–∫–∞', nameUz: 'Fizika' },
    { id: '4', nameRu: '–•–∏–º–∏—è', nameUz: 'Kimyo' },
    { id: '5', nameRu: '–ë–∏–æ–ª–æ–≥–∏—è', nameUz: 'Biologiya' },
    { id: '6', nameRu: '–ò—Å—Ç–æ—Ä–∏—è', nameUz: 'Tarix' },
    { id: '7', nameRu: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', nameUz: 'Adabiyot' },
    { id: '8', nameRu: '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è', nameUz: 'Geografiya' },
    { id: '9', nameRu: '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π —è–∑—ã–∫', nameUz: 'Ingliz tili' },
    { id: '10', nameRu: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', nameUz: 'Informatika' }
];

function getChartLineColor() {
    return document.documentElement.classList.contains('light-theme') ? '#000000' : '#FFFFFF';
}

function getChartGridColor() {
    const base = getChartLineColor();
    return base + '33';
}

function getChartTextColor() {
    return getChartLineColor();
}

function buildAverageSeries(series, labels) {
    if (!labels?.length) return [];
    return labels.map((_, idx) => {
        const values = series.map(s => s.data[idx]).filter(v => typeof v === 'number');
        if (!values.length) return null;
        const avg = values.reduce((sum, v) => sum + v, 0) / values.length;
        return Math.round(avg * 10) / 10;
    });
}

function getOrderedSubjects(subjects = []) {
    const normalized = (Array.isArray(subjects) ? subjects : []).map(subject => {
        const id = subject?._id || subject?.id || subject?.subjectId || subject?.nameRu || subject?.nameUz || subject?.label || subject?.subjectName;
        return {
            id: id ? String(id) : '',
            nameRu: subject?.nameRu || subject?.name || subject?.subjectName || subject?.label || '',
            nameUz: subject?.nameUz || subject?.name || subject?.subjectName || subject?.label || ''
        };
    }).filter(subject => subject.id || subject.nameRu || subject.nameUz);

    const byId = new Map(normalized.map(subject => [subject.id, subject]));
    const byName = new Map(normalized.map(subject => [(subject.nameRu || '').toLowerCase(), subject]));

    const ordered = DEFAULT_SUBJECT_ORDER.map(subject => {
        const match = byId.get(subject.id) || byName.get(subject.nameRu.toLowerCase());
        return match ? { ...subject, ...match } : subject;
    });

    normalized.forEach(subject => {
        const exists = ordered.some(item => {
            const sameId = item.id && subject.id && item.id === subject.id;
            const sameName = (item.nameRu || '').toLowerCase() === (subject.nameRu || '').toLowerCase();
            return sameId || sameName;
        });
        if (!exists) {
            ordered.push(subject);
        }
    });

    return ordered;
}

function buildSubjectAverageChart(chartData, seriesLabel, options = {}) {
    const { subjectList = [], includeAllSubjects = false } = options;
    const lang = store.getState().language;

    if (!chartData?.series?.length) {
        if (!includeAllSubjects) return { labels: [], series: [] };
        const orderedSubjects = getOrderedSubjects(subjectList);
        const labels = orderedSubjects.map(subject => (lang === 'uz' ? (subject.nameUz || subject.nameRu) : (subject.nameRu || subject.nameUz)));
        return {
            labels,
            series: [
                {
                    label: seriesLabel,
                    data: labels.map(() => null)
                }
            ]
        };
    }

    const averagesByKey = new Map();

    chartData.series.forEach(seriesItem => {
        const values = (seriesItem.data || []).filter(v => typeof v === 'number');
        const avg = values.length
            ? Math.round((values.reduce((sum, v) => sum + v, 0) / values.length) * 10) / 10
            : null;

        if (seriesItem.subjectId) {
            averagesByKey.set(String(seriesItem.subjectId), avg);
        }
        const nameKey = (seriesItem.subjectName || seriesItem.label || '').toLowerCase();
        if (nameKey) {
            averagesByKey.set(nameKey, avg);
        }
    });

    if (!includeAllSubjects) {
        const labels = [];
        const data = [];

        chartData.series.forEach(seriesItem => {
            const values = (seriesItem.data || []).filter(v => typeof v === 'number');
            const avg = values.length
                ? Math.round((values.reduce((sum, v) => sum + v, 0) / values.length) * 10) / 10
                : null;
            labels.push(seriesItem.subjectName || seriesItem.label || '');
            data.push(avg);
        });

        return {
            labels,
            series: [
                {
                    label: seriesLabel,
                    data
                }
            ]
        };
    }

    const orderedSubjects = getOrderedSubjects(subjectList);
    const labels = orderedSubjects.map(subject => (lang === 'uz' ? (subject.nameUz || subject.nameRu) : (subject.nameRu || subject.nameUz)));
    const data = orderedSubjects.map(subject => {
        const idKey = subject.id ? String(subject.id) : '';
        if (idKey && averagesByKey.has(idKey)) return averagesByKey.get(idKey);
        const ruKey = (subject.nameRu || '').toLowerCase();
        if (ruKey && averagesByKey.has(ruKey)) return averagesByKey.get(ruKey);
        const uzKey = (subject.nameUz || '').toLowerCase();
        if (uzKey && averagesByKey.has(uzKey)) return averagesByKey.get(uzKey);
        return null;
    });

    return {
        labels,
        series: [
            {
                label: seriesLabel,
                data
            }
        ]
    };
}

function renderBarChart(canvasId, emptyId, chartData, extraSeries = []) {
    const canvas = document.getElementById(canvasId);
    const empty = document.getElementById(emptyId);
    if (!canvas) return;

    const gridColor = getChartGridColor();
    const textColor = getChartTextColor();

    if (window._chartInstances?.[canvasId]) {
        window._chartInstances[canvasId].destroy();
    }

    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
        if (canvas) canvas.style.display = 'none';
        if (empty) empty.style.display = 'block';
        return;
    }

    if (empty) empty.style.display = 'none';
    canvas.style.display = 'block';

    const datasets = chartData.series.map((seriesItem, idx) => ({
        label: seriesItem.label || seriesItem.subjectName,
        data: seriesItem.data,
        backgroundColor: chartPalette[idx % chartPalette.length] + 'CC',
        borderColor: chartPalette[idx % chartPalette.length],
        borderWidth: 1,
        borderRadius: 8,
        maxBarThickness: 48
    }));

    extraSeries.forEach((seriesItem) => {
        datasets.push({
            label: seriesItem.label,
            data: seriesItem.data,
            backgroundColor: (seriesItem.color || '#64748B') + '66',
            borderColor: seriesItem.color || '#64748B',
            borderWidth: 1,
            borderRadius: 8,
            maxBarThickness: 48
        });
    });

    const chart = new Chart(canvas, {
        type: 'bar',
        data: {
            labels: chartData.labels,
            datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: textColor
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: gridColor },
                    ticks: { color: textColor }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: textColor }
                }
            }
        }
    });

    window._chartInstances = window._chartInstances || {};
    window._chartInstances[canvasId] = chart;
}

function renderLineChart(canvasId, emptyId, chartData, extraSeries = []) {
    const canvas = document.getElementById(canvasId);
    const empty = document.getElementById(emptyId);
    if (!canvas) return;

    const lineColor = getChartLineColor();
    const gridColor = getChartGridColor();
    const textColor = getChartTextColor();

    if (window._chartInstances?.[canvasId]) {
        window._chartInstances[canvasId].destroy();
    }

    if (!chartData || !chartData.labels || chartData.labels.length === 0) {
        if (canvas) canvas.style.display = 'none';
        if (empty) empty.style.display = 'block';
        return;
    }

    if (empty) empty.style.display = 'none';
    canvas.style.display = 'block';

    const datasets = chartData.series.map((seriesItem, idx) => ({
        label: seriesItem.subjectName || seriesItem.label,
        data: seriesItem.data,
        borderColor: lineColor,
        backgroundColor: lineColor + '22',
        borderWidth: 2,
        fill: false,
        tension: 0.35,
        pointRadius: 3,
        pointHoverRadius: 5
    }));

    extraSeries.forEach((seriesItem, idx) => {
        datasets.push({
            label: seriesItem.label,
            data: seriesItem.data,
            borderColor: lineColor,
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: seriesItem.dash || [6, 4],
            fill: false,
            tension: 0.35,
            pointRadius: 2,
            pointHoverRadius: 4
        });
    });

    const chart = new Chart(canvas, {
        type: 'line',
        data: {
            labels: chartData.labels,
            datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: textColor,
                        usePointStyle: true
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    grid: { color: gridColor },
                    ticks: { color: textColor }
                },
                x: {
                    grid: { color: gridColor },
                    ticks: { color: textColor }
                }
            }
        }
    });

    window._chartInstances = window._chartInstances || {};
    window._chartInstances[canvasId] = chart;
}

function cleanupOverlays() {
    document.querySelectorAll('.admin-modal-overlay, .custom-modal-overlay, .modal').forEach(el => el.remove());
}

// ========================================
// ROUTER
// ========================================
class Router {
    constructor() {
        this.routes = {};
        this.currentRoute = null;
        
        window.addEventListener('popstate', () => {
            this.navigate(window.location.pathname, false);
        });
    }

    register(path, handler) {
        this.routes[path] = handler;
    }

    navigate(path, pushState = true) {
        console.log('üîç Router.navigate called:', path);
        
        // Clear any active test timer when navigating away
        if (window._testTimerInterval) {
            clearInterval(window._testTimerInterval);
            window._testTimerInterval = null;
            console.log('üßπ Timer cleared on navigation');
        }

        cleanupOverlays();
        
        if (pushState) {
            window.history.pushState({}, '', path);
        }

        this.currentRoute = path;
        
        // First try exact match
        const exactHandler = this.routes[path];
        if (exactHandler) {
            console.log('‚úÖ Found exact route match for:', path);
            exactHandler();
            initBottomNav();
            return;
        }

        // Try to match dynamic routes
        for (const [routePath, handler] of Object.entries(this.routes)) {
            if (routePath.includes(':')) {
                const paramNames = [];
                const routeRegex = new RegExp('^' + routePath.replace(/:([^\/]+)/g, (_, paramName) => {
                    paramNames.push(paramName);
                    return '([^/]+)';
                }) + '$');
                const match = path.match(routeRegex);
                
                console.log(`üîç Checking route pattern: ${routePath} against ${path}`, match ? '‚úÖ MATCH' : '‚ùå NO MATCH');
                
                if (match) {
                    console.log('‚úÖ Found dynamic route match:', routePath);
                    
                    // Extract parameters
                    this.currentParams = {};
                    paramNames.forEach((paramName, index) => {
                        this.currentParams[paramName] = match[index + 1];
                    });
                    console.log('üìù Route params:', this.currentParams);
                    
                    handler(this.currentParams);
                    initBottomNav();
                    return;
                }
            }
        }
        
        console.log('‚ùå No route found for:', path);
        
        // Default to home or 404
        const homeHandler = this.routes['/'];
        if (homeHandler) homeHandler();
    }
}

// ========================================
// COMPONENTS
// ========================================

// Language Switch Component
function renderLanguageSwitch() {
    const state = store.getState();
    const currentLang = state.language;
    console.log('üîß renderLanguageSwitch called, current language:', currentLang);
    
    // Fixed language switch (for login page only)
    const langBtn = document.getElementById('langBtn');
    if (langBtn) {
        const languageSwitch = document.getElementById('languageSwitch');
        // Hide on authenticated pages
        if (state.isAuthenticated && languageSwitch) {
            languageSwitch.style.display = 'none';
        } else if (languageSwitch) {
            languageSwitch.style.display = 'block';
        }
        
        if (currentLang === 'ru') {
            langBtn.innerHTML = '<span style="color: white; font-weight: 900;">RU</span> | <span style="opacity: 0.5;">UZ</span>';
        } else {
            langBtn.innerHTML = '<span style="opacity: 0.5;">RU</span> | <span style="color: white; font-weight: 900;">UZ</span>';
        }
        
        langBtn.removeEventListener('click', langBtn._switchLangHandler);
        langBtn._switchLangHandler = () => {
            const newLang = currentLang === 'ru' ? 'uz' : 'ru';
            console.log('üåç Switching language to:', newLang);
            store.setLanguage(newLang);
            renderLanguageSwitch();
            refreshCurrentPage();
        };
        langBtn.addEventListener('click', langBtn._switchLangHandler);
    }
    
    // Sidebar language switch
    const sidebarLangBtn = document.getElementById('sidebarLangBtn');
    const sidebarLangText = document.getElementById('sidebarLangText');
    console.log('üîß Sidebar language button check:', { found: !!sidebarLangBtn, sidebarLangBtn, sidebarLangText });
    if (sidebarLangBtn && sidebarLangText) {
        if (currentLang === 'ru') {
            sidebarLangText.innerHTML = '<span style="font-weight: 900;">RU</span> | <span style="opacity: 0.6;">UZ</span>';
        } else {
            sidebarLangText.innerHTML = '<span style="opacity: 0.6;">RU</span> | <span style="font-weight: 900;">UZ</span>';
        }
        
        sidebarLangBtn.removeEventListener('click', sidebarLangBtn._switchLangHandler);
        sidebarLangBtn._switchLangHandler = () => {
            const newLang = currentLang === 'ru' ? 'uz' : 'ru';
            console.log('üåç Switching language to:', newLang);
            store.setLanguage(newLang);
            renderLanguageSwitch();
            refreshCurrentPage();
        };
        sidebarLangBtn.addEventListener('click', sidebarLangBtn._switchLangHandler);
    }
    
    // Bottom nav language switch
    const bottomLangBtn = document.querySelector('[data-nav="language"]');
    const bottomLangText = document.getElementById('bottomLangText');
    if (bottomLangText) {
        bottomLangText.textContent = currentLang === 'ru' ? 'RU' : 'UZ';
    }
    if (bottomLangBtn) {
        bottomLangBtn.removeEventListener('click', bottomLangBtn._switchLangHandler, true);
        bottomLangBtn._switchLangHandler = (e) => {
            e.preventDefault();
            e.stopPropagation();
            const newLang = currentLang === 'ru' ? 'uz' : 'ru';
            console.log('üåç Switching language to:', newLang);
            store.setLanguage(newLang);
            renderLanguageSwitch();
            refreshCurrentPage();
        };
        bottomLangBtn.addEventListener('click', bottomLangBtn._switchLangHandler, true);
    }
    
    // Update bottom nav profile text
    const bottomProfileText = document.getElementById('bottomProfileText');
    if (bottomProfileText) {
        bottomProfileText.textContent = currentLang === 'ru' ? '–ü—Ä–æ—Ñ–∏–ª—å' : 'Profil';
    }
}

// Refresh current page with new language
function refreshCurrentPage() {
    const currentPath = window.location.pathname;
    console.log('üîÑ Refreshing page with new language:', currentPath);
    router.navigate(currentPath === '/' ? '/' : currentPath, false);
}

// Theme Toggle
function initThemeToggle() {
    const themeBtn = document.getElementById('themeBtn');
    const topbarThemeBtn = document.getElementById('topbarThemeBtn');
    if (!themeBtn && !topbarThemeBtn) return;
    
    // Load theme from localStorage
    const savedTheme = localStorage.getItem('theme') || 'dark';
    const applyThemeToButtons = (theme) => {
        const isLight = theme === 'light';
        if (isLight) {
            document.documentElement.classList.add('light-theme');
        } else {
            document.documentElement.classList.remove('light-theme');
        }
        const icon = isLight ? '‚òÄÔ∏è' : 'üåô';
        const title = isLight ? 'Switch to Dark Mode' : 'Switch to Light Mode';
        if (themeBtn) {
            themeBtn.innerHTML = icon;
            themeBtn.title = title;
        }
        if (topbarThemeBtn) {
            topbarThemeBtn.innerHTML = icon;
            topbarThemeBtn.title = title;
        }
    };

    applyThemeToButtons(savedTheme);
    
    const toggleTheme = () => {
        if (themeBtn?._ignoreNextClick) {
            themeBtn._ignoreNextClick = false;
            return;
        }
        const currentTheme = localStorage.getItem('theme') || 'dark';
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyThemeToButtons(newTheme);

        const lineColor = getChartLineColor();
        const gridColor = getChartGridColor();
        const textColor = getChartTextColor();
        Object.values(window._chartInstances || {}).forEach(chart => {
            if (!chart) return;
            if (chart.options?.scales?.x?.grid) chart.options.scales.x.grid.color = gridColor;
            if (chart.options?.scales?.y?.grid) chart.options.scales.y.grid.color = gridColor;
            if (chart.options?.scales?.x?.ticks) chart.options.scales.x.ticks.color = textColor;
            if (chart.options?.scales?.y?.ticks) chart.options.scales.y.ticks.color = textColor;
            if (chart.options?.plugins?.legend?.labels) chart.options.plugins.legend.labels.color = textColor;
            if (chart.config?.type === 'line') {
                chart.data.datasets.forEach(dataset => {
                    dataset.borderColor = lineColor;
                    dataset.backgroundColor = lineColor + '22';
                });
            }
            chart.update();
        });
    };

    if (themeBtn) {
        themeBtn.removeEventListener('click', themeBtn._toggleHandler);
        themeBtn._toggleHandler = toggleTheme;
        themeBtn.addEventListener('click', themeBtn._toggleHandler);
    }
    if (topbarThemeBtn) {
        topbarThemeBtn.removeEventListener('click', topbarThemeBtn._toggleHandler);
        topbarThemeBtn._toggleHandler = toggleTheme;
        topbarThemeBtn.addEventListener('click', topbarThemeBtn._toggleHandler);
    }

    initThemeDrag();
}

function initThemeDrag() {
    const themeBtn = document.getElementById('themeBtn');
    if (!themeBtn) return;

    const isSmallScreen = () => window.matchMedia('(max-width: 768px)').matches;
    const margin = 16;

    const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

    const setPosition = (left, top) => {
        const rect = themeBtn.getBoundingClientRect();
        const maxLeft = window.innerWidth - rect.width - margin;
        const maxTop = window.innerHeight - rect.height - margin;
        const clampedLeft = clamp(left, margin, maxLeft);
        const clampedTop = clamp(top, margin, maxTop);
        themeBtn.style.left = `${clampedLeft}px`;
        themeBtn.style.top = `${clampedTop}px`;
        themeBtn.style.right = 'auto';
        themeBtn.style.bottom = 'auto';
    };

    const snapToClosestCorner = () => {
        const rect = themeBtn.getBoundingClientRect();
        const corners = [
            { left: margin, top: margin },
            { left: window.innerWidth - rect.width - margin, top: margin },
            { left: margin, top: window.innerHeight - rect.height - margin },
            { left: window.innerWidth - rect.width - margin, top: window.innerHeight - rect.height - margin }
        ];

        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        let closest = corners[0];
        let minDist = Infinity;

        corners.forEach(corner => {
            const dx = centerX - (corner.left + rect.width / 2);
            const dy = centerY - (corner.top + rect.height / 2);
            const dist = Math.hypot(dx, dy);
            if (dist < minDist) {
                minDist = dist;
                closest = corner;
            }
        });

        setPosition(closest.left, closest.top);
    };

    const enableDrag = () => {
        if (themeBtn._dragEnabled) return;
        themeBtn._dragEnabled = true;
        themeBtn.classList.add('theme-toggle-draggable');

        const initialRect = themeBtn.getBoundingClientRect();
        if (!themeBtn.style.left && !themeBtn.style.top) {
            setPosition(window.innerWidth - initialRect.width - margin, margin);
        } else {
            snapToClosestCorner();
        }

        let isDragging = false;
        let didMove = false;
        let offsetX = 0;
        let offsetY = 0;

        themeBtn._dragPointerDown = (e) => {
            if (!isSmallScreen()) return;
            if (e.button !== undefined && e.button !== 0) return;

            isDragging = true;
            didMove = false;
            const rect = themeBtn.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            themeBtn.classList.add('dragging');
            themeBtn.setPointerCapture?.(e.pointerId);

            const onMove = (event) => {
                if (!isDragging) return;
                const nextLeft = event.clientX - offsetX;
                const nextTop = event.clientY - offsetY;
                setPosition(nextLeft, nextTop);
                if (!didMove) {
                    didMove = Math.abs(event.clientX - e.clientX) > 4 || Math.abs(event.clientY - e.clientY) > 4;
                }
            };

            const onUp = () => {
                isDragging = false;
                themeBtn.classList.remove('dragging');
                snapToClosestCorner();
                if (didMove) {
                    themeBtn._ignoreNextClick = true;
                }
                window.removeEventListener('pointermove', onMove);
                window.removeEventListener('pointerup', onUp);
                window.removeEventListener('pointercancel', onUp);
            };

            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', onUp);
            window.addEventListener('pointercancel', onUp);
        };

        themeBtn.addEventListener('pointerdown', themeBtn._dragPointerDown);
    };

    const disableDrag = () => {
        if (!themeBtn._dragEnabled) return;
        themeBtn._dragEnabled = false;
        themeBtn.classList.remove('theme-toggle-draggable', 'dragging');
        themeBtn.removeEventListener('pointerdown', themeBtn._dragPointerDown);
        themeBtn.style.left = '';
        themeBtn.style.top = '';
        themeBtn.style.right = '';
        themeBtn.style.bottom = '';
    };

    const applyMode = () => {
        if (isSmallScreen()) {
            enableDrag();
        } else {
            disableDrag();
        }
    };

    applyMode();

    if (themeBtn._dragResizeHandler) {
        window.removeEventListener('resize', themeBtn._dragResizeHandler);
    }

    themeBtn._dragResizeHandler = () => {
        applyMode();
        if (themeBtn._dragEnabled) {
            snapToClosestCorner();
        }
    };

    window.addEventListener('resize', themeBtn._dragResizeHandler);
}

// Bottom Navigation for Mobile
function initBottomNav() {
    const bottomNav = document.getElementById('bottomNav');
    const themeBtn = document.getElementById('themeBtn');
    const languageSwitch = document.querySelector('.language-switch');
    const state = store.getState();
    
    if (!bottomNav) return;
    
    // Check if we're on a login page
    const app = document.getElementById('app');
    const isLoginPage = app && app.innerHTML.includes('login-page');
    
    // Hide nav on login pages
    if (isLoginPage) {
        bottomNav.style.display = 'none';
        if (themeBtn) themeBtn.parentElement.style.display = 'none';
        if (languageSwitch) languageSwitch.style.display = 'none';
        return;
    }
    
    // Show nav on authenticated pages
    bottomNav.style.display = '';
    if (themeBtn) themeBtn.parentElement.style.display = '';
    if (languageSwitch) languageSwitch.style.display = '';
    
    // Show bottom nav only for authenticated users
    if (state.isAuthenticated) {
        bottomNav.classList.add('active');
        
        // Hide profile and history buttons for admin
        const navItems = bottomNav.querySelectorAll('.bottom-nav-item');
        navItems.forEach(item => {
            const action = item.getAttribute('data-nav');
            
            // Skip language button - it's handled by renderLanguageSwitch()
            if (action === 'language') {
                return;
            }
            
            // Hide statistics (profile) and history buttons for admin; hide history for teachers
            if ((state.user?.role === 'admin' && (action === 'statistics' || action === 'history'))
                || (state.user?.role === 'teacher' && action === 'history')) {
                item.style.display = 'none';
            } else {
                item.style.display = 'flex';
            }
            
            if (item._navHandler) {
                item.removeEventListener('click', item._navHandler);
            }
            
            // Add new event listener
            item._navHandler = () => {
                const action = item.getAttribute('data-nav');
                
                if (action === 'home') {
                    if (state.user?.role === 'admin') {
                        router.navigate('/admin/dashboard');
                    } else {
                        router.navigate('/');
                    }
                } else if (action === 'statistics') {
                    if (state.user?.role === 'student') {
                        router.navigate('/student/profile');
                    } else if (state.user?.role === 'teacher') {
                        router.navigate('/teacher/profile');
                    }
                } else if (action === 'history') {
                    if (state.user?.role === 'student') {
                        router.navigate('/student/test-history');
                    }
                } else if (action === 'profile') {
                    router.navigate('/');
                } else if (action === 'settings') {
                    // Logout
                    handleLogout();
                }
            };
            
            item.addEventListener('click', item._navHandler);
        });
        
        // Update language button text
        renderLanguageSwitch();
    } else {
        bottomNav.classList.remove('active');
    }
}

// Login Page
function renderLoginPage() {
    console.log('üìÑ renderLoginPage called');
    const app = document.getElementById('app');
    
    if (!app) {
        console.error('‚ùå app element not found!');
        return;
    }
    
    // Hide navigation elements on login page
    const bottomNav = document.getElementById('bottomNav');
    const themeBtn = document.getElementById('themeBtn');
    const languageSwitch = document.querySelector('.language-switch');
    
    if (bottomNav) bottomNav.style.display = 'none';
    if (themeBtn) themeBtn.parentElement.style.display = 'none';
    if (languageSwitch) languageSwitch.style.display = 'none';
    
    app.innerHTML = `
        <div class="login-page">
            <div class="login-container fade-in" id="loginContainer">
                <!-- Content will be inserted here -->
            </div>
        </div>
    `;

    console.log('üìù Calling renderRoleSelection');
    renderRoleSelection();
}

function renderRoleSelection() {
    console.log('üîê renderRoleSelection called');
    const container = document.getElementById('loginContainer');
    
    if (!container) {
        console.error('‚ùå loginContainer not found!');
        return;
    }
    
    const lang = store.getState().language;
    
    container.innerHTML = `
        <div class="login-card">
            <div class="login-header">
                <div class="brand-mark">
                    <img src="/assets/zedly_logo_bg.png" alt="ZEDLY" class="brand-logo" />
                    <div class="brand-name">ZEDLY</div>
                </div>
                <h2>${t('selectRole')}</h2>
                <p>${lang === 'uz' ? 'Rolni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ—é —Ä–æ–ª—å'}</p>
            </div>
            
            <div class="role-cards">
                <div class="role-card" data-role="student">
                    <span>üë®‚Äçüéì</span>
                    <div class="role-card-text">
                        <h3>${t('loginAsStudent')}</h3>
                        <p>${lang === 'uz' ? "O'quvchi paneli" : '–ü–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–∞'}</p>
                    </div>
                </div>
                
                <div class="role-card" data-role="teacher">
                    <span>üë®‚Äçüè´</span>
                    <div class="role-card-text">
                        <h3>${t('loginAsTeacher')}</h3>
                        <p>${lang === 'uz' ? "O'qituvchi paneli" : '–ü–∞–Ω–µ–ª—å —É—á–∏—Ç–µ–ª—è'}</p>
                    </div>
                </div>
                
                <div class="role-card" data-role="admin">
                    <span>üë®‚Äçüíº</span>
                    <div class="role-card-text">
                        <h3>${t('loginAsAdmin')}</h3>
                        <p>${lang === 'uz' ? 'Administrator paneli' : '–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞'}</p>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Add event listeners to role cards
    console.log('üìç Adding event listeners to role cards');
    document.querySelectorAll('.role-card').forEach(card => {
        card.addEventListener('click', function() {
            const role = this.getAttribute('data-role');
            console.log('üñ±Ô∏è Role card clicked:', role);
            selectRole(role);
        });
    });
    
    console.log('‚úÖ renderRoleSelection complete');
}

function selectRole(role) {
    console.log('üîê selectRole called with role:', role);
    const container = document.getElementById('loginContainer');
    const lang = store.getState().language;
    
    const roleIcons = {
        student: 'üë®‚Äçüéì',
        teacher: 'üë®‚Äçüè´',
        admin: 'üë®‚Äçüíº'
    };

    const roleNames = {
        student: t('loginAsStudent'),
        teacher: t('loginAsTeacher'),
        admin: t('loginAsAdmin')
    };
    
    container.innerHTML = `
        <div class="login-card">
            <button class="back-button" id="backBtn">
                <span>‚Üê</span>
                <span>${t('back')}</span>
            </button>
            
            <div class="login-header">
                <div class="role-badge">${roleIcons[role]}</div>
                <h2>${roleNames[role]}</h2>
                <p>${lang === 'uz' ? "Kirish ma'lumotlaringizni kiriting" : '–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞'}</p>
            </div>
            
            <form class="login-form" id="loginForm">
                <div id="errorContainer"></div>
                
                <div class="form-group">
                    <label>${t('username')}</label>
                    <input type="text" id="username" placeholder="${t('username')}" required />
                </div>
                
                <div class="form-group">
                    <label>${t('password')}</label>
                    <input type="password" id="password" placeholder="${t('password')}" required />
                </div>
                
                <button type="submit" class="btn-primary" id="loginBtn">
                    ${t('login')}
                </button>
            </form>
        </div>
    `;
    
    // Add event listener to back button
    console.log('üìç Adding event listener to back button');
    document.getElementById('backBtn').addEventListener('click', function(e) {
        e.preventDefault();
        console.log('‚¨ÖÔ∏è Back button clicked');
        renderRoleSelection();
    });

    console.log('üìç Adding event listener to login form');
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('üìù Login form submitted');
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const loginBtn = document.getElementById('loginBtn');
        const errorContainer = document.getElementById('errorContainer');
        
        console.log('üë§ Attempting login with username:', username, 'role:', role);
        
        loginBtn.disabled = true;
        loginBtn.textContent = t('loading');
        errorContainer.innerHTML = '';
        
        const result = await store.login(username, password, role);
        console.log('üìä Login result:', result);
        
        if (result.success) {
            console.log('‚úÖ Login successful');
            if (result.requirePasswordChange || result.user.isTemporaryPassword) {
                console.log('üîÑ Navigating to /change-password');
                router.navigate('/change-password');
            } else {
                console.log('üîÑ Navigating to /');
                router.navigate('/');
            }
        } else {
            console.log('‚ùå Login failed:', result.error);
            errorContainer.innerHTML = `<div class="error-message">${result.error}</div>`;
            loginBtn.disabled = false;
            loginBtn.textContent = t('login');
        }
    });
}

// Change Password Page
function renderChangePasswordPage() {
    const app = document.getElementById('app');
    
    // Hide navigation elements on password change page
    const bottomNav = document.getElementById('bottomNav');
    const themeBtn = document.getElementById('themeBtn');
    const languageSwitch = document.querySelector('.language-switch');
    
    if (bottomNav) bottomNav.style.display = 'none';
    if (themeBtn) themeBtn.parentElement.style.display = 'none';
    if (languageSwitch) languageSwitch.style.display = 'none';
    
    app.innerHTML = `
        <div class="login-page">
            <div class="login-container fade-in">
                <div class="login-header">
                    <h2>${t('changePassword')}</h2>
                    <p>${t('mustChangePassword')}</p>
                </div>
                
                <form class="login-form" id="changePasswordForm">
                    <div id="messageContainer"></div>
                    
                    <div class="form-group">
                        <label>${t('currentPassword')}</label>
                        <input type="password" id="currentPassword" required />
                    </div>
                    
                    <div class="form-group">
                        <label>${t('newPassword')}</label>
                        <input type="password" id="newPassword" required />
                    </div>
                    
                    <div class="form-group">
                        <label>${t('confirmPassword')}</label>
                        <input type="password" id="confirmPassword" required />
                    </div>
                    
                    <button type="submit" class="btn-primary" id="changeBtn">
                        ${t('changePassword')}
                    </button>
                </form>
            </div>
        </div>
    `;

    document.getElementById('changePasswordForm').onsubmit = async (e) => {
        e.preventDefault();
        
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const changeBtn = document.getElementById('changeBtn');
        const messageContainer = document.getElementById('messageContainer');
        
        messageContainer.innerHTML = '';
        
        if (newPassword !== confirmPassword) {
            messageContainer.innerHTML = '<div class="error-message">Passwords do not match</div>';
            return;
        }
        
        changeBtn.disabled = true;
        changeBtn.textContent = t('loading');
        
        const result = await store.changePassword(currentPassword, newPassword);
        
        if (result.success) {
            messageContainer.innerHTML = '<div class="success-message">Password changed successfully!</div>';
            setTimeout(() => router.navigate('/'), 1500);
        } else {
            messageContainer.innerHTML = `<div class="error-message">${result.error}</div>`;
            changeBtn.disabled = false;
            changeBtn.textContent = t('changePassword');
        }
    };
}

// Layout Component
function renderLayout(content, userRole) {
    const user = store.getState().user;
    
    const app = document.getElementById('app');
    
    const navigation = getNavigationForRole(userRole);
    
    app.innerHTML = `
        <div class="layout">
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <img src="/assets/zedly_logo_bg.png" alt="ZEDLY" class="brand-logo" />
                    <span class="brand-name">ZEDLY</span>
                </div>
                
                <ul class="nav-menu" id="navMenu">
                    ${navigation.map((item, idx) => `
                        <li class="nav-item" data-nav-index="${idx}" data-nav-path="${item.path}">
                            <span>${item.icon}</span>
                            <span>${item.label}</span>
                        </li>
                    `).join('')}
                </ul>
                
                <div class="sidebar-language" style="padding: 1rem; border-top: 1px solid var(--border);">
                    <button id="sidebarLangBtn" class="lang-switch-btn" style="width: 100%; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px; color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span>üåê</span>
                        <span id="sidebarLangText">RU | UZ</span>
                    </button>
                </div>
                
                <button class="logout-btn" id="logoutBtn">
                    ${t('logout')}
                </button>
            </aside>
            
            <main class="main-content" id="mainContent">
                <div class="app-topbar">
                    <div class="app-topbar__side"></div>
                    <div class="app-topbar__center">
                        <img src="/assets/zedly_logo_bg.png" alt="ZEDLY" class="app-topbar__logo" />
                        <span class="app-topbar__name">ZEDLY</span>
                    </div>
                    <div class="app-topbar__side app-topbar__right">
                        <button id="topbarThemeBtn" class="topbar-theme-btn" title="Toggle Dark/Light Mode">üåô</button>
                    </div>
                </div>
                <div class="app-content">
                    ${content}
                </div>
            </main>
        </div>
    `;
    
    // Hide fixed theme/language container on authenticated pages
    const themeBtn = document.getElementById('themeBtn');
    if (themeBtn?.parentElement) {
        themeBtn.parentElement.style.display = 'none';
    }

    // Add event listeners for navigation items
    console.log('üìç Adding event listeners to navigation items');
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function(e) {
            e.preventDefault();
            const path = this.getAttribute('data-nav-path');
            console.log('üîó Navigation clicked:', path);
            router.navigate(path);
        });
    });
    
    // Add event listener for logout button
    console.log('üìç Adding event listener to logout button');
    document.getElementById('logoutBtn')?.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('üö™ Logout button clicked');
        handleLogout();
    });
    
    // Render language switch for sidebar
    renderLanguageSwitch();

    // Ensure theme toggle is wired for the topbar button
    initThemeToggle();
}

function getNavigationForRole(role) {
    const navs = {
        student: [
            { path: '/student/dashboard', label: t('dashboard'), icon: '<i class="fas fa-home"></i>' },
            { path: '/student/subjects', label: t('subjectTests'), icon: '<i class="fas fa-book-open"></i>' },
            { path: '/student/profile', label: store.getState().language === 'uz' ? 'Profil' : '–ü—Ä–æ—Ñ–∏–ª—å', icon: '<i class="fas fa-user-graduate"></i>' },
            { path: '/student/test-history', label: store.getState().language === 'uz' ? 'Testlar tarixi' : '–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤', icon: '<i class="fas fa-history"></i>' },
            { path: '/student/interest-test', label: t('interestTest'), icon: '<i class="fas fa-compass"></i>' },
        ],
        teacher: [
            { path: '/teacher/profile', label: store.getState().language === 'uz' ? 'Profil' : '–ü—Ä–æ—Ñ–∏–ª—å', icon: '<i class="fas fa-user-tie"></i>' },
            { path: '/teacher/subject-analytics', label: store.getState().language === 'uz' ? 'Mavzu analitikasi' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º', icon: '<i class="fas fa-chart-line"></i>' },
            { path: '/teacher/classes', label: t('classes'), icon: '<i class="fas fa-chalkboard-user"></i>' },
        ],
        admin: [
            { path: '/admin/dashboard', label: t('adminPanel'), icon: '<i class="fas fa-crown"></i>' },
            { path: '/admin/analytics', label: t('analytics'), icon: '<i class="fas fa-chart-bar"></i>' },
            { path: '/admin/classes', label: t('classes'), icon: '<i class="fas fa-school"></i>' },
            { path: '/admin/subjects', label: t('subjects'), icon: '<i class="fas fa-book"></i>' },
            { path: '/admin/passwords', label: t('passwords'), icon: '<i class="fas fa-key"></i>' },
            { path: '/admin/teacher-tests', label: store.getState().language === 'uz' ? "O'qituvchilar testlari" : '–¢–µ—Å—Ç—ã –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π', icon: '<i class="fas fa-user-check"></i>' },
        ]
    };
    
    return navs[role] || [];
}

function handleLogout() {
    console.log('üö™ handleLogout called');
    const lang = store.getState().language;
    showConfirmModal(
        lang === 'uz' ? 'Chiqish' : '–í—ã—Ö–æ–¥',
        lang === 'uz' ? 'Chiqishni xohlaysizmi?' : '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?',
        () => {
            console.log('‚úÖ User confirmed logout');
            console.log('üìä State before logout:', store.getState());
            store.logout();
            console.log('üìä State after logout:', store.getState());
            console.log('üîÑ Navigating to /login');
            setTimeout(() => {
                router.navigate('/login');
            }, 100);
        }
    );
}

// Custom Modal Component
function showConfirmModal(title, message, onConfirm) {
    const lang = store.getState().language;
    const modalHTML = `
        <div class="custom-modal-overlay" id="customModal">
            <div class="custom-modal">
                <div class="custom-modal-header">
                    <h3>${title}</h3>
                </div>
                <div class="custom-modal-body">
                    <p>${message}</p>
                </div>
                <div class="custom-modal-footer">
                    <button class="btn-cancel" id="modalCancelBtn">
                        ${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}
                    </button>
                    <button class="btn-confirm" id="modalConfirmBtn">
                        ${lang === 'uz' ? 'Ha' : '–î–∞'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    const modal = document.getElementById('customModal');
    const cancelBtn = document.getElementById('modalCancelBtn');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    
    const closeModal = () => {
        modal.classList.add('fade-out');
        setTimeout(() => modal.remove(), 300);
    };
    
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    
    confirmBtn.addEventListener('click', () => {
        closeModal();
        if (onConfirm) onConfirm();
    });
    
    setTimeout(() => modal.classList.add('show'), 10);
}

// Student Profile Page with Charts
async function renderStudentProfile() {
    const lang = store.getState().language;
    const user = store.getState().user;
    
    if (!user) {
        router.navigate('/login');
        return;
    }
    
    const content = `
        <div class="page-header">
            <div class="page-header-title">
                <h1>${lang === 'uz' ? 'Mening Profilim' : '–ú–æ–π –ü—Ä–æ—Ñ–∏–ª—å'}</h1>
                <p class="page-header-subtitle">${lang === 'uz' ? 'Shaxsiy ma\'lumotlar va statistika' : '–õ–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'}</p>
            </div>
            <div class="page-header-actions">
                <button class="back-button back-button--compact" id="btnBackFromProfile">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                </button>
            </div>
        </div>
        
        <div id="profileContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    document.getElementById('btnBackFromProfile')?.addEventListener('click', () => {
        router.navigate('/student/dashboard');
    });
    
    const container = document.getElementById('profileContainer');
    
    try {
        // Load user profile, subjects, test results and interest test results
        const profileResponse = await apiRequest('/api/users/me');
        const subjectsResponse = await apiRequest('/api/subjects');
        const testResultsResponse = await apiRequest('/api/test-results');
        const testsResponse = await apiRequest('/api/tests');
        const interestResultsResponse = await apiRequest('/api/interest-results');
        
        if (!profileResponse.success) {
            throw new Error('Failed to load profile');
        }
        
        const profile = profileResponse.data;
        const subjects = subjectsResponse.success ? subjectsResponse.data : [];
        const allTestResults = testResultsResponse.success ? testResultsResponse.data : [];
        const tests = testsResponse.success ? testsResponse.data : [];
        const testsById = new Map(tests.map(t => [t._id, t]));
        const interestResultsRaw = interestResultsResponse.success ? interestResultsResponse.data : null;
        const fallbackInterest = profile?.interestTestResults || null;

        const normalizeInterestResults = (value) => {
            if (!value) return null;
            if (Array.isArray(value)) {
                return [...value]
                    .filter(v => v && v.categories)
                    .sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0))[0] || null;
            }
            return value.categories ? value : null;
        };

        const interestResults = normalizeInterestResults(interestResultsRaw) || normalizeInterestResults(fallbackInterest);
        
        // Group test results by subject
        const resultsBySubject = {};
        for (const result of allTestResults) {
            const subjectId = result.subjectId || 'unknown';
            if (!resultsBySubject[subjectId]) {
                resultsBySubject[subjectId] = [];
            }
            resultsBySubject[subjectId].push(result);
        }
        
        console.log('üìä Results by subject:', resultsBySubject);
        console.log('üìö Available subjects:', subjects);
        console.log('üìù All test results:', allTestResults);
        console.log('üß≠ Interest test results:', interestResults);
        console.log('üß≠ Interest results response:', interestResultsResponse);
        
        // Subject recommendations based on interests
        const subjectRecommendations = {
            math: {
                subjects: [
                    { 
                        nameRu: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', 
                        nameUz: 'Matematika',
                        icon: 'üî¢',
                        reasonRu: '–í–∞—à–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ —á–∏—Å–ª–∞–º –¥–µ–ª–∞—é—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –∏–¥–µ–∞–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º',
                        reasonUz: 'Mantiqiy qobiliyatingiz va sonlarga qiziqish matematikani ideal tanlov qiladi'
                    },
                    { 
                        nameRu: '–§–∏–∑–∏–∫–∞', 
                        nameUz: 'Fizika',
                        icon: '‚öõÔ∏è',
                        reasonRu: '–§–∏–∑–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —Å–∏–ª—å–Ω—ã—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≤—ã–∫–æ–≤ –∏ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è',
                        reasonUz: 'Fizika kuchli matematika ko\'nikmalarini va mantiqiy fikrlashni talab qiladi'
                    }
                ]
            },
            science: {
                subjects: [
                    { 
                        nameRu: '–ë–∏–æ–ª–æ–≥–∏—è', 
                        nameUz: 'Biologiya',
                        icon: 'üß¨',
                        reasonRu: '–í–∞—à –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–∏—Ä–æ–¥–µ –∏ –∂–∏–≤—ã–º –æ—Ä–≥–∞–Ω–∏–∑–º–∞–º –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–∏–æ–ª–æ–≥–∏–∏',
                        reasonUz: 'Tabiat va tirik organizmlar haqidagi qiziqishingiz biologiya uchun ideal'
                    },
                    { 
                        nameRu: '–•–∏–º–∏—è', 
                        nameUz: 'Kimyo',
                        icon: 'üß™',
                        reasonRu: '–•–∏–º–∏—è –æ—Ç–∫—Ä–æ–µ—Ç –≤–∞–º –º–∏—Ä –Ω–∞—É—á–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π',
                        reasonUz: 'Kimyo sizga ilmiy tajribalar va tadqiqotlar dunyosini ochadi'
                    }
                ]
            },
            tech: {
                subjects: [
                    { 
                        nameRu: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', 
                        nameUz: 'Informatika',
                        icon: 'üíª',
                        reasonRu: '–í–∞—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è',
                        reasonUz: 'Texnik ko\'nikmalaringiz dasturlash uchun juda mos'
                    },
                    { 
                        nameRu: '–§–∏–∑–∏–∫–∞', 
                        nameUz: 'Fizika',
                        icon: '‚öõÔ∏è',
                        reasonRu: '–§–∏–∑–∏–∫–∞ - –æ—Å–Ω–æ–≤–∞ –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π',
                        reasonUz: 'Fizika - barcha zamonaviy texnologiyalarning asosi'
                    }
                ]
            },
            art: {
                subjects: [
                    { 
                        nameRu: '–ò–∑–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ', 
                        nameUz: 'Tasviriy san\'at',
                        icon: 'üé®',
                        reasonRu: '–†–∞–∑–≤–∏–≤–∞–π—Ç–µ —Å–≤–æ–π —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —á–µ—Ä–µ–∑ –∏—Å–∫—É—Å—Å—Ç–≤–æ',
                        reasonUz: 'San\'at orqali ijodiy salohiyatingizni rivojlantiring'
                    },
                    { 
                        nameRu: '–ú—É–∑—ã–∫–∞', 
                        nameUz: 'Musiqa',
                        icon: 'üéµ',
                        reasonRu: '–ú—É–∑—ã–∫–∞ –ø–æ–º–æ–∂–µ—Ç –≤—ã—Ä–∞–∑–∏—Ç—å –≤–∞—à—É –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å',
                        reasonUz: 'Musiqa ijodkorligingizni ifodalashga yordam beradi'
                    }
                ]
            },
            social: {
                subjects: [
                    { 
                        nameRu: '–ò—Å—Ç–æ—Ä–∏—è', 
                        nameUz: 'Tarix',
                        icon: 'üìú',
                        reasonRu: '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å –æ–±—â–µ—Å—Ç–≤–æ –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
                        reasonUz: 'Tarix jamiyat va inson munosabatlarini tushunishga yordam beradi'
                    },
                    { 
                        nameRu: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', 
                        nameUz: 'Jamiyatshunoslik',
                        icon: 'üë•',
                        reasonRu: '–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤',
                        reasonUz: 'Ijtimoiy va kommunikativ ko\'nikmalarni rivojlantirish uchun ideal'
                    }
                ]
            },
            language: {
                subjects: [
                    { 
                        nameRu: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', 
                        nameUz: 'Adabiyot',
                        icon: 'üìö',
                        reasonRu: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç —è–∑—ã–∫–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ –∏ –∫—É–ª—å—Ç—É—Ä–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ',
                        reasonUz: 'Adabiyot til ko\'nikmalarini va madaniy tushunchani rivojlantiradi'
                    },
                    { 
                        nameRu: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫', 
                        nameUz: 'Chet tili',
                        icon: 'üåç',
                        reasonRu: '–û—Ç–∫—Ä–æ–π—Ç–µ –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —á–µ—Ä–µ–∑ –∏–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–æ–≤',
                        reasonUz: 'Tillarni o\'rganish orqali yangi imkoniyatlarni oching'
                    }
                ]
            }
        };
        
        // Calculate overall statistics
        const totalTests = allTestResults.length;
        const averageScore = totalTests > 0 ? Math.round(allTestResults.reduce((sum, r) => sum + r.score, 0) / totalTests) : 0;
        const bestScore = totalTests > 0 ? Math.max(...allTestResults.map(r => r.score)) : 0;

        // Class ranking
        let classRankingCard = '';
        let classLabelText = '';
        try {
            const classesRes = await apiRequest('/api/classes');
            const classes = classesRes.success ? (classesRes.data || []) : [];
            const studentGrade = profile.grade;
            const studentSection = profile.gradeSection || '';

            if (studentGrade && classes.length) {
                const matchedClass = classes.find(cls => {
                    if (cls.grade !== studentGrade) return false;
                    if (cls.name) return cls.name === studentSection;
                    if (Array.isArray(cls.sections) && studentSection) return cls.sections.includes(studentSection);
                    return !studentSection;
                });

                if (matchedClass) {
                    const classId = matchedClass._id || matchedClass.id;
                    const classSection = matchedClass.name || studentSection || '';
                    classLabelText = matchedClass.name
                        ? `${matchedClass.grade || ''}${matchedClass.name}`
                        : (matchedClass.sections?.length ? `${matchedClass.grade || ''}${studentSection || ''}` : (matchedClass.grade || ''));

                    const studentsRes = await apiRequest(`/api/classes/${classId}/students${classSection ? `?section=${encodeURIComponent(classSection)}` : ''}`);
                    const students = studentsRes.success ? (studentsRes.data || []) : [];

                    if (students.length) {
                        const rankedStudents = [...students].sort((a, b) => (b.averageScore || 0) - (a.averageScore || 0));
                        const studentIndex = rankedStudents.findIndex(s => (s._id || s.id) === (profile._id || profile.id));
                        const studentRank = studentIndex >= 0 ? studentIndex + 1 : null;
                        const totalStudentsInClass = rankedStudents.length;
                        const studentEntry = studentIndex >= 0 ? rankedStudents[studentIndex] : null;
                        const classAverageScore = studentEntry?.averageScore ?? averageScore;

                        if (studentRank) {
                            classRankingCard = `
                                <div class="card" style="text-align: center; background: linear-gradient(135deg, #10b981 0%, #06b6d4 100%); color: white;">
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üèÖ</div>
                                    <div style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.25rem;">${studentRank}/${totalStudentsInClass}</div>
                                    <div style="opacity: 0.9;">${lang === 'uz' ? 'Sinfdagi o‚Äòrin' : '–ú–µ—Å—Ç–æ –≤ –∫–ª–∞—Å—Å–µ'}</div>
                                    <div style="font-size: 0.85rem; opacity: 0.9; margin-top: 0.35rem;">
                                        ${classLabelText || ''} ‚Ä¢ ${lang === 'uz' ? 'O‚Äòrtacha' : '–°—Ä–µ–¥–Ω–∏–π'}: ${classAverageScore}%
                                    </div>
                                </div>
                            `;
                        }
                    }
                }
            }
        } catch (error) {
            console.warn('Class ranking unavailable:', error);
        }
        
        container.innerHTML = `
            <div class="profile-grid" style="display: grid; gap: 1.5rem;">
                <!-- Profile Info Card -->
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <div style="width: 80px; height: 80px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                            üë§
                        </div>
                        <div style="flex: 1;">
                            <h2 style="margin: 0 0 0.5rem 0; color: white;">${profile.firstName} ${profile.lastName}</h2>
                            <div style="display: flex; gap: 1.5rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.95;">
                                <span>üè´ ${profile.school || 'N/A'}</span>
                                <span>üìö ${profile.grade || 'N/A'}${profile.gradeSection ? profile.gradeSection : ''} ${lang === 'uz' ? 'sinf' : '–∫–ª–∞—Å—Å'}</span>
                                <span>üë®‚Äçüéì ${profile.username}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Statistics Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìù</div>
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${totalTests}</div>
                        <div style="opacity: 0.9;">${lang === 'uz' ? 'Jami testlar' : '–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤'}</div>
                    </div>
                    
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üìä</div>
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${averageScore}%</div>
                        <div style="opacity: 0.9;">${lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª'}</div>
                    </div>
                    
                    <div class="card" style="text-align: center; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">üèÜ</div>
                        <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${bestScore}%</div>
                        <div style="opacity: 0.9;">${lang === 'uz' ? 'Eng yaxshi natija' : '–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç'}</div>
                    </div>
                    ${classRankingCard}
                </div>

                <div class="card" style="margin-top: 0.25rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="margin: 0;">${lang === 'uz' ? 'Fanlar bo\'yicha o\'rtacha natijalar' : '–°—Ä–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}</h3>
                    </div>
                    <div style="position: relative; min-height: 260px;">
                        <div id="studentSubjectTrendEmpty" class="card" style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                            ${lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                        </div>
                        <canvas id="studentSubjectTrendChart" style="max-height: 300px; width: 100%; display: none;"></canvas>
                    </div>
                </div>
                
                <!-- Interest Test Results Section -->
                ${interestResults ? `
                <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 16px; overflow: hidden;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <h3 style="margin: 0; display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 1.8rem;">üß≠</span>
                            <span>${lang === 'uz' ? 'Qiziqishlaringiz profili' : '–ü—Ä–æ—Ñ–∏–ª—å –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤'}</span>
                        </h3>
                        ${interestResults.completedAt ? `
                            <div style="font-size: 0.85rem; color: var(--text-muted); text-align: right;">
                                <div>${lang === 'uz' ? 'Oxirgi test' : '–ü–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ—Å—Ç'}:</div>
                                <div style="font-weight: 600;">${new Date(interestResults.completedAt).toLocaleDateString('ru-RU', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
                            </div>
                        ` : ''}
                    </div>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem;">
                        ${lang === 'uz' ? 'Test natijalariga asoslangan qiziqishlaringiz tahlili' : '–ê–Ω–∞–ª–∏–∑ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–∞'}
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        ${Object.entries(interestResults.categories).sort((a, b) => b[1] - a[1]).slice(0, 3).map(([category, score]) => {
                            const categoryNames = {
                                math: { uz: 'Matematika', ru: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', icon: 'üî¢' },
                                science: { uz: 'Fan', ru: '–ù–∞—É–∫–∞', icon: 'üî¨' },
                                tech: { uz: 'Texnologiya', ru: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', icon: 'üíª' },
                                art: { uz: 'San\'at', ru: '–ò—Å–∫—É—Å—Å—Ç–≤–æ', icon: 'üé®' },
                                social: { uz: 'Ijtimoiy', ru: '–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ', icon: 'üë•' },
                                language: { uz: 'Til', ru: '–Ø–∑—ã–∫–∏', icon: 'üìö' }
                            };
                            const cat = categoryNames[category] || { uz: category, ru: category, icon: 'üìä' };
                            const percentage = Math.round(score);
                            
                            return `
                                <div class="card" style="text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: 2px solid rgba(102, 126, 234, 0.5); position: relative; overflow: hidden;">
                                    <div style="position: absolute; top: 8px; right: 8px; font-size: 1.2rem;">‚≠ê</div>
                                    <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${cat.icon}</div>
                                    <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.25rem;">${percentage}%</div>
                                    <div style="opacity: 0.95; font-size: 0.9rem;">${lang === 'uz' ? cat.uz : cat.ru}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 1rem; flex-wrap: wrap;">
                        <button class="button button-secondary" id="btnViewInterestTest" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span>üìä</span>
                            <span>${lang === 'uz' ? 'Batafsil natijalarni ko\'rish' : '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</span>
                        </button>
                        <button class="button button-primary" id="btnRetakeInterestTest" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span>üîÑ</span>
                            <span>${lang === 'uz' ? 'Testni qayta topshirish' : '–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç –∑–∞–Ω–æ–≤–æ'}</span>
                        </button>
                    </div>
                </div>
                
                <!-- Subject Recommendations based on interests -->
                <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.05) 100%); border: 2px solid rgba(102, 126, 234, 0.3); border-radius: 16px; overflow: hidden;">
                    <h2 style="margin-bottom: 1rem; display: flex; align-items: center; gap: 0.75rem;">
                        <span style="font-size: 2rem;">üéì</span>
                        <span>${lang === 'uz' ? 'Tavsiya etiladigan fanlar' : '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}</span>
                    </h2>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem;">
                        ${lang === 'uz' ? 'Sizning qiziqishlaringizga mos keladigan fanlar' : '–ü—Ä–µ–¥–º–µ—Ç—ã, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–∞—à–∏–º –∏–Ω—Ç–µ—Ä–µ—Å–∞–º'}
                    </p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        ${Object.entries(interestResults.categories).sort((a, b) => b[1] - a[1]).slice(0, 3).flatMap(([category, score]) => {
                            const recommendations = subjectRecommendations[category];
                            if (!recommendations) return [];
                            
                            return recommendations.subjects.map(subject => ({
                                subject,
                                score,
                                category
                            }));
                        }).slice(0, 3).map(({ subject, score }) => `
                            <div class="subject-recommendation-card" style="background: var(--bg-secondary); border: 2px solid rgba(102, 126, 234, 0.2); border-radius: 12px; padding: 1.5rem; transition: all 0.3s ease;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="font-size: 2.5rem; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px;">
                                        ${subject.icon}
                                    </div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 0.25rem 0; font-size: 1.1rem;">${lang === 'uz' ? subject.nameUz : subject.nameRu}</h3>
                                        <div style="color: var(--primary); font-weight: bold;">${Math.round(score)}% ${lang === 'uz' ? 'mos' : '—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'}</div>
                                    </div>
                                </div>
                                <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem; line-height: 1.5;">
                                    ${lang === 'uz' ? subject.reasonUz : subject.reasonRu}
                                </p>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : `
                <div class="card" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.03) 100%); border: 2px dashed rgba(102, 126, 234, 0.3); text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.4;">üß≠</div>
                    <h3 style="margin-bottom: 0.75rem;">${lang === 'uz' ? 'Qiziqishlaringizni aniqlang' : '–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –≤–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã'}</h3>
                    <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.95rem;">
                        ${lang === 'uz' ? 'Test sizning qiziqishlaringizni aniqlash va mos fanlarni tavsiya qilishga yordam beradi' : '–¢–µ—Å—Ç –ø–æ–º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ –ø–æ—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}
                    </p>
                    <button class="button button-primary" id="btnStartInterestTest" style="display: inline-flex; align-items: center; gap: 0.5rem;">
                        <span>üöÄ</span>
                        <span>${lang === 'uz' ? 'Testni boshlash' : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'}</span>
                    </button>
                </div>
                `}
                
                ${totalTests > 0 ? `
                <!-- Subject Selector -->
                <div class="card">
                    <h3 style="margin-bottom: 1rem;">
                        <span style="font-size: 1.5rem; margin-right: 0.5rem;">üìö</span>
                        ${lang === 'uz' ? 'Fan bo\'yicha natijalarni ko\'rish' : '–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É'}
                    </h3>
                    <p style="color: var(--text-muted); margin-bottom: 1rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Quyidagi ro\'yxatdan fanni tanlab, o\'sha fan bo\'yicha batafsil natijalaringizni ko\'ring' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –Ω–µ–º—É'}
                    </p>
                    <select id="subjectSelector" class="form-input">
                        <option value="" selected disabled>${lang === 'uz' ? 'Fanni tanlang...' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç...'}</option>
                        ${subjects.filter(s => resultsBySubject[s._id]).map(subject => `
                            <option value="${subject._id}">${lang === 'uz' ? subject.nameUz : subject.nameRu} (${resultsBySubject[subject._id].length} ${lang === 'uz' ? 'ta test' : '—Ç–µ—Å—Ç–æ–≤'})</option>
                        `).join('')}
                    </select>
                </div>
                
                <!-- Statistics for Selected Subject -->
                <div id="subjectStats" style="display: none;">
                </div>
                ` : `
                <div class="card" style="text-align: center; padding: 3rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üìä</div>
                    <h3 style="color: var(--text-muted);">${lang === 'uz' ? 'Hali testlar topshirilmagan' : '–¢–µ—Å—Ç—ã –µ—â–µ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω—ã'}</h3>
                    <p style="color: var(--text-muted); margin-top: 0.5rem;">${lang === 'uz' ? 'Testlarni boshlang va natijalaringizni bu yerda ko\'ring' : '–ü—Ä–æ–π–¥–∏—Ç–µ —Ç–µ—Å—Ç—ã –∏ —É–≤–∏–¥–∏—Ç–µ —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∑–¥–µ—Å—å'}</p>
                    <button class="button button-primary" id="btnGoToSubjects" style="margin-top: 1rem;">
                        ${lang === 'uz' ? 'Testlarni boshlash' : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç—ã'}
                    </button>
                </div>
                `}
            </div>
        `;

        const subjectSeries = Object.keys(resultsBySubject).map(subjectId => {
            const subject = subjects.find(s => (s._id || s.id) === subjectId);
            return {
                subjectId,
                subjectName: subject?.nameRu || subject?.nameUz || subjectId,
                data: (resultsBySubject[subjectId] || []).map(result => result.score)
            };
        });

        const subjectChartData = buildSubjectAverageChart(
            { series: subjectSeries },
            lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª',
            { subjectList: subjects, includeAllSubjects: true }
        );

        renderLineChart('studentSubjectTrendChart', 'studentSubjectTrendEmpty', subjectChartData);
        
        if (totalTests > 0) {
            // Function to render statistics for selected subject
            const renderSubjectStatistics = async (subjectId) => {
                const statsContainer = document.getElementById('subjectStats');
                
                // If no subject selected, hide container
                if (!subjectId || subjectId === '') {
                    statsContainer.style.display = 'none';
                    return;
                }
                
                const testResults = resultsBySubject[subjectId] || [];
                
                if (testResults.length === 0) {
                    statsContainer.style.display = 'block';
                    statsContainer.innerHTML = `
                        <div class="card" style="text-align: center; padding: 2rem;">
                            <p style="color: var(--text-muted);">${lang === 'uz' ? 'Bu fan bo\'yicha natijalar yo\'q' : '–ù–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ —ç—Ç–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É'}</p>
                        </div>
                    `;
                    return;
                }
                
                const subjectTotalTests = testResults.length;
                const subjectAverageScore = Math.round(testResults.reduce((sum, r) => sum + r.score, 0) / subjectTotalTests);
                
                const subject = subjects.find(s => s._id === subjectId);
                const subjectName = subject ? (lang === 'uz' ? subject.nameUz : subject.nameRu) : '';
                
                const modulesRes = await apiRequest(`/api/subjects/${subjectId}/modules`);
                const modules = modulesRes.success ? (modulesRes.data?.data || modulesRes.data || []) : [];
                const moduleNameById = new Map(modules.map(m => [m._id, lang === 'uz' ? m.nameUz : m.nameRu]));

                const moduleBuckets = {};
                testResults.forEach(result => {
                    const test = testsById.get(result.testId);
                    const moduleId = test?.moduleId || 'unknown';
                    if (!moduleBuckets[moduleId]) {
                        moduleBuckets[moduleId] = {
                            scores: [],
                            label: moduleNameById.get(moduleId) || (lang === 'uz' ? 'Mavzu' : '–¢–µ–º–∞')
                        };
                    }
                    moduleBuckets[moduleId].scores.push(result.score);
                });

                const moduleLabels = Object.values(moduleBuckets).map(b => b.label);
                const moduleScores = Object.values(moduleBuckets).map(b => {
                    const avg = b.scores.reduce((sum, v) => sum + v, 0) / b.scores.length;
                    return Math.round(avg * 10) / 10;
                });

                statsContainer.style.display = 'block';
                statsContainer.innerHTML = `
                    <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-bottom: 1rem;">
                        <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">üìñ</span>
                            <span>${subjectName}</span>
                        </h2>
                    </div>
                    
                    <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); margin-bottom: 1.5rem;">
                        <div class="card" style="text-align: center; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                            <div style="font-size: 1.75rem; font-weight: bold; margin-bottom: 0.25rem;">${subjectTotalTests}</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">${lang === 'uz' ? 'Topshirilgan' : '–ü—Ä–æ–π–¥–µ–Ω–æ'}</div>
                        </div>
                        
                        <div class="card" style="text-align: center; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                            <div style="font-size: 1.75rem; font-weight: bold; margin-bottom: 0.25rem;">${subjectAverageScore}%</div>
                            <div style="opacity: 0.9; font-size: 0.9rem;">${lang === 'uz' ? 'O\'rtacha' : '–°—Ä–µ–¥–Ω–∏–π'}</div>
                        </div>
                        
                    </div>
                    
                    <div class="card">
                        <h3 style="margin-bottom: 1rem;">
                            <span style="font-size: 1.25rem; margin-right: 0.5rem;">üìà</span>
                            ${lang === 'uz' ? 'Modullar bo\'yicha natijalar' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –º–æ–¥—É–ª—è–º'}
                        </h3>
                        <div style="position: relative; min-height: 260px;">
                            <canvas id="subjectModuleChart" style="max-height: 300px; width: 100%;"></canvas>
                        </div>
                    </div>
                `;
                const chartData = {
                    labels: moduleLabels,
                    series: [{ label: lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª', data: moduleScores }]
                };
                renderBarChart('subjectModuleChart', null, chartData);
            };
            
            // Add event listener to subject selector
            const subjectSelector = document.getElementById('subjectSelector');
            if (subjectSelector) {
                subjectSelector.addEventListener('change', async (e) => {
                    await renderSubjectStatistics(e.target.value);
                });
            }
        } else {
            // Add event listener for "Go to Subjects" button if no tests
            const btnGoToSubjects = document.getElementById('btnGoToSubjects');
            if (btnGoToSubjects) {
                btnGoToSubjects.addEventListener('click', () => {
                    router.navigate('/student/subjects');
                });
            }
        }
        
        // Add event listeners for interest test buttons
        const btnViewInterestTest = document.getElementById('btnViewInterestTest');
        if (btnViewInterestTest) {
            btnViewInterestTest.addEventListener('click', () => {
                router.navigate('/student/interest-test');
            });
        }
        
        const btnRetakeInterestTest = document.getElementById('btnRetakeInterestTest');
        if (btnRetakeInterestTest) {
            btnRetakeInterestTest.addEventListener('click', () => {
                router.navigate('/student/interest-test');
            });
        }
        
        const btnStartInterestTest = document.getElementById('btnStartInterestTest');
        if (btnStartInterestTest) {
            btnStartInterestTest.addEventListener('click', () => {
                router.navigate('/student/interest-test');
            });
        }
        
    } catch (error) {
        console.error('‚ùå Error loading profile:', error);
        console.error('Error details:', error.message, error.stack);
        container.innerHTML = `
            <div class="card" style="text-align: center; padding: 3rem;">
                <p style="color: #ef4444;">${lang === 'uz' ? 'Profilni yuklashda xato' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ—Ñ–∏–ª—è'}</p>
                <p style="color: var(--text-muted); font-size: 0.9rem; margin-top: 0.5rem;">${error.message || ''}</p>
                <button class="button button-secondary" id="btnBackToDashboard" style="margin-top: 1rem;">
                    ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
                </button>
            </div>
        `;
        
        document.getElementById('btnBackToDashboard')?.addEventListener('click', () => {
            router.navigate('/student/dashboard');
        });
    }
}

// Student Dashboard
function renderStudentDashboard() {
    const user = store.getState().user;
    
    if (!user) {
        router.navigate('/login');
        return;
    }
    
    const content = `
        <div class="student-dashboard">
            <header class="page-header">
                <h1>${t('dashboard')}</h1>
                <p>${user.firstName} ${user.lastName} ‚Ä¢ ${user.school || ''} ${user.grade ? '‚Ä¢ ' + user.grade + ' ' + t('grade') : ''}</p>
            </header>

            <div class="info-section" style="margin-bottom: 3rem;">
                <div class="card">
                    <h3>üë§ ${t('myProfile')}</h3>
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">${t('firstName')}</span>
                            <span class="info-value">${user.firstName}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">${t('lastName')}</span>
                            <span class="info-value">${user.lastName}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">${t('school')}</span>
                            <span class="info-value">${user.school || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">${t('grade')}</span>
                            <span class="info-value" style="color: var(--text-primary); font-weight: 700; font-size: 1.1rem;">${user.grade || 'N/A'}</span>
                        </div>
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <h2 style="color: var(--text-primary); font-size: 1.5rem; font-weight: 600; margin: 0;">
                    ${store.getState().language === 'uz' ? 'üìù Mavjud testlar' : 'üìù –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–µ—Å—Ç—ã'}
                </h2>
            </div>

            <div class="dashboard-cards">
                <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" id="btnStudentProfile">
                    <div class="card-icon">üìä</div>
                    <div class="card-content">
                        <h3>${store.getState().language === 'uz' ? 'Profil va Statistika' : '–ü—Ä–æ—Ñ–∏–ª—å –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'}</h3>
                        <p>${store.getState().language === 'uz' ? "Natijalaringizni ko'ring" : '–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —Å–≤–æ–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>

                <div class="dashboard-card card-primary" id="btnSubjectTests">
                    <div class="card-icon">üìö</div>
                    <div class="card-content">
                        <h3>${t('subjectTests')}</h3>
                        <p>${store.getState().language === 'uz' ? "Fanlar bo'yicha bilimingizni tekshiring" : '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>

                <div class="dashboard-card card-secondary" id="btnInterestTest">
                    <div class="card-icon">üéØ</div>
                    <div class="card-content">
                        <h3>${t('interestTest')}</h3>
                        <p>${store.getState().language === 'uz' ? "O'z qobiliyatingizni aniqlang" : '–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–≤–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏'}</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>

                <div class="dashboard-card card-tertiary" id="btnControlTests">
                    <div class="card-icon">‚úèÔ∏è</div>
                    <div class="card-content">
                        <h3>${t('controlTests')}</h3>
                        <p>${store.getState().language === 'uz' ? 'O\'qituvchining nazorat isbotlarini bajaring' : '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã'}</p>
                    </div>
                    <div class="card-arrow">‚Üí</div>
                </div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    // Add event listeners for navigation buttons
    console.log('üìç Adding event listeners to dashboard cards');
    document.getElementById('btnSubjectTests')?.addEventListener('click', () => {
        console.log('üìö Subject Tests button clicked');
        router.navigate('/student/subjects');
    });
    
    document.getElementById('btnInterestTest')?.addEventListener('click', () => {
        console.log('üéØ Interest Test button clicked');
        router.navigate('/student/interest-test');
    });

    document.getElementById('btnControlTests')?.addEventListener('click', () => {
        console.log('‚úèÔ∏è Control Tests button clicked');
        router.navigate('/student/control-tests');
    });

    document.getElementById('btnStudentProfile')?.addEventListener('click', () => {
        console.log('üìä Student Profile button clicked');
        router.navigate('/student/profile');
    });
}

// Subject Tests Page
async function renderSubjectTests() {
    const lang = store.getState().language;
    const content = `
        <div class="page-header">
            <div class="page-header-title">
                <h1>${t('subjectTests')}</h1>
                <p class="page-header-subtitle">${lang === 'uz' ? 'Bilimingizni sinab ko\'ring' : '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–≤–æ–∏ –∑–Ω–∞–Ω–∏—è'}</p>
            </div>
            <div class="page-header-actions">
                <button class="back-button back-button--compact" id="btnBackFromSubjects">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                </button>
            </div>
        </div>
        
        <div id="subjectsContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    document.getElementById('btnBackFromSubjects')?.addEventListener('click', () => {
        router.navigate('/student/dashboard');
    });
    
    // Fetch subjects
    const result = await apiRequest('/api/subjects');
    
    if (result.success && result.data && result.data.length > 0) {
        const subjectsContainer = document.getElementById('subjectsContainer');
        subjectsContainer.innerHTML = `
            <div class="subjects-grid">
                ${result.data.map(subject => `
                    <div class="subject-card" data-subject-id="${subject._id}">
                        <div class="subject-header">
                            <div class="subject-icon">${getSubjectIcon(store.getState().language === 'uz' ? subject.nameUz : subject.nameRu)}</div>
                            <h3>${store.getState().language === 'uz' ? subject.nameUz : subject.nameRu}</h3>
                        </div>
                        <div class="subject-info">
                            <p>${store.getState().language === 'uz' ? 'Savollar' : '–í–æ–ø—Ä–æ—Å–æ–≤'}: ${subject.questionsCount || 10}</p>
                            <p>${store.getState().language === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}: 30 ${store.getState().language === 'uz' ? 'daqiqa' : '–º–∏–Ω—É—Ç'}</p>
                        </div>
                        <button class="btn-secondary btn-start-test" data-subject-id="${subject._id}">
                            ${store.getState().language === 'uz' ? 'Testni boshlash' : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'}
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Add event listeners to start test buttons
        console.log('üìç Adding event listeners to start test buttons');
        document.querySelectorAll('.btn-start-test').forEach(btn => {
            btn.addEventListener('click', function() {
                const subjectId = this.getAttribute('data-subject-id');
                console.log('üìö Start test button clicked for subject:', subjectId);
                startSubjectTest(subjectId);
            });
        });
    } else {
        const subjectsContainer = document.getElementById('subjectsContainer');
        subjectsContainer.innerHTML = `<p style="text-align: center; color: var(--text-muted);">${store.getState().language === 'uz' ? 'Fanlar topilmadi' : '–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</p>`;
    }
}

function getSubjectIcon(subjectName) {
    const icons = {
        'Mathematics': 'üî¢',
        'Matematika': 'üî¢',
        '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞': 'üî¢',
        'Physics': '‚öõÔ∏è',
        'Fizika': '‚öõÔ∏è',
        '–§–∏–∑–∏–∫–∞': '‚öõÔ∏è',
        'Chemistry': 'üß™',
        'Kimyo': 'üß™',
        '–•–∏–º–∏—è': 'üß™',
        'Biology': 'üß¨',
        'Biologiya': 'üß¨',
        '–ë–∏–æ–ª–æ–≥–∏—è': 'üß¨',
        'History': 'üìú',
        'Tarix': 'üìú',
        '–ò—Å—Ç–æ—Ä–∏—è': 'üìú',
        'Literature': 'üìö',
        'Adabiyot': 'üìö',
        '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞': 'üìö',
        'English': 'üî§',
        'Ingliz tili': 'üî§',
        '–ê–Ω–≥–ª–∏–π—Å–∫–∏–π': 'üî§',
        'Geography': 'üåç',
        'Geografiya': 'üåç',
        '–ì–µ–æ–≥—Ä–∞—Ñ–∏—è': 'üåç'
    };
    return icons[subjectName] || 'üìñ';
}

// View subject modules and tests (for students)
async function startSubjectTest(subjectId) {
    router.navigate(`/student/subject-modules/${subjectId}`);
}

// Render subject modules page for students
async function renderStudentSubjectModules() {
    const subjectId = window.location.pathname.split('/').pop();
    const lang = store.getState().language;
    
    console.log('üìñ renderStudentSubjectModules called with subjectId:', subjectId);
    
    const content = `
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="subjectName">${lang === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</h1>
                    <p>${lang === 'uz' ? 'Modullar va testlar' : '–ú–æ–¥—É–ª–∏ –∏ —Ç–µ—Å—Ç—ã'}</p>
                </div>
                <button class="button button-secondary" id="btnBackToSubjects">
                    ${lang === 'uz' ? '‚Üê Orqaga' : '‚Üê –ù–∞–∑–∞–¥'}
                </button>
            </div>
        </div>
        
        <div id="modulesContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    // Add back button listener
    console.log('üìç Adding event listener to back button');
    document.getElementById('btnBackToSubjects')?.addEventListener('click', () => {
        console.log('‚¨ÖÔ∏è Back to subjects button clicked');
        router.navigate('/student/subjects');
    });
    
    // Load subject name
    const subjectsResult = await apiRequest('/api/subjects');
    if (subjectsResult.success) {
        const subject = subjectsResult.data.find(s => s._id === subjectId);
        if (subject) {
            document.getElementById('subjectName').textContent = lang === 'uz' ? subject.nameUz : subject.nameRu;
        }
    }
    
    // Load modules
    console.log('üì¶ Loading modules for subject:', subjectId);
    const modulesResult = await apiRequest(`/api/subjects/${subjectId}/modules`);
    console.log('üì¶ Modules result:', modulesResult);
    console.log('üì¶ Data:', modulesResult.data);
    console.log('üì¶ Data length:', modulesResult.data ? modulesResult.data.length : 'undefined');
    console.log('üì¶ Success:', modulesResult.success);
    
    if (modulesResult.success && modulesResult.data && modulesResult.data.length > 0) {
        const modulesContainer = document.getElementById('modulesContainer');
        
        // Load test results for this student
        const testResultsResponse = await apiRequest('/api/test-results');
        const allTestResults = testResultsResponse.success ? testResultsResponse.data : [];
        
        console.log('======================');
        console.log('üìä –ó–ê–ì–†–£–ñ–ï–ù–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:');
        console.log('üìä –í—Å–µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:', allTestResults.length);
        allTestResults.forEach((result, idx) => {
            console.log(`  ${idx + 1}. TestId: ${result.testId}, Score: ${result.score}%, Correct: ${result.correctCount}/${result.totalCount}, Date: ${result.completedAt}`);
        });
        console.log('======================');
        
        // Create a map of test results by testId (latest only) - sort by date DESC
        const latestResultByTestId = {};
        allTestResults.forEach(result => {
            const testId = result.testId;
            const currentDate = new Date(result.completedAt).getTime();
            
            if (!latestResultByTestId[testId]) {
                latestResultByTestId[testId] = result;
                console.log(`‚ú® First result for test ${testId}: ${result.correctCount}/${result.totalCount} (${result.score}%) - ${result.completedAt}`);
            } else {
                const existingDate = new Date(latestResultByTestId[testId].completedAt).getTime();
                console.log(`üîç Comparing for test ${testId}:`);
                console.log(`   Existing: ${latestResultByTestId[testId].correctCount}/${latestResultByTestId[testId].totalCount} (${latestResultByTestId[testId].score}%) - ${latestResultByTestId[testId].completedAt}`);
                console.log(`   New: ${result.correctCount}/${result.totalCount} (${result.score}%) - ${result.completedAt}`);
                
                if (currentDate > existingDate) {
                    console.log(`   ‚úÖ New result is NEWER - using it!`);
                    latestResultByTestId[testId] = result;
                } else {
                    console.log(`   ‚ùå Existing result is newer - keeping it`);
                }
            }
        });
        
        console.log('üìä –ü–û–°–õ–ï–î–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ü–û –¢–ï–°–¢–ê–ú:');
        Object.keys(latestResultByTestId).forEach(testId => {
            const r = latestResultByTestId[testId];
            console.log(`  TestId: ${testId} ‚Üí ${r.correctCount}/${r.totalCount} (${r.score}%) - Date: ${r.completedAt}`);
        });
        console.log('======================');
        
        // Load tests for each module
        const modulesWithTests = await Promise.all(
            modulesResult.data.map(async (module) => {
                const testsResult = await apiRequest(`/api/modules/${module._id}/tests`);
                const publishedTests = testsResult.success ? testsResult.data.filter(t => t.status === 'published') : [];
                return {
                    ...module,
                    tests: publishedTests
                };
            })
        );
        
        modulesContainer.innerHTML = modulesWithTests.map(module => `
            <div class="card" style="margin-bottom: 2rem;">
                <h3 style="margin-bottom: 0.5rem;">${lang === 'uz' ? module.nameUz : module.nameRu}</h3>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">${lang === 'uz' ? module.descriptionUz : module.descriptionRu}</p>
                
                ${module.tests.length > 0 ? `
                    <div style="display: grid; gap: 1rem;">
                        ${module.tests.map(test => {
                            // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è —ç—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞
                            const testResult = latestResultByTestId[test._id];
                            const isPassed = testResult !== null && testResult !== undefined;
                            
                            // –ë–∞–∑–æ–≤–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –Ω–µ–ø—Ä–æ–π–¥–µ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
                            if (!isPassed) {
                                return `
                                    <div class="card" style="background: var(--bg-tertiary); transition: all 0.3s ease;">
                                        <h4 style="margin-bottom: 0.5rem;">${lang === 'uz' ? test.nameUz : test.nameRu}</h4>
                                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                                            ${test.duration ? `<span>‚è±Ô∏è ${test.duration} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω'}</span>` : ''}
                                            <span>üìù ${test.questionsCount || 0} ${lang === 'uz' ? 'savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                                        </div>
                                        <button class="button button-primary btn-start-student-test" data-test-id="${test._id}" style="width: 100%;">
                                            ${lang === 'uz' ? '‚ñ∂Ô∏è Boshlash' : '‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'}
                                        </button>
                                    </div>
                                `;
                            }
                            
                            // –¢–µ—Å—Ç –ø—Ä–æ–π–¥–µ–Ω - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å —Ü–≤–µ—Ç–Ω–æ–π —Ä–∞–º–∫–æ–π
                            const correctCount = testResult.correctCount || 0;
                            const totalCount = testResult.totalCount || test.questionsCount || 0;
                            const scorePercent = testResult.score || 0;
                            
                            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∏ –±–µ–π–¥–∂ –ø–æ –ø—Ä–æ—Ü–µ–Ω—Ç—É
                            let borderColor, badgeText, badgeIcon, badgeGradient;
                            
                            if (scorePercent >= 80) {
                                // –û—Ç–ª–∏—á–Ω–æ - –∑–µ–ª—ë–Ω—ã–π
                                borderColor = '#10b981';
                                badgeText = lang === 'uz' ? 'A\'lo' : '–û—Ç–ª–∏—á–Ω–æ';
                                badgeIcon = '‚≠ê';
                                badgeGradient = 'linear-gradient(135deg, #10b981, #059669)';
                            } else if (scorePercent >= 50) {
                                // –ù–æ—Ä–º–∞–ª—å–Ω–æ - –∂—ë–ª—Ç—ã–π
                                borderColor = '#f59e0b';
                                badgeText = lang === 'uz' ? 'Yaxshi' : '–•–æ—Ä–æ—à–æ';
                                badgeIcon = 'üëç';
                                badgeGradient = 'linear-gradient(135deg, #f59e0b, #d97706)';
                            } else {
                                // –ü–ª–æ—Ö–æ - –∫—Ä–∞—Å–Ω—ã–π
                                borderColor = '#ef4444';
                                badgeText = lang === 'uz' ? 'Qayta urining' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë';
                                badgeIcon = 'üí™';
                                badgeGradient = 'linear-gradient(135deg, #ef4444, #dc2626)';
                            }
                            
                            return `
                                <div class="card" style="
                                    background: var(--bg-tertiary); 
                                    border-left: 5px solid ${borderColor};
                                    position: relative;
                                    transition: all 0.3s ease;
                                ">
                                    <!-- –ë–µ–π–¥–∂ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
                                    <div style="
                                        position: absolute;
                                        top: 1rem;
                                        right: 1rem;
                                        background: ${badgeGradient};
                                        color: white;
                                        padding: 0.4rem 0.9rem;
                                        border-radius: 20px;
                                        font-size: 0.8rem;
                                        font-weight: 600;
                                        display: flex;
                                        align-items: center;
                                        gap: 0.4rem;
                                        box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                                    ">
                                        <span>${badgeIcon}</span>
                                        <span>${badgeText}</span>
                                    </div>
                                    
                                    <!-- –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ -->
                                    <h4 style="margin-bottom: 0.5rem; padding-right: 130px;">
                                        ${lang === 'uz' ? test.nameUz : test.nameRu}
                                    </h4>
                                    
                                    <!-- –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Ç–µ—Å—Ç–∞ -->
                                    <div style="display: flex; gap: 1rem; margin-bottom: 1rem; font-size: 0.875rem; color: var(--text-muted);">
                                        ${test.duration ? `<span>‚è±Ô∏è ${test.duration} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω'}</span>` : ''}
                                        <span>üìù ${test.questionsCount || 0} ${lang === 'uz' ? 'savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                                    </div>
                                    
                                    <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã -->
                                    <div style="
                                        background: rgba(0,0,0,0.2);
                                        border-radius: 10px;
                                        padding: 1rem;
                                        margin-bottom: 1rem;
                                        display: flex;
                                        justify-content: space-around;
                                        align-items: center;
                                        gap: 1rem;
                                        flex-wrap: wrap;
                                    ">
                                        <!-- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã -->
                                        <div style="text-align: center; flex: 1; min-width: 100px;">
                                            <div style="
                                                font-size: 0.7rem;
                                                text-transform: uppercase;
                                                letter-spacing: 0.5px;
                                                color: var(--text-muted);
                                                margin-bottom: 0.3rem;
                                            ">
                                                ${lang === 'uz' ? 'Natija' : '–†–µ–∑—É–ª—å—Ç–∞—Ç'}
                                            </div>
                                            <div style="
                                                font-size: 1.6rem;
                                                font-weight: 700;
                                                color: ${borderColor};
                                                line-height: 1;
                                            ">
                                                ${correctCount}/${totalCount}
                                            </div>
                                        </div>
                                        
                                        <!-- –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å -->
                                        <div style="
                                            width: 2px;
                                            height: 45px;
                                            background: rgba(255,255,255,0.1);
                                        "></div>
                                        
                                        <!-- –ü—Ä–æ—Ü–µ–Ω—Ç -->
                                        <div style="text-align: center; flex: 1; min-width: 100px;">
                                            <div style="
                                                font-size: 0.7rem;
                                                text-transform: uppercase;
                                                letter-spacing: 0.5px;
                                                color: var(--text-muted);
                                                margin-bottom: 0.3rem;
                                            ">
                                                ${lang === 'uz' ? 'Foiz' : '–ü—Ä–æ—Ü–µ–Ω—Ç'}
                                            </div>
                                            <div style="
                                                font-size: 1.6rem;
                                                font-weight: 700;
                                                color: ${borderColor};
                                                line-height: 1;
                                            ">
                                                ${scorePercent}%
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- –ö–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è -->
                                    <button class="button button-secondary btn-start-student-test" data-test-id="${test._id}" style="width: 100%;">
                                        ${lang === 'uz' ? 'üîÑ Qayta topshirish' : 'üîÑ –ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞'}
                                    </button>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : `
                    <p style="text-align: center; color: var(--text-muted); padding: 2rem;">
                        ${lang === 'uz' ? 'Bu modulda hali testlar mavjud emas' : '–í —ç—Ç–æ–º –º–æ–¥—É–ª–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤'}
                    </p>
                `}
            </div>
        `).join('');
        
        // Add event listeners to start test buttons
        console.log('üìç Adding event listeners to start test buttons');
        document.querySelectorAll('.btn-start-student-test').forEach(btn => {
            btn.addEventListener('click', function() {
                const testId = this.getAttribute('data-test-id');
                console.log('üìù Start test button clicked:', testId);
                router.navigate(`/student/take-test/${testId}`);
            });
        });
    } else {
        console.log('‚ùå No modules found or error. Success:', modulesResult.success, 'Data:', modulesResult.data);
        document.getElementById('modulesContainer').innerHTML = `
            <div class="card">
                <p style="text-align: center; color: var(--text-muted);">
                    ${lang === 'uz' ? 'Bu fanda hali modullar mavjud emas' : '–í —ç—Ç–æ–º –ø—Ä–µ–¥–º–µ—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç –º–æ–¥—É–ª–µ–π'}
                </p>
            </div>
        `;
    }
}

// Test Taker Page
async function renderTestTaker() {
    const testId = window.location.pathname.split('/').pop();
    const lang = store.getState().language;
    
    console.log('üìñ renderTestTaker called with testId:', testId);
    
    const content = `
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 id="testName">${lang === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</h1>
                    <p id="testInfo">${lang === 'uz' ? 'Test vaqti' : '–í—Ä–µ–º—è –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞'}</p>
                </div>
                <button class="button button-secondary" id="btnBackToModules">
                    ${lang === 'uz' ? '‚Üê Orqaga' : '‚Üê –ù–∞–∑–∞–¥'}
                </button>
            </div>
        </div>
        
        <div id="testTimer" style="display: none; position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1rem; margin: -2rem -2rem 2rem -2rem; text-align: center; box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);">
            <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">
                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.9); font-weight: 600; letter-spacing: 1px;">‚è±Ô∏è ${lang === 'uz' ? 'QOLGAN VAQT' : '–û–°–¢–ê–õ–û–°–¨'}</div>
                <div id="timerDisplay" style="font-size: 2.5rem; font-weight: bold; color: white; font-family: 'Courier New', monospace; letter-spacing: 4px; min-width: 120px; text-shadow: 0 2px 8px rgba(0,0,0,0.3);">00:00</div>
            </div>
        </div>
        
        <div id="testContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    const testContainer = document.getElementById('testContainer');
    
    // Add back button listener
    document.getElementById('btnBackToModules')?.addEventListener('click', () => {
        console.log('‚¨ÖÔ∏è Back to modules button clicked');
        // Clear timer before leaving
        if (window._testTimerInterval) {
            clearInterval(window._testTimerInterval);
            window._testTimerInterval = null;
            console.log('üßπ Timer cleared');
        }
        history.back();
    });
    
    // Load test with questions
    console.log('üìö Loading test:', testId);
    const testResult = await apiRequest(`/api/tests/${testId}`);
    console.log('üìù Test result:', testResult);
    
    if (testResult.success && testResult.data) {
        const test = testResult.data;
        document.getElementById('testName').textContent = lang === 'uz' ? test.nameUz : test.nameRu;
        
        const questions = test.questions || [];
        
        console.log('üìä Test has', questions.length, 'questions');
        
        // Shuffle questions and answers
        const shuffledQuestions = shuffleQuestions(questions);
        console.log('üîÄ Shuffled questions:', shuffledQuestions.length);
        
        // Start/resume timer - check if test was already in progress
        let timeLeft = (test.timeLimit || 15) * 60; // Convert to seconds
        let startTime = Date.now();
        
        // Check localStorage for saved progress
        const savedProgress = localStorage.getItem(`test-${testId}-progress`);
        if (savedProgress) {
            const progress = JSON.parse(savedProgress);
            const elapsedTime = Math.floor((Date.now() - progress.startedAt) / 1000);
            timeLeft = Math.max(0, progress.timeLimit * 60 - elapsedTime);
            startTime = progress.startedAt;
            console.log('‚è±Ô∏è Resumed test from saved progress. Time left:', timeLeft, 'seconds');
        } else {
            // Save test start time for resumption
            localStorage.setItem(`test-${testId}-progress`, JSON.stringify({
                testId,
                startedAt: startTime,
                timeLimit: test.timeLimit || 15
            }));
            console.log('‚è±Ô∏è Started new test');
        }
        
        const timerElement = document.getElementById('timerDisplay');
        const timerContainer = document.getElementById('testTimer');
        
        if (timerElement && timerContainer) {
            timerContainer.style.display = 'block';
            
            const timerInterval = setInterval(() => {
                timeLeft--;
                const minutes = Math.floor(timeLeft / 60);
                // Save progress every second
                localStorage.setItem(`test-${testId}-progress`, JSON.stringify({
                    testId,
                    startedAt: startTime,
                    timeLimit: test.timeLimit || 15
                }));
                const seconds = timeLeft % 60;
                timerElement.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                
                // Change color when time is running out
                if (timeLeft <= 300 && timeLeft > 60) { // 5 minutes
                    timerContainer.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
                    timerElement.style.color = 'white';
                    timerElement.style.animation = 'none';
                }
                if (timeLeft <= 60) { // 1 minute
                    timerContainer.style.background = 'linear-gradient(135deg, #dc2626, #991b1b)';
                    timerElement.style.color = 'white';
                    timerElement.style.animation = 'pulse 1s ease-in-out infinite';
                }
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    console.log('‚è∞ Time is up!');
                    document.getElementById('testForm')?.dispatchEvent(new Event('submit'));
                }
            }, 1000);
            
            // Store interval ID for cleanup
            window._testTimerInterval = timerInterval;
        }
        
        let testHTML = `
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; gap: 1.5rem; font-size: 0.875rem; color: var(--text-muted); margin-bottom: 2rem; flex-wrap: wrap;">
                    ${test.timeLimit ? `<span>‚è±Ô∏è ${test.timeLimit} ${lang === 'uz' ? 'min' : '–º–∏–Ω'}</span>` : ''}
                    <span>üìù ${questions.length} ${lang === 'uz' ? 'savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                    <span>üéØ ${test.maxScore} ${lang === 'uz' ? 'ball' : '–±–∞–ª–ª–æ–≤'}</span>
                </div>
                
                <form id="testForm" style="display: grid; gap: 2rem;">
        `;
        
        // Render each question
        shuffledQuestions.forEach((question, index) => {
            const questionText = lang === 'uz' ? question.questionUz : question.questionRu;
            const answers = question.answers || [];
            
            testHTML += `
                <div style="padding: 1.5rem; background: var(--bg-primary); border-radius: 10px; border: 2px solid var(--border-color);">
                    <h3 style="margin-top: 0; color: var(--text-primary); margin-bottom: 1rem;">
                        ${index + 1}. ${questionText}
                    </h3>
                    
                    <div style="display: grid; gap: 1rem;">
            `;
            
            // Render answer options (already shuffled)
            answers.forEach((answer, answerIndex) => {
                const answerText = lang === 'uz' ? answer.textUz : answer.textRu;
                const inputId = `q${index}_a${answerIndex}`;
                
                testHTML += `
                    <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" id="${inputId}" name="question_${index}" value="${answer.originalIndex}" data-question-idx="${index}" style="cursor: pointer; width: 18px; height: 18px;">
                        <span style="flex: 1; color: var(--text-primary);">${answerText}</span>
                    </label>
                `;
            });
            
            testHTML += `
                    </div>
                </div>
            `;
        });
        
        testHTML += `
                    <button type="submit" class="button button-primary" style="width: 100%; padding: 1rem; font-size: 1rem;">
                        ${lang === 'uz' ? 'Testni tugatish' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç'}
                    </button>
                </form>
            </div>
        `;
        
        testContainer.innerHTML = testHTML;
        
        // Add form submission handler
        document.getElementById('testForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Clear timer
            if (window._testTimerInterval) {
                clearInterval(window._testTimerInterval);
            }
            
            // Clear saved progress
            localStorage.removeItem(`test-${testId}-progress`);
            
            console.log('‚úÖ Test form submitted');
            
            // Collect answers - map to original question indices
            const answers = {};
            shuffledQuestions.forEach((question, index) => {
                const selected = document.querySelector(`input[name="question_${index}"]:checked`);
                if (selected) {
                    const answerIdx = parseInt(selected.value);
                    answers[index] = answerIdx;
                    console.log(`Q${index}: selected answer ${answerIdx}`);
                }
            });
            
            const timeTaken = Math.round((Date.now() - startTime) / 1000);
            console.log('üìä Collected answers object:', answers);
            console.log('‚è±Ô∏è Time taken:', timeTaken, 'seconds');
            
            // Convert answers object to array (server expects array indexed by question)
            const answersArray = shuffledQuestions.map((_, idx) => answers[idx] !== undefined ? answers[idx] : null);
            console.log('üìä Converted to array:', answersArray);
            console.log('üì§ Submitting to API...');
            
            // Submit to backend
            const submitResult = await apiRequest(`/api/tests/${testId}/submit`, {
                method: 'POST',
                body: JSON.stringify({ answers: answersArray, timeTaken })
            });
            
            console.log('üì• API Response:', submitResult);
            
            if (submitResult.success && submitResult.data) {
                const result = submitResult.data;
                console.log('üéØ Test result received:', result);
                console.log('üîç Result keys:', Object.keys(result));
                console.log('üîç questionResults exists?', result.questionResults !== undefined);
                console.log('üîç questionResults:', result.questionResults);
                
                // Show detailed results
                renderTestResults(result);
            } else {
                console.error('‚ùå Submit failed:', submitResult);
                testContainer.innerHTML = `
                    <div class="card">
                        <p style="text-align: center; color: #ef4444;">
                            ${lang === 'uz' ? 'Natijani saqlashda xato' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞'}
                        </p>
                        <p style="text-align: center; color: #ef4444; font-size: 0.9rem;">
                            ${submitResult.error || (lang === 'uz' ? 'Kutilmagan xato' : '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞')}
                        </p>
                    </div>
                `;
            }
        });
    } else {
        console.error('‚ùå Failed to load test:', testResult);
        testContainer.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: var(--text-muted);">
                    ${lang === 'uz' ? 'Test topilmadi' : '–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
                </p>
                <p style="text-align: center; color: #ef4444; font-size: 0.9rem;">
                    ${testResult.error || 'API Error'}
                </p>
            </div>
        `;
    }
}

function shuffleQuestions(questions) {
    // Shuffle answers using Fisher-Yates algorithm for true randomness
    // Keep track of original indices for correct answer validation
    return questions.map(question => {
        const answers = question.answers.map((answer, originalIndex) => ({
            ...answer,
            originalIndex // Save original index before shuffling
        }));
        
        // Fisher-Yates shuffle
        for (let i = answers.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [answers[i], answers[j]] = [answers[j], answers[i]];
        }
        
        return {
            ...question,
            answers
        };
    });
}

function renderTestResults(result) {
    const lang = store.getState().language;
    const testContainer = document.getElementById('testContainer');
    
    console.log('üé® renderTestResults called with:', result);
    
    if (!result || !result.questionResults) {
        console.error('‚ùå Missing result data:', result);
        testContainer.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: #ef4444;">
                    ${lang === 'uz' ? 'Natijada xato' : '–û—à–∏–±–∫–∞ –≤ –¥–∞–Ω–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞'}
                </p>
                <p style="text-align: center; color: #ef4444; font-size: 0.9rem;">
                    questionResults is missing
                </p>
            </div>
        `;
        return;
    }
    
    const percentage = Math.round((result.correctCount / result.totalCount) * 100);
    const status = percentage >= 70 ? 'success' : percentage >= 50 ? 'warning' : 'error';
    const statusColor = status === 'success' ? '#10b981' : status === 'warning' ? '#f59e0b' : '#ef4444';
    const statusGradient = status === 'success' ? 'linear-gradient(135deg, #10b981, #059669)' : status === 'warning' ? 'linear-gradient(135deg, #f59e0b, #d97706)' : 'linear-gradient(135deg, #ef4444, #dc2626)';
    
    let resultHTML = `
        <style>
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }
            .result-card { animation: slideIn 0.6s ease-out; }
            .score-circle { animation: pulse 0.8s ease-in-out infinite; }
        </style>
        
        <div class="result-card" style="text-align: center; padding: 3rem 2rem; margin-bottom: 2rem; background: ${statusGradient}; border-radius: 16px; color: white; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <h2 style="margin-top: 0; font-size: 2rem; text-transform: uppercase; letter-spacing: 1px;">
                ${status === 'success' ? 'üéâ ' : status === 'warning' ? 'üëç ' : 'üí™ '}
                ${lang === 'uz' ? 'Test tugatildi!' : '–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à—ë–Ω!'}
            </h2>
            <div class="score-circle" style="font-size: 4.5rem; font-weight: 900; margin: 2rem 0; text-shadow: 0 4px 8px rgba(0,0,0,0.2);">
                ${result.correctCount}/${result.totalCount}
            </div>
            <p style="font-size: 1.8rem; font-weight: 700; margin: 1rem 0; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
                ${percentage}%
            </p>
            <div style="display: flex; gap: 2rem; justify-content: center; margin-top: 2rem; flex-wrap: wrap;">
                <div style="background: rgba(255,255,255,0.2); padding: 1rem 2rem; border-radius: 12px; backdrop-filter: blur(10px);">
                    <div style="font-size: 0.9rem; opacity: 0.9;">‚è±Ô∏è ${lang === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">
                        ${Math.floor(result.timeTaken / 60)}:${String(result.timeTaken % 60).padStart(2, '0')}
                    </div>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 1rem 2rem; border-radius: 12px; backdrop-filter: blur(10px);">
                    <div style="font-size: 0.9rem; opacity: 0.9;">üìä ${lang === 'uz' ? 'Baho' : '–û—Ü–µ–Ω–∫–∞'}</div>
                    <div style="font-size: 1.5rem; font-weight: bold;">
                        ${status === 'success' ? '‚≠ê‚≠ê‚≠ê' : status === 'warning' ? '‚≠ê‚≠ê' : '‚≠ê'}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h3 style="margin-top: 0; color: var(--text-primary); display: flex; align-items: center; gap: 0.5rem;">
                üìã ${lang === 'uz' ? 'Batafsil natija' : '–ü–æ–¥—Ä–æ–±–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}
            </h3>
            <div style="display: grid; gap: 1.2rem;">
    `;
    
    // Show each question result
    result.questionResults.forEach((qr, index) => {
        const isCorrect = qr.isCorrect;
        const bgColor = isCorrect ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)';
        const borderColor = isCorrect ? '#10b981' : '#ef4444';
        const icon = isCorrect ? '‚úì' : '‚úó';
        
        resultHTML += `
            <div style="padding: 1.5rem; background: ${bgColor}; border-left: 4px solid ${borderColor}; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                    <span style="font-size: 1.5rem; color: ${borderColor}; font-weight: bold;">${icon}</span>
                    <div style="flex: 1;">
                        <p style="margin: 0; color: var(--text-primary); font-weight: 500;">
                            ${index + 1}. ${lang === 'uz' ? qr.questionUz : qr.questionRu}
                        </p>
                    </div>
                </div>
                
                <div style="margin-left: 2.5rem; color: var(--text-muted); font-size: 0.9rem;">
                    <p style="margin: 0.5rem 0;">
                        <strong>${lang === 'uz' ? 'Sizning javobingiz' : '–í–∞—à –æ—Ç–≤–µ—Ç'}:</strong> 
                        <span style="color: ${borderColor};">
                            ${qr.userAnswerText ? (lang === 'uz' ? qr.userAnswerText.textUz : qr.userAnswerText.textRu) : (lang === 'uz' ? 'Javob yo\'q' : '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞')}
                        </span>
                    </p>
                    ${!isCorrect ? `<p style="margin: 0.5rem 0;">
                        <strong>${lang === 'uz' ? 'To\'g\'ri javob' : '–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç'}:</strong> 
                        <span style="color: #10b981;">
                            ${lang === 'uz' ? qr.correctAnswerText.textUz : qr.correctAnswerText.textRu}
                        </span>
                    </p>` : ''}
                </div>
            </div>
        `;
    });
    
    resultHTML += `
            </div>
        </div>
        
        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
            <button class="button button-primary" id="btnBackFromResults" style="flex: 1;">
                ${lang === 'uz' ? 'Modulga qaytish' : '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–¥—É–ª—é'}
            </button>
        </div>
    `;
    
    testContainer.innerHTML = resultHTML;
    
    document.getElementById('btnBackFromResults')?.addEventListener('click', () => {
        // Navigate back to subject modules with subjectId from result
        if (result.subjectId) {
            router.navigate(`/student/subject-modules/${result.subjectId}`);
        } else {
            // Fallback to subjects list if no subjectId
            router.navigate('/student/subjects');
        }
    });
}

async function renderTestResultsPage() {
    const resultId = window.location.pathname.split('/').pop();
    const lang = store.getState().language;
    
    const content = `
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>${lang === 'uz' ? 'Test natijalari' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞'}</h1>
                <button class="button button-secondary" id="btnBackToHistory">
                    ${lang === 'uz' ? '‚Üê Orqaga' : '‚Üê –ù–∞–∑–∞–¥'}
                </button>
            </div>
        </div>
        
        <div id="resultContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    document.getElementById('btnBackToHistory')?.addEventListener('click', () => {
        router.navigate('/student/test-history');
    });
    
    const resultContainer = document.getElementById('resultContainer');
    const result = await apiRequest(`/api/test-results/${resultId}`);
    
    if (result.success && result.data) {
        const data = result.data;
        renderTestResults(data);
    } else {
        resultContainer.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: #ef4444;">
                    ${lang === 'uz' ? 'Natija topilmadi' : '–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω'}
                </p>
            </div>
        `;
    }
}

async function renderTestHistoryPage() {
    const lang = store.getState().language;
    
    const content = `
        <div class="page-header">
            <div class="page-header-title">
                <h1>${lang === 'uz' ? 'Testlar tarixi' : '–ò—Å—Ç–æ—Ä–∏—è —Ç–µ—Å—Ç–æ–≤'}</h1>
                <p class="page-header-subtitle">${lang === 'uz' ? "Barcha tugatilgan testlarning ro'yxati" : '–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–æ–π–¥–µ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤'}</p>
            </div>
            <div class="page-header-actions">
                <button class="back-button back-button--compact" id="btnBackFromHistory">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                </button>
            </div>
        </div>
        
        <div id="historyContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    document.getElementById('btnBackFromHistory')?.addEventListener('click', () => {
        router.navigate('/student/dashboard');
    });
    
    const historyContainer = document.getElementById('historyContainer');
    const results = await apiRequest('/api/test-results');
    
    if (results.success && results.data && results.data.length > 0) {
        const data = results.data;
        
        let historyHTML = `<div style="display: grid; gap: 1rem;">`;
        
        data.forEach((result, index) => {
            const date = new Date(result.completedAt);
            const dateStr = date.toLocaleDateString(lang === 'uz' ? 'uz' : 'ru');
            const timeStr = date.toLocaleTimeString(lang === 'uz' ? 'uz' : 'ru');
            const percentage = Math.round((result.correctCount / result.totalCount) * 100);
            const statusColor = percentage >= 70 ? '#10b981' : percentage >= 50 ? '#f59e0b' : '#ef4444';
            
            historyHTML += `
                <div class="card" style="display: flex; justify-content: space-between; align-items: center; padding: 1.5rem;">
                    <div>
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--text-primary);">
                            ${result.testName}
                        </h3>
                        <p style="margin: 0.25rem 0; color: var(--text-muted); font-size: 0.9rem;">
                            üìÖ ${dateStr} ${timeStr}
                        </p>
                        <p style="margin: 0.25rem 0; color: var(--text-muted); font-size: 0.9rem;">
                            ‚è±Ô∏è ${lang === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}: ${Math.floor(result.timeTaken / 60)} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω'}
                        </p>
                    </div>
                    <div style="text-align: right; display: flex; gap: 2rem; align-items: center;">
                        <div>
                            <div style="font-size: 1.5rem; font-weight: bold; color: ${statusColor};">
                                ${result.correctCount}/${result.totalCount}
                            </div>
                            <div style="font-size: 0.9rem; color: ${statusColor}; font-weight: 600;">
                                ${percentage}%
                            </div>
                        </div>
                        <button class="button button-secondary view-details-btn" data-result-id="${result._id}" data-index="${index}">
                            ${lang === 'uz' ? 'Batafsil' : '–ü–æ–¥—Ä–æ–±–Ω–æ'}
                        </button>
                    </div>
                </div>
            `;
        });
        
        historyHTML += `</div>`;
        historyContainer.innerHTML = historyHTML;
        
        // Add event listeners to all detail buttons
        document.querySelectorAll('.view-details-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const resultId = this.getAttribute('data-result-id');
                console.log('üìä Viewing result details:', resultId);
                router.navigate(`/student/test-results/${resultId}`);
            });
        });
    } else {
        historyContainer.innerHTML = `
            <div class="card" style="text-align: center; padding: 3rem;">
                <p style="color: var(--text-muted); font-size: 1.1rem;">
                    ${lang === 'uz' ? 'Hali testlar topilmadi' : '–¢–µ—Å—Ç—ã –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}
                </p>
                <button class="button button-primary" id="btnStartTest" style="margin-top: 1rem;">
                    ${lang === 'uz' ? 'Testni boshlash' : '–ü—Ä–æ–π—Ç–∏ —Ç–µ—Å—Ç'}
                </button>
            </div>
        `;
        
        document.getElementById('btnStartTest')?.addEventListener('click', () => {
            router.navigate('/student/subjects');
        });
    }
}

// ===========================================
// ADMIN PANEL
// ===========================================

async function renderAdminDashboard() {
    const state = store.getState();
    const lang = state.language;
    
    // Check authentication
    if (!state.isAuthenticated || !state.user || state.user.role !== 'admin') {
        console.log('‚ùå Unauthorized access to admin dashboard');
        router.navigate('/login');
        return;
    }
    
    try {
        const content = `
        <style>
            @media (max-width: 768px) {
                #adminHeader { flex-direction: column; align-items: flex-start; gap: 1rem; }
                #adminHeader h1 { font-size: 1.75rem; }
                .admin-actions { grid-template-columns: 1fr !important; gap: 1rem !important; }
            }
            @media (max-width: 480px) {
                #adminHeader { padding: 0; }
                #adminHeader h1 { font-size: 1.4rem; margin-bottom: 0.25rem; }
                #adminHeader p { font-size: 0.75rem; }
                .admin-actions { grid-template-columns: 1fr !important; }
            }
        </style>
        <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
            <div style="max-width: 1400px; margin: 0 auto;">
                <!-- Header -->
                <div id="adminHeader" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2.5rem;">
                    <div>
                        <h1 style="margin: 0; font-size: 2.25rem; font-weight: 700; color: var(--text-primary);">${t('adminPanel')}</h1>
                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">${t('adminManagement')}</p>
                    </div>
                </div>

                <!-- Action Cards -->
                <div class="admin-actions" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(290px, 1fr)); gap: 1.5rem; margin-bottom: 2.5rem;">
                    <!-- Analytics -->
                    <div onclick="window.router.navigate('/admin/analytics')" style="cursor: pointer; background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.02) 100%); border: 2px solid #3B82F6; border-radius: 16px; padding: 1.75rem; transition: all 0.3s; display: flex; gap: 1rem; align-items: flex-start;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(59, 130, 246, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #3B82F6 0%, #2563EB 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);"><i class="fas fa-chart-bar"></i></div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.4rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${t('analytics')}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${t('analyticsDesc')}</p>
                        </div>
                        <div style="color: #3B82F6; font-size: 1.5rem; font-weight: 600; flex-shrink: 0;"><i class="fas fa-arrow-right"></i></div>
                    </div>

                    <!-- Classes -->
                    <div onclick="window.router.navigate('/admin/classes')" style="cursor: pointer; background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.02) 100%); border: 2px solid #10b981; border-radius: 16px; padding: 1.75rem; transition: all 0.3s; display: flex; gap: 1rem; align-items: flex-start;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(16, 185, 129, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(16, 185, 129, 0.3);"><i class="fas fa-school"></i></div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.4rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${t('classes')}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${t('classesManagement')}</p>
                        </div>
                        <div style="color: #10b981; font-size: 1.5rem; font-weight: 600; flex-shrink: 0;"><i class="fas fa-arrow-right"></i></div>
                    </div>

                    <!-- Teacher Tests -->
                    <div onclick="window.router.navigate('/admin/teacher-tests')" style="cursor: pointer; background: linear-gradient(135deg, rgba(245, 158, 11, 0.08) 0%, rgba(245, 158, 11, 0.02) 100%); border: 2px solid #f59e0b; border-radius: 16px; padding: 1.75rem; transition: all 0.3s; display: flex; gap: 1rem; align-items: flex-start;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(245, 158, 11, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(245, 158, 11, 0.3);"><i class="fas fa-clipboard-list"></i></div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.4rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${t('teacherTests')}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${t('teacherTestsDesc')}</p>
                        </div>
                        <div style="color: #f59e0b; font-size: 1.5rem; font-weight: 600; flex-shrink: 0;"><i class="fas fa-arrow-right"></i></div>
                    </div>

                    <!-- Subjects Management -->
                    <div onclick="window.router.navigate('/admin/subjects')" style="cursor: pointer; background: linear-gradient(135deg, rgba(124, 58, 237, 0.08) 0%, rgba(124, 58, 237, 0.02) 100%); border: 2px solid #7c3aed; border-radius: 16px; padding: 1.75rem; transition: all 0.3s; display: flex; gap: 1rem; align-items: flex-start;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(124, 58, 237, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(124, 58, 237, 0.3);"><i class="fas fa-book"></i></div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.4rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${t('subjectsManagement')}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${t('subjectsManagementDesc')}</p>
                        </div>
                        <div style="color: #7c3aed; font-size: 1.5rem; font-weight: 600; flex-shrink: 0;"><i class="fas fa-arrow-right"></i></div>
                    </div>

                    <!-- Add User -->
                    <div onclick="showAddUserModal()" style="cursor: pointer; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08) 0%, rgba(34, 197, 94, 0.02) 100%); border: 2px solid #22c55e; border-radius: 16px; padding: 1.75rem; transition: all 0.3s; display: flex; gap: 1rem; align-items: flex-start;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(34, 197, 94, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(34, 197, 94, 0.3);"><i class="fas fa-user-plus"></i></div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.4rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${t('newUser')}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${t('newUserDesc')}</p>
                        </div>
                        <div style="color: #22c55e; font-size: 1.5rem; font-weight: 600; flex-shrink: 0;"><i class="fas fa-arrow-right"></i></div>
                    </div>

                    <!-- Passwords -->
                    <div onclick="window.router.navigate('/admin/passwords')" style="cursor: pointer; background: linear-gradient(135deg, rgba(239, 68, 68, 0.08) 0%, rgba(239, 68, 68, 0.02) 100%); border: 2px solid #ef4444; border-radius: 16px; padding: 1.75rem; transition: all 0.3s; display: flex; gap: 1rem; align-items: flex-start;" onmouseover="this.style.transform='translateY(-6px)'; this.style.boxShadow='0 16px 32px rgba(239, 68, 68, 0.2)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                        <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0; box-shadow: 0 8px 16px rgba(239, 68, 68, 0.3);"><i class="fas fa-key"></i></div>
                        <div style="flex: 1;">
                            <h3 style="margin: 0 0 0.4rem 0; font-size: 1.1rem; font-weight: 700; color: var(--text-primary);">${t('passwords')}</h3>
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4;">${t('passwordsManagement')}</p>
                        </div>
                        <div style="color: #ef4444; font-size: 1.5rem; font-weight: 600; flex-shrink: 0;"><i class="fas fa-arrow-right"></i></div>
                    </div>
                </div>
                
                <!-- Tabs for Users -->
                <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                    <div class="admin-tabs" style="display: flex; border-bottom: 2px solid var(--border-color); background: var(--bg-tertiary);">
                        <button class="admin-tab active" data-tab="students" style="flex: 1; padding: 1rem; background: transparent; border: none; color: var(--text-primary); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid #3B82F6; margin-bottom: -2px;">
                            ${t('students')}
                        </button>
                        <button class="admin-tab" data-tab="teachers" style="flex: 1; padding: 1rem; background: transparent; border: none; color: var(--text-secondary); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.3s; border-bottom: 3px solid transparent; margin-bottom: -2px;">
                            ${t('teachers')}
                        </button>
                    </div>
                    
                    <!-- Students Tab Content -->
                    <div class="admin-tab-content" data-content="students" style="padding: 1.5rem;">
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">${t('classFilter')}</label>
                            <select id="adminClassFilter">
                                <option value="">${t('allClasses')}</option>
                            </select>
                        </div>
                        <div id="studentsList" style="color: var(--text-secondary); text-align: center; padding: 2rem;">${t('loading')}</div>
                    </div>

                    <!-- Teachers Tab Content -->
                    <div class="admin-tab-content" data-content="teachers" style="padding: 1.5rem; display: none;">
                        <div id="teachersList" style="color: var(--text-secondary); text-align: center; padding: 2rem;">${t('loading')}</div>
                    </div>
        `;

        renderLayout(content, 'admin');
        await loadAdminDashboardData();
        setupAdminTabs();
        setupAdminFilters();
        renderLanguageSwitch(); // Ensure language switch is properly initialized
    } catch (error) {
        console.error('Error loading admin dashboard:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø–∞–Ω–µ–ª–∏', 'error');
    }
}

// ====== SUBJECTS MANAGEMENT ======
async function renderAdminSubjects() {
    const state = store.getState();
    const lang = state.language;

    if (!state.isAuthenticated || !state.user || state.user.role !== 'admin') {
        console.log('‚ùå Unauthorized access to subjects');
        router.navigate('/login');
        return;
    }

    try {
        const response = await apiRequest('/api/subjects');
        const subjects = response.success ? response.data : [];

        const content = `
            <style>
                .subjects-hero {
                    background: linear-gradient(135deg, rgba(124, 58, 237, 0.18) 0%, rgba(59, 130, 246, 0.12) 100%);
                    border: 1px solid rgba(124, 58, 237, 0.25);
                    border-radius: 18px;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 1rem;
                    flex-wrap: wrap;
                }
                .subjects-hero__title {
                    margin: 0;
                    font-size: 2.1rem;
                    font-weight: 800;
                    color: var(--text-primary);
                }
                .subjects-hero__desc {
                    margin: 0.5rem 0 0 0;
                    color: var(--text-secondary);
                    font-size: 0.95rem;
                }
                .subjects-hero__meta {
                    display: flex;
                    gap: 0.75rem;
                    flex-wrap: wrap;
                    align-items: center;
                }
                .subjects-pill {
                    padding: 0.45rem 0.9rem;
                    border-radius: 999px;
                    background: rgba(124, 58, 237, 0.16);
                    color: #c4b5fd;
                    border: 1px solid rgba(124, 58, 237, 0.4);
                    font-weight: 600;
                    font-size: 0.8rem;
                }
                .subjects-panel {
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 1.25rem;
                    display: grid;
                    gap: 1rem;
                }
                .subjects-toolbar {
                    display: grid;
                    grid-template-columns: 1fr auto;
                    gap: 1rem;
                    align-items: center;
                }
                .subjects-search {
                    display: flex;
                    align-items: center;
                    gap: 0.6rem;
                    padding: 0.65rem 0.9rem;
                    background: var(--bg-tertiary);
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                }
                .subjects-search input {
                    background: transparent;
                    border: none;
                    outline: none;
                    color: var(--text-primary);
                    width: 100%;
                    font-size: 0.95rem;
                }
                .subjects-grid {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                    gap: 1rem;
                }
                .subjects-card {
                    background: var(--bg-primary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 1rem;
                    display: grid;
                    gap: 0.75rem;
                    transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
                }
                .subjects-card:hover {
                    transform: translateY(-4px);
                    border-color: rgba(124, 58, 237, 0.6);
                    box-shadow: 0 16px 32px rgba(15, 23, 42, 0.15);
                }
                .subjects-card__header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 0.75rem;
                }
                .subjects-card__title {
                    font-size: 1.05rem;
                    font-weight: 700;
                    color: var(--text-primary);
                }
                .subjects-card__subtitle {
                    font-size: 0.85rem;
                    color: var(--text-secondary);
                }
                .subjects-badge {
                    padding: 0.3rem 0.7rem;
                    border-radius: 10px;
                    background: rgba(59, 130, 246, 0.16);
                    color: #93c5fd;
                    font-size: 0.75rem;
                    font-weight: 600;
                }
                .subjects-card__actions {
                    display: flex;
                    gap: 0.5rem;
                    flex-wrap: wrap;
                }
                @media (max-width: 768px) {
                    .subjects-hero { padding: 1.25rem; }
                    .subjects-hero__title { font-size: 1.75rem; }
                    .subjects-toolbar { grid-template-columns: 1fr; }
                }
                @media (max-width: 420px) {
                    .subjects-hero { padding: 1rem; border-radius: 14px; }
                    .subjects-hero__title { font-size: 1.5rem; }
                    .subjects-hero__desc { font-size: 0.85rem; }
                    .subjects-panel { padding: 1rem; }
                    .subjects-grid { grid-template-columns: 1fr; }
                    .subjects-card { padding: 0.85rem; }
                    .subjects-card__actions button { width: 100%; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1100px; margin: 0 auto; display: grid; gap: 1.5rem;">
                    <div class="subjects-hero">
                        <div>
                            <h1 class="subjects-hero__title">${t('subjectsManagement')}</h1>
                            <p class="subjects-hero__desc">${t('subjectsManagementDesc')}</p>
                        </div>
                        <div class="subjects-hero__meta">
                            <button id="btnSubjectsBack" class="btn-secondary" style="padding: 0.7rem 1.2rem; font-size: 0.9rem; white-space: nowrap; border: 1px solid var(--border-color);">‚Üê ${t('back')}</button>
                            <span class="subjects-pill">${subjects.length} ${lang === 'uz' ? 'fan' : '–ø—Ä–µ–¥–º–µ—Ç–æ–≤'}</span>
                            <button id="btnAddSubject" class="btn-primary" style="padding: 0.75rem 1.5rem; font-size: 0.9rem; white-space: nowrap;">+ ${t('addSubject')}</button>
                        </div>
                    </div>

                    <div class="subjects-panel">
                        <div class="subjects-toolbar">
                            <div class="subjects-search">
                                <i class="fas fa-search" style="color: var(--text-muted);"></i>
                                <input id="subjectsSearch" type="text" placeholder="${lang === 'uz' ? 'Fanlarni qidiring...' : '–ù–∞–π—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç...'}">
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="fas fa-filter"></i>
                                <span>${lang === 'uz' ? 'Qidiruv bo\'yicha filtr' : '–§–∏–ª—å—Ç—Ä –ø–æ –ø–æ–∏—Å–∫—É'}</span>
                            </div>
                        </div>

                        ${subjects.length === 0 ? `
                            <div style="background: var(--bg-tertiary); border: 1px dashed var(--border-color); border-radius: 12px; padding: 2.5rem; text-align: center; color: var(--text-secondary);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìö</div>
                                <div style="font-weight: 600; margin-bottom: 0.35rem;">${t('noSubjects')}</div>
                                <div style="font-size: 0.9rem;">${lang === 'uz' ? 'Yangi fanni qo\'shing' : '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç'}</div>
                            </div>
                        ` : `
                            <div id="subjectsGrid" class="subjects-grid">
                                ${subjects.map(subject => {
                                    const id = subject._id || subject.id || '';
                                    return `
                                        <div class="subjects-card" data-name-ru="${(subject.nameRu || '').toLowerCase()}" data-name-uz="${(subject.nameUz || '').toLowerCase()}">
                                            <div class="subjects-card__header">
                                                <div>
                                                    <div class="subjects-card__title">${subject.nameRu || '‚Äî'}</div>
                                                    <div class="subjects-card__subtitle">${subject.nameUz || '‚Äî'}</div>
                                                </div>
                                                <span class="subjects-badge">${lang === 'uz' ? 'Fan' : 'Subject'}</span>
                                            </div>
                                            <div class="subjects-card__actions">
                                                <button class="subject-edit-btn" data-id="${id}" style="padding: 0.5rem 0.9rem; font-size: 0.82rem; background: transparent; border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-weight: 600;">${t('edit')}</button>
                                                <button class="subject-delete-btn" data-id="${id}" style="padding: 0.5rem 0.9rem; font-size: 0.82rem; background: transparent; border: 1px solid #ef4444; border-radius: 8px; color: #ef4444; cursor: pointer; font-weight: 600;">${t('delete')}</button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;

        renderLayout(content, 'admin');

        const subjectMap = new Map(subjects.map(s => [s._id || s.id, s]));

        document.getElementById('btnAddSubject')?.addEventListener('click', () => showAddSubjectModal());
        document.getElementById('btnSubjectsBack')?.addEventListener('click', () => {
            router.navigate('/admin/dashboard');
        });

        const searchInput = document.getElementById('subjectsSearch');
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                const value = e.target.value.trim().toLowerCase();
                document.querySelectorAll('#subjectsGrid .subjects-card').forEach(card => {
                    const ru = card.getAttribute('data-name-ru') || '';
                    const uz = card.getAttribute('data-name-uz') || '';
                    const match = ru.includes(value) || uz.includes(value);
                    card.style.display = match ? 'grid' : 'none';
                });
            });
        }

        document.querySelectorAll('.subject-edit-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                const subject = subjectMap.get(id);
                if (subject) showEditSubjectModal(subject);
            });
        });

        document.querySelectorAll('.subject-delete-btn').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.getAttribute('data-id');
                const confirmed = await showConfirm(
                    lang === 'uz' ? 'Fanni o\'chirishni xohlaysizmi?' : '–£–¥–∞–ª–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç?',
                    lang === 'uz' ? 'Tasdiqlash' : '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ'
                );
                if (!confirmed) return;
                await deleteSubject(id);
            });
        });
    } catch (error) {
        console.error('Error loading subjects:', error);
        showAlert(lang === 'uz' ? 'Fanlarni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤', 'error');
        router.navigate('/admin/dashboard');
    }
}

function showAddSubjectModal() {
    const lang = store.getState().language;
    const modal = document.createElement('div');
    modal.className = 'modal modal--centered';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 520px;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.4rem;">${t('addSubject')}</h2>
            <p style="margin: 0 0 1.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">${t('subjectsManagementDesc')}</p>
            <form id="subjectForm" style="display: grid; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem;">${t('subjectNameRu')}</label>
                    <input id="subjectNameRu" type="text" placeholder="${lang === 'uz' ? 'Masalan: Matematika' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem;">${t('subjectNameUz')}</label>
                    <input id="subjectNameUz" type="text" placeholder="${lang === 'uz' ? 'Masalan: Matematika' : '–ù–∞–ø—Ä–∏–º–µ—Ä: Matematika'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <button type="button" id="closeSubjectModal" class="button button-secondary" style="flex: 1;">${t('cancel')}</button>
                    <button type="submit" class="button button-primary" style="flex: 1; background: #7c3aed;">${t('save')}</button>
                </div>
            </form>
        </div>
    `;

    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });

    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);

    document.getElementById('closeSubjectModal')?.addEventListener('click', () => modal.remove());
    document.getElementById('subjectForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nameRu = document.getElementById('subjectNameRu').value.trim();
        const nameUz = document.getElementById('subjectNameUz').value.trim();
        if (!nameRu || !nameUz) {
            showAlert(lang === 'uz' ? 'Barcha maydonlarni to\'ldiring' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'warning');
            return;
        }

        const payload = { nameRu, nameUz };

        const result = await apiRequest('/api/subjects', 'POST', payload);
        if (result.success) {
            showAlert(lang === 'uz' ? 'Fan qo\'shildi' : '–ü—Ä–µ–¥–º–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
            modal.remove();
            renderAdminSubjects();
        } else {
            showAlert(result.error || (lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'), 'error');
        }
    });
}

function showEditSubjectModal(subject) {
    const lang = store.getState().language;
    const modal = document.createElement('div');
    modal.className = 'modal modal--centered';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 520px;">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.4rem;">${t('editSubject')}</h2>
            <p style="margin: 0 0 1.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">${t('subjectsManagementDesc')}</p>
            <form id="subjectEditForm" style="display: grid; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem;">${t('subjectNameRu')}</label>
                    <input id="subjectEditNameRu" type="text" value="${subject.nameRu || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem;">${t('subjectNameUz')}</label>
                    <input id="subjectEditNameUz" type="text" value="${subject.nameUz || ''}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                    <button type="button" id="closeSubjectEditModal" class="button button-secondary" style="flex: 1;">${t('cancel')}</button>
                    <button type="submit" class="button button-primary" style="flex: 1; background: #7c3aed;">${t('save')}</button>
                </div>
            </form>
        </div>
    `;

    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });

    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);

    document.getElementById('closeSubjectEditModal')?.addEventListener('click', () => modal.remove());
    document.getElementById('subjectEditForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const nameRu = document.getElementById('subjectEditNameRu').value.trim();
        const nameUz = document.getElementById('subjectEditNameUz').value.trim();
        if (!nameRu || !nameUz) {
            showAlert(lang === 'uz' ? 'Barcha maydonlarni to\'ldiring' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'warning');
            return;
        }

        const payload = { nameRu, nameUz };

        const subjectId = subject._id || subject.id;
        const result = await apiRequest(`/api/subjects/${subjectId}`, 'PUT', payload);
        if (result.success) {
            showAlert(lang === 'uz' ? 'Fan yangilandi' : '–ü—Ä–µ–¥–º–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            modal.remove();
            renderAdminSubjects();
        } else {
            showAlert(result.error || (lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'), 'error');
        }
    });
}

async function deleteSubject(subjectId) {
    const lang = store.getState().language;
    const response = await apiRequest(`/api/subjects/${subjectId}`, 'DELETE');
    if (response.success) {
        showAlert(lang === 'uz' ? 'Fan o\'chirildi' : '–ü—Ä–µ–¥–º–µ—Ç —É–¥–∞–ª–µ–Ω', 'success');
        renderAdminSubjects();
    } else {
        showAlert(response.error || (lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'), 'error');
    }
}

async function loadAdminDashboardData() {
    try {
        const [usersRes, classesRes, testsRes] = await Promise.all([
            apiRequest('/api/users'),
            apiRequest('/api/classes'),
            apiRequest('/api/tests')
        ]);
        
        if (!usersRes.success || !classesRes.success || !testsRes.success) {
            console.error('Failed to load admin data');
            const errorMessage = usersRes.error || classesRes.error || testsRes.error || (store.getState().language === 'uz' ? 'Ma\'lumotlarni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
            const studentsList = document.getElementById('studentsList');
            const teachersList = document.getElementById('teachersList');
            if (studentsList) studentsList.textContent = errorMessage;
            if (teachersList) teachersList.textContent = errorMessage;
            return;
        }
        
        const users = usersRes.data || [];
        const classes = classesRes.data || [];
        const tests = testsRes.data || [];
        
        const students = users.filter(u => u.role === 'student');
        const teachers = users.filter(u => u.role === 'teacher');
        
        // Update metrics with animation
        animateCounter('totalStudents', students.length);
        animateCounter('totalTeachers', teachers.length);
        animateCounter('totalTests', tests.length);
        animateCounter('totalClasses', classes.length);
        
        // Populate class filter
        const classFilter = document.getElementById('adminClassFilter');
        if (classFilter) {
            classes.forEach(cls => {
                const option = document.createElement('option');
                const classLabel = cls.name
                    ? `${cls.grade || ''}${cls.name}`
                    : (cls.sections?.length ? `${cls.grade || ''} (${cls.sections.join(', ')})` : (cls.grade || '‚Äî'));
                option.value = cls.grade || '';
                option.textContent = classLabel;
                classFilter.appendChild(option);
            });
        }
        
        // Store data for filtering
        window.adminData = { students, teachers, classes };
        
        // Render lists
        renderAdminStudentList(students, classes);
        renderAdminTeacherList(teachers);
    } catch (error) {
        console.error('Error loading admin data:', error);
    }
}

function setupAdminTabs() {
    const tabs = document.querySelectorAll('.admin-tab');
    const contents = document.querySelectorAll('.admin-tab-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const targetTab = tab.getAttribute('data-tab');
            
            // Update tab styles
            tabs.forEach(t => {
                t.classList.remove('active');
                t.style.color = 'var(--text-secondary)';
                t.style.borderBottomColor = 'transparent';
                t.style.background = 'transparent';
            });
            tab.classList.add('active');
            tab.style.color = 'var(--text-primary)';
            tab.style.borderBottomColor = '#3B82F6';
            tab.style.background = 'var(--bg-tertiary)';
            
            // Update content visibility
            contents.forEach(c => {
                if (c.getAttribute('data-content') === targetTab) {
                    c.style.display = 'block';
                } else {
                    c.style.display = 'none';
                }
            });
        });
    });
}

function animateCounter(elementId, target) {
    const element = document.getElementById(elementId);
    if (!element) return;
    
    let current = 0;
    const increment = target / 30;
    const timer = setInterval(() => {
        current += increment;
        if (current >= target) {
            element.textContent = target;
            clearInterval(timer);
        } else {
            element.textContent = Math.floor(current);
        }
    }, 30);
}

function renderAdminStudentList(students, classes) {
    const listContainer = document.getElementById('studentsList');
    if (!listContainer) return;
    
    if (students.length === 0) {
        listContainer.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">${t('noStudents')}</div>`;
        return;
    }
    
    let html = `<div style="display: grid; gap: 1rem;">`;
    students.forEach(student => {
        const classInfo = classes.find(c => c.id === student.classId || c._id === student.classId);
        const classLabel = (student.grade || student.gradeSection)
            ? `${student.grade || ''}${student.gradeSection || ''}`.trim()
            : (classInfo?.name
                ? `${classInfo.grade || ''}${classInfo.name}`
                : (classInfo?.sections?.length ? `${classInfo.grade || ''} (${classInfo.sections.join(', ')})` : '‚Äî'));
        html += `
            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.08) 0%, rgba(59, 130, 246, 0.02) 100%); border: 2px solid #3B82F6; border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.3s; display: flex; gap: 1rem; align-items: center;" 
                 onclick="window.router.navigate('/admin/student/${student.id || student._id}')"
                 onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(59, 130, 246, 0.15)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #3B82F6, #1e40af); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">
                    <i class="fas fa-user"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${student.name || student.firstName}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${student.username}</div>
                    <div style="font-size: 0.8rem; color: #3B82F6; margin-top: 0.25rem;">${classLabel || '‚Äî'}</div>
                </div>
            </div>
        `;
    });
    html += `</div>`;
    listContainer.innerHTML = html;
}

function renderAdminTeacherList(teachers) {
    const listContainer = document.getElementById('teachersList');
    if (!listContainer) return;
    
    if (teachers.length === 0) {
        listContainer.innerHTML = `<div style="text-align: center; color: var(--text-secondary); padding: 2rem;">${t('noTeachers')}</div>`;
        return;
    }
    
    let html = `<div style="display: grid; gap: 1rem;">`;
    teachers.forEach(teacher => {
        html += `
            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(16, 185, 129, 0.02) 100%); border: 2px solid #10b981; border-radius: 12px; padding: 1.25rem; cursor: pointer; transition: all 0.3s; display: flex; gap: 1rem; align-items: center;" 
                 onclick="window.router.navigate('/admin/teacher/${teacher.id || teacher._id}')"
                 onmouseover="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 12px 24px rgba(16, 185, 129, 0.15)'" 
                 onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.25rem; flex-shrink: 0;">
                    <i class="fas fa-chalkboard-user"></i>
                </div>
                <div style="flex: 1; min-width: 0;">
                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.95rem;">${teacher.name || teacher.firstName}</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">${teacher.username}</div>
                    <div style="font-size: 0.75rem; color: #10b981; margin-top: 0.25rem; font-weight: 500;">${t('teacher')}</div>
                </div>
            </div>
        `;
    });
    html += `</div>`;
    listContainer.innerHTML = html;
}

// Helper functions for admin modals
async function showAddUserModal() {
    const lang = store.getState().language;
    
    // Load subjects first
    let subjectsList = [];
    try {
        const response = await apiRequest('/api/subjects');
        if (response.success) {
            subjectsList = response.data || [];
        }
    } catch (error) {
        console.error('Error loading subjects:', error);
    }
    
    // Load teachers for student class teacher select
    let teachersList = [];
    try {
        const response = await apiRequest('/api/users');
        if (response.success) {
            teachersList = response.data.filter(u => u.role === 'teacher') || [];
        }
    } catch (error) {
        console.error('Error loading teachers:', error);
    }

    // No extra teacher-specific class data needed here
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 550px;">
            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(59, 130, 246, 0.15) 100%); border: 1px solid rgba(16, 185, 129, 0.35); color: var(--text-primary); padding: 1.25rem; border-radius: 14px; margin-bottom: 1.25rem;">
                <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.4rem;">${lang === 'uz' ? 'Admin paneli' : '–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å'}</div>
                <h2 style="margin: 0; font-size: 1.35rem; font-weight: 800;">${lang === 'uz' ? 'Foydalanuvchi qo\'shish' : '–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}</h2>
                <p style="margin: 0.4rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">${lang === 'uz' ? 'O\'quvchi yoki o\'qituvchi yaratish' : '–°–æ–∑–¥–∞–π—Ç–µ —É—á–µ–Ω–∏–∫–∞ –∏–ª–∏ —É—á–∏—Ç–µ–ª—è'}</p>
            </div>
            
            <form id="addUserForm" class="add-user-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <div id="addUserAlert" class="inline-alert" style="display: none;"></div>
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Rol' : '–†–æ–ª—å'}
                    </label>
                    <select id="userRole">
                        <option value="student">${lang === 'uz' ? 'O\'quvchi' : '–£—á–µ–Ω–∏–∫'}</option>
                        <option value="teacher">${lang === 'uz' ? 'O\'qituvchi' : '–£—á–∏—Ç–µ–ª—å'}</option>
                    </select>
                </div>
                
                <div class="add-user-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                            ${lang === 'uz' ? 'Ism' : '–ò–º—è'}
                        </label>
                        <input id="userFirstName" type="text" placeholder="${lang === 'uz' ? 'Ism' : '–ò–º—è'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                    </div>
                    <div>
                        <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                            ${lang === 'uz' ? 'Familiya' : '–§–∞–º–∏–ª–∏—è'}
                        </label>
                        <input id="userLastName" type="text" placeholder="${lang === 'uz' ? 'Familiya' : '–§–∞–º–∏–ª–∏—è'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                    </div>
                </div>
                
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Foydalanuvchi nomi' : '–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è'}
                    </label>
                    <input id="userUsername" type="text" placeholder="${lang === 'uz' ? 'username' : 'username'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                
                <div style="background: var(--bg-tertiary); border: 1px dashed var(--border-color); padding: 0.9rem; border-radius: 8px; font-size: 0.85rem; color: var(--text-secondary);">
                    ${lang === 'uz'
                        ? 'Parol bir martalik OTP orqali yaratiladi va foydalanuvchiga vaqtinchalik parol beriladi.'
                        : '–ü–∞—Ä–æ–ª—å —Å–æ–∑–¥–∞—ë—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π OTP, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –≤—ã–¥–∞—ë—Ç—Å—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å.'}
                </div>
                
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Maktab' : '–®–∫–æ–ª–∞'}
                    </label>
                    <input id="userSchool" type="text" placeholder="${lang === 'uz' ? 'Maktab nomi' : '–ù–∞–∑–≤–∞–Ω–∏–µ —à–∫–æ–ª—ã'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                </div>
                
                <!-- STUDENT FIELDS -->
                <div id="studentFields" style="display: none; border: 2px solid rgba(16, 185, 129, 0.3); padding: 1rem; border-radius: 8px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                                ${lang === 'uz' ? 'Sinf raqami' : '–ù–æ–º–µ—Ä –∫–ª–∞—Å—Å–∞'}
                            </label>
                            <input id="studentGrade" type="text" placeholder="${lang === 'uz' ? '9' : '9'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                                ${lang === 'uz' ? 'Sinf harfi' : '–ë—É–∫–≤–∞ –∫–ª–∞—Å—Å–∞'}
                            </label>
                            <input id="studentSection" type="text" placeholder="${lang === 'uz' ? '–ê' : '–ê'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" maxlength="1">
                        </div>
                    </div>
                    
                    <div style="margin-top: 1rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                            ${lang === 'uz' ? 'Sinf o\'qituvchisi' : '–ö–ª–∞—Å—Å–Ω–∞—è —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å–Ω–∏—Ü–∞'}
                        </label>
                        <select id="studentClassTeacher">
                            <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                            ${teachersList.map(t => `<option value="${t._id}">${t.firstName} ${t.lastName}</option>`).join('')}
                        </select>
                    </div>
                </div>
                
                <!-- TEACHER FIELDS -->
                <div id="teacherFields" class="teacher-fields" style="display: none; border: 2px solid rgba(139, 92, 246, 0.3); padding: 1rem; border-radius: 8px; overflow: auto;">
                    <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Predmetlar' : '–ü—Ä–µ–¥–º–µ—Ç—ã'}
                    </label>
                    <div class="teacher-subjects-list" style="display: flex; flex-direction: column; gap: 0.5rem; max-height: 200px; overflow-y: auto;">
                        ${subjectsList.map(subject => `
                            <label class="teacher-subject-item" style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; border-radius: 6px; transition: background 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.1)'" onmouseout="this.style.background='transparent'">
                                <input type="checkbox" class="teacherSubject" value="${subject._id}" data-name="${subject.nameRu}" style="width: 18px; height: 18px; cursor: pointer;">
                                <span style="flex: 1; font-size: 0.95rem;">${lang === 'uz' ? subject.nameUz : subject.nameRu}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="button button-secondary" id="closeAddUserBtn" style="flex: 1;">
                        ${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}
                    </button>
                    <button type="submit" class="button button-primary" style="flex: 1; background: #10b981;">
                        ‚úÖ ${lang === 'uz' ? 'Qo\'shish' : '–î–æ–±–∞–≤–∏—Ç—å'}
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
    
    // Handle role change
    const roleSelect = document.getElementById('userRole');
    const studentFields = document.getElementById('studentFields');
    const teacherFields = document.getElementById('teacherFields');
    const addUserAlert = document.getElementById('addUserAlert');

    const showAddUserAlert = (message, type = 'info') => {
        if (!addUserAlert) return;
        const icons = {
            success: '‚úÖ',
            error: '‚ùå',
            warning: '‚ö†Ô∏è',
            info: '‚ÑπÔ∏è'
        };
        addUserAlert.className = `inline-alert inline-alert--${type}`;
        addUserAlert.innerHTML = `
            <span style="font-size: 1.1rem;">${icons[type] || icons.info}</span>
            <span>${message}</span>
        `;
        addUserAlert.style.display = 'flex';
    };
    
    const updateFieldsVisibility = (role) => {
        const isStudent = role === 'student';
        studentFields.style.display = isStudent ? 'block' : 'none';
        teacherFields.style.display = !isStudent ? 'block' : 'none';
    };
    
    // Initialize fields visibility based on default role
    updateFieldsVisibility(roleSelect.value);
    
    roleSelect.addEventListener('change', (e) => {
        updateFieldsVisibility(e.target.value);
    });
    
    // Close button
    document.getElementById('closeAddUserBtn').addEventListener('click', () => {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
    });
    
    // Form submission
    document.getElementById('addUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const role = document.getElementById('userRole').value;
        const firstName = document.getElementById('userFirstName').value.trim();
        const lastName = document.getElementById('userLastName').value.trim();
        const username = document.getElementById('userUsername').value.trim();
        const school = document.getElementById('userSchool').value.trim() || 'School';
        
        if (!firstName || !lastName || !username) {
            showAddUserAlert(lang === 'uz' ? 'Barcha maydonlarni to\'ldiring' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'warning');
            return;
        }
        
        const userData = {
            username,
            role,
            firstName,
            lastName,
            school
        };
        
        if (role === 'student') {
            const grade = document.getElementById('studentGrade').value.trim();
            const section = document.getElementById('studentSection').value.trim();
            const classTeacherId = document.getElementById('studentClassTeacher')?.value || '';
            if (!grade) {
                showAddUserAlert(lang === 'uz' ? 'Sinf raqamini kiriting' : '–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–ª–∞—Å—Å–∞', 'warning');
                return;
            }
            userData.grade = grade;
            userData.gradeSection = section || '–ê';
            if (classTeacherId) {
                userData.classTeacherId = classTeacherId;
            }
        } else if (role === 'teacher') {
            const selectedSubjects = Array.from(document.querySelectorAll('.teacherSubject:checked')).map(checkbox => ({
                id: checkbox.value,
                name: checkbox.dataset.name
            }));
            if (selectedSubjects.length === 0) {
                showAddUserAlert(lang === 'uz' ? 'Kamida bitta predmet tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –ø—Ä–µ–¥–º–µ—Ç', 'warning');
                return;
            }
            userData.subjects = selectedSubjects;
        }
        
        try {
            const response = await apiRequest('/api/users/register', {
                method: 'POST',
                body: JSON.stringify(userData)
            });
            
            if (response.success) {
                // Show OTP to admin
                if (response.data.otp) {
                    const otpModal = document.createElement('div');
                    otpModal.className = 'modal show';
                    otpModal.style.zIndex = '10001';
                    
                    otpModal.innerHTML = `
                        <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); color: white;">
                            <div style="text-align: center; padding: 2rem;">
                                <div style="font-size: 3rem; margin-bottom: 1rem;">üîë</div>
                                <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem;">${lang === 'uz' ? 'OTP Parol Yaratildi' : 'OTP –ü–∞—Ä–æ–ª—å –°–æ–∑–¥–∞–Ω'}</h2>
                                <p style="margin: 0 0 1.5rem 0; opacity: 0.9;">
                                    ${lang === 'uz' ? 'Foydalanuvchiga quyidagi ma\'lumotlarni bering:' : '–ü–µ—Ä–µ–¥–∞–π—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ:'}
                                </p>
                                
                                <div style="background: rgba(255,255,255,0.15); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; backdrop-filter: blur(10px);">
                                    <div style="margin-bottom: 1rem;">
                                        <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.3rem;">${lang === 'uz' ? 'Login' : '–õ–æ–≥–∏–Ω'}:</div>
                                        <div style="font-size: 1.3rem; font-weight: 700; font-family: monospace; letter-spacing: 1px;">${response.data.username}</div>
                                    </div>
                                    <div>
                                        <div style="font-size: 0.85rem; opacity: 0.8; margin-bottom: 0.3rem;">${lang === 'uz' ? 'Bir martalik parol (OTP)' : '–û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –ø–∞—Ä–æ–ª—å (OTP)'}:</div>
                                        <div style="font-size: 1.8rem; font-weight: 700; font-family: monospace; letter-spacing: 3px; background: rgba(255,255,255,0.2); padding: 0.7rem; border-radius: 8px;">${response.data.otp}</div>
                                    </div>
                                </div>
                                
                                <div style="background: rgba(255,255,255,0.1); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem; font-size: 0.85rem; text-align: left;">
                                    <div style="font-weight: 600; margin-bottom: 0.5rem;">‚ö†Ô∏è ${lang === 'uz' ? 'Muhim' : '–í–∞–∂–Ω–æ'}:</div>
                                    <ul style="margin: 0; padding-left: 1.2rem; line-height: 1.6;">
                                        <li>${lang === 'uz' ? 'Parol faqat bir marta ishlatiladi' : '–ü–∞—Ä–æ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑'}</li>
                                        <li>${lang === 'uz'
                                            ? `Amal qilish muddati: ${new Date(response.data.otpExpiresAt).toLocaleString('uz-UZ')}`
                                            : `–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è: ${new Date(response.data.otpExpiresAt).toLocaleString('ru-RU')}`}</li>
                                        <li>${lang === 'uz' ? 'Foydalanuvchi birinchi kirishda parolni o\'zgartirishi kerak' : '–ü—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω —Å–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å'}</li>
                                    </ul>
                                </div>
                                
                                <button onclick="this.closest('.modal').remove()" style="width: 100%; padding: 0.9rem; background: white; color: #1e40af; border: none; border-radius: 8px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.2s;">
                                    ${lang === 'uz' ? 'Yopish' : '–ó–∞–∫—Ä—ã—Ç—å'}
                                </button>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(otpModal);
                }
                
                showAlert(
                    lang === 'uz' ? 'Foydalanuvchi muvaffaqiyatli qo\'shildi' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω',
                    'success'
                );
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                    // Reload admin dashboard
                    renderAdminDashboard();
                }, 300);
            } else {
                showAddUserAlert(response.error || (lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            console.error('Error creating user:', error);
            showAddUserAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        }
    });
}

async function showAddClassModal() {
    const lang = store.getState().language;
    
    const modal = document.createElement('div');
    modal.className = 'admin-modal-overlay';
    
    modal.innerHTML = `
        <div class="admin-modal-content modal-content" style="max-width: 450px;">
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; margin: -1.5rem -1.5rem 1.5rem -1.5rem;">
                <h2 style="margin: 0; font-size: 1.3rem;">üè´ ${lang === 'uz' ? 'Sinf qo\'shish' : '–î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å'}</h2>
            </div>
            
            <form id="addClassForm" style="display: flex; flex-direction: column; gap: 1rem;">
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Sinf raqami' : '–ù–æ–º–µ—Ä –∫–ª–∞—Å—Å–∞'}
                    </label>
                    <input id="classGrade" type="text" placeholder="${lang === 'uz' ? '9' : '9'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Sinf nomi' : '–ù–∞–∑–≤–∞–Ω–∏–µ –∫–ª–∞—Å—Å–∞'}
                    </label>
                    <input id="className" type="text" placeholder="${lang === 'uz' ? 'A, B, V' : '–ê, –ë, –í'}" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary);" required>
                </div>
                
                <div>
                    <label style="display: block; font-weight: 600; margin-bottom: 0.4rem; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'Sinf o\'qituvchisi' : '–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å'}
                    </label>
                    <select id="classTeacher">
                        <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button type="button" class="button button-secondary" id="closeAddClassBtn" style="flex: 1;">
                        ${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}
                    </button>
                    <button type="submit" class="button button-primary" style="flex: 1; background: #f59e0b;">
                        ‚úÖ ${lang === 'uz' ? 'Yaratish' : '–°–æ–∑–¥–∞—Ç—å'}
                    </button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        }
    });
    
    // Load teachers list
    try {
        const response = await apiRequest('/api/users');
        const teachers = response.success ? response.data.filter(u => u.role === 'teacher') : [];
        const teacherSelect = document.getElementById('classTeacher');
        
        teachers.forEach(teacher => {
            const option = document.createElement('option');
            option.value = teacher._id;
            option.textContent = `${teacher.firstName} ${teacher.lastName}`;
            teacherSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading teachers:', error);
    }
    
    // Close button
    document.getElementById('closeAddClassBtn').addEventListener('click', () => {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
    });
    
    // Form submission
    document.getElementById('addClassForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const grade = document.getElementById('classGrade').value.trim();
        const name = document.getElementById('className').value.trim();
        const teacherId = document.getElementById('classTeacher').value;
        
        if (!grade || !name) {
            showAlert(lang === 'uz' ? 'Barcha maydonlarni to\'ldiring' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è', 'warning');
            return;
        }
        
        try {
            const response = await apiRequest('/api/classes', {
                method: 'POST',
                body: JSON.stringify({
                    grade,
                    name,
                    teacherId: teacherId || null
                })
            });
            
            if (response.success) {
                showAlert(
                    lang === 'uz' ? 'Sinf muvaffaqiyatli yaratildi' : '–ö–ª–∞—Å—Å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω',
                    'success'
                );
                modal.classList.remove('show');
                setTimeout(() => {
                    modal.remove();
                    // Reload admin dashboard
                    renderAdminDashboard();
                }, 300);
            } else {
                showAlert(response.error || (lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'), 'error');
            }
        } catch (error) {
            console.error('Error creating class:', error);
            showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        }
    });
}

// Make functions globally accessible for onclick handlers
window.showAddUserModal = showAddUserModal;
window.showAddClassModal = showAddClassModal;
window.viewTeacherTestResults = viewTeacherTestResults;
window.assignTestToTeachers = assignTestToTeachers;
window.deleteTeacherTest = deleteTeacherTest;
window.startTeacherTest = startTeacherTest;
window.retakeTeacherTest = retakeTeacherTest;
window.viewMyTestResult = viewMyTestResult;

function setupAdminFilters() {
    const classFilter = document.getElementById('adminClassFilter');
    const searchInput = document.getElementById('adminSearchInput');
    
    if (!classFilter || !searchInput) return;
    
    const applyFilters = () => {
        if (!window.adminData) return;
        
        const selectedClass = classFilter.value;
        const searchTerm = searchInput.value.toLowerCase();
        
        // Filter students
        let filteredStudents = window.adminData.students;
        
        if (selectedClass) {
            filteredStudents = filteredStudents.filter(s => s.grade === selectedClass);
        }
        
        if (searchTerm) {
            filteredStudents = filteredStudents.filter(s => 
                (s.firstName + ' ' + s.lastName).toLowerCase().includes(searchTerm) ||
                s.username.toLowerCase().includes(searchTerm)
            );
        }
        
        renderAdminStudentList(filteredStudents, window.adminData.classes, window.adminData.results);
    };
    
    classFilter.addEventListener('change', applyFilters);
    searchInput.addEventListener('input', applyFilters);
}

async function viewStudentDetails(studentId) {
    router.navigate(`/admin/student/${studentId}`);
}

async function renderAdminStudentDetail(studentId) {
    const lang = store.getState().language;
    
    const content = `
        <div class="page-header">
            <button class="button button-secondary" id="btnBackToAdminDashboard" style="margin-bottom: 1rem;">
                ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
            </button>
            <h1>${lang === 'uz' ? "O'quvchi ma'lumotlari" : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± —É—á–µ–Ω–∏–∫–µ'}</h1>
        </div>
        
        <div id="studentDetailContainer">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    `;
    
    renderLayout(content, 'admin');
    
    document.getElementById('btnBackToAdminDashboard')?.addEventListener('click', () => {
        router.navigate('/admin/dashboard');
    });
    
    await loadStudentDetail(studentId);
}

async function loadStudentDetail(studentId) {
    const lang = store.getState().language;
    
    const [userRes, resultsRes, subjectsRes, timelineRes] = await Promise.all([
        apiRequest(`/api/users/${studentId}`),
        apiRequest('/api/test-results'),
        apiRequest('/api/subjects'),
        apiRequest(`/api/analytics/students/${studentId}/timeline`)
    ]);
    
    if (!userRes.success) {
        document.getElementById('studentDetailContainer').innerHTML = `
            <div class="card" style="text-align: center; padding: 3rem;">
                <p style="color: #ef4444;">${lang === 'uz' ? 'O\'quvchi topilmadi' : '–£—á–µ–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω'}</p>
            </div>
        `;
        return;
    }
    
    const student = userRes.data;
    const allResults = resultsRes.data || [];
    const subjects = subjectsRes.data || [];
    
    const studentResults = allResults.filter(r => r.userId === studentId).sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
    const lastResults = studentResults.slice(0, 5);
    
    const avgScore = studentResults.length > 0
        ? Math.round(studentResults.reduce((sum, r) => sum + (r.correctCount / r.totalCount * 100), 0) / studentResults.length)
        : 0;
    
    const bestScore = studentResults.length > 0
        ? Math.max(...studentResults.map(r => Math.round((r.correctCount / r.totalCount) * 100)))
        : 0;
    
    const passedTests = studentResults.filter(r => Math.round((r.correctCount / r.totalCount) * 100) >= 70).length;
    
    const scoreColor = avgScore >= 80 ? '#10b981' : avgScore >= 50 ? '#f59e0b' : '#ef4444';
    const fullName = `${student.firstName} ${student.lastName}`;
    const interests = student.interestTestResults?.categories || {};
    
    // Get recommended subjects based on interests
    const recommendedSubjects = Object.entries(interests)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3)
        .map(([key, score]) => ({
            name: key,
            score: score
        }));
    
    let html = `
        <style>
            @keyframes slideInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .profile-section { animation: slideInUp 0.5s ease-out; }
        </style>
        
        <!-- Profile Header -->
        <div class="card profile-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; text-align: center; margin-bottom: 2rem; border-radius: 20px;">
            <div style="width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; border: 3px solid rgba(255,255,255,0.4); font-size: 3rem;">
                ${fullName.charAt(0).toUpperCase()}
            </div>
            <h1 style="margin: 0 0 0.5rem 0; font-size: 1.8rem; font-weight: 800;">${fullName}</h1>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                <div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å'}</div>
                    <div style="font-size: 1.5rem; font-weight: bold; margin-top: 0.25rem;">${student.grade}-${student.gradeSection || '–ê'}</div>
                </div>
                <div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Maktab' : '–®–∫–æ–ª–∞'}</div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-top: 0.25rem;">${student.school}</div>
                </div>
                <div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">ID</div>
                    <div style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem; font-family: monospace;">${student.username}</div>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card profile-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${avgScore}%</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª'}</div>
            </div>
            <div class="card profile-section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${studentResults.length}</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Testlar topshirdi' : '–ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤'}</div>
            </div>
            <div class="card profile-section" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${bestScore}%</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Eng yuqori ball' : '–õ—É—á—à–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç'}</div>
            </div>
            <div class="card profile-section" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${passedTests}</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'O\'tkazdi' : '–£—Å–ø–µ—à–Ω–æ'}</div>
            </div>
        </div>
    `;
    
    // Recommended Subjects
    if (student.interestTestResults && Object.keys(interests).length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üéØ ${lang === 'uz' ? 'Tavsiya etilgan fanlar' : '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    ${Object.entries(interests).map(([key, score]) => {
                        const colors = {
                            'math': { bg: '#667eea', text: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞/Matematika' },
                            'science': { bg: '#f093fb', text: '–ù–∞—É–∫–∞/Fanlar' },
                            'tech': { bg: '#4facfe', text: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è/Texnologiya' },
                            'art': { bg: '#43e97b', text: '–ò—Å–∫—É—Å—Å—Ç–≤–æ/San\'at' },
                            'social': { bg: '#f5576c', text: '–°–æ—Ü–∏–æ–ª–æ–≥–∏—è/Jamiyat' },
                            'language': { bg: '#ffa502', text: '–Ø–∑—ã–∫/Til' }
                        };
                        const color = colors[key] || { bg: '#667eea', text: key };
                        const displayText = lang === 'uz' ? 
                            (key === 'math' ? 'Matematika' : key === 'science' ? 'Fanlar' : key === 'tech' ? 'Texnologiya' : key === 'art' ? 'San\'art' : key === 'social' ? 'Jamiyat' : 'Til') :
                            (key === 'math' ? '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞' : key === 'science' ? '–ù–∞—É–∫–∞' : key === 'tech' ? '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è' : key === 'art' ? '–ò—Å–∫—É—Å—Å—Ç–≤–æ' : key === 'social' ? '–°–æ—Ü–∏–æ–ª–æ–≥–∏—è' : '–Ø–∑—ã–∫');
                        return `
                            <div style="background: linear-gradient(135deg, ${color.bg} 0%, ${color.bg}dd 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 1.8rem; margin-bottom: 0.5rem;">
                                    ${key === 'math' ? 'üìê' : key === 'science' ? 'üß™' : key === 'tech' ? 'üíª' : key === 'art' ? 'üé®' : key === 'social' ? 'üë•' : 'üìö'}
                                </div>
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">${displayText}</div>
                                <div style="font-size: 1.3rem; font-weight: bold;">${Math.round(score)}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;

        html += `
            <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìå ${lang === 'uz' ? 'Qiziqish profili' : '–ü—Ä–æ—Ñ–∏–ª—å –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤'}
                </h2>
                <div style="display: grid; gap: 0.75rem;">
                    ${Object.entries(interests).map(([key, score]) => {
                        const labels = {
                            math: lang === 'uz' ? 'Matematika' : '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞',
                            science: lang === 'uz' ? 'Fanlar' : '–ù–∞—É–∫–∞',
                            tech: lang === 'uz' ? 'Texnologiya' : '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è',
                            art: lang === 'uz' ? 'San\'at' : '–ò—Å–∫—É—Å—Å—Ç–≤–æ',
                            social: lang === 'uz' ? 'Jamiyat' : '–°–æ—Ü–∏—É–º',
                            language: lang === 'uz' ? 'Til' : '–Ø–∑—ã–∫'
                        };
                        const label = labels[key] || key;
                        return `
                            <div style="display: grid; gap: 0.4rem;">
                                <div style="display: flex; justify-content: space-between; font-weight: 600; color: var(--text-primary);">
                                    <span>${label}</span>
                                    <span>${score}%</span>
                                </div>
                                <div style="height: 8px; background: var(--bg-tertiary); border-radius: 999px; overflow: hidden;">
                                    <div style="height: 100%; width: ${Math.min(Math.max(score, 0), 100)}%; background: linear-gradient(90deg, #3B82F6, #8B5CF6);"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // Student analytics chart
    html += `
        <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
            <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                üìà ${lang === 'uz' ? 'Fanlar bo\'yicha dinamika' : '–î–∏–Ω–∞–º–∏–∫–∞ –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}
            </h2>
            <div style="position: relative; min-height: 280px;">
                <div id="adminStudentAnalyticsEmpty" class="card" style="padding: 1rem; text-align: center; color: var(--text-secondary);">${lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}</div>
                <canvas id="adminStudentAnalyticsChart" style="max-height: 320px; width: 100%; display: none;"></canvas>
            </div>
        </div>
    `;
    
    // Recent Results (Top 5)
    if (lastResults.length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìä ${lang === 'uz' ? 'So\'nggi natijalar' : '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'} (${lang === 'uz' ? 'Top 5' : '–¢–æ–ø 5'})
                </h2>
                <div style="display: grid; gap: 0.75rem;">
                    ${lastResults.map(result => {
                        const score = Math.round((result.correctCount / result.totalCount) * 100);
                        const scoreColor = score >= 80 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                        const date = new Date(result.completedAt);
                        const dateStr = date.toLocaleDateString(lang === 'uz' ? 'uz-UZ' : 'ru-RU');
                        return `
                            <div style="display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid ${scoreColor};">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 0.25rem;">${result.testName}</div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted);">üìÖ ${dateStr}</div>
                                </div>
                                <div style="text-align: right; margin-left: 1rem;">
                                    <div style="font-size: 1.5rem; font-weight: bold; color: ${scoreColor};">${score}%</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">${result.correctCount}/${result.totalCount}</div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }
    
    // All Test Results History
    if (studentResults.length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìã ${lang === 'uz' ? 'Barcha test natijalari' : '–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤'} (${studentResults.length} ${lang === 'uz' ? 'test' : '—Ç–µ—Å—Ç–æ–≤'})
                </h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead>
                            <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border);">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">${lang === 'uz' ? 'Test nomi' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞'}</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600;">${lang === 'uz' ? 'Ball' : '–ë–∞–ª–ª'}</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600;">${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å–æ–≤'}</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600;">${lang === 'uz' ? 'To\'g\'ri' : '–í–µ—Ä–Ω–æ'}</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">${lang === 'uz' ? 'Sana' : '–î–∞—Ç–∞'}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${studentResults.map((result, idx) => {
                                const score = Math.round((result.correctCount / result.totalCount) * 100);
                                const scoreColor = score >= 80 ? '#10b981' : score >= 50 ? '#f59e0b' : '#ef4444';
                                const date = new Date(result.completedAt);
                                const dateStr = date.toLocaleDateString(lang === 'uz' ? 'uz-UZ' : 'ru-RU', { month: 'short', day: 'numeric' });
                                return `
                                    <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 0.75rem; color: var(--text-primary);">${result.testName}</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="color: ${scoreColor}; font-weight: bold; font-size: 1.1rem;">${score}%</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center; color: var(--text-muted);">${result.totalCount}</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="color: #10b981; font-weight: 600;">${result.correctCount}</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: right; color: var(--text-muted); font-size: 0.9rem;">${dateStr}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    document.getElementById('studentDetailContainer').innerHTML = html;

    if (timelineRes.success) {
        const barData = buildSubjectAverageChart(timelineRes.data, lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª');
        renderBarChart('adminStudentAnalyticsChart', 'adminStudentAnalyticsEmpty', barData);
    }
}

async function viewTeacherDetails(teacherId) {
    router.navigate(`/admin/teacher/${teacherId}`);
}

async function renderAdminTeacherDetail(teacherId) {
    const lang = store.getState().language;
    
    const content = `
        <div style="margin-bottom: 1rem;">
            <button class="button button-secondary" id="btnBackToAdminDashboard2">
                ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
            </button>
        </div>
        
        <div id="teacherDetailContainer">
            <div class="loading"><div class="spinner"></div></div>
        </div>
    `;
    
    renderLayout(content, 'admin');
    
    document.getElementById('btnBackToAdminDashboard2')?.addEventListener('click', () => {
        router.navigate('/admin/dashboard');
    });
    
    await loadTeacherDetail(teacherId);
}

async function loadTeacherDetail(teacherId) {
    const lang = store.getState().language;
    
    const [userRes, testsRes, analyticsRes, classesRes] = await Promise.all([
        apiRequest(`/api/users/${teacherId}`),
        apiRequest('/api/tests'),
        apiRequest(`/api/analytics/teachers/${teacherId}/subjects`),
        apiRequest('/api/classes')
    ]);
    
    if (!userRes.success) {
        document.getElementById('teacherDetailContainer').innerHTML = `
            <div class="card" style="text-align: center; padding: 3rem;">
                <p style="color: #ef4444;">${lang === 'uz' ? 'O\'qituvchi topilmadi' : '–£—á–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω'}</p>
            </div>
        `;
        return;
    }
    
    const teacher = userRes.data;
    const subjectAnalytics = analyticsRes.success ? analyticsRes.data : [];
    const allTests = testsRes.data || [];
    const classes = classesRes.success ? classesRes.data : [];
    
    // Get tests created by this teacher
    const teacherTests = allTests.filter(t => t.createdBy === teacherId);
    const fullName = `${teacher.firstName} ${teacher.lastName}`;
    
    // Get subjects as array
    const subjects = Array.isArray(teacher.subjects) ? teacher.subjects : [];
    const teacherClasses = classes.filter(cls => cls.teacherId === teacherId);
    
    let html = `
        <style>
            @keyframes slideInUp {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .profile-section { animation: slideInUp 0.5s ease-out; }
        </style>
        
        <!-- Profile Header -->
        <div class="card profile-section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 2rem; text-align: center; margin-bottom: 2rem; border-radius: 20px;">
            <div style="width: 100px; height: 100px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; border: 3px solid rgba(255,255,255,0.4); font-size: 3rem;">
                ${fullName.charAt(0).toUpperCase()}
            </div>
            <h1 style="margin: 0 0 0.5rem 0; font-size: 1.8rem; font-weight: 800;">${fullName}</h1>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                <div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Maktab' : '–®–∫–æ–ª–∞'}</div>
                    <div style="font-size: 1.2rem; font-weight: 600; margin-top: 0.25rem;">${teacher.school}</div>
                </div>
                <div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">ID</div>
                    <div style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem; font-family: monospace;">${teacher.username}</div>
                </div>
                <div>
                    <div style="font-size: 0.85rem; opacity: 0.9;">üë®‚Äçüè´</div>
                    <div style="font-size: 1rem; font-weight: 600; margin-top: 0.25rem;">${lang === 'uz' ? 'O\'qituvchi' : '–£—á–∏—Ç–µ–ª—å'}</div>
                </div>
            </div>
        </div>
        
        <!-- Statistics -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
            <div class="card profile-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${subjects.length}</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Fanlar' : '–ü—Ä–µ–¥–º–µ—Ç—ã'}</div>
            </div>
            <div class="card profile-section" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 16px; text-align: center;">
                <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${teacherTests.length}</div>
                <div style="font-size: 0.85rem; opacity: 0.9;">${lang === 'uz' ? 'Testlar tuzildi' : '–°–æ–∑–¥–∞–Ω–æ —Ç–µ—Å—Ç–æ–≤'}</div>
            </div>
        </div>
    `;
    
    // Subjects List
    if (subjects.length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìö ${lang === 'uz' ? 'O\'qitadigan fanlar' : '–ü—Ä–µ–ø–æ–¥–∞–≤–∞–µ–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                    ${subjects.map((subject, idx) => {
                        const colors = ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#f5576c', '#ffa502'];
                        const color = colors[idx % colors.length];
                        const subjectName = lang === 'uz' 
                            ? (subject.nameUz || subject.name || subject)
                            : (subject.nameRu || subject.name || subject);
                        const emojis = ['üìê', 'üî¨', '‚öóÔ∏è', 'üß¨', 'üìú', 'üìñ'];
                        const emoji = emojis[idx % emojis.length];
                        return `
                            <div style="background: linear-gradient(135deg, ${color} 0%, ${color}dd 100%); color: white; padding: 1.5rem; border-radius: 12px; text-align: center;">
                                <div style="font-size: 2rem; margin-bottom: 0.75rem;">${emoji}</div>
                                <div style="font-weight: 600;">${typeof subject === 'string' ? subject : subjectName}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    if (teacherClasses.length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üè´ ${lang === 'uz' ? 'Biriktirilgan sinflar' : '–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–Ω—ã–µ –∫–ª–∞—Å—Å—ã'}
                </h2>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                    ${teacherClasses.map(cls => {
                        const label = cls.name ? `${cls.grade || ''}${cls.name}` : (cls.sections?.length ? `${cls.grade || ''} (${cls.sections.join(', ')})` : (cls.grade || '‚Äî'));
                        const count = cls.studentCount ?? 0;
                        return `
                            <div style="padding: 0.9rem; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-secondary); display: grid; gap: 0.25rem;">
                                <div style="font-weight: 700; color: var(--text-primary);">${label}</div>
                                <div style="font-size: 0.85rem; color: var(--text-muted);">${count} ${lang === 'uz' ? 'o\'quvchi' : '—É—á–µ–Ω–∏–∫–æ–≤'}</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }

    // Subject analytics
    if (subjectAnalytics.length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìä ${lang === 'uz' ? 'Fanlar bo\'yicha natijalar' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}
                </h2>
                <div style="display: grid; gap: 0.75rem;">
                    ${subjectAnalytics.map(stat => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.9rem; background: var(--bg-secondary); border-radius: 10px; border-left: 4px solid #3B82F6;">
                            <div style="font-weight: 600; color: var(--text-primary);">${stat.subjectName}</div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: #3B82F6;">${stat.averageScore}%</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">${stat.testsCompleted} ${lang === 'uz' ? 'natija' : '—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
    

    
    // All Tests Created History
    if (teacherTests.length > 0) {
        html += `
            <div class="card profile-section" style="padding: 1.5rem;">
                <h2 style="margin-top: 0; display: flex; align-items: center; gap: 0.5rem;">
                    üìö ${lang === 'uz' ? 'Barcha tuzilgan testlar' : '–ò—Å—Ç–æ—Ä–∏—è –≤—Å–µ—Ö —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤'} (${teacherTests.length} ${lang === 'uz' ? 'test' : '—Ç–µ—Å—Ç–æ–≤'})
                </h2>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.95rem;">
                        <thead>
                            <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border);">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600;">${lang === 'uz' ? 'Test nomi' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞'}</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600;">${lang === 'uz' ? 'Savollar' : '–í–æ–ø—Ä–æ—Å—ã'}</th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600;">${lang === 'uz' ? 'Turi' : '–¢–∏–ø'}</th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600;">${lang === 'uz' ? 'Sana' : '–î–∞—Ç–∞'}</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${teacherTests.map((test, idx) => {
                                const date = new Date(test.createdAt || test.updatedAt);
                                const dateStr = date.toLocaleDateString(lang === 'uz' ? 'uz-UZ' : 'ru-RU', { month: 'short', day: 'numeric', year: '2-digit' });
                                const testType = test.testType || (lang === 'uz' ? 'Standart' : '–°—Ç–∞–Ω–¥–∞—Ä—Ç');
                                const testTitle = lang === 'uz' ? (test.nameUz || test.nameRu || test.testName || test.name || '–ù–æ–º–∏ –∫–µ–ª–º–∞–≥–∞–Ω —Ç–µ—Å—Ç') : (test.nameRu || test.nameUz || test.testName || test.name || '–¢–µ—Å—Ç –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
                                return `
                                    <tr style="border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                                        <td style="padding: 0.75rem; color: var(--text-primary);">${testTitle}</td>
                                        <td style="padding: 0.75rem; text-align: center;">
                                            <span style="background: var(--bg-tertiary); padding: 0.25rem 0.75rem; border-radius: 8px; font-weight: 600; color: #667eea;">${test.questions?.length || test.questionCount || 0}</span>
                                        </td>
                                        <td style="padding: 0.75rem; text-align: center; color: var(--text-muted);">${testType}</td>
                                        <td style="padding: 0.75rem; text-align: right; color: var(--text-muted); font-size: 0.9rem;">${dateStr}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }
    
    document.getElementById('teacherDetailContainer').innerHTML = html;
}

// Admin Teacher Tests Management Page
async function renderAdminTeacherTests() {
    const lang = store.getState().language;
    
    const content = `
        <style>
            .teacher-tests-hero {
                background: linear-gradient(135deg, rgba(245, 158, 11, 0.16) 0%, rgba(124, 58, 237, 0.12) 100%);
                border: 1px solid rgba(245, 158, 11, 0.28);
                border-radius: 18px;
                padding: 1.5rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 1rem;
                flex-wrap: wrap;
            }
            .teacher-tests-hero__title {
                margin: 0;
                font-size: 2.1rem;
                font-weight: 800;
                color: var(--text-primary);
            }
            .teacher-tests-hero__desc {
                margin: 0.5rem 0 0 0;
                color: var(--text-secondary);
                font-size: 0.95rem;
            }
            .teacher-tests-hero__meta {
                display: flex;
                gap: 0.75rem;
                flex-wrap: wrap;
                align-items: center;
            }
            .teacher-tests-pill {
                padding: 0.45rem 0.9rem;
                border-radius: 999px;
                background: rgba(245, 158, 11, 0.16);
                color: #fde68a;
                border: 1px solid rgba(245, 158, 11, 0.4);
                font-weight: 600;
                font-size: 0.8rem;
            }
            .teacher-tests-panel {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 16px;
                padding: 1.25rem;
                display: grid;
                gap: 1rem;
            }
            @media (max-width: 768px) {
                .teacher-tests-hero { padding: 1.25rem; }
                .teacher-tests-hero__title { font-size: 1.75rem; }
            }
            @media (max-width: 420px) {
                .teacher-tests-hero { padding: 1rem; border-radius: 14px; }
                .teacher-tests-hero__title { font-size: 1.5rem; }
                .teacher-tests-hero__desc { font-size: 0.85rem; }
            }
        </style>
        <div style="display: grid; gap: 1.5rem;">
            <div class="teacher-tests-hero">
                <div>
                    <h1 class="teacher-tests-hero__title">${lang === 'uz' ? 'O\'qituvchilar uchun testlar' : '–¢–µ—Å—Ç—ã –¥–ª—è —É—á–∏—Ç–µ–ª–µ–π'}</h1>
                    <p class="teacher-tests-hero__desc">${lang === 'uz' ? 'O\'qituvchilarning malakasini baholash uchun testlar yaratish va boshqarish' : '–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π —É—á–∏—Ç–µ–ª–µ–π'}</p>
                </div>
                <div class="teacher-tests-hero__meta">
                    <button class="btn-secondary" id="btnBackToAdmin" style="padding: 0.7rem 1.2rem; font-size: 0.9rem; border: 1px solid var(--border-color);">‚Üê ${t('back')}</button>
                    <span class="teacher-tests-pill">${lang === 'uz' ? 'Testlar' : '–¢–µ—Å—Ç—ã'}</span>
                </div>
            </div>

            <div class="teacher-tests-panel">
                <button class="button button-primary" id="btnCreateTeacherTest" style="width: 100%;">
                    <span>‚ûï</span>
                    <span>${lang === 'uz' ? 'Yangi test yaratish' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç'}</span>
                </button>
            </div>

            <div class="teacher-tests-panel" style="overflow: hidden;">
                <h2 style="margin: 0 0 1.25rem 0;">${lang === 'uz' ? 'Mavjud testlar' : '–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã'}</h2>
                <div id="teacherTestsList">
                    <div class="loading"><div class="spinner"></div></div>
                </div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'admin');
    
    document.getElementById('btnBackToAdmin')?.addEventListener('click', () => {
        window.router.navigate('/admin/dashboard');
    });
    
    document.getElementById('btnCreateTeacherTest')?.addEventListener('click', () => {
        showCreateTeacherTestModal();
    });
    
    // Load teacher tests
    await loadTeacherTests();
}

// Load teacher tests list
async function loadTeacherTests() {
    const lang = store.getState().language;
    const container = document.getElementById('teacherTestsList');
    
    if (!container) {
        console.error('teacherTestsList container not found');
        return;
    }
    
    try {
        console.log('Loading teacher tests...');
        const response = await apiRequest('/api/teacher-tests');
        console.log('Teacher tests response:', response);
        
        if (!response.success || !response.data || response.data.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üìù</div>
                    <p>${lang === 'uz' ? 'Hali testlar yaratilmagan' : '–¢–µ—Å—Ç—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã'}</p>
                </div>
            `;
            return;
        }
        
        const tests = response.data;
        console.log('Rendering', tests.length, 'tests');
        
        container.innerHTML = tests.map(test => `
            <div class="card" style="margin-bottom: 1rem; border-left: 4px solid var(--primary); overflow: hidden;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <div style="flex: 1;">
                        <h3 style="margin: 0 0 0.5rem 0;">${test.title}</h3>
                        <p style="color: var(--text-muted); margin: 0 0 0.5rem 0;">${test.description}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                            <span>üìù ${test.questionsCount || 0} ${lang === 'uz' ? 'ta savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                            <span>‚è±Ô∏è ${test.duration || 30} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω—É—Ç'}</span>
                            <span>üìÖ ${new Date(test.createdAt).toLocaleDateString('ru-RU')}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button class="button button-secondary button-inline" onclick="viewTeacherTestResults('${test._id}')" style="padding: 0.5rem 1rem;">
                            <span>üìä</span>
                            <span>${lang === 'uz' ? 'Natijalar' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</span>
                        </button>
                        <button class="button button-primary button-inline" onclick="assignTestToTeachers('${test._id}')" style="padding: 0.5rem 1rem;">
                            <span>üë•</span>
                            <span>${lang === 'uz' ? 'Tayinlash' : '–ù–∞–∑–Ω–∞—á–∏—Ç—å'}</span>
                        </button>
                        <button class="button button-inline" onclick="deleteTeacherTest('${test._id}')" style="padding: 0.5rem 1rem; background: #ef4444; color: white; display: inline-flex; align-items: center; gap: 0.5rem;">
                            <span>üóëÔ∏è</span>
                            <span class="delete-text">${lang === 'uz' ? 'O\'chirish' : '–£–¥–∞–ª–∏—Ç—å'}</span>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
    } catch (error) {
        console.error('Error loading teacher tests:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <p>${lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</p>
            </div>
        `;
    }
}

// Show create teacher test modal
function showCreateTeacherTestModal() {
    const lang = store.getState().language;
    
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h2 style="margin: 0;">${lang === 'uz' ? 'Yangi test yaratish' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç'}</h2>
                <button class="modal-close" id="closeModal">‚úï</button>
            </div>
            
            <form id="createTeacherTestForm" style="display: grid; gap: 1rem;">
                <div>
                    <label class="form-label">${lang === 'uz' ? 'Test nomi' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞'}</label>
                    <input type="text" name="title" class="form-input" required placeholder="${lang === 'uz' ? 'Test nomini kiriting' : '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞'}">
                </div>
                
                <div>
                    <label class="form-label">${lang === 'uz' ? 'Ta\'rif' : '–û–ø–∏—Å–∞–Ω–∏–µ'}</label>
                    <textarea name="description" class="form-input" rows="3" placeholder="${lang === 'uz' ? 'Test haqida qisqacha ma\'lumot' : '–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞'}"></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <label class="form-label">${lang === 'uz' ? 'Davomiyligi (daqiqa)' : '–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç—ã)'}</label>
                        <input type="number" name="duration" class="form-input" value="30" min="5" max="180">
                    </div>
                    <div>
                        <label class="form-label">${lang === 'uz' ? 'O\'tish bali (%)' : '–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª (%)'}</label>
                        <input type="number" name="passingScore" class="form-input" value="70" min="0" max="100">
                    </div>
                </div>
                
                <div>
                    <label class="form-label">${lang === 'uz' ? 'Savollar' : '–í–æ–ø—Ä–æ—Å—ã'}</label>
                    <div id="questionsContainer" style="display: grid; gap: 1rem;">
                        <!-- Questions will be added here -->
                    </div>
                    <button type="button" class="button button-secondary" id="btnAddQuestion" style="margin-top: 0.5rem;">
                        <span>‚ûï</span>
                        <span>${lang === 'uz' ? 'Savol qo\'shish' : '–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å'}</span>
                    </button>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                    <button type="button" class="button button-secondary" id="btnCancelCreate">${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}</button>
                    <button type="submit" class="button button-primary">${lang === 'uz' ? 'Saqlash' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</button>
                </div>
            </form>
        </div>
    `;
    
    document.body.appendChild(modal);
    setTimeout(() => modal.classList.add('show'), 10);
    
    // Reset question counter
    questionCounter = 0;
    
    // Add first question by default
    addQuestionField();
    
    document.getElementById('btnAddQuestion').addEventListener('click', addQuestionField);
    
    document.getElementById('closeModal').addEventListener('click', () => {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
    });
    
    document.getElementById('btnCancelCreate').addEventListener('click', () => {
        modal.classList.remove('show');
        setTimeout(() => modal.remove(), 300);
    });
    
    document.getElementById('createTeacherTestForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await createTeacherTest(new FormData(e.target), modal);
    });
}

let questionCounter = 0;

// Add question field to form
function addQuestionField() {
    const lang = store.getState().language;
    const container = document.getElementById('questionsContainer');
    questionCounter++;
    
    const questionDiv = document.createElement('div');
    questionDiv.className = 'card';
    questionDiv.style.background = 'var(--bg-secondary)';
    questionDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; gap: 0.5rem;">
            <h4 style="margin: 0;">${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å'} ${questionCounter}</h4>
            <button type="button" onclick="this.closest('.card').remove()" style="padding: 0.5rem 0.75rem; background: #ef4444; color: white; border-radius: 8px; display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; border: none; cursor: pointer; transition: all 0.3s; width: auto; min-width: 0; flex: 0 0 auto;" onmouseover="this.style.background='#dc2626'" onmouseout="this.style.background='#ef4444'" aria-label="–£–¥–∞–ª–∏—Ç—å –≤–æ–ø—Ä–æ—Å">
                <span>üóëÔ∏è</span>
            </button>
        </div>
        
        <div style="display: grid; gap: 0.75rem;">
            <input type="text" name="question_${questionCounter}_text" class="form-input" required placeholder="${lang === 'uz' ? 'Savol matni' : '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞'}">
            
            <div style="display: grid; gap: 0.5rem;">
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="radio" name="question_${questionCounter}_correct" value="0" required>
                    <input type="text" name="question_${questionCounter}_option_0" class="form-input" required placeholder="${lang === 'uz' ? 'Variant A' : '–í–∞—Ä–∏–∞–Ω—Ç A'}" style="flex: 1;">
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="radio" name="question_${questionCounter}_correct" value="1" required>
                    <input type="text" name="question_${questionCounter}_option_1" class="form-input" required placeholder="${lang === 'uz' ? 'Variant B' : '–í–∞—Ä–∏–∞–Ω—Ç B'}" style="flex: 1;">
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="radio" name="question_${questionCounter}_correct" value="2" required>
                    <input type="text" name="question_${questionCounter}_option_2" class="form-input" required placeholder="${lang === 'uz' ? 'Variant C' : '–í–∞—Ä–∏–∞–Ω—Ç C'}" style="flex: 1;">
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input type="radio" name="question_${questionCounter}_correct" value="3" required>
                    <input type="text" name="question_${questionCounter}_option_3" class="form-input" required placeholder="${lang === 'uz' ? 'Variant D' : '–í–∞—Ä–∏–∞–Ω—Ç D'}" style="flex: 1;">
                </div>
            </div>
            <p style="margin: 0; font-size: 0.85rem; color: var(--text-muted);">
                ${lang === 'uz' ? 'To\'g\'ri javobni belgilang' : '–û—Ç–º–µ—Ç—å—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç'}
            </p>
        </div>
    `;
    
    container.appendChild(questionDiv);
}

// Create teacher test
async function createTeacherTest(formData, modal) {
    const lang = store.getState().language;
    
    console.log('Creating teacher test...');
    console.log('questionCounter:', questionCounter);
    
    try {
        // Parse form data
        const testData = {
            title: formData.get('title'),
            description: formData.get('description'),
            duration: parseInt(formData.get('duration')),
            passingScore: parseInt(formData.get('passingScore')),
            questions: []
        };
        
        console.log('Test data basic:', testData);
        
        // Extract questions
        for (let i = 1; i <= questionCounter; i++) {
            const questionText = formData.get(`question_${i}_text`);
            console.log(`Question ${i}:`, questionText);
            if (questionText) {
                const question = {
                    text: questionText,
                    options: [
                        formData.get(`question_${i}_option_0`),
                        formData.get(`question_${i}_option_1`),
                        formData.get(`question_${i}_option_2`),
                        formData.get(`question_${i}_option_3`)
                    ],
                    correctAnswer: parseInt(formData.get(`question_${i}_correct`))
                };
                console.log(`Parsed question ${i}:`, question);
                testData.questions.push(question);
            }
        }
        
        console.log('Total questions parsed:', testData.questions.length);
        console.log('Full testData:', testData);
        
        if (testData.questions.length === 0) {
            await showAlert(lang === 'uz' ? 'Kamida bitta savol qo\'shing' : '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å', 'warning');
            return;
        }
        
        const response = await apiRequest('/api/teacher-tests', 'POST', testData);
        
        console.log('Create test response:', response);
        
        if (response.success) {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
            console.log('Test created successfully, reloading list...');
            await loadTeacherTests();
            await showAlert(lang === 'uz' ? 'Test muvaffaqiyatli yaratildi' : '–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω', 'success');
        } else {
            throw new Error(response.error);
        }
    } catch (error) {
        console.error('Error creating teacher test:', error);
        await showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    }
}

// View teacher test results
// View teacher test results (Admin)
async function viewTeacherTestResults(testId) {
    const lang = store.getState().language;
    
    try {
        // Get test info
        const testResponse = await apiRequest(`/api/teacher-tests/${testId}`);
        const test = testResponse.data;
        
        // Get results
        const resultsResponse = await apiRequest(`/api/teacher-test-results/${testId}`);
        const results = resultsResponse.data || [];
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; position: sticky; top: 0; background: var(--bg-primary); padding-bottom: 1rem; border-bottom: 2px solid var(--border-color); z-index: 10;">
                    <div>
                        <h2 style="margin: 0 0 0.5rem 0;">${lang === 'uz' ? 'Test natijalari' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞'}</h2>
                        <h4 style="margin: 0; color: var(--text-muted); font-weight: normal;">${test.title}</h4>
                    </div>
                    <button class="modal-close" id="closeResultsModal">‚úï</button>
                </div>
                
                ${results.length === 0 ? `
                    <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                        <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üìä</div>
                        <p>${lang === 'uz' ? 'Hali natijalar yo\'q' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—â–µ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω—ã'}</p>
                    </div>
                ` : `
                    <!-- Statistics -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; text-align: center; padding: 1.5rem;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${results.length}</div>
                            <div style="opacity: 0.9;">${lang === 'uz' ? 'Jami ishtirokchilar' : '–í—Å–µ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; text-align: center; padding: 1.5rem;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${results.filter(r => r.passed).length}</div>
                            <div style="opacity: 0.9;">${lang === 'uz' ? 'O\'tdi' : '–°–¥–∞–ª–∏'}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; text-align: center; padding: 1.5rem;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">${results.filter(r => !r.passed).length}</div>
                            <div style="opacity: 0.9;">${lang === 'uz' ? 'O\'tmadi' : '–ù–µ —Å–¥–∞–ª–∏'}</div>
                        </div>
                        <div class="card" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; text-align: center; padding: 1.5rem;">
                            <div style="font-size: 2.5rem; font-weight: bold; margin-bottom: 0.5rem;">
                                ${results.length > 0 ? Math.round(results.reduce((sum, r) => sum + r.score, 0) / results.length) : 0}%
                            </div>
                            <div style="opacity: 0.9;">${lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª'}</div>
                        </div>
                    </div>
                    
                    <!-- Results Table -->
                    <div class="card">
                        <h3 style="margin: 0 0 1rem 0;">${lang === 'uz' ? 'Batafsil natijalar' : '–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</h3>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-secondary); text-align: left;">
                                        <th style="padding: 1rem; border-bottom: 2px solid var(--border-color);">#</th>
                                        <th style="padding: 1rem; border-bottom: 2px solid var(--border-color);">${lang === 'uz' ? 'O\'qituvchi' : '–£—á–∏—Ç–µ–ª—å'}</th>
                                        <th style="padding: 1rem; border-bottom: 2px solid var(--border-color);">${lang === 'uz' ? 'Ball' : '–ë–∞–ª–ª'}</th>
                                        <th style="padding: 1rem; border-bottom: 2px solid var(--border-color);">${lang === 'uz' ? 'Holat' : '–°—Ç–∞—Ç—É—Å'}</th>
                                        <th style="padding: 1rem; border-bottom: 2px solid var(--border-color);">${lang === 'uz' ? 'Sana' : '–î–∞—Ç–∞'}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.sort((a, b) => b.score - a.score).map((result, index) => `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 1rem;">${index + 1}</td>
                                            <td style="padding: 1rem;">
                                                <div style="font-weight: 600;">${result.teacher?.firstName || ''} ${result.teacher?.lastName || ''}</div>
                                                <div style="font-size: 0.85rem; color: var(--text-muted);">${result.teacher?.username || ''}</div>
                                            </td>
                                            <td style="padding: 1rem;">
                                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                                    <div style="flex: 1; max-width: 100px; height: 8px; background: var(--bg-secondary); border-radius: 4px; overflow: hidden;">
                                                        <div style="height: 100%; background: ${result.passed ? '#10b981' : '#ef4444'}; width: ${result.score}%;"></div>
                                                    </div>
                                                    <span style="font-weight: 600; min-width: 50px;">${result.score}%</span>
                                                </div>
                                            </td>
                                            <td style="padding: 1rem;">
                                                <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: ${result.passed ? '#10b981' : '#ef4444'}; color: white;">
                                                    ${result.passed ? (lang === 'uz' ? 'O\'tdi' : '–°–¥–∞–Ω') : (lang === 'uz' ? 'O\'tmadi' : '–ù–µ —Å–¥–∞–Ω')}
                                                </span>
                                            </td>
                                            <td style="padding: 1rem; color: var(--text-muted); font-size: 0.9rem;">
                                                ${new Date(result.completedAt).toLocaleDateString('ru-RU')}
                                                <br>
                                                ${new Date(result.completedAt).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })}
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `}
                
                <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                    <button class="button button-secondary" id="btnCloseResults">${lang === 'uz' ? 'Yopish' : '–ó–∞–∫—Ä—ã—Ç—å'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
        
        document.getElementById('closeResultsModal')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        });
        
        document.getElementById('btnCloseResults')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        });
        
    } catch (error) {
        console.error('Error viewing results:', error);
        await showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    }
}


// Assign test to teachers
// Assign test to teachers
async function assignTestToTeachers(testId) {
    const lang = store.getState().language;
    
    try {
        // Get all teachers
        const usersResponse = await apiRequest('/api/users');
        
        if (!usersResponse.success) {
            throw new Error('Failed to load teachers');
        }
        
        const teachers = usersResponse.data.filter(u => u.role === 'teacher');
        
        if (teachers.length === 0) {
            await showAlert(lang === 'uz' ? 'O\'qituvchilar topilmadi' : '–£—á–∏—Ç–µ–ª—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã', 'warning');
            return;
        }
        
        // Get current test
        const testResponse = await apiRequest(`/api/teacher-tests/${testId}`);
        const test = testResponse.data;
        const assignedIds = test.assignedTo || [];
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 600px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">${lang === 'uz' ? 'Testni tayinlash' : '–ù–∞–∑–Ω–∞—á–∏—Ç—å —Ç–µ—Å—Ç'}</h2>
                    <button class="modal-close" id="closeAssignModal">‚úï</button>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin: 0 0 0.5rem 0;">${test.title}</h4>
                    <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem;">${test.description}</p>
                </div>
                
                <form id="assignTestForm" style="display: grid; gap: 1rem;">
                    <div>
                        <label class="form-label">${lang === 'uz' ? 'O\'qituvchilarni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ —É—á–∏—Ç–µ–ª–µ–π'}</label>
                        <div style="max-height: 300px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem;">
                            ${teachers.map(teacher => `
                                <label style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 6px; cursor: pointer; transition: background 0.2s;" class="teacher-checkbox-label">
                                    <input type="checkbox" name="teachers" value="${teacher._id}" ${assignedIds.includes(teacher._id) ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: var(--primary);">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600;">${teacher.firstName} ${teacher.lastName}</div>
                                        <div style="font-size: 0.85rem; color: var(--text-muted);">${teacher.username}</div>
                                    </div>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1rem;">
                        <button type="button" class="button button-secondary" id="btnCancelAssign">${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}</button>
                        <button type="submit" class="button button-primary">${lang === 'uz' ? 'Tayinlash' : '–ù–∞–∑–Ω–∞—á–∏—Ç—å'}</button>
                    </div>
                </form>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
        
        // Add hover effects
        modal.querySelectorAll('.teacher-checkbox-label').forEach(label => {
            label.addEventListener('mouseenter', () => {
                label.style.background = 'var(--bg-secondary)';
            });
            label.addEventListener('mouseleave', () => {
                label.style.background = 'transparent';
            });
        });
        
        document.getElementById('closeAssignModal')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        });
        
        document.getElementById('btnCancelAssign')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        });
        
        document.getElementById('assignTestForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            const selectedTeachers = formData.getAll('teachers');
            
            if (selectedTeachers.length === 0) {
                await showAlert(lang === 'uz' ? 'Kamida bitta o\'qituvchi tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ–≥–æ —É—á–∏—Ç–µ–ª—è', 'warning');
                return;
            }
            
            try {
                const response = await apiRequest(`/api/teacher-tests/${testId}/assign`, 'POST', {
                    teacherIds: selectedTeachers
                });
                
                if (response.success) {
                    modal.classList.remove('show');
                    setTimeout(() => modal.remove(), 300);
                    await showAlert(lang === 'uz' ? 'Test muvaffaqiyatli tayinlandi' : '–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω', 'success');
                } else {
                    throw new Error(response.error);
                }
            } catch (error) {
                console.error('Error assigning test:', error);
                await showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            }
        });
        
    } catch (error) {
        console.error('Error loading teachers:', error);
        await showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    }
}


// Delete teacher test
async function deleteTeacherTest(testId) {
    const lang = store.getState().language;
    
    const confirmed = await showConfirm(
        lang === 'uz' ? 'Testni o\'chirmoqchimisiz?' : '–£–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç?',
        lang === 'uz' ? 'O\'chirish' : '–£–¥–∞–ª–µ–Ω–∏–µ'
    );
    
    if (!confirmed) return;
    
    try {
        const response = await apiRequest(`/api/teacher-tests/${testId}`, 'DELETE');
        
        if (response.success) {
            await loadTeacherTests();
            await showAlert(lang === 'uz' ? 'Test o\'chirildi' : '–¢–µ—Å—Ç —É–¥–∞–ª–µ–Ω', 'success');
        } else {
            throw new Error(response.error);
        }
    } catch (error) {
        console.error('Error deleting test:', error);
        await showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    }
}

// ============================================
// TEACHER TESTS - Teacher Interface
// ============================================

// Teacher: View assigned tests
async function renderTeacherMyTests() {
    const user = store.getState().user;
    const lang = store.getState().language;
    
    if (!user) {
        router.navigate('/login');
        return;
    }
    
    const content = `
        <div class="page-header">
            <div class="page-header-title">
                <h1>üìã ${lang === 'uz' ? 'Mening testlarim' : '–ú–æ–∏ —Ç–µ—Å—Ç—ã'}</h1>
                <p class="page-header-subtitle">${lang === 'uz' ? 'Sizga tayinlangan malaka baholash testlari' : '–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ –≤–∞–º —Ç–µ—Å—Ç—ã –Ω–∞ –æ—Ü–µ–Ω–∫—É –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π'}</p>
            </div>
            <div class="page-header-actions">
                <button class="back-button back-button--compact" id="btnBackToTeacher">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                </button>
            </div>
        </div>
        
        <div class="card">
            <div id="teacherMyTestsList">
                <div class="loading"><div class="spinner"></div></div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'teacher');
    
    document.getElementById('btnBackToTeacher')?.addEventListener('click', () => {
        router.navigate('/teacher/subjects');
    });
    
    await loadTeacherMyTests();
}

// Load teacher's assigned tests
async function loadTeacherMyTests() {
    const user = store.getState().user;
    const lang = store.getState().language;
    const container = document.getElementById('teacherMyTestsList');
    
    console.log('üë§ Current user:', user);
    const userId = user?._id || user?.id || user?.userId;
    console.log('üÜî User ID:', userId);
    
    if (!userId) {
        console.error('‚ùå User ID not found in user object:', user);
        await showAlert(lang === 'uz' ? 'Foydalanuvchi ma\'lumotlari topilmadi' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        router.navigate('/login');
        return;
    }
    
    try {
        // Get assigned tests
        const response = await apiRequest(`/api/teacher-tests/assigned/${userId}`);
        
        // Get teacher's results
        const resultsResponse = await apiRequest(`/api/teacher-test-results/teacher/${userId}`);
        const results = resultsResponse.success ? resultsResponse.data : [];
        const latestResults = results.reduce((acc, result) => {
            const current = acc[result.testId];
            if (!current || new Date(result.completedAt) > new Date(current.completedAt)) {
                acc[result.testId] = result;
            }
            return acc;
        }, {});
        
        if (!response.success || !response.data || response.data.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: var(--text-muted);">
                    <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.3;">üìù</div>
                    <p>${lang === 'uz' ? 'Sizga hali testlar tayinlanmagan' : '–í–∞–º –µ—â–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–µ—Å—Ç—ã'}</p>
                </div>
            `;
            return;
        }
        
        const tests = response.data;
        
        container.innerHTML = tests.map(test => {
            const testResult = latestResults[test._id];
            const isPassed = testResult?.passed;
            const score = testResult?.score || 0;
            
            return `
                <div class="card" style="margin-bottom: 1rem; border-left: 4px solid ${isPassed ? '#10b981' : testResult ? '#ef4444' : 'var(--primary)'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                <h3 style="margin: 0;">${test.title}</h3>
                                ${testResult ? `
                                    <span style="padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600; background: ${isPassed ? '#10b981' : '#ef4444'}; color: white;">
                                        ${isPassed ? (lang === 'uz' ? 'O\'tdi' : '–°–¥–∞–Ω') : (lang === 'uz' ? 'O\'tmadi' : '–ù–µ —Å–¥–∞–Ω')}
                                    </span>
                                ` : ''}
                            </div>
                            <p style="color: var(--text-muted); margin: 0 0 0.5rem 0;">${test.description}</p>
                            <div style="display: flex; gap: 1rem; font-size: 0.9rem; color: var(--text-muted);">
                                <span>üìù ${test.questionsCount || test.questions?.length || 0} ${lang === 'uz' ? 'ta savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                                <span>‚è±Ô∏è ${test.duration || 30} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω—É—Ç'}</span>
                                <span>üìä ${lang === 'uz' ? 'O\'tish bali' : '–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª'}: ${test.passingScore || 70}%</span>
                                ${testResult ? `<span>‚úÖ ${lang === 'uz' ? 'Ball' : '–†–µ–∑—É–ª—å—Ç–∞—Ç'}: ${score}%</span>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem;">
                            ${testResult ? `
                                <button class="button button-secondary" onclick="viewMyTestResult('${test._id}')" style="padding: 0.5rem 1rem;">
                                    <span>üìä</span>
                                    <span>${lang === 'uz' ? 'Natija' : '–†–µ–∑—É–ª—å—Ç–∞—Ç'}</span>
                                </button>
                                <button class="button button-primary" onclick="retakeTeacherTest('${test._id}')" style="padding: 0.5rem 1rem;">
                                    <span>üîÑ</span>
                                    <span>${lang === 'uz' ? 'Qayta topshirish' : '–ü–µ—Ä–µ—Å–¥–∞—Ç—å'}</span>
                                </button>
                            ` : `
                                <button class="button button-primary" onclick="startTeacherTest('${test._id}')" style="padding: 0.5rem 1rem;">
                                    <span>‚ñ∂Ô∏è</span>
                                    <span>${lang === 'uz' ? 'Boshlash' : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'}</span>
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading teacher tests:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #ef4444;">
                <p>${lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</p>
            </div>
        `;
    }
}

// Start teacher test
async function startTeacherTest(testId) {
    router.navigate(`/teacher/test/${testId}`);
}

// Retake teacher test
async function retakeTeacherTest(testId) {
    const lang = store.getState().language;
    const ok = await showConfirm(
        lang === 'uz' ? 'Testni qayta topshirishni xohlaysizmi?' : '–•–æ—Ç–∏—Ç–µ –ø–µ—Ä–µ—Å–¥–∞—Ç—å —Ç–µ—Å—Ç?',
        lang === 'uz' ? 'Test qayta boshlanadi' : '–¢–µ—Å—Ç –±—É–¥–µ—Ç –Ω–∞—á–∞—Ç –∑–∞–Ω–æ–≤–æ'
    );
    if (ok) {
        router.navigate(`/teacher/test/${testId}`);
    }
}

// View my test result
async function viewMyTestResult(testId) {
    const lang = store.getState().language;
    const user = store.getState().user;
    const teacherId = user?._id || user?.id || user?.userId;
    
    try {
        if (!teacherId) {
            await showAlert(lang === 'uz' ? 'Foydalanuvchi topilmadi' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
            return;
        }

        const resultsResponse = await apiRequest(`/api/teacher-test-results/teacher/${teacherId}`);
        const results = resultsResponse.data || [];
        const result = results
            .filter(r => r.testId === testId)
            .sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt))[0];
        
        if (!result) {
            await showAlert(lang === 'uz' ? 'Natija topilmadi' : '–†–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
            return;
        }
        
        const testResponse = await apiRequest(`/api/teacher-tests/${testId}`);
        const test = testResponse.data;
        
        if (!test) {
            await showAlert(lang === 'uz' ? 'Test topilmadi' : '–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
            return;
        }
        
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 700px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h2 style="margin: 0;">${lang === 'uz' ? 'Test natijasi' : '–†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞'}</h2>
                    <button class="modal-close" id="closeResultModal">‚úï</button>
                </div>
                
                <div style="text-align: center; padding: 2rem; background: ${result.passed ? 'linear-gradient(135deg, #10b981 0%, #059669 100%)' : 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)'}; color: white; border-radius: 12px; margin-bottom: 1.5rem;">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">${result.passed ? '‚úÖ' : '‚ùå'}</div>
                    <h3 style="margin: 0 0 0.5rem 0; color: white;">${test.title}</h3>
                    <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0;">${result.score}%</div>
                    <p style="margin: 0; opacity: 0.9;">
                        ${result.passed ? 
                            (lang === 'uz' ? 'Tabriklaymiz! Test muvaffaqiyatli topshirildi' : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–¥–∞–Ω') : 
                            (lang === 'uz' ? `O'tish bali: ${test.passingScore}%` : `–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${test.passingScore}%`)
                        }
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.8;">
                        ${new Date(result.completedAt).toLocaleString('ru-RU')}
                    </p>
                </div>
                
                <div style="background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px;">
                    <h4 style="margin: 0 0 1rem 0;">${lang === 'uz' ? 'Batafsil ma\'lumot' : '–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}</h4>
                    <div style="display: grid; gap: 0.75rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span>${lang === 'uz' ? 'Jami savollar' : '–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤'}:</span>
                            <strong>${test.questions?.length || 0}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>${lang === 'uz' ? 'To\'g\'ri javoblar' : '–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤'}:</span>
                            <strong style="color: #10b981;">${Math.round((result.score / 100) * test.questions.length)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>${lang === 'uz' ? 'Noto\'g\'ri javoblar' : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤'}:</span>
                            <strong style="color: #ef4444;">${test.questions.length - Math.round((result.score / 100) * test.questions.length)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>${lang === 'uz' ? 'O\'tish bali' : '–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª'}:</span>
                            <strong>${test.passingScore}%</strong>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                    ${!result.passed ? `
                        <button class="button button-primary" id="btnRetakeTest">
                            <span>üîÑ</span>
                            <span>${lang === 'uz' ? 'Qayta topshirish' : '–ü–µ—Ä–µ—Å–¥–∞—Ç—å'}</span>
                        </button>
                    ` : ''}
                    <button class="button button-secondary" id="btnCloseResult">${lang === 'uz' ? 'Yopish' : '–ó–∞–∫—Ä—ã—Ç—å'}</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        setTimeout(() => modal.classList.add('show'), 10);
        
        document.getElementById('closeResultModal')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        });
        
        document.getElementById('btnCloseResult')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
        });
        
        document.getElementById('btnRetakeTest')?.addEventListener('click', () => {
            modal.classList.remove('show');
            setTimeout(() => modal.remove(), 300);
            retakeTeacherTest(testId);
        });
        
    } catch (error) {
        console.error('Error viewing result:', error);
        await showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    }
}

// Render teacher test taking page
async function renderTeacherTestTaking() {
    const user = store.getState().user;
    const lang = store.getState().language;
    const testId = router.currentParams.id;
    
    if (!user || !testId) {
        router.navigate('/teacher/tests');
        return;
    }
    
    try {
        const response = await apiRequest(`/api/teacher-tests/${testId}`);
        
        if (!response.success || !response.data) {
            showAlert(lang === 'uz' ? 'Test topilmadi' : '–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'warning');
            router.navigate('/teacher/tests');
            return;
        }
        
        const test = response.data;
        const questions = test.questions || [];
        
        const content = `
            <div class="page-header" style="background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; padding: 2rem; margin: -2rem -2rem 2rem -2rem; border-radius: 0 0 20px 20px;">
                <h1 style="margin: 0 0 0.5rem 0; color: white;">üìã ${test.title}</h1>
                <p style="margin: 0 0 1rem 0; opacity: 0.9;">${test.description}</p>
                <div style="display: flex; gap: 2rem; font-size: 0.95rem; opacity: 0.95;">
                    <span>‚è±Ô∏è ${test.duration} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω—É—Ç'}</span>
                    <span>üìù ${questions.length} ${lang === 'uz' ? 'ta savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                    <span>üìä ${lang === 'uz' ? 'O\'tish' : '–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª'}: ${test.passingScore}%</span>
                </div>
            </div>
            
            <div class="card" style="margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);">
                    <div>
                        <h3 style="margin: 0;">${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å'} <span id="currentQuestion">1</span> / ${questions.length}</h3>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--primary);" id="timer">
                            ${test.duration}:00
                        </div>
                    </div>
                </div>
                
                <div id="questionContainer">
                    <!-- Questions will be rendered here -->
                </div>
                
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid var(--border-color);">
                    <button class="button button-secondary" id="btnPrevQuestion" disabled>
                        <span>‚Üê</span>
                        <span>${lang === 'uz' ? 'Oldingi' : '–ù–∞–∑–∞–¥'}</span>
                    </button>
                    
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;">
                        ${questions.map((_, index) => `
                            <button class="question-nav-btn ${index === 0 ? 'active' : ''}" data-question="${index}" style="width: 40px; height: 40px; border-radius: 8px; border: 2px solid var(--border-color); background: var(--bg-secondary); cursor: pointer; font-weight: 600; transition: all 0.2s;">
                                ${index + 1}
                            </button>
                        `).join('')}
                    </div>
                    
                    <button class="button button-primary" id="btnNextQuestion">
                        <span>${lang === 'uz' ? 'Keyingi' : '–î–∞–ª–µ–µ'}</span>
                        <span>‚Üí</span>
                    </button>
                </div>
            </div>
            
            <div style="text-align: center;">
                <button class="button" id="btnFinishTest" style="background: #10b981; color: white; padding: 1rem 2rem; font-size: 1.1rem;">
                    <span>‚úÖ</span>
                    <span>${lang === 'uz' ? 'Testni yakunlash' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç'}</span>
                </button>
            </div>
        `;
        
        renderLayout(content, 'teacher');
        
        // Initialize test taking
        initializeTeacherTest(test);
        
    } catch (error) {
        console.error('Error loading test:', error);
        showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
        router.navigate('/teacher/tests');
    }
}

// Initialize teacher test taking
function initializeTeacherTest(test) {
    const lang = store.getState().language;
    const questions = test.questions || [];
    let currentQuestionIndex = 0;
    const answers = new Array(questions.length).fill(null);
    
    // Timer
    let timeLeft = test.duration * 60; // Convert to seconds
    const timerEl = document.getElementById('timer');
    
    const timerInterval = setInterval(() => {
        timeLeft--;
        const minutes = Math.floor(timeLeft / 60);
        const seconds = timeLeft % 60;
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            submitTeacherTest(test._id, answers, test);
        }
    }, 1000);
    
    // Render question
    function renderQuestion(index) {
        const question = questions[index];
        const container = document.getElementById('questionContainer');
        
        container.innerHTML = `
            <div style="margin-bottom: 2rem;">
                <h3 style="font-size: 1.25rem; line-height: 1.6; margin-bottom: 1.5rem;">${question.text}</h3>
                <div style="display: grid; gap: 1rem;">
                    ${question.options.map((option, optIndex) => `
                        <label class="test-option ${answers[index] === optIndex ? 'selected' : ''}" style="display: flex; align-items: center; gap: 1rem; padding: 1.25rem; background: var(--bg-secondary); border: 2px solid ${answers[index] === optIndex ? 'var(--primary)' : 'var(--border-color)'}; border-radius: 12px; cursor: pointer; transition: all 0.2s;">
                            <input type="radio" name="question_${index}" value="${optIndex}" ${answers[index] === optIndex ? 'checked' : ''} style="width: 20px; height: 20px; accent-color: var(--primary);">
                            <span style="flex: 1; font-size: 1.05rem;">${String.fromCharCode(65 + optIndex)}. ${option}</span>
                        </label>
                    `).join('')}
                </div>
            </div>
        `;
        
        // Add change listeners
        container.querySelectorAll('input[type="radio"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                answers[index] = parseInt(e.target.value);
                updateQuestionNavigation();
                renderQuestion(index); // Re-render to update styling
            });
        });
        
        document.getElementById('currentQuestion').textContent = index + 1;
        updateNavigationButtons();
        updateQuestionNavigation();
    }
    
    function updateNavigationButtons() {
        document.getElementById('btnPrevQuestion').disabled = currentQuestionIndex === 0;
        
        const nextBtn = document.getElementById('btnNextQuestion');
        if (currentQuestionIndex === questions.length - 1) {
            nextBtn.style.display = 'none';
        } else {
            nextBtn.style.display = 'flex';
        }
    }
    
    function updateQuestionNavigation() {
        document.querySelectorAll('.question-nav-btn').forEach((btn, index) => {
            btn.classList.remove('active');
            if (index === currentQuestionIndex) {
                btn.classList.add('active');
                btn.style.background = 'var(--primary)';
                btn.style.color = 'white';
                btn.style.borderColor = 'var(--primary)';
            } else if (answers[index] !== null) {
                btn.style.background = '#10b981';
                btn.style.color = 'white';
                btn.style.borderColor = '#10b981';
            } else {
                btn.style.background = 'var(--bg-secondary)';
                btn.style.color = 'var(--text-primary)';
                btn.style.borderColor = 'var(--border-color)';
            }
        });
    }
    
    // Navigation
    document.getElementById('btnPrevQuestion')?.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion(currentQuestionIndex);
        }
    });
    
    document.getElementById('btnNextQuestion')?.addEventListener('click', () => {
        if (currentQuestionIndex < questions.length - 1) {
            currentQuestionIndex++;
            renderQuestion(currentQuestionIndex);
        }
    });
    
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            currentQuestionIndex = parseInt(btn.dataset.question);
            renderQuestion(currentQuestionIndex);
        });
    });
    
    document.getElementById('btnFinishTest')?.addEventListener('click', () => {
        const unanswered = answers.filter(a => a === null).length;
        if (unanswered > 0) {
            if (!confirm(`${lang === 'uz' ? `${unanswered} ta savolga javob berilmagan. Testni yakunlashni xohlaysizmi?` : `–ù–µ –æ—Ç–≤–µ—á–µ–Ω–æ ${unanswered} –≤–æ–ø—Ä–æ—Å–æ–≤. –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?`}`)) {
                return;
            }
        }
        clearInterval(timerInterval);
        submitTeacherTest(test._id, answers, test);
    });
    
    // Initial render
    renderQuestion(0);
}

// Submit teacher test
async function submitTeacherTest(testId, answers, test) {
    const lang = store.getState().language;
    const user = store.getState().user;
    
    console.log('üì§ Submitting teacher test:', { testId, user });
    const userId = user?._id || user?.id || user?.userId;
    console.log('üÜî Teacher ID:', userId);
    
    if (!userId) {
        console.error('‚ùå User ID not found');
        await showAlert(lang === 'uz' ? 'Foydalanuvchi ma\'lumotlari topilmadi' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
        return;
    }
    
    try {
        // Calculate score
        let correctAnswers = 0;
        test.questions.forEach((question, index) => {
            if (answers[index] === question.correctAnswer) {
                correctAnswers++;
            }
        });
        
        const score = Math.round((correctAnswers / test.questions.length) * 100);
        const passed = score >= test.passingScore;
        
        console.log('üìä Test results:', { score, passed, correctAnswers, total: test.questions.length });
        
        // Submit result
        const response = await apiRequest('/api/teacher-test-results', 'POST', {
            testId,
            teacherId: userId,
            answers,
            score,
            passed
        });
        
        console.log('üì§ Submit response:', response);
        
        if (response.success) {
            // Show result modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div style="text-align: center; padding: 2rem;">
                        <div style="font-size: 5rem; margin-bottom: 1rem;">${passed ? 'üéâ' : 'üòî'}</div>
                        <h2 style="margin: 0 0 1rem 0; color: ${passed ? '#10b981' : '#ef4444'};">
                            ${passed ? 
                                (lang === 'uz' ? 'Tabriklaymiz!' : '–ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º!') : 
                                (lang === 'uz' ? 'Afsuski...' : '–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é...')
                            }
                        </h2>
                        <div style="font-size: 3rem; font-weight: bold; margin: 1rem 0; color: ${passed ? '#10b981' : '#ef4444'};">
                            ${score}%
                        </div>
                        <p style="font-size: 1.1rem; color: var(--text-muted); margin-bottom: 2rem;">
                            ${passed ? 
                                (lang === 'uz' ? 'Test muvaffaqiyatli topshirildi!' : '–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–¥–∞–Ω!') : 
                                (lang === 'uz' ? `O'tish bali: ${test.passingScore}%` : `–ü—Ä–æ—Ö–æ–¥–Ω–æ–π –±–∞–ª–ª: ${test.passingScore}%`)
                            }
                        </p>
                        <button class="button button-primary" id="btnBackToTests" style="padding: 1rem 2rem; font-size: 1.1rem;">
                            <span>${lang === 'uz' ? 'Testlarga qaytish' : '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–∞–º'}</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('btnBackToTests')?.addEventListener('click', () => {
                modal.remove();
                router.navigate('/teacher/tests');
            });
        } else {
            throw new Error(response.error);
        }
        
    } catch (error) {
        console.error('Error submitting test:', error);
        showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
    }
}



// Interest Test Page
async function renderInterestTest() {
    const lang = store.getState().language;
    
    // Enhanced questions mapped to 6 main interest categories
    const questions = [
        // Math & Logic (6 questions)
        { uz: 'Men matematika va hisob-kitoblarni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è', category: 'math' },
        { uz: 'Men mantiqiy muammolarni hal qilishni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–µ—à–∞—Ç—å –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏', category: 'math' },
        { uz: 'Men sonlar va formulalar bilan ishlashni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å —á–∏—Å–ª–∞–º–∏ –∏ —Ñ–æ—Ä–º—É–ª–∞–º–∏', category: 'math' },
        { uz: 'Men murakkab masalalarni bosqichma-bosqich yechishni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–µ—à–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ –∑–∞–¥–∞—á–∏ —à–∞–≥ –∑–∞ —à–∞–≥–æ–º', category: 'math' },
        { uz: 'Men mantiqiy fikrlashni talab qiladigan o\'yinlarni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤—è—Ç—Å—è –∏–≥—Ä—ã, —Ç—Ä–µ–±—É—é—â–∏–µ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è', category: 'math' },
        
        // Science & Nature (6 questions)
        { uz: 'Men tabiatni o\'rganishni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∏–∑—É—á–∞—Ç—å –ø—Ä–∏—Ä–æ–¥—É', category: 'science' },
        { uz: 'Men fizika va kimyo tajribalarini yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤—è—Ç—Å—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏–µ –∏ —Ö–∏–º–∏—á–µ—Å–∫–∏–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã', category: 'science' },
        { uz: 'Men hayotni va tirik mavjudotlarni o\'rganishni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∏–∑—É—á–∞—Ç—å –∂–∏–∑–Ω—å –∏ –∂–∏–≤—ã–µ —Å—É—â–µ—Å—Ç–≤–∞', category: 'science' },
        { uz: 'Men tabiat hodisalarining sabablarini bilishni istayman', ru: '–ú–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —É–∑–Ω–∞–≤–∞—Ç—å –ø—Ä–∏—á–∏–Ω—ã –ø—Ä–∏—Ä–æ–¥–Ω—ã—Ö —è–≤–ª–µ–Ω–∏–π', category: 'science' },
        { uz: 'Men ilmiy faktlar va kashfiyotlar haqida o\'qishni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —á–∏—Ç–∞—Ç—å –æ –Ω–∞—É—á–Ω—ã—Ö —Ñ–∞–∫—Ç–∞—Ö –∏ –æ—Ç–∫—Ä—ã—Ç–∏—è—Ö', category: 'science' },
        
        // Technology & Engineering (6 questions)
        { uz: 'Men kompyuterlar va texnologiyalar bilan ishlashni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å –∫–æ–º–ø—å—é—Ç–µ—Ä–∞–º–∏ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º–∏', category: 'tech' },
        { uz: 'Men dasturlash va kodlashni o\'rganishni xohlayman', ru: '–Ø —Ö–æ—á—É –∏–∑—É—á–∞—Ç—å –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ', category: 'tech' },
        { uz: 'Men texnik qurilmalarni yaratish va ta\'mirlashni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏ —á–∏–Ω–∏—Ç—å —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞', category: 'tech' },
        { uz: 'Men yangi ilovalar va texnik yechimlarni sinab ko\'raman', ru: '–ú–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ –ø—Ä–æ–±–æ–≤–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è', category: 'tech' },
        { uz: 'Men robotlar yoki mexanizmlar qanday ishlashini bilishni xohlayman', ru: '–ú–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞—é—Ç —Ä–æ–±–æ—Ç—ã –∏ –º–µ—Ö–∞–Ω–∏–∑–º—ã', category: 'tech' },
        
        // Arts & Creativity (6 questions)
        { uz: 'Men rasmchilik va ijodiy ishlarni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∏—Å–æ–≤–∞–Ω–∏–µ –∏ —Ç–≤–æ—Ä—á–µ—Å–∫–∞—è —Ä–∞–±–æ—Ç–∞', category: 'art' },
        { uz: 'Men musiqa va san\'atni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –º—É–∑—ã–∫–∞ –∏ –∏—Å–∫—É—Å—Å—Ç–≤–æ', category: 'art' },
        { uz: 'Men o\'zimning g\'oyalarimni ijodiy usulda ifodalashni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–≤–æ—Ä—á–µ—Å–∫–∏ –≤—ã—Ä–∞–∂–∞—Ç—å —Å–≤–æ–∏ –∏–¥–µ–∏', category: 'art' },
        { uz: 'Men dizayn va bezaklar bilan ishlashni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å —Å –¥–∏–∑–∞–π–Ω–æ–º –∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ–º', category: 'art' },
        { uz: 'Men yangi g\'oyalar yaratishdan zavqlanaman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å –Ω–æ–≤—ã–µ –∏–¥–µ–∏', category: 'art' },
        
        // Social & Communication (6 questions)
        { uz: 'Men odamlar bilan muloqot qilishni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –æ–±—â–∞—Ç—å—Å—è —Å –ª—é–¥—å–º–∏', category: 'social' },
        { uz: 'Men boshqalarga yordam berishni va ularni qo\'llab-quvvatlashni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –ø–æ–º–æ–≥–∞—Ç—å –¥—Ä—É–≥–∏–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –∏—Ö', category: 'social' },
        { uz: 'Men jamoa bilan ishlashni va hamkorlikni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –∫–æ–º–∞–Ω–¥–µ –∏ —Å–æ—Ç—Ä—É–¥–Ω–∏—á–∞—Ç—å', category: 'social' },
        { uz: 'Men jamoada yetakchi bo\'lishni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –±—ã—Ç—å –ª–∏–¥–µ—Ä–æ–º –≤ –∫–æ–º–∞–Ω–¥–µ', category: 'social' },
        { uz: 'Men odamlarning fikrlarini tinglash va murosaga kelishni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–ª—É—à–∞—Ç—å –ª—é–¥–µ–π –∏ –Ω–∞—Ö–æ–¥–∏—Ç—å –∫–æ–º–ø—Ä–æ–º–∏—Å—Å', category: 'social' },
        
        // Languages & Literature (6 questions)
        { uz: 'Men kitob o\'qishni va yozishni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —á–∏—Ç–∞—Ç—å –∏ –ø–∏—Å–∞—Ç—å', category: 'language' },
        { uz: 'Men tillarni o\'rganishni qiziqarli deb bilaman', ru: '–Ø –Ω–∞—Ö–æ–∂—É –∏–∑—É—á–µ–Ω–∏–µ —è–∑—ã–∫–æ–≤ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–º', category: 'language' },
        { uz: 'Men hikoyalar yaratishni va she\'rlar yozishni yaxshi ko\'raman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è —Å–æ—á–∏–Ω—è—Ç—å –∏—Å—Ç–æ—Ä–∏–∏ –∏ –ø–∏—Å–∞—Ç—å —Å—Ç–∏—Ö–∏', category: 'language' },
        { uz: 'Men so\'z boyligimni oshirishni istayman', ru: '–ú–Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ —Ä–∞—Å—à–∏—Ä—è—Ç—å —Å–ª–æ–≤–∞—Ä–Ω—ã–π –∑–∞–ø–∞—Å', category: 'language' },
        { uz: 'Men matnlarni tahlil qilish va tushunishni yoqtiraman', ru: '–ú–Ω–µ –Ω—Ä–∞–≤–∏—Ç—Å—è –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–Ω–∏–º–∞—Ç—å —Ç–µ–∫—Å—Ç—ã', category: 'language' }
    ];
    
    const content = `
        <div class="page-header">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1>${t('interestTest')}</h1>
                    <p>${lang === 'uz' ? 'Qobiliyat va qiziqishlaringizni aniqlang' : '–û–ø—Ä–µ–¥–µ–ª–∏—Ç–µ —Å–≤–æ–∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã'}</p>
                </div>
                <button class="back-button" id="btnBackFromInterestTest">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                </button>
            </div>
        </div>
        
        <div class="card" id="interestTestContainer">
            <div id="testIntro">
                <h3>${lang === 'uz' ? 'Testni boshlash' : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'}</h3>
                <p style="margin-bottom: 1rem;">${lang === 'uz' ? 'Ushbu test sizning qiziqishlaringiz va qobiliyatlaringizni aniqlashga yordam beradi. Har bir savolga 1 dan 5 gacha baho bering:' : '–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø–æ–º–æ–∂–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏. –û—Ü–µ–Ω–∏—Ç–µ –∫–∞–∂–¥—ã–π –≤–æ–ø—Ä–æ—Å –æ—Ç 1 –¥–æ 5:'}</p>
                <ul style="margin-bottom: 1.5rem; margin-left: 1.5rem;">
                    <li><strong>1</strong> - ${lang === 'uz' ? 'Umuman qiziqtirmaydi' : '–°–æ–≤—Å–µ–º –Ω–µ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç'}</li>
                    <li><strong>2</strong> - ${lang === 'uz' ? 'Kam qiziqtiradi' : '–ú–∞–ª–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç'}</li>
                    <li><strong>3</strong> - ${lang === 'uz' ? 'O\'rtacha' : '–°—Ä–µ–¥–Ω–µ'}</li>
                    <li><strong>4</strong> - ${lang === 'uz' ? 'Qiziqtiradi' : '–ò–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç'}</li>
                    <li><strong>5</strong> - ${lang === 'uz' ? 'Juda qiziqtiradi' : '–û—á–µ–Ω—å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç'}</li>
                </ul>
                <button id="btnStartInterestTest" class="button button-primary">
                    ${lang === 'uz' ? 'Testni boshlash' : '–ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç'}
                </button>
            </div>
            <div id="testQuestions" style="display: none;">
                <div style="background: var(--bg-tertiary); padding: 1rem; border-radius: 8px; margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span>${lang === 'uz' ? 'Savol:' : '–í–æ–ø—Ä–æ—Å:'} <strong id="currentQuestion">1</strong> / ${questions.length}</span>
                        <span id="progressPercentage">0%</span>
                    </div>
                    <div style="background: var(--bg-primary); height: 8px; border-radius: 4px; margin-top: 0.5rem; overflow: hidden;">
                        <div id="progressBar" style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s;"></div>
                    </div>
                </div>
                <form id="interestTestForm">
                    ${questions.map((q, index) => `
                        <div class="question-item" data-question="${index}" style="display: ${index === 0 ? 'block' : 'none'}; margin-bottom: 2rem; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px;">
                            <p style="margin-bottom: 1.5rem; font-weight: 500; font-size: 1rem; line-height: 1.5;">${index + 1}. ${lang === 'uz' ? q.uz : q.ru}</p>
                            <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                ${[1, 2, 3, 4, 5].map(val => `
                                    <label style="cursor: pointer; padding: 0.75rem 0.5rem; background: var(--bg-primary); border-radius: 8px; border: 2px solid transparent; transition: all 0.2s; min-width: 50px; flex: 1; max-width: 80px; text-align: center;" class="radio-option">
                                        <input type="radio" name="q${index}" value="${val}" data-category="${q.category}" required style="display: none;" />
                                        <div style="font-size: 1.25rem; font-weight: 600;">${val}</div>
                                        <div style="font-size: 0.7rem; margin-top: 0.25rem; color: var(--text-secondary);">
                                            ${val === 1 ? (lang === 'uz' ? 'Yo\'q' : '–ù–µ—Ç') : val === 3 ? (lang === 'uz' ? 'O\'rtacha' : '–°—Ä–µ–¥–Ω–µ') : val === 5 ? (lang === 'uz' ? 'Ha' : '–î–∞') : ''}
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 0.75rem; margin-top: 2rem; flex-wrap: wrap;">
                                ${index > 0 ? `<button type="button" class="button button-secondary prev-question" style="flex: 1; min-width: 120px;">${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</button>` : ''}
                                ${index < questions.length - 1 ? 
                                    `<button type="button" class="button button-primary next-question" style="flex: 1; min-width: 120px;" disabled>${lang === 'uz' ? 'Keyingi' : '–î–∞–ª–µ–µ'}</button>` :
                                    `<button type="submit" class="button button-primary" id="btnSubmitInterestTest" style="flex: 1; min-width: 120px;" disabled>${lang === 'uz' ? 'Natijalarni ko\'rish' : '–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</button>`
                                }
                            </div>
                        </div>
                    `).join('')}
                </form>
            </div>
            <div id="testResults" style="display: none;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="color: var(--text-primary); margin-bottom: 0.5rem; margin-top: 5rem; font-size: 1.75rem;">
                        ${lang === 'uz' ? 'üéâ Test natijalari' : 'üéâ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞'}
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 1rem;">
                        ${lang === 'uz' ? 'Sizning qiziqishlaringiz va qobiliyatlaringiz profili' : '–ü—Ä–æ—Ñ–∏–ª—å –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –∏ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–µ–π'}
                    </p>
                </div>
                
                <div class="radar-chart-wrap" style="max-width: 700px; margin: 0 auto 2rem; padding: 1.5rem; background: var(--bg-tertiary); border-radius: 16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                    <canvas id="interestRadarChart"></canvas>
                </div>
                <div id="categoryDescriptions"></div>
                <div style="margin-top: 2rem; text-align: center; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button id="btnRetakeTest" class="button button-secondary" style="min-width: 150px;">
                        ${lang === 'uz' ? 'Qayta topshirish' : '–ü—Ä–æ–π—Ç–∏ —Å–Ω–æ–≤–∞'}
                    </button>
                    <button id="btnBackToDashboard" class="button button-primary" style="min-width: 150px;">
                        ${lang === 'uz' ? 'Bosh sahifaga' : '–ù–∞ –≥–ª–∞–≤–Ω—É—é'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'student');
    
    // Add back button event listener
    const btnBack = document.getElementById('btnBackFromInterestTest');
    if (btnBack) {
        btnBack.addEventListener('click', () => router.navigate('/student/dashboard'));
    }
    
    // Check if user already has saved results
    try {
        const response = await apiRequest('/api/interest-results');
        if (response.success && response.data && response.data.categories) {
            // User has completed the test, show results directly
            displayInterestResults(response.data.categories);
            return;
        }
    } catch (error) {
        console.error('Error loading saved interest test results:', error);
    }
    
    // Initialize test functionality if no saved results
    initInterestTest(questions);
}

function initInterestTest(questions) {
    const lang = store.getState().language;
    let currentQuestionIndex = 0;
    const answers = {};
    
    // Start test button
    const btnStart = document.getElementById('btnStartInterestTest');
    if (btnStart) {
        btnStart.addEventListener('click', () => {
            document.getElementById('testIntro').style.display = 'none';
            document.getElementById('testQuestions').style.display = 'block';
            updateProgress();
        });
    }
    
    // Radio option styling
    document.querySelectorAll('.radio-option').forEach(label => {
        label.addEventListener('click', function() {
            const input = this.querySelector('input[type="radio"]');
            const questionDiv = this.closest('.question-item');
            const questionIndex = parseInt(questionDiv.dataset.question);
            
            // Remove selected class from all options in this question
            questionDiv.querySelectorAll('.radio-option').forEach(opt => {
                opt.style.borderColor = 'transparent';
                opt.style.background = 'var(--bg-primary)';
            });
            
            // Add selected class to clicked option
            this.style.borderColor = '#667eea';
            this.style.background = 'rgba(102, 126, 234, 0.1)';
            
            // Save answer
            answers[`q${questionIndex}`] = {
                value: parseInt(input.value),
                category: input.dataset.category
            };
            
            // Enable next/submit button
            const nextBtn = questionDiv.querySelector('.next-question');
            const submitBtn = document.getElementById('btnSubmitInterestTest');
            if (nextBtn) nextBtn.disabled = false;
            if (submitBtn) submitBtn.disabled = false;
            
            updateProgress();
        });
    });
    
    // Next question buttons
    document.querySelectorAll('.next-question').forEach(btn => {
        btn.addEventListener('click', () => {
            const currentQuestion = document.querySelector(`.question-item[data-question="${currentQuestionIndex}"]`);
            currentQuestion.style.display = 'none';
            currentQuestionIndex++;
            const nextQuestion = document.querySelector(`.question-item[data-question="${currentQuestionIndex}"]`);
            nextQuestion.style.display = 'block';
            updateProgress();
        });
    });
    
    // Previous question buttons
    document.querySelectorAll('.prev-question').forEach(btn => {
        btn.addEventListener('click', () => {
            const currentQuestion = document.querySelector(`.question-item[data-question="${currentQuestionIndex}"]`);
            currentQuestion.style.display = 'none';
            currentQuestionIndex--;
            const prevQuestion = document.querySelector(`.question-item[data-question="${currentQuestionIndex}"]`);
            prevQuestion.style.display = 'block';
            updateProgress();
        });
    });
    
    // Update progress bar
    function updateProgress() {
        const answeredCount = Object.keys(answers).length;
        const percentage = Math.round((answeredCount / questions.length) * 100);
        document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
        document.getElementById('progressPercentage').textContent = percentage + '%';
        document.getElementById('progressBar').style.width = percentage + '%';
    }
    
    // Form submission
    const form = document.getElementById('interestTestForm');
    if (form) {
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Calculate category scores
            const categoryScores = {};
            Object.values(answers).forEach(answer => {
                if (!categoryScores[answer.category]) {
                    categoryScores[answer.category] = { total: 0, count: 0 };
                }
                categoryScores[answer.category].total += answer.value;
                categoryScores[answer.category].count++;
            });
            
            // Calculate averages
            const categories = {};
            Object.keys(categoryScores).forEach(cat => {
                categories[cat] = Math.round((categoryScores[cat].total / categoryScores[cat].count) * 20); // Convert to 0-100 scale
            });
            
            // Save results to server (silently)
            try {
                const response = await apiRequest('/api/interest-results', {
                    method: 'POST',
                    body: JSON.stringify({
                        results: answers,
                        categories: categories
                    })
                });

                if (response.success) {
                    console.log('‚úÖ Interest test results saved successfully');
                }
            } catch (error) {
                console.error('Error saving interest test results:', error);
                // Don't show alert - save silently
            }
            
            // Display results regardless of save success
            displayInterestResults(categories);
        });
    }
}

function displayInterestResults(categories) {
    const lang = store.getState().language;
    
    // Hide form, show results
    document.getElementById('testQuestions').style.display = 'none';
    document.getElementById('testResults').style.display = 'block';
    
    // Subject recommendations based on interests
    const subjectRecommendations = {
        math: {
            subjects: [
                { 
                    nameRu: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', 
                    nameUz: 'Matematika',
                    icon: 'üî¢',
                    reasonRu: '–í–∞—à–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∏ –∏–Ω—Ç–µ—Ä–µ—Å –∫ —á–∏—Å–ª–∞–º –¥–µ–ª–∞—é—Ç –º–∞—Ç–µ–º–∞—Ç–∏–∫—É –∏–¥–µ–∞–ª—å–Ω—ã–º –≤—ã–±–æ—Ä–æ–º',
                    reasonUz: 'Mantiqiy qobiliyatingiz va sonlarga qiziqish matematikani ideal tanlov qiladi'
                },
                { 
                    nameRu: '–§–∏–∑–∏–∫–∞', 
                    nameUz: 'Fizika',
                    icon: '‚öõÔ∏è',
                    reasonRu: '–§–∏–∑–∏–∫–∞ —Ç—Ä–µ–±—É–µ—Ç —Å–∏–ª—å–Ω—ã—Ö –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≤—ã–∫–æ–≤ –∏ –ª–æ–≥–∏—á–µ—Å–∫–æ–≥–æ –º—ã—à–ª–µ–Ω–∏—è',
                    reasonUz: 'Fizika kuchli matematika ko\'nikmalarini va mantiqiy fikrlashni talab qiladi'
                }
            ]
        },
        science: {
            subjects: [
                { 
                    nameRu: '–ë–∏–æ–ª–æ–≥–∏—è', 
                    nameUz: 'Biologiya',
                    icon: 'üß¨',
                    reasonRu: '–í–∞—à –∏–Ω—Ç–µ—Ä–µ—Å –∫ –ø—Ä–∏—Ä–æ–¥–µ –∏ –∂–∏–≤—ã–º –æ—Ä–≥–∞–Ω–∏–∑–º–∞–º –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è –±–∏–æ–ª–æ–≥–∏–∏',
                    reasonUz: 'Tabiat va tirik organizmlar haqidagi qiziqishingiz biologiya uchun ideal'
                },
                { 
                    nameRu: '–•–∏–º–∏—è', 
                    nameUz: 'Kimyo',
                    icon: 'üß™',
                    reasonRu: '–•–∏–º–∏—è –æ—Ç–∫—Ä–æ–µ—Ç –≤–∞–º –º–∏—Ä –Ω–∞—É—á–Ω—ã—Ö —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–æ–≤ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π',
                    reasonUz: 'Kimyo sizga ilmiy tajribalar va tadqiqotlar dunyosini ochadi'
                }
            ]
        },
        tech: {
            subjects: [
                { 
                    nameRu: '–ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞', 
                    nameUz: 'Informatika',
                    icon: 'üíª',
                    reasonRu: '–í–∞—à–∏ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è',
                    reasonUz: 'Texnik ko\'nikmalaringiz dasturlash uchun juda mos'
                },
                { 
                    nameRu: '–§–∏–∑–∏–∫–∞', 
                    nameUz: 'Fizika',
                    icon: '‚öõÔ∏è',
                    reasonRu: '–§–∏–∑–∏–∫–∞ - –æ—Å–Ω–æ–≤–∞ –≤—Å–µ—Ö —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π',
                    reasonUz: 'Fizika - barcha zamonaviy texnologiyalarning asosi'
                }
            ]
        },
        art: {
            subjects: [
                { 
                    nameRu: '–ò–∑–æ–±—Ä–∞–∑–∏—Ç–µ–ª—å–Ω–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ', 
                    nameUz: 'Tasviriy san\'at',
                    icon: 'üé®',
                    reasonRu: '–†–∞–∑–≤–∏–≤–∞–π—Ç–µ —Å–≤–æ–π —Ç–≤–æ—Ä—á–µ—Å–∫–∏–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —á–µ—Ä–µ–∑ –∏—Å–∫—É—Å—Å—Ç–≤–æ',
                    reasonUz: 'San\'at orqali ijodiy salohiyatingizni rivojlantiring'
                },
                { 
                    nameRu: '–ú—É–∑—ã–∫–∞', 
                    nameUz: 'Musiqa',
                    icon: 'üéµ',
                    reasonRu: '–ú—É–∑—ã–∫–∞ –ø–æ–º–æ–∂–µ—Ç –≤—ã—Ä–∞–∑–∏—Ç—å –≤–∞—à—É –∫—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å',
                    reasonUz: 'Musiqa ijodkorligingizni ifodalashga yordam beradi'
                }
            ]
        },
        social: {
            subjects: [
                { 
                    nameRu: '–ò—Å—Ç–æ—Ä–∏—è', 
                    nameUz: 'Tarix',
                    icon: 'üìú',
                    reasonRu: '–ò—Å—Ç–æ—Ä–∏—è –ø–æ–º–æ–∂–µ—Ç –ø–æ–Ω—è—Ç—å –æ–±—â–µ—Å—Ç–≤–æ –∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
                    reasonUz: 'Tarix jamiyat va inson munosabatlarini tushunishga yordam beradi'
                },
                { 
                    nameRu: '–û–±—â–µ—Å—Ç–≤–æ–∑–Ω–∞–Ω–∏–µ', 
                    nameUz: 'Jamiyatshunoslik',
                    icon: 'üë•',
                    reasonRu: '–ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ä–∞–∑–≤–∏—Ç–∏—è —Å–æ—Ü–∏–∞–ª—å–Ω—ã—Ö –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ç–∏–≤–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤',
                    reasonUz: 'Ijtimoiy va kommunikativ ko\'nikmalarni rivojlantirish uchun ideal'
                }
            ]
        },
        language: {
            subjects: [
                { 
                    nameRu: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', 
                    nameUz: 'Adabiyot',
                    icon: 'üìö',
                    reasonRu: '–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞ —Ä–∞–∑–≤–∏–≤–∞–µ—Ç —è–∑—ã–∫–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ –∏ –≤–æ–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                    reasonUz: 'Adabiyot til ko\'nikmalarini va tasavvurni rivojlantiradi'
                },
                { 
                    nameRu: '–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∏', 
                    nameUz: 'Chet tillar',
                    icon: 'üåç',
                    reasonRu: '–í–∞—à–∞ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å –∫ —è–∑—ã–∫–∞–º –æ—Ç–∫—Ä–æ–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏',
                    reasonUz: 'Tillar haqidagi qobiliyatingiz yangi imkoniyatlarni ochadi'
                }
            ]
        }
    };
    
    // Category labels and descriptions
    const categoryInfo = {
        math: {
            uz: { name: 'Matematika va Mantiq', desc: 'Sizda matematika va mantiqiy fikrlash qobiliyati kuchli' },
            ru: { name: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –∏ –õ–æ–≥–∏–∫–∞', desc: '–£ –≤–∞—Å —Å–∏–ª—å–Ω—ã–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫ –º–∞—Ç–µ–º–∞—Ç–∏–∫–µ –∏ –ª–æ–≥–∏—á–µ—Å–∫–æ–º—É –º—ã—à–ª–µ–Ω–∏—é' }
        },
        science: {
            uz: { name: 'Fan va Tabiat', desc: 'Sizda tabiatni o\'rganish va ilmiy tadqiqotlarga qiziqish yuqori' },
            ru: { name: '–ù–∞—É–∫–∞ –∏ –ü—Ä–∏—Ä–æ–¥–∞', desc: '–£ –≤–∞—Å –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ –∏–∑—É—á–µ–Ω–∏—é –ø—Ä–∏—Ä–æ–¥—ã –∏ –Ω–∞—É—á–Ω—ã–º –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º' }
        },
        tech: {
            uz: { name: 'Texnologiya va Injinering', desc: 'Sizda texnik soha va texnologiyalarga qiziqish kuchli' },
            ru: { name: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∏ –ò–Ω–∂–µ–Ω–µ—Ä–∏—è', desc: '–£ –≤–∞—Å —Å–∏–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π —Å—Ñ–µ—Ä–µ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º' }
        },
        art: {
            uz: { name: 'San\'at va Ijod', desc: 'Sizda ijodiy fikrlash va san\'atga iste\'dod bor' },
            ru: { name: '–ò—Å–∫—É—Å—Å—Ç–≤–æ –∏ –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ', desc: '–£ –≤–∞—Å –µ—Å—Ç—å —Ç–∞–ª–∞–Ω—Ç –∫ —Ç–≤–æ—Ä—á–µ—Å–∫–æ–º—É –º—ã—à–ª–µ–Ω–∏—é –∏ –∏—Å–∫—É—Å—Å—Ç–≤—É' }
        },
        social: {
            uz: { name: 'Ijtimoiy va Kommunikatsiya', desc: 'Sizda odamlar bilan ishlash va muloqot qilish qobiliyati yuqori' },
            ru: { name: '–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å—Ñ–µ—Ä–∞ –∏ –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è', desc: '–£ –≤–∞—Å –≤—ã—Å–æ–∫–∏–µ —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏ –∫ —Ä–∞–±–æ—Ç–µ —Å –ª—é–¥—å–º–∏ –∏ –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏' }
        },
        language: {
            uz: { name: 'Til va Adabiyot', desc: 'Sizda tillar va adabiyot sohasida qiziqish yuqori' },
            ru: { name: '–Ø–∑—ã–∫–∏ –∏ –õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞', desc: '–£ –≤–∞—Å –≤—ã—Å–æ–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å –∫ —è–∑—ã–∫–∞–º –∏ –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–µ' }
        }
    };
    
    // Prepare data for radar chart
    const labels = Object.keys(categories).map(cat => 
        categoryInfo[cat] ? categoryInfo[cat][lang].name : cat
    );
    const data = Object.values(categories);
    
    // Create radar chart with modern design
    const ctx = document.getElementById('interestRadarChart');
    if (ctx) {
        ctx.style.background = '#1F2937';
        ctx.style.borderRadius = '12px';
        ctx.style.width = '100%';
        ctx.style.height = '100%';
        // Create gradient for better visual
        const gradient = ctx.getContext('2d').createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(102, 126, 234, 0.4)');
        gradient.addColorStop(0.5, 'rgba(118, 75, 162, 0.3)');
        gradient.addColorStop(1, 'rgba(102, 126, 234, 0.2)');

        const wrapLabel = (label) => {
            if (!label || label.length <= 14) return label;
            const parts = label.split(' ');
            if (parts.length < 2) return label;
            const mid = Math.ceil(parts.length / 2);
            return [parts.slice(0, mid).join(' '), parts.slice(mid).join(' ')];
        };
        
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: lang === 'uz' ? 'Sizning natijangiz' : '–í–∞—à —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
                    data: data,
                    backgroundColor: gradient,
                    borderColor: '#667eea',
                    borderWidth: 3,
                    pointBackgroundColor: '#667eea',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 3,
                    pointHoverBackgroundColor: '#764ba2',
                    pointHoverBorderColor: '#fff',
                    pointHoverBorderWidth: 4,
                    pointRadius: 6,
                    pointHoverRadius: 9,
                    pointStyle: 'circle'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: { top: 10, bottom: 10, left: 10, right: 10 }
                },
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        min: 0,
                        ticks: {
                            stepSize: 20,
                            callback: function(value) {
                                return value + '%';
                            },
                            color: '#111827',
                            font: {
                                size: 11,
                                weight: '500'
                            }
                        },
                        pointLabels: {
                            color: '#FFFFFF',
                            callback: wrapLabel,
                            font: {
                                size: window.innerWidth < 420 ? 9 : window.innerWidth < 768 ? 10 : 12,
                                weight: '600',
                                family: 'system-ui, -apple-system, sans-serif'
                            },
                            padding: window.innerWidth < 420 ? 4 : window.innerWidth < 768 ? 6 : 10
                        },
                        grid: {
                            color: '#FFF',
                            circular: true
                        },
                        angleLines: {
                            color: '#FFFF',
                            lineWidth: 2
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: {
                            color: '#FFFFFF',
                            font: {
                                size: window.innerWidth < 420 ? 11 : 13,
                                weight: '600'
                            },
                            padding: 20,
                            usePointStyle: true,
                            pointStyle: 'circle'
                        }
                    },
                    tooltip: {
                        backgroundColor: '#FFFFFF',
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        titleFont: {
                            size: 14,
                            weight: 'bold'
                        },
                        bodyFont: {
                            size: 13
                        },
                        padding: 12,
                        cornerRadius: 8,
                        displayColors: false,
                        callbacks: {
                            label: function(context) {
                                return context.parsed.r + '%';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Display category descriptions
    const descriptionsContainer = document.getElementById('categoryDescriptions');
    if (descriptionsContainer) {
        // Sort categories by score
        const sortedCategories = Object.entries(categories).sort((a, b) => b[1] - a[1]);
        
        descriptionsContainer.innerHTML = `
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 1.25rem; color: var(--text-primary); margin-bottom: 1rem; text-align: center;">
                    ${lang === 'uz' ? 'üìä Batafsil natijalar' : 'üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}
                </h3>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem;">
                ${sortedCategories.map(([cat, score], index) => {
                    const info = categoryInfo[cat] ? categoryInfo[cat][lang] : { name: cat, desc: '' };
                    const color = score >= 70 ? '#10b981' : score >= 50 ? '#f59e0b' : '#6b7280';
                    const emoji = index === 0 ? 'üèÜ' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : 'üìå';
                    const bgGradient = score >= 70 
                        ? 'linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(16, 185, 129, 0.05) 100%)'
                        : score >= 50
                        ? 'linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(245, 158, 11, 0.05) 100%)'
                        : 'linear-gradient(135deg, rgba(107, 114, 128, 0.1) 0%, rgba(107, 114, 128, 0.05) 100%)';
                    
                    return `
                        <div style="
                            padding: 1.25rem; 
                            background: ${bgGradient}; 
                            border-radius: 12px; 
                            border-left: 5px solid ${color};
                            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
                            transition: transform 0.2s, box-shadow 0.2s;
                        " class="category-card">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.75rem; gap: 0.5rem;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                                    <span style="font-size: 1.5rem;">${emoji}</span>
                                    <h4 style="margin: 0; font-size: 1rem; font-weight: 600; color: var(--text-primary); line-height: 1.3;">${info.name}</h4>
                                </div>
                                <div style="
                                    background: ${color}; 
                                    color: white; 
                                    padding: 0.35rem 0.75rem; 
                                    border-radius: 20px; 
                                    font-size: 1rem; 
                                    font-weight: 700;
                                    white-space: nowrap;
                                ">${score}%</div>
                            </div>
                            <p style="margin: 0; font-size: 0.875rem; color: var(--text-secondary); line-height: 1.5;">${info.desc}</p>
                            <div style="
                                margin-top: 0.75rem; 
                                height: 6px; 
                                background: rgba(0,0,0,0.1); 
                                border-radius: 3px; 
                                overflow: hidden;
                            ">
                                <div style="
                                    height: 100%; 
                                    width: ${score}%; 
                                    background: ${color}; 
                                    border-radius: 3px;
                                    transition: width 0.6s ease;
                                "></div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <!-- Subject Recommendations Section -->
            <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border-radius: 16px; border: 2px solid rgba(102, 126, 234, 0.3);">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <h2 style="font-size: 1.75rem; color: var(--text-primary); margin-bottom: 0.75rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        <span style="font-size: 2rem;">üéì</span>
                        <span>${lang === 'uz' ? 'Tavsiya etiladigan fanlar' : '–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}</span>
                    </h2>
                    <p style="color: var(--text-secondary); font-size: 1rem; max-width: 600px; margin: 0 auto;">
                        ${lang === 'uz' ? 'Sizning qiziqishlaringiz asosida ushbu fanlarni o\'rganishni tavsiya qilamiz' : '–ù–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –º—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –∏–∑—É—á–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}
                    </p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                    ${sortedCategories.slice(0, 3).map(([cat, score]) => {
                        const recommendations = subjectRecommendations[cat];
                        if (!recommendations) return '';
                        
                        return recommendations.subjects.map(subject => `
                            <div style="
                                background: var(--bg-tertiary); 
                                padding: 1.5rem; 
                                border-radius: 12px;
                                border: 2px solid rgba(102, 126, 234, 0.2);
                                transition: all 0.3s ease;
                                cursor: pointer;
                            " class="subject-recommendation-card">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="
                                        font-size: 2.5rem;
                                        width: 60px;
                                        height: 60px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        border-radius: 12px;
                                    ">${subject.icon}</div>
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.25rem; color: var(--text-primary); font-weight: 700;">
                                            ${lang === 'uz' ? subject.nameUz : subject.nameRu}
                                        </h3>
                                        <div style="
                                            display: inline-block;
                                            background: rgba(102, 126, 234, 0.2);
                                            color: #667eea;
                                            padding: 0.25rem 0.75rem;
                                            border-radius: 12px;
                                            font-size: 0.75rem;
                                            font-weight: 600;
                                            margin-top: 0.25rem;
                                        ">${score}% ${lang === 'uz' ? 'mos' : '—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ'}</div>
                                    </div>
                                </div>
                                <p style="
                                    margin: 0; 
                                    color: var(--text-secondary); 
                                    font-size: 0.9rem; 
                                    line-height: 1.6;
                                    padding-left: 0.5rem;
                                    border-left: 3px solid #667eea;
                                ">${lang === 'uz' ? subject.reasonUz : subject.reasonRu}</p>
                            </div>
                        `).join('');
                    }).join('')}
                </div>
                
                <div style="text-align: center; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid rgba(102, 126, 234, 0.2);">
                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                        ${lang === 'uz' ? 'üí° Maslahat: Har bir fanni sinab ko\'ring va o\'zingizga eng mos keladiganini tanlang!' : 'üí° –°–æ–≤–µ—Ç: –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∫–∞–∂–¥—ã–π –ø—Ä–µ–¥–º–µ—Ç –∏ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–æ, —á—Ç–æ –≤–∞–º –±–æ–ª—å—à–µ –≤—Å–µ–≥–æ –ø–æ–¥—Ö–æ–¥–∏—Ç!'}
                    </p>
                </div>
            </div>
        `;
    }
    
    // Retake test button
    const btnRetake = document.getElementById('btnRetakeTest');
    if (btnRetake) {
        btnRetake.addEventListener('click', () => {
            router.navigate('/student/interest-test');
        });
    }
    
    // Back to dashboard button
    const btnBack = document.getElementById('btnBackToDashboard');
    if (btnBack) {
        btnBack.addEventListener('click', () => {
            router.navigate('/student/dashboard');
        });
    }
}

// Control Tests Page
// ===========================================
async function renderControlTests() {
    const lang = store.getState().language;
    const user = store.getState().user;
    const token = store.getState().token;

    try {
        // Fetch control tests assigned to student's class
        const response = await fetch(`${API_BASE_URL}/api/student/control-tests`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch control tests');

        const result = await response.json();
        const tests = result.data || result || [];
        const noTests = !Array.isArray(tests) || tests.length === 0;

        const content = `
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h1>${t('controlTests')}</h1>
                        <p>${lang === 'uz' ? '√ñqituvchining nazorat isbotlarini bajaring' : '–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã'}</p>
                    </div>
                    <button class="back-button" id="btnBackFromControlTests">
                        <span>‚Üê</span>
                        <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                    </button>
                </div>
            </div>

            <div class="content-wrapper">
                ${noTests ? `
                    <div class="card" style="text-align: center; padding: 2rem;">
                        <p style="color: var(--text-secondary); font-size: 1.1rem;">${t('noControlTests')}</p>
                    </div>
                ` : `
                    <div class="tests-grid">
                        ${Array.isArray(tests) ? tests.map(test => {
                            // Check if test is already completed
                            const completedKey = `control-test-completed-${test._id}`;
                            const completedData = JSON.parse(localStorage.getItem(completedKey) || 'null');
                            const isCompleted = !!completedData;
                            
                            let statusColor = '';
                            let statusIcon = '';
                            let statusText = '';
                            
                            if (isCompleted) {
                                const percentage = completedData.percentage;
                                if (percentage >= 70) {
                                    statusColor = '#10B981';
                                    statusIcon = '‚úÖ';
                                    statusText = lang === 'uz' ? 'Ajoyib!' : '–û—Ç–ª–∏—á–Ω–æ!';
                                } else if (percentage >= 50) {
                                    statusColor = '#F59E0B';
                                    statusIcon = '‚ö†Ô∏è';
                                    statusText = lang === 'uz' ? 'Yaxshi' : '–•–æ—Ä–æ—à–æ';
                                } else {
                                    statusColor = '#EF4444';
                                    statusIcon = '‚ùå';
                                    statusText = lang === 'uz' ? 'Qayta harakat' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ';
                                }
                            }
                            
                            return `
                            <div class="test-card" data-test-id="${test._id}">
                                <div class="test-header">
                                    <h3>${lang === 'uz' ? test.nameUz : test.nameRu}</h3>
                                    ${isCompleted ? `
                                        <div style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: ${statusColor}20; border: 2px solid ${statusColor}; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">${statusIcon}</div>
                                            <div style="font-size: 0.85rem; font-weight: 700; color: ${statusColor};">${statusText}</div>
                                            <div style="font-size: 0.75rem; color: ${statusColor}; margin-top: 0.25rem;">
                                                ${completedData.score} / ${completedData.maxScore} (${completedData.percentage}%)
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="test-details" style="margin: 1rem 0; color: var(--text-secondary);">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>‚è±Ô∏è ${lang === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}:</span>
                                        <strong>${test.duration || 60} ${lang === 'uz' ? 'daqiqa' : '–º–∏–Ω—É—Ç'}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span>‚≠ê ${lang === 'uz' ? 'Maksimal ball' : '–ú–∞–∫—Å. –±–∞–ª–ª–æ–≤'}:</span>
                                        <strong>${test.maxScore || 100}</strong>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>‚ùì ${lang === 'uz' ? 'Savollar' : '–í–æ–ø—Ä–æ—Å—ã'}:</span>
                                        <strong>${test.questions?.length || 0}</strong>
                                    </div>
                                </div>
                                <div class="test-description" style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.95rem;">
                                    ${lang === 'uz' ? test.descriptionUz : test.descriptionRu}
                                </div>
                                ${isCompleted ? `
                                    <button class="btn-secondary" style="width: 100%; cursor: not-allowed; opacity: 0.6;" disabled>
                                        ${lang === 'uz' ? '‚úÖ Yakunlandi' : '‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ'}
                                    </button>
                                ` : `
                                    <button class="btn-primary btn-start-test" data-test-id="${test._id}">
                                        ${lang === 'uz' ? 'Boshlash' : '–ù–∞—á–∞—Ç—å'}
                                    </button>
                                `}
                            </div>
                        `}).join('') : '<div style="text-align: center;"><p>–ù–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã—Ö —Ä–∞–±–æ—Ç</p></div>'}
                    </div>
                `}
            </div>
        `;

        renderLayout(content, 'student');

        // Back button
        document.getElementById('btnBackFromControlTests')?.addEventListener('click', () => {
            router.navigate('/student/dashboard');
        });

        // Start test buttons
        document.querySelectorAll('.btn-start-test').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const testId = e.target.dataset.testId;
                router.navigate(`/student/take-control-test/${testId}`);
            });
        });

    } catch (error) {
        console.error('‚ùå Error loading control tests:', error);
        const content = `
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h1>${t('controlTests')}</h1>
                    <button class="back-button" id="btnBackFromControlTests">
                        <span>‚Üê</span>
                        <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                    </button>
                </div>
            </div>
            <div class="card error-message">
                <p>${lang === 'uz' ? 'Xatolik yuz berdi. Qayta urinib ko\'ring.' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'}</p>
            </div>
        `;
        renderLayout(content, 'student');
        document.getElementById('btnBackFromControlTests')?.addEventListener('click', () => {
            router.navigate('/student/dashboard');
        });
    }
}

// Control Test Taker Page
// ===========================================
async function renderControlTestTaker({ testId }) {
    const lang = store.getState().language;
    const user = store.getState().user;
    const token = store.getState().token;

    try {
        // Check if test is already completed
        const completedKey = `control-test-completed-${testId}`;
        const completedData = JSON.parse(localStorage.getItem(completedKey) || 'null');
        
        if (completedData) {
            // Test already completed - show results
            const percentage = completedData.percentage;
            const isPassed = percentage >= 70;
            const isGood = percentage >= 50;
            
            let statusColor = '';
            let statusIcon = '';
            let statusText = '';
            
            if (isPassed) {
                statusColor = '#10B981';
                statusIcon = '‚úÖ';
                statusText = lang === 'uz' ? 'Ajoyib!' : '–û—Ç–ª–∏—á–Ω–æ!';
            } else if (isGood) {
                statusColor = '#F59E0B';
                statusIcon = '‚ö†Ô∏è';
                statusText = lang === 'uz' ? 'Yaxshi' : '–•–æ—Ä–æ—à–æ';
            } else {
                statusColor = '#EF4444';
                statusIcon = '‚ùå';
                statusText = lang === 'uz' ? 'Qayta harakat' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ';
            }
            
            const content = `
                <div style="background: var(--bg-primary); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem 1.5rem;">
                    <div style="max-width: 600px; width: 100%;">
                        <div style="background: var(--bg-secondary); border-radius: 16px; padding: 3rem 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 2px solid var(--border-color); text-align: center;">
                            <div style="font-size: 4rem; margin-bottom: 1rem; color: ${statusColor};">${statusIcon}</div>
                            <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; font-weight: 800; color: var(--text-primary);">
                                ${statusText}
                            </h1>
                            <p style="margin: 0 0 2rem 0; color: var(--text-secondary); font-size: 1rem;">
                                ${lang === 'uz' ? 'Bu test allaqachon yakunlangan!' : '–≠—Ç–æ—Ç —Ç–µ—Å—Ç —É–∂–µ –∑–∞–≤–µ—Ä—à–µ–Ω!'}
                            </p>

                            <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 2px solid var(--primary); border-radius: 14px; padding: 2rem; margin-bottom: 2rem;">
                                <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                    üìä ${lang === 'uz' ? 'Ballangiz' : '–í–∞—à –±–∞–ª–ª'}
                                </div>
                                <div style="font-size: 2.5rem; font-weight: 800; color: ${statusColor}; margin-bottom: 1rem;">
                                    ${completedData.score} / ${completedData.maxScore}
                                </div>
                                <div style="font-size: 1.5rem; font-weight: 700; color: ${statusColor};">
                                    ${percentage}%
                                </div>
                            </div>

                            <button class="button button-primary" id="btnBackToTests" style="width: 100%; padding: 1rem;">
                                ‚Üê ${lang === 'uz' ? 'Testlarga qaytish' : '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ç–µ—Å—Ç–∞–º'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            renderLayout(content, 'student');
            
            document.getElementById('btnBackToTests')?.addEventListener('click', () => {
                router.navigate('/student/control-tests');
            });
            
            return;
        }

        // Fetch the control test
        const response = await fetch(`${API_BASE_URL}/api/control-tests/${testId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch control test');

        const result = await response.json();
        const test = result.data || result;
        const questions = test.questions || [];
        
        if (!questions || questions.length === 0) {
            throw new Error('Test has no questions');
        }
        
        const duration = test.duration || 60;

        // Load or initialize progress
        const progressKey = `control-test-${testId}-progress`;
        let progress = JSON.parse(localStorage.getItem(progressKey)) || {
            testId,
            answers: {},
            startTime: Date.now(),
            timeRemaining: duration * 60 * 1000
        };

        if (!localStorage.getItem(progressKey)) {
            localStorage.setItem(progressKey, JSON.stringify(progress));
        }

        const content = `
            <div style="background: var(--bg-primary); min-height: 100vh;">
                <!-- Header with Timer -->
                <div class="test-header-modern" style="position: sticky; top: 0; z-index: 100; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border-bottom: 2px solid var(--primary); padding: 1.5rem; box-shadow: 0 4px 12px rgba(0,0,0,0.2);">
                    <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                        <div style="flex: 1; min-width: 250px;">
                            <h1 style="margin: 0 0 0.5rem 0; font-size: 1.8rem; font-weight: 800; color: var(--text-primary);">
                                ${lang === 'uz' ? test.nameUz : test.nameRu}
                            </h1>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem;">
                                ${lang === 'uz' ? test.descUz : test.descRu}
                            </p>
                        </div>
                        
                        <!-- Timer Display -->
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 1rem 1.5rem; text-align: center; min-width: 150px;">
                            <div style="font-size: 0.85rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                ‚è±Ô∏è ${lang === 'uz' ? 'Qolgan vaqt' : '–û—Å—Ç–∞–ª–æ—Å—å'}
                            </div>
                            <div id="timer" style="font-size: 2rem; font-weight: 800; color: var(--primary); font-family: 'Courier New', monospace;">
                                ${duration}:00
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                            <button class="button button-secondary" id="btnSaveProgress" style="padding: 0.75rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                üíæ <span>${lang === 'uz' ? 'Saqlash' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</span>
                            </button>
                            <button class="button button-secondary" id="btnExitTest" style="padding: 0.75rem 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                ‚Üê <span>${lang === 'uz' ? 'Chiqish' : '–ù–∞–∑–∞–¥'}</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div style="max-width: 900px; margin: 0 auto; padding: 2rem 1.5rem;">
                    <!-- Progress Bar -->
                    <div style="background: var(--bg-secondary); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <span style="color: var(--text-secondary); font-weight: 600;">
                                ${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å'} <span id="currentQuestion" style="color: var(--primary); font-weight: 800;">1</span> / <span style="color: var(--text-muted);">${questions.length}</span>
                            </span>
                            <span style="color: var(--text-muted); font-size: 0.9rem;">
                                ${lang === 'uz' ? 'Javoblar' : '–û—Ç–≤–µ—Ç–æ–≤'}: <span id="answeredCount" style="color: var(--primary); font-weight: 800;">0</span>/${questions.length}
                            </span>
                        </div>
                        <div style="height: 8px; background: var(--bg-tertiary); border-radius: 4px; overflow: hidden;">
                            <div id="progressBar" style="height: 100%; background: linear-gradient(90deg, var(--primary) 0%, var(--accent) 100%); width: 0%; transition: width 0.3s ease; border-radius: 4px;"></div>
                        </div>
                    </div>

                    <!-- Questions Container -->
                    <div id="questionsContainer">
                        ${questions.map((q, idx) => `
                            <div class="question-card-modern" data-question-index="${idx}" style="background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 14px; padding: 2rem; margin-bottom: 2rem; transition: all 0.3s ease;">
                                <!-- Question Number Badge -->
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
                                    <div style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 1.1rem;">
                                        ${idx + 1}
                                    </div>
                                    <div style="flex: 1;">
                                        <h3 style="margin: 0 0 0.25rem 0; color: var(--text-primary); font-size: 1.2rem; font-weight: 700;">
                                            ${lang === 'uz' ? q.questionUz : q.questionRu}
                                        </h3>
                                        <div style="color: var(--text-muted); font-size: 0.85rem;">
                                            ${lang === 'uz' ? 'Bitta javobni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –æ—Ç–≤–µ—Ç'}
                                        </div>
                                    </div>
                                </div>

                                <!-- Answer Options -->
                                <div class="answers-list-modern" style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${q.answers.map((ans, ansIdx) => `
                                        <label class="answer-option-modern" style="cursor: pointer; display: flex; align-items: center; padding: 1rem; background: var(--bg-tertiary); border: 2px solid var(--border-color); border-radius: 10px; transition: all 0.3s ease; position: relative; overflow: hidden;">
                                            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(59, 130, 246, 0.1), transparent); pointer-events: none;"></div>
                                            
                                            <input type="radio" 
                                                name="question_${idx}" 
                                                value="${ansIdx}"
                                                data-question-index="${idx}"
                                                ${progress.answers[idx] == ansIdx ? 'checked' : ''}
                                                class="answer-input" 
                                                style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); flex-shrink: 0; margin-right: 1rem;">
                                            
                                            <span style="color: var(--text-secondary); font-weight: 500; flex: 1; position: relative; z-index: 1;">
                                                ${lang === 'uz' ? ans.textUz : ans.textRu}
                                            </span>
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>

                    <!-- Submit Button -->
                    <div style="display: flex; gap: 1rem; margin-top: 2rem; margin-bottom: 2rem;">
                        <button class="button button-primary" id="btnSubmitTest" style="flex: 1; padding: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            ‚úÖ ${lang === 'uz' ? 'Testni yakunlash' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç'}
                        </button>
                    </div>
                </div>
            </div>
        `;

        renderLayout(content, 'student');

        // Timer logic
        let timeRemaining = progress.timeRemaining;
        const timerEl = document.getElementById('timer');

        const timerInterval = setInterval(() => {
            timeRemaining -= 1000;
            progress.timeRemaining = timeRemaining;

            if (timerEl) {
                const minutes = Math.floor(timeRemaining / 60000);
                const seconds = Math.floor((timeRemaining % 60000) / 1000);
                timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                if (timeRemaining <= 0) {
                    clearInterval(timerInterval);
                    autoSubmitTest();
                }
            }

            localStorage.setItem(progressKey, JSON.stringify(progress));
        }, 1000);

        // Auto-save answers
        function updateProgress() {
            // Update answered count
            const answeredCount = Object.keys(progress.answers).filter(key => progress.answers[key] !== undefined).length;
            const answeredEl = document.getElementById('answeredCount');
            const currentQuestionEl = document.getElementById('currentQuestion');
            
            if (answeredEl) {
                answeredEl.textContent = answeredCount;
            }
            
            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            if (progressBar) {
                const percentage = (answeredCount / questions.length) * 100;
                progressBar.style.width = percentage + '%';
            }
        }

        document.querySelectorAll('.answer-input').forEach(input => {
            input.addEventListener('change', (e) => {
                const questionIdx = parseInt(e.target.dataset.questionIndex);
                const answerIdx = parseInt(e.target.value);
                progress.answers[questionIdx] = answerIdx;
                localStorage.setItem(progressKey, JSON.stringify(progress));
                updateProgress();
            });
        });
        
        // Initial progress update
        updateProgress();

        // Save progress button
        document.getElementById('btnSaveProgress')?.addEventListener('click', () => {
            localStorage.setItem(progressKey, JSON.stringify(progress));
            showAlert(lang === 'uz' ? '‚úÖ Saqlandi!' : '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
        });

        // Exit test button
        document.getElementById('btnExitTest')?.addEventListener('click', async () => {
            clearInterval(timerInterval);
            const confirmed = await showConfirm(
                lang === 'uz' ? 'Testdan chiqishni xohlaysizmi? Tayyorlangan javoblar saqlanadi.' : '–í—ã —É–≤–µ—Ä–µ–Ω—ã? –í–∞—à–∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.',
                lang === 'uz' ? 'Testdan chiqish' : '–í—ã—Ö–æ–¥ –∏–∑ —Ç–µ—Å—Ç–∞'
            );
            if (confirmed) {
                router.navigate('/student/control-tests');
            }
        });

        // Submit test button
        document.getElementById('btnSubmitTest')?.addEventListener('click', async () => {
            clearInterval(timerInterval);
            const confirmed = await showConfirm(
                lang === 'uz' ? 'Testni yakunlaysizmi?' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç?',
                lang === 'uz' ? 'Testni yakunlash' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç'
            );
            if (confirmed) {
                await submitControlTest(testId, progress.answers);
            }
        });

        async function autoSubmitTest() {
            console.log('‚è∞ Time\'s up, auto-submitting...');
            await submitControlTest(testId, progress.answers);
        }

    } catch (error) {
        console.error('‚ùå Error loading control test:', error);
        const content = `
            <div class="page-header">
                <h1>${lang === 'uz' ? 'Xatolik' : '–û—à–∏–±–∫–∞'}</h1>
            </div>
            <div style="max-width: 600px; margin: 2rem auto;">
                <div class="alert alert-error">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span style="font-size: 1.5rem;">‚ö†Ô∏è</span>
                        <div>
                            <strong style="display: block; margin-bottom: 0.25rem;">${lang === 'uz' ? 'Xatolik' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</strong>
                            <span>${lang === 'uz' ? 'Testni yuklashda xatolik yuz berdi' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–∞'}</span>
                        </div>
                    </div>
                    <button class="btn-primary" id="btnBackToControlTests" style="margin-top: 1rem; width: 100%; padding: 0.75rem;">
                        ${lang === 'uz' ? 'Orqaga qaytish' : '–í–µ—Ä–Ω—É—Ç—å—Å—è'}
                    </button>
                </div>
            </div>
        `;
        renderLayout(content, 'student');
        document.getElementById('btnBackToControlTests')?.addEventListener('click', () => {
            router.navigate('/student/control-tests');
        });
    }
}

// Submit Control Test
async function submitControlTest(testId, answers) {
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        const response = await fetch(`${API_BASE_URL}/api/control-tests/${testId}/submit`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ answers })
        });

        if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || 'Submission failed');
        }

        const result = await response.json();

        // Clear progress
        localStorage.removeItem(`control-test-${testId}-progress`);

        // Ensure we have the correct data structure
        const resultData = result.data || result;
        const score = resultData.score || 0;
        const maxScore = resultData.maxScore || 100;
        const correctCount = resultData.correctCount || 0;
        const totalQuestions = resultData.totalCount || resultData.totalQuestions || 0;

        // Calculate percentage
        const percentage = totalQuestions > 0 ? Math.round((score / maxScore) * 100) : 0;
        
        // Save completion status to localStorage to prevent re-taking
        const completedKey = `control-test-completed-${testId}`;
        localStorage.setItem(completedKey, JSON.stringify({
            testId,
            score,
            maxScore,
            percentage,
            completedAt: new Date().toISOString(),
            correctCount,
            totalQuestions
        }));
        
        const isPassed = percentage >= 70;
        const isGood = percentage >= 50;

        // Show results
        const content = `
            <div style="background: var(--bg-primary); min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 2rem 1.5rem;">
                <div style="max-width: 600px; width: 100%;">
                    <!-- Results Card -->
                    <div style="background: var(--bg-secondary); border-radius: 16px; padding: 3rem 2rem; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 2px solid var(--border-color); text-align: center;">
                        
                        <!-- Result Emoji/Icon -->
                        <div style="font-size: 5rem; margin-bottom: 1.5rem; animation: bounce 0.6s ease;">
                            ${isPassed ? 'üéâ' : isGood ? 'üëç' : 'üìö'}
                        </div>

                        <!-- Title -->
                        <h1 style="margin: 0 0 0.5rem 0; font-size: 2rem; font-weight: 800; color: var(--text-primary);">
                            ${lang === 'uz' ? (isPassed ? 'üåü Ajoyib!' : isGood ? 'Yaxshi!' : 'Qayta harakat qiling') : (isPassed ? 'üåü –û—Ç–ª–∏—á–Ω–æ!' : isGood ? '–•–æ—Ä–æ—à–æ!' : '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞')}
                        </h1>

                        <p style="margin: 0 0 2rem 0; color: var(--text-secondary); font-size: 1rem;">
                            ${lang === 'uz' ? 'Siz testni yakunladingiz!' : '–í—ã –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ç–µ—Å—Ç!'}
                        </p>

                        <!-- Score Display -->
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 2px solid var(--primary); border-radius: 14px; padding: 2rem; margin-bottom: 2rem;">
                            <div style="font-size: 0.9rem; color: var(--text-muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem;">
                                üìä ${lang === 'uz' ? 'Ballangiz' : '–í–∞—à –±–∞–ª–ª'}
                            </div>
                            <div style="font-size: 3rem; font-weight: 800; color: var(--primary); margin-bottom: 1rem;">
                                ${score} / ${maxScore}
                            </div>
                            
                            <!-- Score Bar -->
                            <div style="height: 10px; background: var(--bg-tertiary); border-radius: 5px; overflow: hidden; margin-bottom: 1rem;">
                                <div style="height: 100%; background: linear-gradient(90deg, ${isPassed ? '#10B981' : isGood ? '#F59E0B' : '#EF4444'} 0%, ${isPassed ? '#34D399' : isGood ? '#FBBF24' : '#F87171'} 100%); width: ${percentage}%; border-radius: 5px; transition: width 0.6s ease;"></div>
                            </div>

                            <div style="display: flex; justify-content: space-around; gap: 1rem; flex-wrap: wrap;">
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                                        ${lang === 'uz' ? 'Foizda' : '–ü—Ä–æ—Ü–µ–Ω—Ç'}
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: ${isPassed ? '#10B981' : isGood ? '#F59E0B' : '#EF4444'};">
                                        ${percentage}%
                                    </div>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.25rem;">
                                        ‚úÖ ${lang === 'uz' ? "To'g'ri" : '–ü—Ä–∞–≤–∏–ª—å–Ω–æ'}
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: 700; color: #10B981;">
                                        ${correctCount}/${totalQuestions}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Status Badge -->
                        <div style="background: ${isPassed ? 'rgba(16, 185, 129, 0.1); border: 2px solid #10B981' : isGood ? 'rgba(245, 158, 11, 0.1); border: 2px solid #F59E0B' : 'rgba(239, 68, 68, 0.1); border: 2px solid #EF4444'}; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                            <p style="margin: 0; color: ${isPassed ? '#10B981' : isGood ? '#F59E0B' : '#EF4444'}; font-weight: 700;">
                                ${isPassed ? lang === 'uz' ? '‚úÖ Siz o\'tkazib kittingiz!' : '‚úÖ –í—ã –ø—Ä–æ—à–ª–∏ —Ç–µ—Å—Ç!' : isGood ? lang === 'uz' ? '‚ö†Ô∏è Davom ettiring' : '‚ö†Ô∏è –£–ª—É—á—à–∞–π—Ç–µ—Å—å' : lang === 'uz' ? '‚ùå Qayta harakat qiling' : '‚ùå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞'}
                            </p>
                        </div>

                        <!-- Details -->
                        <div style="background: var(--bg-tertiary); border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem; text-align: left; border: 1px solid var(--border-color);">
                            <h3 style="margin: 0 0 1rem 0; color: var(--text-primary); font-size: 1rem; font-weight: 700;">
                                ${lang === 'uz' ? 'üìà Natijalar' : 'üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã'}
                            </h3>
                            <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                                    <span style="color: var(--text-secondary);">${lang === 'uz' ? 'Jami savollar' : '–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤'}:</span>
                                    <span style="font-weight: 700; color: var(--primary);">${totalQuestions}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color);">
                                    <span style="color: var(--text-secondary);">‚úÖ ${lang === 'uz' ? "To'g'ri javoblar" : '–ü—Ä–∞–≤–∏–ª—å–Ω–æ'}:</span>
                                    <span style="font-weight: 700; color: #10B981;">${correctCount}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="color: var(--text-secondary);">‚ùå ${lang === 'uz' ? "Noto'g'ri javoblar" : '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ'}:</span>
                                    <span style="font-weight: 700; color: #EF4444;">${totalQuestions - correctCount}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Action Button -->
                        <button class="button button-primary" id="btnBackToDashboard" style="width: 100%; padding: 1rem; font-size: 1rem; font-weight: 700; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            ‚Üê ${lang === 'uz' ? 'Bosh sahifaga' : '–ù–∞ –≥–ª–∞–≤–Ω—É—é'}
                        </button>
                    </div>

                    <!-- Motivation Message -->
                    <div style="text-align: center; margin-top: 2rem; padding: 1.5rem; background: var(--bg-secondary); border-radius: 10px; border: 1px dashed var(--border-color);">
                        <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem;">
                            ${isPassed ? lang === 'uz' ? 'üåü Tabriklaysiz! Siz yaxshi natijavga erishdingiz.' : 'üåü –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º! –í—ã –æ—Ç–ª–∏—á–Ω–æ —Å–ø—Ä–∞–≤–∏–ª–∏—Å—å.' : isGood ? lang === 'uz' ? 'üí™ Yana biroz harakat qiling va o ªtkazib ketasiz!' : 'üí™ –ï—â–µ –Ω–µ–º–Ω–æ–≥–æ —É—Å–∏–ª–∏–π –∏ –≤—ã —Å–ø—Ä–∞–≤–∏—Ç–µ—Å—å!' : lang === 'uz' ? 'üìö Materialni qayta o ªrganing va qayta harakat qiling.' : 'üìö –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'}
                        </p>
                    </div>
                </div>
            </div>

            <style>
                @keyframes bounce {
                    0%, 100% { transform: translateY(0); }
                    50% { transform: translateY(-20px); }
                }
            </style>
        `;

        renderLayout(content, 'student');

        document.getElementById('btnBackToDashboard')?.addEventListener('click', () => {
            router.navigate('/student/dashboard');
        });

    } catch (error) {
        console.error('‚ùå Error submitting control test:', error);
        showAlert(lang === 'uz' ? 'Xatolik yuz berdi: ' + error.message : '–û—à–∏–±–∫–∞: ' + error.message, 'error', 6000);
    }
}

// Teacher Dashboard
// ===========================================
// TEACHER: SUBJECT MANAGEMENT
// ===========================================

function renderTeacherDashboard() {
    const user = store.getState().user;
    
    if (!user) {
        router.navigate('/login');
        return;
    }
    
    // Redirect to subject management
    router.navigate('/teacher/subjects');
}

// Teacher: My Subjects (Main page)
async function renderTeacherSubjects() {
    const user = store.getState().user;
    const lang = store.getState().language;
    
    if (!user) {
        router.navigate('/login');
        return;
    }
    
    const content = `
        <div class="page-header">
            <h1>${lang === 'uz' ? 'Mening fanlarim' : '–ú–æ–∏ –ø—Ä–µ–¥–º–µ—Ç—ã'}</h1>
            <p>${user.firstName} ${user.lastName} ‚Ä¢ ${t('teacher')}</p>
        </div>

        <div class="dashboard-cards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="dashboard-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); cursor: pointer;" id="btnTeacherProfile">
                <div class="card-icon">üìä</div>
                <div class="card-content">
                    <h3 style="color: white;">${lang === 'uz' ? 'Profil va Statistika' : '–ü—Ä–æ—Ñ–∏–ª—å –∏ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞'}</h3>
                    <p style="color: white;">${lang === 'uz' ? 'Analitika va natijalar' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</p>
                </div>
                <div class="card-arrow">‚Üí</div>
            </div>

            <div class="dashboard-card" style="background: linear-gradient(135deg, #0ea5e9 0%, #38bdf8 100%); cursor: pointer;" id="btnTeacherModuleAnalytics">
                <div class="card-icon">üìà</div>
                <div class="card-content">
                    <h3 style="color: white;">${lang === 'uz' ? 'Mavzu analitikasi' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º'}</h3>
                    <p style="color: white;">${lang === 'uz' ? 'Sinf va fan kesimida' : '–ü–æ –∫–ª–∞—Å—Å–∞–º –∏ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}</p>
                </div>
                <div class="card-arrow">‚Üí</div>
            </div>
            
            <div class="dashboard-card" style="background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); cursor: pointer;" id="btnTeacherTests">
                <div class="card-icon">üìã</div>
                <div class="card-content">
                    <h3 style="color: white;">${lang === 'uz' ? 'Mening testlarim' : '–ú–æ–∏ —Ç–µ—Å—Ç—ã'}</h3>
                    <p style="color: white;">${lang === 'uz' ? 'Malaka baholash testlari' : '–¢–µ—Å—Ç—ã –Ω–∞ –æ—Ü–µ–Ω–∫—É –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π'}</p>
                </div>
                <div class="card-arrow">‚Üí</div>
            </div>

            <div class="dashboard-card" style="background: linear-gradient(135deg, #ec4899 0%, #f97316 100%); cursor: pointer;" id="btnTeacherControlTests">
                <div class="card-icon">‚úèÔ∏è</div>
                <div class="card-content">
                    <h3 style="color: white;">${lang === 'uz' ? 'Nazorat isbotlari' : '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã'}</h3>
                    <p style="color: white;">${lang === 'uz' ? 'Sinov va tahlil' : '–°–æ–∑–¥–∞–Ω–∏–µ –∏ –æ—Ü–µ–Ω–∫–∞'}</p>
                </div>
                <div class="card-arrow">‚Üí</div>
            </div>

            <div class="dashboard-card" style="background: linear-gradient(135deg, #14b8a6 0%, #06b6d4 100%); cursor: pointer;" id="btnTeacherClasses">
                <div class="card-icon">üë•</div>
                <div class="card-content">
                    <h3 style="color: white;">${lang === 'uz' ? 'Mening sinflarim' : '–ú–æ–∏ –∫–ª–∞—Å—Å—ã'}</h3>
                    <p style="color: white;">${lang === 'uz' ? 'Oqituvchi va analitika' : '–£—á–µ–Ω–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞'}</p>
                </div>
                <div class="card-arrow">‚Üí</div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: 2rem;">
            <h3>${lang === 'uz' ? 'Tanlangan fanlar' : '–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}</h3>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                ${lang === 'uz' ? 'Quyidagi fanlarni o\'qitasiz. Har bir fan uchun modullar va testlar yaratishingiz mumkin.' : '–í—ã –ø—Ä–µ–ø–æ–¥–∞–µ—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã. –í—ã –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –º–æ–¥—É–ª–∏ –∏ —Ç–µ—Å—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.'}
            </p>
            <div id="teacherSubjects">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'teacher');

    // Add profile card click handler
    document.getElementById('btnTeacherProfile')?.addEventListener('click', () => {
        router.navigate('/teacher/profile');
    });
    
    // Add teacher tests card click handler
    document.getElementById('btnTeacherTests')?.addEventListener('click', () => {
        router.navigate('/teacher/tests');
    });

    // Add teacher module analytics card click handler
    document.getElementById('btnTeacherModuleAnalytics')?.addEventListener('click', () => {
        router.navigate('/teacher/subject-analytics');
    });

    // Add teacher control tests card click handler
    document.getElementById('btnTeacherControlTests')?.addEventListener('click', () => {
        router.navigate('/teacher/control-tests');
    });

    // Add teacher classes card click handler
    document.getElementById('btnTeacherClasses')?.addEventListener('click', () => {
        router.navigate('/teacher/classes');
    });
    
    // Load all subjects
    const result = await apiRequest('/api/subjects');
    
    if (result.success && result.data) {
        const subjects = result.data;
        const teacherSubjects = Array.isArray(user.subjects) ? user.subjects : [];
        const teacherSubjectIds = new Set(
            teacherSubjects
                .map(s => s?.id || s?._id || s?.subjectId || s)
                .filter(Boolean)
        );
        const subjectsToShow = teacherSubjectIds.size
            ? subjects.filter(s => teacherSubjectIds.has(s._id))
            : subjects;
        const container = document.getElementById('teacherSubjects');
        
        container.innerHTML = `
            <div class="subjects-grid">
                ${subjectsToShow.map(subject => `
                    <div class="subject-card" data-subject-id="${subject._id}" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-color); transition: all 0.3s ease; cursor: pointer;">
                        <div class="subject-header" style="pointer-events: none;">
                            <div class="subject-icon" style="width: 64px; height: 64px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 2rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">${getSubjectIcon(lang === 'uz' ? subject.nameUz : subject.nameRu)}</div>
                            <h3 style="margin: 1rem 0 0.5rem 0; font-size: 1.25rem;">${lang === 'uz' ? subject.nameUz : subject.nameRu}</h3>
                        </div>
                        <div class="subject-info" style="margin: 0.75rem 0; pointer-events: none;">
                            <p id="subject-${subject._id}-stats" style="color: var(--text-muted); font-size: 0.875rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                <span style="font-size: 1.125rem;">üì¶</span>
                                ${lang === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}
                            </p>
                        </div>
                        <button class="button button-primary" style="width: 100%; padding: 12px 20px; font-size: 15px; font-weight: 600; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 0.5rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; pointer-events: none;">
                            <span>‚ö°</span>
                            <span>${lang === 'uz' ? 'Boshqarish' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ'}</span>
                            <span>‚Üí</span>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
        
        // Add click handlers to subject cards
        document.querySelectorAll('.subject-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const subjectId = card.getAttribute('data-subject-id');
                if (subjectId) {
                    router.navigate(`/teacher/subject/${subjectId}`);
                }
            });
        });
        
        // Load module counts for each subject
        console.log('üìä Loading module counts for subjects...');
        subjectsToShow.forEach(async (subject) => {
            console.log('üì¶ Loading modules for subject:', subject._id);
            const modulesResult = await apiRequest(`/api/subjects/${subject._id}/modules`);
            console.log('üì¶ Modules result for subject ' + subject._id + ':', modulesResult);
            const statsEl = document.getElementById(`subject-${subject._id}-stats`);
            if (statsEl && modulesResult.success) {
                const moduleCount = modulesResult.data.length;
                console.log('‚úÖ Module count for subject ' + subject._id + ':', moduleCount);
                statsEl.textContent = `${moduleCount} ${lang === 'uz' ? 'ta modul' : moduleCount === 1 ? '–º–æ–¥—É–ª—å' : '–º–æ–¥—É–ª–µ–π'}`;
            } else {
                console.error('‚ùå Failed to load modules for subject ' + subject._id + ':', modulesResult);
            }
        });
    }
}

// Teacher: Single Subject Management
async function renderTeacherSubjectManagement() {
    const subjectId = window.location.pathname.split('/').pop();
    const lang = store.getState().language;
    const user = store.getState().user;
    
    console.log('üîç renderTeacherSubjectManagement called with subjectId:', subjectId);
    console.log('üìç Current path:', window.location.pathname);
    
    const content = `
        <div class="page-header" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="subjectName" style="background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">${lang === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</h1>
                    <p style="color: var(--text-muted); margin: 0;">${lang === 'uz' ? 'Modullar va testlarni boshqarish' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–æ–¥—É–ª—è–º–∏ –∏ —Ç–µ—Å—Ç–∞–º–∏'}</p>
                </div>
                <button class="button button-secondary" id="btnBackToSubjects" style="display: flex; align-items: center; gap: 0.5rem; padding: 12px 20px; border-radius: 10px; transition: all 0.3s ease;">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Fanlar ro\'yxati' : '–°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤'}</span>
                </button>
            </div>
        </div>
        
        <!-- Create Module Section -->
        <div class="card create-module-card" style="background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-color); margin-bottom: 2rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <div class="card-header-flex">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #06b6d4); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); flex-shrink: 0;">
                    ‚ûï
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem;">${lang === 'uz' ? 'Yangi modul yaratish' : '–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å'}</h3>
                    <p style="margin: 0.25rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">${lang === 'uz' ? 'Fan uchun yangi modul qo\'shing' : '–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞'}</p>
                </div>
            </div>
            <form id="createModuleForm" class="module-form">
                <div class="form-row-2cols">
                    <div class="form-group">
                        <label class="form-label">
                            <span style="font-size: 1.25rem;">üá∑üá∫</span>
                            ${lang === 'uz' ? 'Modul nomi (Ruscha)' : '–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è (RU)'}
                        </label>
                        <input type="text" class="form-input" id="moduleNameRu" placeholder="${lang === 'uz' ? 'Masalan: Algebra asoslari' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤—ã –∞–ª–≥–µ–±—Ä—ã'}" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span style="font-size: 1.25rem;">üá∫üáø</span>
                            ${lang === 'uz' ? 'Modul nomi (O\'zbekcha)' : '–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è (UZ)'}
                        </label>
                        <input type="text" class="form-input" id="moduleNameUz" placeholder="${lang === 'uz' ? 'Masalan: Algebra asoslari' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤—ã –∞–ª–≥–µ–±—Ä—ã'}" required />
                    </div>
                </div>
                <div class="form-row-2cols">
                    <div class="form-group">
                        <label class="form-label">
                            <span style="font-size: 1.25rem;">üìù</span>
                            ${lang === 'uz' ? 'Tavsif (Ruscha)' : '–û–ø–∏—Å–∞–Ω–∏–µ (RU)'}
                        </label>
                        <textarea class="form-textarea" id="moduleDescRu" rows="3" placeholder="${lang === 'uz' ? 'Modul haqida qisqacha ma\'lumot' : '–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª–µ'}"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span style="font-size: 1.25rem;">üìù</span>
                            ${lang === 'uz' ? 'Tavsif (O\'zbekcha)' : '–û–ø–∏—Å–∞–Ω–∏–µ (UZ)'}
                        </label>
                        <textarea class="form-textarea" id="moduleDescUz" rows="3" placeholder="${lang === 'uz' ? 'Modul haqida qisqacha ma\'lumot' : '–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥—É–ª–µ'}"></textarea>
                    </div>
                </div>
                <button type="submit" class="button button-primary submit-btn">
                    <span style="font-size: 1.25rem;">‚ú®</span>
                    <span>${lang === 'uz' ? 'Modulni yaratish' : '–°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å'}</span>
                </button>
            </form>
            <div id="moduleMessage" style="margin-top: 1rem;"></div>
        </div>
        
        <!-- Modules List -->
        <div class="card" style="border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                    üì¶
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem;">${lang === 'uz' ? 'Mavjud modullar' : '–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏'}</h3>
                    <p style="margin: 0.25rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">${lang === 'uz' ? 'Barcha yaratilgan modullar' : '–í—Å–µ —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏'}</p>
                </div>
            </div>
            <div id="modulesList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'teacher');
    
    // Load subject name
    const subjectsResult = await apiRequest('/api/subjects');
    if (subjectsResult.success) {
        const subject = subjectsResult.data.find(s => s._id === subjectId);
        if (user?.role === 'teacher') {
            const teacherSubjects = Array.isArray(user.subjects) ? user.subjects : [];
            const teacherSubjectIds = new Set(
                teacherSubjects
                    .map(s => s?.id || s?._id || s?.subjectId || s)
                    .filter(Boolean)
            );
            if (teacherSubjectIds.size && !teacherSubjectIds.has(subjectId)) {
                showAlert(lang === 'uz' ? 'Bu fan sizga biriktirilmagan' : '–≠—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç –≤–∞–º –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω', 'error');
                router.navigate('/teacher/subjects');
                return;
            }
        }
        if (subject) {
            document.getElementById('subjectName').textContent = lang === 'uz' ? subject.nameUz : subject.nameRu;
            window.currentSubject = subject;
        }
    }
    
    // Load modules
    await loadSubjectModules(subjectId);
    
    // Handle back button
    document.getElementById('btnBackToSubjects').addEventListener('click', () => {
        router.navigate('/teacher/subjects');
    });
    
    // Handle create module form
    document.getElementById('createModuleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const nameRu = document.getElementById('moduleNameRu').value;
        const nameUz = document.getElementById('moduleNameUz').value;
        const descriptionRu = document.getElementById('moduleDescRu').value;
        const descriptionUz = document.getElementById('moduleDescUz').value;
        
        const result = await apiRequest(`/api/subjects/${subjectId}/modules`, {
            method: 'POST',
            body: JSON.stringify({ nameRu, nameUz, descriptionRu, descriptionUz })
        });
        
        const messageDiv = document.getElementById('moduleMessage');
        
        if (result.success) {
            messageDiv.innerHTML = `<div class="success-message">${lang === 'uz' ? '‚úì Modul muvaffaqiyatli yaratildi!' : '‚úì –ú–æ–¥—É–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!'}</div>`;
            document.getElementById('createModuleForm').reset();
            await loadSubjectModules(subjectId);

            if (result.data?._id) {
                await apiRequest(`/api/modules/${result.data._id}/tests`, {
                    method: 'POST',
                    body: JSON.stringify({
                        nameRu: lang === 'uz' ? 'Test' : '–¢–µ—Å—Ç',
                        nameUz: lang === 'uz' ? 'Test' : 'Test',
                        duration: 30,
                        maxScore: 100,
                        status: 'published',
                        questions: []
                    })
                });
                router.navigate(`/teacher/module/${result.data._id}/tests`);
                return;
            }
            
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 3000);
        } else {
            messageDiv.innerHTML = `<div class="error-message">${result.error || t('error')}</div>`;
        }
    });
}

// Load modules for subject
async function loadSubjectModules(subjectId) {
    const lang = store.getState().language;
    const modulesList = document.getElementById('modulesList');
    
    console.log('üîç loadSubjectModules called with subjectId:', subjectId);
    
    modulesList.innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p>${lang === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</p>
        </div>
    `;
    
    const result = await apiRequest(`/api/subjects/${subjectId}/modules`);
    
    console.log('üì¶ Modules API response:', result);
    console.log('üìä result.success:', result.success);
    console.log('üìä result.data:', result.data);
    
    // Handle double-wrapped response (apiRequest already unwraps once)
    const modulesData = result.data?.data || result.data || [];
    console.log('üìä modulesData:', modulesData);
    console.log('üìä modulesData.length:', modulesData.length);
    console.log('üìä Is array?', Array.isArray(modulesData));
    
    if (result.success && modulesData && modulesData.length > 0) {
        console.log('‚úÖ Found', modulesData.length, 'modules');
        // Load test counts for each module
        const modulesWithTests = await Promise.all(
            modulesData.map(async (module) => {
                const testsResult = await apiRequest(`/api/modules/${module._id}/tests`);
                const testsData = testsResult.data?.data || testsResult.data || [];
                return {
                    ...module,
                    testCount: Array.isArray(testsData) ? testsData.length : 0
                };
            })
        );
        
        console.log('‚úÖ Modules with test counts:', modulesWithTests);
        
        modulesList.innerHTML = modulesWithTests.map(module => `
            <div class="card module-item" data-module-id="${module._id}" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-color); border-left: 4px solid var(--accent); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08); position: relative; overflow: hidden;">
                <div style="position: absolute; top: 0; right: 0; width: 100px; height: 100px; background: linear-gradient(135deg, var(--accent) 0%, transparent 50%); opacity: 0.1; pointer-events: none;"></div>
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem; position: relative;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: flex-start; gap: 1.25rem; margin-bottom: 1.25rem;">
                            <div style="width: 56px; height: 56px; background: linear-gradient(135deg, var(--accent), #06b6d4); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; flex-shrink: 0; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);">
                                üì¶
                            </div>
                            <div style="flex: 1; padding-top: 0.25rem;">
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 1.25rem; font-weight: 600; color: var(--text-primary);">${lang === 'uz' ? module.nameUz : module.nameRu}</h4>
                                <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem; line-height: 1.5;">
                                    ${lang === 'uz' ? module.descriptionUz : module.descriptionRu}
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 2.5rem; font-size: 0.875rem; padding: 1rem; background: var(--bg-primary); border-radius: 10px; margin-left: 72px;">
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem;">üìù</div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.125rem;">${lang === 'uz' ? 'Testlar' : '–¢–µ—Å—Ç—ã'}</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${module.testCount}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 1rem;">üìÖ</div>
                                <div>
                                    <div style="color: var(--text-muted); font-size: 0.75rem; margin-bottom: 0.125rem;">${lang === 'uz' ? 'Yaratilgan' : '–°–æ–∑–¥–∞–Ω–æ'}</div>
                                    <div style="font-weight: 600; color: var(--text-primary);">${new Date(module.createdAt).toLocaleDateString()}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; min-width: 160px;">
                        <button class="btn-module-tests button button-primary" data-module-id="${module._id}" style="width: 100%; padding: 12px 18px; font-size: 0.9rem; font-weight: 600; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; border-radius: 10px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span>üìù</span>
                            <span>${lang === 'uz' ? 'Testlar' : '–¢–µ—Å—Ç—ã'}</span>
                        </button>
                        <button class="btn-module-edit button button-secondary" data-module-id="${module._id}" style="width: 100%; padding: 12px 18px; font-size: 0.9rem; font-weight: 600; border-radius: 10px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span>‚úèÔ∏è</span>
                            <span>${lang === 'uz' ? 'Tahrirlash' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}</span>
                        </button>
                        <button class="btn-module-delete button button-danger" data-module-id="${module._id}" data-subject-id="${subjectId}" style="width: 100%; padding: 12px 18px; font-size: 0.9rem; font-weight: 600; border-radius: 10px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span>üóëÔ∏è</span>
                            <span>${lang === 'uz' ? 'O\'chirish' : '–£–¥–∞–ª–∏—Ç—å'}</span>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add event listeners to all module buttons
        document.querySelectorAll('.btn-module-tests').forEach(btn => {
            btn.addEventListener('click', () => {
                const moduleId = btn.getAttribute('data-module-id');
                router.navigate(`/teacher/module/${moduleId}/tests`);
            });
        });
        
        document.querySelectorAll('.btn-module-edit').forEach(btn => {
            btn.addEventListener('click', () => {
                const moduleId = btn.getAttribute('data-module-id');
                editModule(moduleId);
            });
        });
        
        document.querySelectorAll('.btn-module-delete').forEach(btn => {
            btn.addEventListener('click', () => {
                const moduleId = btn.getAttribute('data-module-id');
                const subjectId = btn.getAttribute('data-subject-id');
                deleteModuleConfirm(moduleId, subjectId);
            });
        });
        
        console.log('‚úÖ Event listeners attached to', document.querySelectorAll('.btn-module-tests').length, 'buttons');
    } else if (result.success) {
        console.log('‚ö†Ô∏è No modules found - showing empty state');
        modulesList.innerHTML = `
            <div class="card" style="text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 2px dashed var(--border-color);">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üì¶</div>
                <p style="color: var(--text-muted); font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">
                    ${lang === 'uz' ? 'Hali modullar yaratilmagan' : '–ú–æ–¥—É–ª–∏ –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã'}
                </p>
                <p style="color: var(--text-muted); margin-top: 0.5rem; font-size: 0.875rem;">
                    ${lang === 'uz' ? 'Yuqorida yangi modul yarating' : '–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å –≤—ã—à–µ'}
                </p>
            </div>
        `;
    } else {
        modulesList.innerHTML = `<div class="error-message">${result.error || t('error')}</div>`;
    }
}

// Edit module
function editModule(moduleId) {
    const lang = store.getState().language;
    const module = window.currentModules?.find(m => m._id === moduleId);
    
    if (!module) {
        alert(lang === 'uz' ? 'Modul topilmadi' : '–ú–æ–¥—É–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
    }
    
    const newNameRu = prompt(lang === 'uz' ? 'Modul nomi (Ruscha):' : '–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è (RU):', module.nameRu);
    if (!newNameRu) return;
    
    const newNameUz = prompt(lang === 'uz' ? 'Modul nomi (O\'zbekcha):' : '–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è (UZ):', module.nameUz);
    if (!newNameUz) return;
    
    const newDescRu = prompt(lang === 'uz' ? 'Tavsif (Ruscha):' : '–û–ø–∏—Å–∞–Ω–∏–µ (RU):', module.descriptionRu);
    if (!newDescRu) return;
    
    const newDescUz = prompt(lang === 'uz' ? 'Tavsif (O\'zbekcha):' : '–û–ø–∏—Å–∞–Ω–∏–µ (UZ):', module.descriptionUz);
    if (!newDescUz) return;
    
    updateModule(moduleId, newNameRu, newNameUz, newDescRu, newDescUz);
}

// Update module
async function updateModule(moduleId, nameRu, nameUz, descriptionRu, descriptionUz) {
    const lang = store.getState().language;
    
    const result = await apiRequest(`/api/modules/${moduleId}`, {
        method: 'PUT',
        body: JSON.stringify({ nameRu, nameUz, descriptionRu, descriptionUz })
    });
    
    if (result.success) {
        alert(lang === 'uz' ? 'Modul muvaffaqiyatli yangilandi!' : '–ú–æ–¥—É–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!');
        // Reload the modules list
        const subjectId = window.location.pathname.split('/')[3];
        await loadSubjectModules(subjectId);
    } else {
        alert(result.error || (lang === 'uz' ? 'Xato' : '–û—à–∏–±–∫–∞'));
    }
}

// Delete module with confirmation
async function deleteModuleConfirm(moduleId, subjectId) {
    const lang = store.getState().language;
    
    if (!confirm(lang === 'uz' ? 
        'Modulni o\'chirishga ishonchingiz komilmi? Modul ichidagi barcha testlar ham o\'chadi!' : 
        '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å? –í—Å–µ —Ç–µ—Å—Ç—ã –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è —Ç–∞–∫–∂–µ –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã!')) {
        return;
    }
    
    const result = await apiRequest(`/api/modules/${moduleId}`, {
        method: 'DELETE'
    });
    
    if (result.success) {
        await loadSubjectModules(subjectId);
    } else {
        alert(result.error || t('error'));
    }
}

// View Control Test Results
async function viewControlTestResults(testId) {
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        const response = await fetch(`${API_BASE_URL}/api/control-tests/${testId}/results`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch results');

        const result = await response.json();
        const results = result.data || [];

        const content = `
            <style>
                @media (max-width: 768px) {
                    #resultsHeader { flex-direction: column; align-items: flex-start; gap: 1rem; }
                    #btnBackFromResults { width: 100%; }
                    .results-table { font-size: 0.9rem; }
                    .results-table th, .results-table td { padding: 0.75rem 0.5rem !important; }
                    .student-name { font-size: 0.9rem; }
                    .student-id { font-size: 0.75rem; }
                }
                @media (max-width: 480px) {
                    #resultsHeader { padding: 0; }
                    #resultsHeader h1 { font-size: 1.5rem; }
                    #resultsHeader p { font-size: 0.85rem; }
                    #btnBackFromResults { padding: 0.6rem 1rem; font-size: 0.85rem; }
                    .results-table { font-size: 0.8rem; }
                    .results-table th, .results-table td { padding: 0.5rem 0.25rem !important; }
                    .student-name { font-size: 0.8rem; }
                    .student-id { display: none; }
                    .results-table th:nth-child(4), .results-table td:nth-child(4) { display: none; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1200px; margin: 0 auto;">
                    <!-- Header -->
                    <div id="resultsHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h1 style="margin: 0; font-size: 2rem;">${lang === 'uz' ? 'üìä Natijalar' : 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</h1>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">
                                ${results.length} ${lang === 'uz' ? 'ta natija' : '—Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'}
                            </p>
                        </div>
                        <button class="btn-secondary" id="btnBackFromResults" style="padding: 0.75rem 1.5rem;">
                            ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
                        </button>
                    </div>

                    <!-- Results Table -->
                    ${results.length === 0 ? `
                        <div class="card" style="text-align: center; padding: 3rem;">
                            <p style="color: var(--text-secondary); font-size: 1.1rem;">
                                ${lang === 'uz' ? 'Hali natija yo\'q' : '–†–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–µ—Ç'}
                            </p>
                        </div>
                    ` : `
                        <div style="background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto;">
                            <table class="results-table" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);">
                                        <th style="padding: 1rem; text-align: left; font-weight: 700;">${lang === 'uz' ? 'Talaba' : '–°—Ç—É–¥–µ–Ω—Ç'}</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 700;">‚úÖ ${lang === 'uz' ? "To'g'ri" : '–ü—Ä–∞–≤–∏–ª—å–Ω–æ'}</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 700;">üìä ${lang === 'uz' ? 'Ball' : '–ë–∞–ª–ª'}</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 700;">üìà ${lang === 'uz' ? 'Foiz' : '–ü—Ä–æ—Ü–µ–Ω—Ç'}</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 700;">üìÖ ${lang === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(res => {
                                        const percentage = res.totalCount > 0 ? Math.round((res.correctCount / res.totalCount) * 100) : 0;
                                        const date = new Date(res.completedAt).toLocaleDateString();
                                        return `
                                        <tr style="border-bottom: 1px solid var(--border-color); hover: background: var(--bg-tertiary);">
                                            <td style="padding: 1rem;">
                                                <div class="student-name" style="font-weight: 600;">${res.userName || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}</div>
                                                <div class="student-id" style="font-size: 0.85rem; color: var(--text-secondary);">${res.userId || ''}</div>
                                            </td>
                                            <td style="padding: 1rem; text-align: center;">
                                                <span style="font-weight: 700; color: #10B981;">${res.correctCount}/${res.totalCount}</span>
                                            </td>
                                            <td style="padding: 1rem; text-align: center;">
                                                <span style="font-weight: 700;">${res.score}</span>
                                            </td>
                                            <td style="padding: 1rem; text-align: center;">
                                                <span style="font-weight: 700; color: ${percentage >= 70 ? '#10B981' : percentage >= 50 ? '#F59E0B' : '#EF4444'};">
                                                    ${percentage}%
                                                </span>
                                            </td>
                                            <td style="padding: 1rem; text-align: center;">
                                                <span style="color: var(--text-secondary);">${date}</span>
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </div>
        `;

        renderLayout(content, 'teacher');

        document.getElementById('btnBackFromResults')?.addEventListener('click', () => {
            router.navigate('/teacher/control-tests');
        });

    } catch (error) {
        console.error('‚ùå Error loading results:', error);
        showAlert(lang === 'uz' ? 'Natijalarni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤', 'error');
        router.navigate('/teacher/control-tests');
    }
}

// Preview Control Test
async function previewControlTest(testId) {
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        const response = await fetch(`${API_BASE_URL}/api/control-tests/${testId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch test');

        const result = await response.json();
        const test = result.data || result;
        const questions = test.questions || [];

        const content = `
            <style>
                @media (max-width: 768px) {
                    #previewHeader { flex-direction: column; align-items: flex-start; gap: 1rem; }
                    #previewHeader h1 { font-size: 1.5rem; }
                    #btnBackFromPreview { width: 100%; }
                    .test-info-grid { grid-template-columns: 1fr !important; }
                    .question-card { padding: 1.25rem !important; }
                    .question-badge { width: 36px; height: 36px; font-size: 0.9rem; }
                    .answer-option { padding: 0.75rem !important; gap: 0.5rem !important; }
                }
                @media (max-width: 480px) {
                    #previewHeader { padding: 0; }
                    #previewHeader h1 { font-size: 1.3rem; }
                    #previewHeader p { font-size: 0.85rem; line-height: 1.4; }
                    #btnBackFromPreview { padding: 0.6rem 1rem; font-size: 0.85rem; }
                    .test-info-grid { grid-template-columns: 1fr !important; }
                    .test-info-box { padding: 1rem !important; }
                    .test-info-box-value { font-size: 1.3rem !important; }
                    .question-card { padding: 1rem !important; margin-bottom: 1rem !important; }
                    .question-badge { width: 32px; height: 32px; font-size: 0.85rem; margin-right: 0.5rem; }
                    .question-text { font-size: 1rem; }
                    .answer-option { padding: 0.65rem !important; font-size: 0.9rem; }
                    .answer-option input { width: 16px; height: 16px; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 900px; margin: 0 auto;">
                    <!-- Header -->
                    <div id="previewHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h1 style="margin: 0; font-size: 2rem;">${lang === 'uz' ? test.nameUz : test.nameRu}</h1>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary);">
                                ${lang === 'uz' ? test.descriptionUz : test.descriptionRu}
                            </p>
                        </div>
                        <button class="btn-secondary" id="btnBackFromPreview" style="padding: 0.75rem 1.5rem;">
                            ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
                        </button>
                    </div>

                    <!-- Test Info -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem;">
                        <div class="test-info-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            <div class="test-info-box" style="padding: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 600;">‚è±Ô∏è ${lang === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}</div>
                                <div class="test-info-box-value" style="font-size: 1.5rem; font-weight: 800;">${test.duration || 60} ${lang === 'uz' ? 'min' : '–º–∏–Ω'}</div>
                            </div>
                            <div class="test-info-box" style="padding: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 600;">‚≠ê ${lang === 'uz' ? 'Maksimal ball' : '–ú–∞–∫—Å. –±–∞–ª–ª–æ–≤'}</div>
                                <div class="test-info-box-value" style="font-size: 1.5rem; font-weight: 800;">${test.maxScore || 100}</div>
                            </div>
                            <div class="test-info-box" style="padding: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); font-weight: 600;">‚ùì ${lang === 'uz' ? 'Savollar' : '–í–æ–ø—Ä–æ—Å—ã'}</div>
                                <div class="test-info-box-value" style="font-size: 1.5rem; font-weight: 800;">${questions.length}</div>
                            </div>
                        </div>
                    </div>

                    <!-- Questions -->
                    <div>
                        ${questions.map((q, idx) => `
                            <div class="question-card" style="background: var(--bg-secondary); border: 2px solid var(--border-color); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                    <div class="question-badge" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800;">
                                        ${idx + 1}
                                    </div>
                                    <h3 class="question-text" style="margin: 0; font-size: 1.1rem;">${lang === 'uz' ? q.questionUz : q.questionRu}</h3>
                                </div>
                                
                                <div style="margin-left: 56px; display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${q.answers.map((ans, ansIdx) => `
                                        <div class="answer-option" style="padding: 0.75rem 1rem; background: ${ans.isCorrect ? 'rgba(16, 185, 129, 0.15)' : 'var(--bg-tertiary)'}; border: 2px solid ${ans.isCorrect ? '#10B981' : 'var(--border-color)'}; border-radius: 8px; display: flex; align-items: center; gap: 0.75rem;">
                                            <input type="radio" disabled style="cursor: not-allowed;">
                                            <span>${lang === 'uz' ? ans.textUz : ans.textRu}</span>
                                            ${ans.isCorrect ? `<span style="color: #10B981; font-weight: 700; margin-left: auto;">‚úÖ ${lang === 'uz' ? "To'g'ri" : '–ü—Ä–∞–≤–∏–ª—å–Ω–æ'}</span>` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        renderLayout(content, 'teacher');

        document.getElementById('btnBackFromPreview')?.addEventListener('click', () => {
            router.navigate('/teacher/control-tests');
        });

    } catch (error) {
        console.error('‚ùå Error loading test:', error);
        showAlert(lang === 'uz' ? 'Testni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–∞', 'error');
        router.navigate('/teacher/control-tests');
    }
}

// Edit Control Test
async function editControlTest(testId, myTests, allClasses) {
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        const response = await fetch(`${API_BASE_URL}/api/control-tests/${testId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch test');

        const result = await response.json();
        const test = result.data || result;

        // Show modal with edit form
        const content = `
            <style>
                @media (max-width: 768px) {
                    #editHeader { flex-direction: column; align-items: flex-start; gap: 1rem; }
                    #editHeader h1 { font-size: 1.5rem; }
                    #btnBackFromEdit { width: 100%; }
                    #editTestForm { padding: 1.5rem; }
                    .edit-input { font-size: 1rem; }
                    .edit-buttons { flex-direction: column; }
                    .edit-buttons button { width: 100%; }
                }
                @media (max-width: 480px) {
                    #editHeader { padding: 0; }
                    #editHeader h1 { font-size: 1.3rem; }
                    #btnBackFromEdit { padding: 0.6rem 1rem; font-size: 0.85rem; }
                    #editTestForm { padding: 1.25rem; }
                    .form-section h3 { font-size: 1rem; }
                    .form-group label { font-size: 0.9rem; }
                    .edit-input { padding: 0.65rem; font-size: 0.9rem; }
                    .edit-buttons { gap: 0.5rem; }
                    .edit-buttons button { padding: 0.6rem !important; font-size: 0.85rem; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <!-- Header -->
                    <div id="editHeader" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <div>
                            <h1 style="margin: 0; font-size: 2rem;">‚úèÔ∏è ${lang === 'uz' ? 'Testni tahrirlash' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ—Å—Ç'}</h1>
                        </div>
                        <button class="btn-secondary" id="btnBackFromEdit" style="padding: 0.75rem 1.5rem;">
                            ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
                        </button>
                    </div>

                    <!-- Edit Form -->
                    <form id="editTestForm" style="background: var(--bg-secondary); border-radius: 12px; padding: 2rem; border: 1px solid var(--border-color);">
                        <!-- Basic Info -->
                        <div class="form-section" style="margin-bottom: 2rem;">
                            <h3 style="margin: 0 0 1rem 0; font-size: 1.1rem;">${lang === 'uz' ? 'Asosiy ma\'lumot' : '–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}</h3>
                            
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    ${lang === 'uz' ? 'Nomi (Rus)' : '–ù–∞–∑–≤–∞–Ω–∏–µ (–†—É—Å)'}
                                </label>
                                <input type="text" id="editNameRu" value="${test.nameRu || ''}" class="edit-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;">
                            </div>

                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                    ${lang === 'uz' ? 'Nomi (Uzbek)' : '–ù–∞–∑–≤–∞–Ω–∏–µ (–£–∑–±)'}
                                </label>
                                <input type="text" id="editNameUz" value="${test.nameUz || ''}" class="edit-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary); font-size: 1rem;">
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        ‚è±Ô∏è ${lang === 'uz' ? 'Vaqt (daqiqa)' : '–í—Ä–µ–º—è (–º–∏–Ω—É—Ç)'}
                                    </label>
                                    <input type="number" id="editDuration" value="${test.duration || 60}" min="1" class="edit-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary);">
                                </div>
                                <div class="form-group">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">
                                        ‚≠ê ${lang === 'uz' ? 'Maksimal ball' : '–ú–∞–∫—Å. –±–∞–ª–ª–æ–≤'}
                                    </label>
                                    <input type="number" id="editMaxScore" value="${test.maxScore || 100}" min="1" class="edit-input" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-tertiary); color: var(--text-primary);">>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="edit-buttons" style="display: flex; gap: 1rem; justify-content: flex-end;">
                            <button type="button" class="btn-secondary" id="btnCancelEdit" style="padding: 0.75rem 1.5rem;">
                                ${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}
                            </button>
                            <button type="button" class="btn-primary" id="btnSaveEdit" style="padding: 0.75rem 1.5rem;">
                                ‚úÖ ${lang === 'uz' ? 'Saqlash' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        renderLayout(content, 'teacher');

        document.getElementById('btnBackFromEdit')?.addEventListener('click', () => {
            router.navigate('/teacher/control-tests');
        });

        document.getElementById('btnCancelEdit')?.addEventListener('click', () => {
            router.navigate('/teacher/control-tests');
        });

        document.getElementById('btnSaveEdit')?.addEventListener('click', async () => {
            const nameRu = document.getElementById('editNameRu').value.trim();
            const nameUz = document.getElementById('editNameUz').value.trim();
            const duration = parseInt(document.getElementById('editDuration').value);
            const maxScore = parseInt(document.getElementById('editMaxScore').value);

            if (!nameRu || !nameUz || !duration || !maxScore) {
                showAlert(lang === 'uz' ? 'Barcha maydonlarni to\'ldiring' : '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/api/control-tests/${testId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        nameRu,
                        nameUz,
                        duration,
                        maxScore
                    })
                });

                if (!response.ok) throw new Error('Update failed');

                showAlert(lang === 'uz' ? '‚úÖ Saqlandi!' : '‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ!', 'success');
                router.navigate('/teacher/control-tests');
            } catch (error) {
                console.error('‚ùå Error updating test:', error);
                showAlert(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞', 'error');
            }
        });

    } catch (error) {
        console.error('‚ùå Error loading test:', error);
        showAlert(lang === 'uz' ? 'Testni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–∞', 'error');
        router.navigate('/teacher/control-tests');
    }
}

// Teacher Control Tests Management
// ===========================================
async function renderTeacherControlTests() {
    const lang = store.getState().language;
    const user = store.getState().user;
    const token = store.getState().token;

    try {
        // Fetch all classes to show assignment options
        const classesResponse = await fetch(`${API_BASE_URL}/api/classes`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const classesData = await classesResponse.json();
        const allClasses = classesData.data || [];

        // Fetch control tests created by this teacher
        const userId = user.id || user._id;
        const testsResponse = await fetch(`${API_BASE_URL}/api/control-tests?createdBy=` + userId, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const testsData = await testsResponse.json();
        const myTests = testsData.data || [];

        const content = `
            <div class="page-header">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <div>
                        <h1>${lang === 'uz' ? 'Nazorat isbotlari' : '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã'}</h1>
                        <p>${lang === 'uz' ? 'Isbotlarni yaratish va boshqarish' : '–°–æ–∑–¥–∞–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞–º–∏'}</p>
                    </div>
                    <div style="display: flex; gap: 0.75rem; align-items: center;">
                        <button class="button button-secondary" id="btnBackFromControlTests">
                            ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
                        </button>
                        <button class="btn-primary" id="btnCreateControlTest">
                            <span>‚ûï</span>
                            <span>${lang === 'uz' ? 'Yangi isbot' : '–°–æ–∑–¥–∞—Ç—å'}</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="controlTestsContainer" style="margin-top: 2rem;">
                ${myTests.length === 0 ? `
                    <div class="card" style="text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">‚úèÔ∏è</div>
                        <h3>${lang === 'uz' ? 'Hali nazorat isboti mavjud emas' : '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã'}</h3>
                        <p style="color: var(--text-secondary); margin: 1rem 0;">${lang === 'uz' ? 'Birinchi nazorat isbotini yaratish uchun tugmani bosing' : '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É'}</p>
                    </div>
                ` : `
                    <div class="tests-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
                        ${myTests.map(test => `
                            <div class="card" data-test-id="${test._id}">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.1rem;">${lang === 'uz' ? test.nameUz : test.nameRu}</h3>
                                        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                            ${test.assignedClasses ? test.assignedClasses.join(', ') : '–ù–∞–∑–Ω–∞—á–µ–Ω–æ'}
                                        </p>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        <button class="btn-icon btn-edit" data-test-id="${test._id}" style="padding: 0.5rem; background: var(--bg-secondary); border: none; border-radius: 6px; cursor: pointer;">‚úèÔ∏è</button>
                                        <button class="btn-icon btn-delete" data-test-id="${test._id}" style="padding: 0.5rem; background: #fee2e2; border: none; border-radius: 6px; cursor: pointer; color: #dc2626;">üóëÔ∏è</button>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                                    <div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">‚è±Ô∏è ${lang === 'uz' ? 'Vaqt' : '–í—Ä–µ–º—è'}</div>
                                        <div style="font-weight: bold; font-size: 1.1rem;">${test.duration || 60} –º–∏–Ω</div>
                                    </div>
                                    <div style="background: var(--bg-secondary); padding: 0.75rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">‚≠ê ${lang === 'uz' ? 'Ball' : '–ë–∞–ª–ª—ã'}</div>
                                        <div style="font-weight: bold; font-size: 1.1rem;">${test.maxScore || 100}</div>
                                    </div>
                                </div>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <button class="btn-secondary btn-view-results" data-test-id="${test._id}" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                                        ${lang === 'uz' ? 'üìä Natijalar' : 'üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã'}
                                    </button>
                                    <button class="btn-secondary btn-preview" data-test-id="${test._id}" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer;">
                                        ${lang === 'uz' ? 'üëÅÔ∏è Ko\'rish' : 'üëÅÔ∏è –ü—Ä–æ—Å–º–æ—Ç—Ä'}
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `}
            </div>

            <div id="controlTestFormModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; align-items: center; justify-content: center; padding: 1rem;">
                <div style="width: 100%; max-width: 1000px; max-height: 95vh; overflow-y: auto; background: var(--bg-primary); border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <!-- Header -->
                    <div style="background: linear-gradient(135deg, #ec4899 0%, #f97316 100%); padding: 2rem; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10;">
                        <div>
                            <h2 style="margin: 0; color: white; font-size: 1.75rem;">‚úèÔ∏è ${lang === 'uz' ? 'Yangi nazorat isbot' : '–°–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—É—é —Ä–∞–±–æ—Ç—É'}</h2>
                            <p style="margin: 0.5rem 0 0 0; color: rgba(255,255,255,0.9); font-size: 0.95rem;">${lang === 'uz' ? 'Savollar va javob variantlarini qo\'shing' : '–î–æ–±–∞–≤—å—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤'}</p>
                        </div>
                        <button id="btnCloseForm" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 2rem; cursor: pointer; width: 50px; height: 50px; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">‚úï</button>
                    </div>

                    <form id="controlTestForm" style="padding: 2rem;">
                        <!-- Titles Section -->
                        <div style="margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem; margin-right: 0.75rem;">üìù</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">${lang === 'uz' ? 'Sarlavha' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤'}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">üá∑üá∫ ${lang === 'uz' ? 'Rus tili' : '–†—É—Å—Å–∫–∏–π'}</label>
                                    <input type="text" id="testNameRu" placeholder="–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ1" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; transition: all 0.2s;" required />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">üá∫üáø O'zbek</label>
                                    <input type="text" id="testNameUz" placeholder="Nazorat isbo'ti ‚Ññ1" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; transition: all 0.2s;" required />
                                </div>
                            </div>
                        </div>

                        <!-- Description Section -->
                        <div style="margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem; margin-right: 0.75rem;">üí¨</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">${lang === 'uz' ? 'Tavsif' : '–û–ø–∏—Å–∞–Ω–∏–µ'}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div>
                                    <textarea id="testDescRu" placeholder="–û–ø–∏—à–∏—Ç–µ —Ç–µ—Å—Ç..." rows="3" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; resize: none; font-family: inherit; transition: all 0.2s;"></textarea>
                                </div>
                                <div>
                                    <textarea id="testDescUz" placeholder="Testni tavsiflab bering..." rows="3" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; resize: none; font-family: inherit; transition: all 0.2s;"></textarea>
                                </div>
                            </div>
                        </div>

                        <!-- Settings Section -->
                        <div style="margin-bottom: 2rem; background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; margin-bottom: 1rem;">
                                <span style="font-size: 1.5rem; margin-right: 0.75rem;">‚öôÔ∏è</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">${lang === 'uz' ? 'Sozlamalar' : '–ü–∞—Ä–∞–º–µ—Ç—Ä—ã'}</h3>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">‚è±Ô∏è ${lang === 'uz' ? 'Vaqt (daqiqa)' : '–í—Ä–µ–º—è (–º–∏–Ω—É—Ç—ã)'}</label>
                                    <input type="number" id="testDuration" min="5" max="360" value="60" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;" required />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">‚≠ê ${lang === 'uz' ? 'Maksimal ball' : '–ú–∞–∫—Å. –±–∞–ª–ª—ã'}</label>
                                    <input type="number" id="testMaxScore" min="10" max="1000" value="100" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; font-weight: 600; transition: all 0.2s;" required />
                                </div>
                                <div>
                                    <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 500;">üì¶ ${lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å'}</label>
                                    <select id="testClass">
                                        <option value="">-- ${lang === 'uz' ? 'Tanlash' : '–í—ã–±—Ä–∞—Ç—å'} --</option>
                                        ${allClasses.map(cls => `<option value="${cls.grade}${cls.section || ''}">${cls.grade}${cls.section || ''}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Questions Section -->
                        <div style="margin-bottom: 2rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                                <div style="display: flex; align-items: center;">
                                    <span style="font-size: 1.5rem; margin-right: 0.75rem;">‚ùì</span>
                                    <h3 style="margin: 0; font-size: 1.1rem;">${lang === 'uz' ? 'Savollar' : '–í–æ–ø—Ä–æ—Å—ã'}</h3>
                                </div>
                                <button type="button" id="btnAddQuestion" style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                                    ‚ûï ${lang === 'uz' ? 'Savol qo\'shish' : '–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å'}
                                </button>
                            </div>
                            <div id="questionsContainer" style="display: grid; gap: 1.5rem;"></div>
                        </div>

                        <!-- Form Actions -->
                        <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
                            <button type="button" id="btnCancelForm" style="padding: 0.75rem 2rem; background: var(--bg-secondary); color: var(--text-primary); border: 2px solid var(--border-color); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s;">
                                ${lang === 'uz' ? 'Bekor qilish' : '–û—Ç–º–µ–Ω–∞'}
                            </button>
                            <button type="submit" style="padding: 0.75rem 2rem; background: linear-gradient(135deg, #ec4899 0%, #f97316 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.95rem; transition: all 0.2s; box-shadow: 0 4px 12px rgba(236, 72, 153, 0.3);">
                                üíæ ${lang === 'uz' ? 'Saqlash' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;

        renderLayout(content, 'teacher');

        document.getElementById('btnBackFromControlTests')?.addEventListener('click', () => {
            router.navigate('/teacher/dashboard');
        });

        // Initialize form handlers
        initControlTestForm(allClasses);

        // Add action buttons handlers
        document.querySelectorAll('.btn-edit').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const testId = btn.dataset.testId;
                editControlTest(testId, myTests, allClasses);
            });
        });

        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const testId = btn.dataset.testId;
                if (confirm(lang === 'uz' ? 'Ishonchingiz komilmi?' : '–í—ã —É–≤–µ—Ä–µ–Ω—ã?')) {
                    deleteControlTest(testId);
                }
            });
        });

        document.querySelectorAll('.btn-view-results').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const testId = btn.dataset.testId;
                viewControlTestResults(testId);
            });
        });

        document.querySelectorAll('.btn-preview').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const testId = btn.dataset.testId;
                previewControlTest(testId);
            });
        });

    } catch (error) {
        console.error('‚ùå Error loading control tests:', error);
        const content = `
            <div class="page-header">
                <h1>${lang === 'uz' ? 'Nazorat isbotlari' : '–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Ä–∞–±–æ—Ç—ã'}</h1>
            </div>
            <div class="card error-message">
                <p>${lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</p>
            </div>
        `;
        renderLayout(content, 'teacher');
    }
}

// Initialize control test form
function initControlTestForm(allClasses) {
    const lang = store.getState().language;
    const token = store.getState().token;
    let questionCount = 0;

    const modal = document.getElementById('controlTestFormModal');
    const form = document.getElementById('controlTestForm');
    const btnCreate = document.getElementById('btnCreateControlTest');
    const btnClose = document.getElementById('btnCloseForm');
    const btnCancel = document.getElementById('btnCancelForm');
    const btnAddQuestion = document.getElementById('btnAddQuestion');
    const questionsContainer = document.getElementById('questionsContainer');

    // Open form
    btnCreate?.addEventListener('click', () => {
        modal.style.display = 'flex';
        questionCount = 0;
        questionsContainer.innerHTML = '';
        addQuestionField();
    });

    // Close form
    const closeForm = () => {
        modal.style.display = 'none';
        form.reset();
    };

    btnClose?.addEventListener('click', closeForm);
    btnCancel?.addEventListener('click', closeForm);

    // Add question field
    function addQuestionField() {
        const qIndex = questionCount++;
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-item';
        questionDiv.setAttribute('data-question-index', qIndex);
        questionDiv.style.cssText = 'background: var(--bg-secondary); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--border-color); box-shadow: 0 4px 12px rgba(0,0,0,0.05);';

        questionDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);">
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.9rem;">‚ùì ${qIndex + 1}</span>
                    <h4 style="margin: 0; font-size: 1rem;">${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å'}</h4>
                </div>
                <button type="button" class="btn-remove-question" data-index="${qIndex}" style="background: #fee2e2; border: none; color: #dc2626; cursor: pointer; font-size: 1.5rem; width: 40px; height: 40px; border-radius: 8px; transition: all 0.2s; display: flex; align-items: center; justify-content: center;">üóëÔ∏è</button>
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; margin-bottom: 0.75rem; font-size: 0.95rem; font-weight: 600; color: var(--text-primary);">üìÑ ${lang === 'uz' ? 'Savol matni' : '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞'}</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üá∑üá∫ –†—É—Å—Å–∫–∏–π</div>
                        <input type="text" class="question-text-ru" placeholder="–ö–∞–∫–æ–π –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç?" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; transition: all 0.2s;" required />
                    </div>
                    <div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.5rem;">üá∫üáø O'zbek</div>
                        <input type="text" class="question-text-uz" placeholder="To'g'ri javob qaysi?" style="padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.95rem; transition: all 0.2s;" required />
                    </div>
                </div>
            </div>

            <div style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <label style="font-size: 0.95rem; font-weight: 600; color: var(--text-primary);">üìã ${lang === 'uz' ? 'Javob variantlari' : '–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤'}</label>
                    <button type="button" class="btn-add-answer" data-index="${qIndex}" style="padding: 0.5rem 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.2s;">
                        ‚ûï ${lang === 'uz' ? 'Qo\'sh' : '–î–æ–±–∞–≤–∏—Ç—å'}
                    </button>
                </div>
                <div class="answers-container" style="display: grid; gap: 0.75rem; background: var(--bg-primary); padding: 1rem; border-radius: 8px; border: 1px solid var(--border-color);"></div>
            </div>
        `;

        questionsContainer.appendChild(questionDiv);

        // Add answer fields
        const answersContainer = questionDiv.querySelector('.answers-container');
        let answerCount = 0;

        const addAnswerField = () => {
            const aIndex = answerCount++;
            const answerDiv = document.createElement('div');
            answerDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 50px auto; gap: 0.75rem; align-items: start; padding: 0.75rem; background: var(--bg-secondary); border-radius: 8px; border: 1px solid var(--border-color);';

            answerDiv.innerHTML = `
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">üá∑üá∫</div>
                    <input type="text" class="answer-text-ru" placeholder="–í–∞—Ä–∏–∞–Ω—Ç 1..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.9rem; transition: all 0.2s;" required />
                </div>
                <div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">üá∫üáø</div>
                    <input type="text" class="answer-text-uz" placeholder="Variant 1..." style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-primary); color: var(--text-primary); width: 100%; font-size: 0.9rem; transition: all 0.2s;" required />
                </div>
                <label style="display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer; background: var(--bg-primary); padding: 0.5rem; border-radius: 6px; border: 2px solid var(--border-color); transition: all 0.2s; min-height: 40px;">
                    <input type="checkbox" class="answer-correct" style="cursor: pointer; width: 18px; height: 18px;" />
                    <span style="font-size: 0.85rem; font-weight: 600;">‚úì</span>
                </label>
                <button type="button" style="background: #fee2e2; border: none; color: #dc2626; cursor: pointer; width: 40px; height: 40px; border-radius: 6px; transition: all 0.2s; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">üóëÔ∏è</button>
            `;

            // Remove answer button
            answerDiv.querySelector('button').addEventListener('click', (e) => {
                e.preventDefault();
                answerDiv.remove();
            });

            answersContainer.appendChild(answerDiv);
        };

        // Add initial answer fields
        addAnswerField();
        addAnswerField();

        // Add answer button handler
        questionDiv.querySelector('.btn-add-answer')?.addEventListener('click', (e) => {
            e.preventDefault();
            addAnswerField();
        });

        // Remove question button handler
        questionDiv.querySelector('.btn-remove-question')?.addEventListener('click', (e) => {
            e.preventDefault();
            questionDiv.remove();
        });
    }

    btnAddQuestion?.addEventListener('click', (e) => {
        e.preventDefault();
        addQuestionField();
    });

    // Submit form
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Collect form data
        const nameRu = document.getElementById('testNameRu').value;
        const nameUz = document.getElementById('testNameUz').value;
        const descRu = document.getElementById('testDescRu').value;
        const descUz = document.getElementById('testDescUz').value;
        const duration = parseInt(document.getElementById('testDuration').value);
        const maxScore = parseInt(document.getElementById('testMaxScore').value);
        const assignedClass = document.getElementById('testClass').value;

        // Collect questions
        const questions = [];
        document.querySelectorAll('.question-item').forEach((qDiv) => {
            const textRu = qDiv.querySelector('.question-text-ru').value;
            const textUz = qDiv.querySelector('.question-text-uz').value;

            const answers = [];
            qDiv.querySelectorAll('.answers-container > div').forEach((aDiv) => {
                const ansRu = aDiv.querySelector('.answer-text-ru').value;
                const ansUz = aDiv.querySelector('.answer-text-uz').value;
                const isCorrect = aDiv.querySelector('.answer-correct').checked;

                answers.push({ textRu: ansRu, textUz: ansUz, isCorrect });
            });

            questions.push({ questionRu: textRu, questionUz: textUz, answers });
        });

        if (questions.length === 0) {
            alert(lang === 'uz' ? 'Hech bo\'lmaganda bitta savol qo\'shish kerak' : '–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            return;
        }

        // Create control test
        try {
            const response = await fetch(`${API_BASE_URL}/api/control-tests`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    nameRu,
                    nameUz,
                    descriptionRu: descRu,
                    descriptionUz: descUz,
                    duration,
                    maxScore,
                    questions,
                    assignedClasses: assignedClass ? [assignedClass] : []
                })
            });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Creation failed');
            }

            const result = await response.json();
            console.log('‚úÖ Control test created:', result);

            closeForm();
            // Reload page
            router.navigate('/teacher/control-tests');

        } catch (error) {
            console.error('‚ùå Error creating control test:', error);
            alert(lang === 'uz' ? 'Xatolik: ' + error.message : '–û—à–∏–±–∫–∞: ' + error.message);
        }
    });
}

// Delete control test
async function deleteControlTest(testId) {
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        const response = await fetch(`/api/control-tests/${testId}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Delete failed');

        console.log('‚úÖ Control test deleted');
        router.navigate('/teacher/control-tests');

    } catch (error) {
        console.error('‚ùå Error deleting control test:', error);
        alert(lang === 'uz' ? 'O\'chirishda xatolik yuz berdi' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏');
    }
}

// Teacher Subject Module Analytics
// ===========================================
async function renderTeacherSubjectModuleAnalytics() {
    const lang = store.getState().language;
    const user = store.getState().user;

    if (!user) {
        router.navigate('/login');
        return;
    }

    const content = `
        <div class="teacher-module-analytics">
            <div class="page-header">
                <div class="page-header-title">
                    <h1>${lang === 'uz' ? 'Mavzular bo\'yicha analitika' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ —Ç–µ–º–∞–º'}</h1>
                    <p class="page-header-subtitle">${lang === 'uz' ? 'Fan va sinfni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–ª–∞—Å—Å'}</p>
                </div>
                <div class="page-header-actions">
                    <button class="back-button back-button--compact" id="btnBackFromModuleAnalytics">
                        <span>‚Üê</span>
                        <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                    </button>
                </div>
            </div>

            <div class="card teacher-module-analytics__controls">
                <div class="teacher-module-analytics__control">
                    <label for="teacherModuleSubjectSelect">${lang === 'uz' ? 'Fan' : '–ü—Ä–µ–¥–º–µ—Ç'}</label>
                    <select id="teacherModuleSubjectSelect">
                        <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                    </select>
                </div>
                <div class="teacher-module-analytics__control">
                    <label for="teacherModuleClassSelect">${lang === 'uz' ? 'Sinf yoki parallel' : '–ö–ª–∞—Å—Å –∏–ª–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å'}</label>
                    <select id="teacherModuleClassSelect">
                        <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                    </select>
                </div>
            </div>

            <div class="teacher-module-analytics__chart">
                <div id="teacherModuleAnalyticsEmpty" class="card" style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                    ${lang === 'uz' ? 'Ma\'lumotlarni ko\'rish uchun fan va sinfni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–ª–∞—Å—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö'}
                </div>
                <canvas id="teacherModuleAnalyticsChart" style="max-height: 360px; width: 100%; display: none;"></canvas>
            </div>

            <div id="teacherModuleAnalyticsSummary" class="teacher-module-analytics__summary"></div>
        </div>
    `;

    renderLayout(content, 'teacher');

    document.getElementById('btnBackFromModuleAnalytics')?.addEventListener('click', () => {
        router.navigate('/teacher/subjects');
    });

    const subjectSelect = document.getElementById('teacherModuleSubjectSelect');
    const classSelect = document.getElementById('teacherModuleClassSelect');
    const summaryEl = document.getElementById('teacherModuleAnalyticsSummary');
    const emptyEl = document.getElementById('teacherModuleAnalyticsEmpty');

    const setEmptyState = (message) => {
        if (emptyEl) {
            emptyEl.textContent = message;
        }
        renderBarChart('teacherModuleAnalyticsChart', 'teacherModuleAnalyticsEmpty', { labels: [], series: [] });
        if (summaryEl) summaryEl.innerHTML = '';
    };

    const optionsRes = await apiRequest('/api/teacher/analytics/subject-modules/options');
    if (!optionsRes.success) {
        showAlert(optionsRes.error || (lang === 'uz' ? 'Ma\'lumotlarni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö'), 'error');
        setEmptyState(lang === 'uz' ? 'Ma\'lumotlarni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö');
        return;
    }

    const { subjects = [], classes = [], grades = [] } = optionsRes.data || {};

    if (subjectSelect) {
        if (!subjects.length) {
            subjectSelect.innerHTML = `<option value="">${lang === 'uz' ? 'Fanlar topilmadi' : '–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</option>`;
            subjectSelect.disabled = true;
        } else {
            subjectSelect.innerHTML = `
                <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                ${subjects.map(subject => `
                    <option value="${subject._id}">${lang === 'uz' ? (subject.nameUz || subject.nameRu) : (subject.nameRu || subject.nameUz)}</option>
                `).join('')}
            `;
        }
    }

    if (classSelect) {
        if (!classes.length) {
            classSelect.innerHTML = `<option value="">${lang === 'uz' ? 'Sinflar topilmadi' : '–ö–ª–∞—Å—Å—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</option>`;
            classSelect.disabled = true;
        } else {
            const gradeSections = new Map();
            classes.forEach(cls => {
                const grade = String(cls.grade || '').trim();
                if (!grade) return;
                if (!gradeSections.has(grade)) gradeSections.set(grade, new Set());
                const bucket = gradeSections.get(grade);
                if (Array.isArray(cls.sections) && cls.sections.length) {
                    cls.sections.forEach(section => bucket.add(section));
                } else if (cls.name) {
                    bucket.add(cls.name);
                }
            });

            const gradeList = grades.length ? grades : Array.from(gradeSections.keys());
            const options = gradeList.map(grade => {
                const sections = Array.from(gradeSections.get(String(grade)) || []).sort();
                const parallelLabel = lang === 'uz' ? `${grade}-sinflar` : `${grade}-–µ –∫–ª–∞—Å—Å—ã`;
                const parallelOption = `<option value="grade|${grade}">${parallelLabel}</option>`;
                const sectionOptions = sections.map(section => `<option value="section|${grade}|${section}">${grade}${section}</option>`).join('');
                return parallelOption + sectionOptions;
            }).join('');

            classSelect.innerHTML = `
                <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                ${options}
            `;
        }
    }

    const parseClassValue = (value) => {
        if (!value) return null;
        const parts = value.split('|');
        if (parts[0] === 'grade' && parts[1]) {
            return { grade: parts[1], section: null };
        }
        if (parts[0] === 'section' && parts[1]) {
            return { grade: parts[1], section: parts[2] || null };
        }
        return null;
    };

    const loadAnalytics = async () => {
        const subjectId = subjectSelect?.value;
        const classValue = classSelect?.value;
        const classData = parseClassValue(classValue);

        if (!subjectId || !classData?.grade) {
            setEmptyState(lang === 'uz' ? 'Fan va sinfni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏ –∫–ª–∞—Å—Å');
            return;
        }

        const query = new URLSearchParams({
            subjectId,
            grade: classData.grade
        });
        if (classData.section) {
            query.set('section', classData.section);
        }

        const res = await apiRequest(`/api/teacher/analytics/subject-modules?${query.toString()}`);
        if (!res.success) {
            setEmptyState(res.error || (lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'));
            return;
        }

        const modules = res.data?.modules || [];
        const labels = modules.map(module => lang === 'uz' ? (module.nameUz || module.nameRu) : (module.nameRu || module.nameUz));
        const scores = modules.map(module => typeof module.averageScore === 'number' ? module.averageScore : null);
        const hasScores = scores.some(score => typeof score === 'number');

        if (!hasScores) {
            setEmptyState(lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
        } else {
            renderBarChart('teacherModuleAnalyticsChart', 'teacherModuleAnalyticsEmpty', {
                labels,
                series: [
                    {
                        label: lang === 'uz' ? 'O\'rtacha natija' : '–°—Ä–µ–¥–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç',
                        data: scores
                    }
                ]
            });
        }

        if (summaryEl) {
            const studentCount = res.data?.studentCount ?? 0;
            const attempts = modules.reduce((sum, module) => sum + (module.attempts || 0), 0);
            summaryEl.innerHTML = `
                <div class="teacher-module-analytics__summary-card">
                    <div class="teacher-module-analytics__summary-label">${lang === 'uz' ? 'O\'quvchilar' : '–£—á–µ–Ω–∏–∫–∏'}</div>
                    <div class="teacher-module-analytics__summary-value">${studentCount}</div>
                </div>
                <div class="teacher-module-analytics__summary-card">
                    <div class="teacher-module-analytics__summary-label">${lang === 'uz' ? 'Urinishlar' : '–ü–æ–ø—ã—Ç–∫–∏'}</div>
                    <div class="teacher-module-analytics__summary-value">${attempts}</div>
                </div>
                <div class="teacher-module-analytics__summary-card">
                    <div class="teacher-module-analytics__summary-label">${lang === 'uz' ? 'Mavzular' : '–¢–µ–º—ã'}</div>
                    <div class="teacher-module-analytics__summary-value">${modules.length}</div>
                </div>
            `;
        }
    };

    subjectSelect?.addEventListener('change', loadAnalytics);
    classSelect?.addEventListener('change', loadAnalytics);
}

// Teacher Classes
// ===========================================
async function renderTeacherClasses() {
    const lang = store.getState().language;
    const user = store.getState().user;
    const token = store.getState().token;

    try {
        // Fetch all classes
        const classesResponse = await fetch(`${API_BASE_URL}/api/classes`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const classesData = await classesResponse.json();
        const classes = classesData.data || [];
        const teacherId = user?.id || user?._id;
        const teacherClasses = classes.filter(cls => cls.teacherId === teacherId);

        const totalStudents = teacherClasses.reduce((sum, cls) => sum + (cls.studentCount || 0), 0);
        const content = `
            <div class="teacher-classes-page">
                <div class="page-header">
                    <div class="page-header-title">
                        <h1>${lang === 'uz' ? 'Mening sinflarim' : '–ú–æ–∏ –∫–ª–∞—Å—Å—ã'}</h1>
                        <p class="page-header-subtitle">${lang === 'uz' ? 'O\'quvchilar va natijalarni boshqarish' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–µ–Ω–∏–∫–∞–º–∏ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏'}</p>
                    </div>
                    <div class="page-header-actions">
                        <button class="back-button back-button--compact" id="btnBackFromClasses">
                            <span>‚Üê</span>
                            <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                        </button>
                    </div>
                </div>

                <div class="teacher-classes__summary">
                    <div class="teacher-classes__summary-card">
                        <div class="teacher-classes__summary-icon">üè´</div>
                        <div>
                            <div class="teacher-classes__summary-label">${lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å–æ–≤'}</div>
                            <div class="teacher-classes__summary-value">${teacherClasses.length}</div>
                        </div>
                    </div>
                    <div class="teacher-classes__summary-card">
                        <div class="teacher-classes__summary-icon">üë•</div>
                        <div>
                            <div class="teacher-classes__summary-label">${lang === 'uz' ? 'O\'quvchilar' : '–£—á–µ–Ω–∏–∫–æ–≤'}</div>
                            <div class="teacher-classes__summary-value">${totalStudents}</div>
                        </div>
                    </div>
                </div>

                ${teacherClasses.length > 0 ? `
                    <div class="card teacher-classes__analytics">
                        <div class="teacher-classes__analytics-header">
                            <div>
                                <h2 style="margin: 0;">${lang === 'uz' ? 'Sinf analitikasi' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫–ª–∞—Å—Å–∞'}</h2>
                                <p style="margin: 0.35rem 0 0; color: var(--text-secondary); font-size: 0.95rem;">
                                    ${lang === 'uz' ? 'Sinfni tanlab, natijalarni ko\'ring' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'}
                                </p>
                            </div>
                            <div class="teacher-classes__select">
                                <label>${lang === 'uz' ? 'Sinfni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å'}</label>
                                <select id="teacherClassSelect">
                                    <option value="">${lang === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                                    ${teacherClasses.flatMap(cls => {
                                        if (cls.sections?.length && !cls.name) {
                                            return cls.sections.map(section => {
                                                const label = `${cls.grade || ''}${section}`;
                                                return `<option value="${cls._id || cls.id}::${section}">${label}</option>`;
                                            });
                                        }
                                        const label = cls.name ? `${cls.grade || ''}${cls.name}` : (cls.grade || '');
                                        return [`<option value="${cls._id || cls.id}::${cls.name || ''}">${label}</option>`];
                                    }).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="teacher-classes__analytics-chart">
                            <div id="teacherClassAnalyticsEmpty" class="card" style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                                ${lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                            </div>
                            <canvas id="teacherClassAnalyticsChart" style="max-height: 320px; width: 100%; display: none;"></canvas>
                        </div>

                        <div class="teacher-classes__students">
                            <div class="teacher-classes__students-header">
                                <h3 style="margin: 0;">${lang === 'uz' ? 'Sinf o\'quvchilari' : '–£—á–µ–Ω–∏–∫–∏ –∫–ª–∞—Å—Å–∞'}</h3>
                                <p style="margin: 0.35rem 0 0; color: var(--text-secondary); font-size: 0.9rem;">
                                    ${lang === 'uz' ? 'O\'quvchilar ro\'yxati va reytingi' : '–°–ø–∏—Å–æ–∫ —É—á–µ–Ω–∏–∫–æ–≤ –∏ —Ä–µ–π—Ç–∏–Ω–≥'}
                                </p>
                            </div>
                            <div id="teacherClassStudentsEmpty" class="card" style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                                ${lang === 'uz' ? 'Sinf tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å'}
                            </div>
                            <div id="teacherClassStudentsTable" class="teacher-classes__students-table" style="display: none;">
                                <div class="table-scroll">
                                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: var(--bg-tertiary);">
                                                <th style="padding: 0.85rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Ism va familiya' : '–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è'}</th>
                                                <th style="padding: 0.85rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Login' : '–õ–æ–≥–∏–Ω'}</th>
                                                <th style="padding: 0.85rem; text-align: right; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'O\'rin' : '–ú–µ—Å—Ç–æ'}</th>
                                                <th style="padding: 0.85rem; text-align: right; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Profil' : '–ü—Ä–æ—Ñ–∏–ª—å'}</th>
                                            </tr>
                                        </thead>
                                        <tbody id="teacherClassStudentsBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            <div id="teacherClassStudentsCards" class="teacher-classes__students-cards"></div>
                        </div>
                    </div>
                ` : ''}

                ${teacherClasses.length === 0 ? `
                    <div class="teacher-classes__empty">
                        <div class="teacher-classes__empty-icon">üë•</div>
                        <h3>${lang === 'uz' ? 'Sizga sinf biriktirilmagan' : '–ö–ª–∞—Å—Å –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</h3>
                        <p>${lang === 'uz' ? 'Admin bilan bog\'laning' : '–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É'}</p>
                    </div>
                ` : `
                    <div class="teacher-classes__grid">
                        ${teacherClasses.map(cls => {
                            const classKey = cls.name ? `${cls.grade}${cls.name}` : (cls.grade || '');
                            const sections = cls.sections?.length ? cls.sections.join(', ') : '';
                            return `
                                <div class="teacher-classes__card">
                                    <div class="teacher-classes__card-header">
                                        <div>
                                            <div class="teacher-classes__card-title">${classKey}</div>
                                            <div class="teacher-classes__card-subtitle">${sections ? (lang === 'uz' ? `Seksiyalar: ${sections}` : `–°–µ–∫—Ü–∏–∏: ${sections}`) : (lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å')}</div>
                                        </div>
                                        <div class="teacher-classes__card-badge">${cls.studentCount || 0}</div>
                                    </div>
                                    <div class="teacher-classes__card-body">
                                        <div class="teacher-classes__metric">
                                            <span>üë®‚Äçüéì ${lang === 'uz' ? 'O\'quvchilar' : '–£—á–µ–Ω–∏–∫–∏'}</span>
                                            <strong>${cls.studentCount || 0}</strong>
                                        </div>
                                        <div class="teacher-classes__metric">
                                            <span>üìå ${lang === 'uz' ? 'Sinf kodi' : '–ö–æ–¥ –∫–ª–∞—Å—Å–∞'}</span>
                                            <strong>${classKey || '‚Äî'}</strong>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
        `;

        renderLayout(content, 'teacher');

        // Back button
        document.getElementById('btnBackFromClasses')?.addEventListener('click', () => {
            router.navigate('/teacher/subjects');
        });

        const classSelect = document.getElementById('teacherClassSelect');
        const chartEmpty = document.getElementById('teacherClassAnalyticsEmpty');
        const studentsEmpty = document.getElementById('teacherClassStudentsEmpty');
        const studentsTable = document.getElementById('teacherClassStudentsTable');
        const studentsBody = document.getElementById('teacherClassStudentsBody');
        const studentsCards = document.getElementById('teacherClassStudentsCards');

        const resetStudents = (message) => {
            if (studentsEmpty) {
                studentsEmpty.textContent = message;
                studentsEmpty.style.display = 'block';
            }
            if (studentsTable) studentsTable.style.display = 'none';
            if (studentsCards) studentsCards.innerHTML = '';
        };

        const buildOverallSeries = (values, label) => {
            const nums = values.filter(v => typeof v === 'number');
            if (!nums.length) return null;
            const avg = Math.round((nums.reduce((sum, v) => sum + v, 0) / nums.length) * 10) / 10;
            return {
                label,
                data: values.map(() => avg),
                dash: [6, 4]
            };
        };

        const loadClassAnalytics = async (value) => {
            if (!value) {
                if (chartEmpty) {
                    chartEmpty.textContent = lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
                }
                renderLineChart('teacherClassAnalyticsChart', 'teacherClassAnalyticsEmpty', { labels: [], series: [] });
                resetStudents(lang === 'uz' ? 'Sinf tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –∫–ª–∞—Å—Å');
                return;
            }

            const [classId, section] = value.split('::');

            try {
                const timelineRes = await apiRequest(`/api/analytics/classes/${classId}/timeline${section ? `?section=${encodeURIComponent(section)}` : ''}`);
                if (timelineRes.success) {
                    const chartData = buildSubjectAverageChart(timelineRes.data, lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª', { includeAllSubjects: true });
                    const overallSeries = buildOverallSeries(chartData.series?.[0]?.data || [], lang === 'uz' ? 'Umumiy' : '–û–±—â–∏–π');
                    renderLineChart('teacherClassAnalyticsChart', 'teacherClassAnalyticsEmpty', chartData, overallSeries ? [overallSeries] : []);
                } else {
                    if (chartEmpty) chartEmpty.textContent = timelineRes.error || (lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö');
                    renderLineChart('teacherClassAnalyticsChart', 'teacherClassAnalyticsEmpty', { labels: [], series: [] });
                }

                const studentsRes = await apiRequest(`/api/classes/${classId}/students${section ? `?section=${encodeURIComponent(section)}` : ''}`);
                if (!studentsRes.success) {
                    resetStudents(studentsRes.error || (lang === 'uz' ? 'O\'quvchilar topilmadi' : '–£—á–µ–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'));
                    return;
                }

                const students = studentsRes.data || [];
                if (!students.length) {
                    resetStudents(lang === 'uz' ? 'O\'quvchilar topilmadi' : '–£—á–µ–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
                    return;
                }

                const ranked = [...students].sort((a, b) => (b.averageScore || 0) - (a.averageScore || 0));
                const rankMap = new Map(ranked.map((student, index) => [student._id || student.id, index + 1]));

                const sortedByName = [...students].sort((a, b) => {
                    const nameA = `${a.lastName || ''} ${a.firstName || ''}`.trim();
                    const nameB = `${b.lastName || ''} ${b.firstName || ''}`.trim();
                    return nameA.localeCompare(nameB, 'ru');
                });

                if (studentsEmpty) studentsEmpty.style.display = 'none';
                if (studentsTable) studentsTable.style.display = 'block';

                if (studentsBody) {
                    studentsBody.innerHTML = sortedByName.map(student => {
                        const studentId = student._id || student.id;
                        const rank = rankMap.get(studentId) || '-';
                        return `
                            <tr style="border-bottom: 1px solid var(--border-color);">
                                <td style="padding: 0.85rem; color: var(--text-primary); font-weight: 500;">${student.firstName} ${student.lastName}</td>
                                <td style="padding: 0.85rem; color: var(--text-secondary); font-family: monospace;">@${student.username}</td>
                                <td style="padding: 0.85rem; text-align: right; color: var(--text-primary); font-weight: 600;">${rank}</td>
                                <td style="padding: 0.85rem; text-align: right;">
                                    <button class="button button-secondary" data-student-id="${studentId}">${lang === 'uz' ? 'Profilni ko\'rish' : '–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è'}</button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                }

                if (studentsCards) {
                    studentsCards.innerHTML = sortedByName.map(student => {
                        const studentId = student._id || student.id;
                        const rank = rankMap.get(studentId) || '-';
                        return `
                            <div class="card teacher-classes__student-card">
                                <div style="display: flex; justify-content: space-between; gap: 1rem; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: var(--text-primary);">${student.firstName} ${student.lastName}</div>
                                        <div style="color: var(--text-secondary); font-size: 0.85rem;">@${student.username}</div>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="font-size: 0.75rem; color: var(--text-muted);">${lang === 'uz' ? 'O\'rin' : '–ú–µ—Å—Ç–æ'}</div>
                                        <div style="font-weight: 700; color: var(--text-primary);">${rank}</div>
                                    </div>
                                </div>
                                <div style="margin-top: 0.75rem;">
                                    <button class="button button-secondary" data-student-id="${studentId}">${lang === 'uz' ? 'Profilni ko\'rish' : '–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è'}</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                document.querySelectorAll('[data-student-id]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const studentId = btn.getAttribute('data-student-id');
                        router.navigate(`/teacher/student/${studentId}`);
                    });
                });
            } catch (error) {
                console.error('Error loading class analytics:', error);
                resetStudents(lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞');
                renderLineChart('teacherClassAnalyticsChart', 'teacherClassAnalyticsEmpty', { labels: [], series: [] });
            }
        };

        if (classSelect) {
            classSelect.addEventListener('change', (event) => loadClassAnalytics(event.target.value));
        }

    } catch (error) {
        console.error('‚ùå Error loading classes:', error);
        const content = `
            <div class="page-header">
                <h1>${lang === 'uz' ? 'Sinflar' : '–ö–ª–∞—Å—Å—ã'}</h1>
            </div>
            <div class="card error-message">
                <p>${lang === 'uz' ? 'Xatolik yuz berdi' : '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞'}</p>
            </div>
        `;
        renderLayout(content, 'teacher');
    }
}

// Teacher view: student profile
async function renderTeacherStudentProfile({ studentId }) {
    const lang = store.getState().language;
    const user = store.getState().user;

    if (!user) {
        router.navigate('/login');
        return;
    }

    const content = `
        <div class="page-header">
            <div class="page-header-title">
                <h1>${lang === 'uz' ? 'O\'quvchi profili' : '–ü—Ä–æ—Ñ–∏–ª—å —É—á–µ–Ω–∏–∫–∞'}</h1>
                <p class="page-header-subtitle">${lang === 'uz' ? 'Analitika va qiziqishlar' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã'}</p>
            </div>
            <div class="page-header-actions">
                <button class="back-button back-button--compact" id="btnBackFromStudentProfile">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                </button>
            </div>
        </div>
        <div id="teacherStudentProfileContainer">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    `;

    renderLayout(content, 'teacher');

    document.getElementById('btnBackFromStudentProfile')?.addEventListener('click', () => {
        router.navigate('/teacher/classes');
    });

    const container = document.getElementById('teacherStudentProfileContainer');

    try {
        const [studentRes, timelineRes] = await Promise.all([
            apiRequest(`/api/teachers/students/${studentId}`),
            apiRequest(`/api/analytics/students/${studentId}/timeline`)
        ]);

        if (!studentRes.success || !studentRes.data) {
            throw new Error(studentRes.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å');
        }

        const student = studentRes.data;

        const normalizeInterestResults = (value) => {
            if (!value) return null;
            if (Array.isArray(value)) {
                return [...value]
                    .filter(v => v && v.categories)
                    .sort((a, b) => new Date(b.completedAt || 0) - new Date(a.completedAt || 0))[0] || null;
            }
            return value.categories ? value : null;
        };

        const interestResults = normalizeInterestResults(student.interestTestResults);

        container.innerHTML = `
            <div class="profile-grid" style="display: grid; gap: 1.5rem;">
                <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div style="display: flex; align-items: center; gap: 1.5rem;">
                        <div style="width: 70px; height: 70px; border-radius: 50%; background: white; display: flex; align-items: center; justify-content: center; font-size: 2rem;">
                            üë§
                        </div>
                        <div>
                            <h2 style="margin: 0 0 0.4rem 0; color: white;">${student.firstName} ${student.lastName}</h2>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.9;">
                                <span>üè´ ${student.school || '‚Äî'}</span>
                                <span>üìö ${student.grade || '‚Äî'}${student.gradeSection ? student.gradeSection : ''} ${lang === 'uz' ? 'sinf' : '–∫–ª–∞—Å—Å'}</span>
                                <span>üë®‚Äçüéì @${student.username}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 style="margin: 0 0 1rem 0;">${lang === 'uz' ? 'Fanlar bo\'yicha natijalar' : '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}</h3>
                    <div style="position: relative; min-height: 260px;">
                        <div id="teacherStudentSubjectEmpty" class="card" style="padding: 1rem; text-align: center; color: var(--text-secondary);">
                            ${lang === 'uz' ? 'Ma\'lumotlar mavjud emas' : '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                        </div>
                        <canvas id="teacherStudentSubjectChart" style="max-height: 300px; width: 100%; display: none;"></canvas>
                    </div>
                </div>

                ${interestResults ? `
                    <div class="card">
                        <h3 style="margin: 0 0 1rem 0;">${lang === 'uz' ? 'Qiziqishlar profili' : '–ü—Ä–æ—Ñ–∏–ª—å –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤'}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem;">
                            ${Object.entries(interestResults.categories || {}).sort((a, b) => b[1] - a[1]).map(([category, score]) => {
                                const labels = {
                                    math: { uz: 'Matematika', ru: '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞', icon: 'üî¢' },
                                    science: { uz: 'Fan', ru: '–ù–∞—É–∫–∞', icon: 'üî¨' },
                                    tech: { uz: 'Texnologiya', ru: '–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏', icon: 'üíª' },
                                    art: { uz: 'San\'at', ru: '–ò—Å–∫—É—Å—Å—Ç–≤–æ', icon: 'üé®' },
                                    social: { uz: 'Ijtimoiy', ru: '–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ', icon: 'üë•' },
                                    language: { uz: 'Til', ru: '–Ø–∑—ã–∫–∏', icon: 'üìö' }
                                };
                                const info = labels[category] || { uz: category, ru: category, icon: 'üìä' };
                                return `
                                    <div class="card" style="text-align: center; background: var(--bg-secondary); border: 1px solid var(--border-color);">
                                        <div style="font-size: 2rem; margin-bottom: 0.35rem;">${info.icon}</div>
                                        <div style="font-size: 1.4rem; font-weight: 700; color: var(--text-primary);">${Math.round(score)}%</div>
                                        <div style="color: var(--text-secondary); font-size: 0.9rem;">${lang === 'uz' ? info.uz : info.ru}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                ` : `
                    <div class="card" style="text-align: center; color: var(--text-secondary);">
                        ${lang === 'uz' ? 'Qiziqishlar testi topshirilmagan' : '–¢–µ—Å—Ç –∏–Ω—Ç–µ—Ä–µ—Å–æ–≤ –Ω–µ –ø—Ä–æ–π–¥–µ–Ω'}
                    </div>
                `}
            </div>
        `;

        if (timelineRes.success) {
            const chartData = buildSubjectAverageChart(timelineRes.data, lang === 'uz' ? 'Natija' : '–†–µ–∑—É–ª—å—Ç–∞—Ç', { includeAllSubjects: true });
            renderLineChart('teacherStudentSubjectChart', 'teacherStudentSubjectEmpty', chartData);
        } else {
            renderLineChart('teacherStudentSubjectChart', 'teacherStudentSubjectEmpty', { labels: [], series: [] });
        }
    } catch (error) {
        console.error('Error loading student profile:', error);
        if (container) {
            container.innerHTML = `
                <div class="card" style="text-align: center; color: var(--text-secondary);">
                    ${lang === 'uz' ? 'Ma\'lumotlarni yuklashda xatolik' : '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö'}
                </div>
            `;
        }
    }
}


// Teacher Profile with Analytics
async function renderTeacherProfile() {
    const user = store.getState().user;
    const lang = store.getState().language;

    if (!user) {
        router.navigate('/login');
        return;
    }

    const content = `
        <div class="profile-container">
            <div style="margin-bottom: 1rem;">
                <button class="button button-secondary" id="btnBackFromTeacherProfile">
                    ‚Üê ${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}
                </button>
            </div>
            <div class="profile-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <div class="profile-avatar" style="width: 80px; height: 80px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2.5rem;">
                        üë®‚Äçüè´
                    </div>
                    <div>
                        <h1 style="margin: 0; font-size: 1.8rem;">${user.firstName} ${user.lastName}</h1>
                        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">${user.school || ''} ‚Ä¢ ${lang === 'uz' ? 'O\'qituvchi' : '–£—á–∏—Ç–µ–ª—å'}</p>
                    </div>
                </div>
            </div>

            <div id="analyticsLoading" class="loading" style="text-align: center; padding: 3rem;">
                <div class="spinner"></div>
                <p style="margin-top: 1rem; color: var(--text-muted);">${lang === 'uz' ? 'Statistika yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...'}</p>
            </div>

            <div id="analyticsContent" style="display: none;"></div>
        </div>
    `;

    renderLayout(content, 'teacher');

    document.getElementById('btnBackFromTeacherProfile')?.addEventListener('click', () => {
        router.navigate('/teacher/dashboard');
    });

    // Load analytics data
    const result = await apiRequest('/api/teacher/analytics');

    document.getElementById('analyticsLoading').style.display = 'none';
    const analyticsContent = document.getElementById('analyticsContent');
    analyticsContent.style.display = 'block';

    if (!result.success || !result.data) {
        analyticsContent.innerHTML = `
            <div class="card">
                <p style="text-align: center; color: var(--text-muted);">
                    ${lang === 'uz' ? 'Statistika yuklanmadi' : '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É'}
                </p>
            </div>
        `;
        return;
    }

    const data = result.data;

    // Stats cards
    const statsCards = `
        <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìö</div>
                <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${data.totalTests}</div>
                <div style="opacity: 0.9;">${lang === 'uz' ? 'Testlar' : '–¢–µ—Å—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ'}</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem; border-radius: 12px;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${data.totalCompletions}</div>
                <div style="opacity: 0.9;">${lang === 'uz' ? 'Bajarilgan' : '–ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–π'}</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem; border-radius: 12px;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìä</div>
                <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${data.averageScore}%</div>
                <div style="opacity: 0.9;">${lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª'}</div>
            </div>
            <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.5rem; border-radius: 12px;">
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìù</div>
                <div style="font-size: 2rem; font-weight: bold; margin-bottom: 0.25rem;">${data.totalModules}</div>
                <div style="opacity: 0.9;">${lang === 'uz' ? 'Modullar' : '–ú–æ–¥—É–ª–µ–π'}</div>
            </div>
        </div>
    `;

    // Charts section
    const chartsSection = `
        <div class="charts-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">${lang === 'uz' ? 'Sinflar bo\'yicha statistika' : '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –∫–ª–∞—Å—Å–∞–º'}</h3>
                <canvas id="classByClassChart"></canvas>
            </div>
            <div class="card">
                <h3 style="margin-bottom: 1.5rem;">${lang === 'uz' ? 'Fanlar bo\'yicha o\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º'}</h3>
                <canvas id="subjectScoresChart"></canvas>
            </div>
        </div>
    `;

    // Recent completions
    const recentCompletions = data.recentCompletions && data.recentCompletions.length > 0 ? `
        <div class="card">
            <h3 style="margin-bottom: 1.5rem;">${lang === 'uz' ? 'So\'nggi natijalar' : '–ü–æ—Å–ª–µ–¥–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã'}</h3>
            <div style="max-height: 400px; overflow-y: auto;">
                ${data.recentCompletions.map(completion => `
                    <div style="padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 500; margin-bottom: 0.25rem;">${completion.studentName} (${completion.studentGrade}${lang === 'uz' ? '-sinf' : ' –∫–ª–∞—Å—Å'})</div>
                            <div style="color: var(--text-muted); font-size: 0.9rem;">${completion.subjectName} ‚Ä¢ ${completion.testName}</div>
                            <div style="color: var(--text-muted); font-size: 0.85rem; margin-top: 0.25rem;">${new Date(completion.submittedAt).toLocaleString()}</div>
                        </div>
                        <div>
                            <span style="background: ${completion.score >= 80 ? '#10b981' : completion.score >= 60 ? '#f59e0b' : '#ef4444'}; color: white; padding: 0.5rem 1rem; border-radius: 12px; font-weight: 600; font-size: 1.1rem;">
                                ${completion.score}%
                            </span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    ` : '';

    analyticsContent.innerHTML = statsCards + chartsSection + recentCompletions;

    // Create charts
    if (data.statsByClass && data.statsByClass.length > 0) {
        const ctx1 = document.getElementById('classByClassChart');
        new Chart(ctx1, {
            type: 'bar',
            data: {
                labels: data.statsByClass.map(c => c.grade + (lang === 'uz' ? '-sinf' : ' –∫–ª–∞—Å—Å')),
                datasets: [
                    {
                        label: lang === 'uz' ? 'Bajarilgan testlar' : '–ü—Ä–æ–π–¥–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤',
                        data: data.statsByClass.map(c => c.completedTests),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderRadius: 8
                    },
                    {
                        label: lang === 'uz' ? 'O\'rtacha ball' : '–°—Ä–µ–¥–Ω–∏–π –±–∞–ª–ª',
                        data: data.statsByClass.map(c => c.averageScore),
                        backgroundColor: 'rgba(245, 158, 11, 0.8)',
                        borderRadius: 8
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                },
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }

    if (data.statsBySubject && data.statsBySubject.length > 0) {
        const ctx2 = document.getElementById('subjectScoresChart');
        new Chart(ctx2, {
            type: 'doughnut',
            data: {
                labels: data.statsBySubject.map(s => s.subject),
                datasets: [{
                    data: data.statsBySubject.map(s => s.averageScore),
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(245, 158, 11, 0.8)',
                        'rgba(239, 68, 68, 0.8)',
                        'rgba(16, 185, 129, 0.8)',
                        'rgba(99, 102, 241, 0.8)',
                        'rgba(236, 72, 153, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
}

// Teacher Tests (legacy - keeping for backward compatibility)
// Teacher Modules Page
async function renderTeacherModules() {
    // Redirect to new subjects page
    router.navigate('/teacher/subjects');
}

async function renderTeacherModulesOld() {
    const content = `
        <div class="page-header">
            <h1>${t('modules')}</h1>
            <p>${store.getState().language === 'uz' ? 'Fanga modullar qo\'shing va tahrirlang' : '–î–æ–±–∞–≤–ª—è–π—Ç–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –º–æ–¥—É–ª–∏ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–æ–≤'}</p>
        </div>
        
        <div class="card" style="margin-bottom: 2rem;">
            <h3>${t('createModule')}</h3>
            <form id="createModuleForm" style="display: grid; gap: 1rem;">
                <div class="form-group">
                    <label>${store.getState().language === 'uz' ? 'Fan' : '–ü—Ä–µ–¥–º–µ—Ç'}</label>
                    <select id="moduleSubject" required>
                        <option value="">${store.getState().language === 'uz' ? 'Tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ'}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>${t('moduleName')} (RU)</label>
                    <input type="text" id="moduleNameRu" placeholder="${store.getState().language === 'uz' ? 'Masalan: Algebra' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–≥–µ–±—Ä–∞'}" required />
                </div>
                <div class="form-group">
                    <label>${t('moduleName')} (UZ)</label>
                    <input type="text" id="moduleNameUz" placeholder="${store.getState().language === 'uz' ? 'Masalan: Algebra' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–≥–µ–±—Ä–∞'}" required />
                </div>
                <div class="form-group">
                    <label>${store.getState().language === 'uz' ? 'Tavsif (RU)' : '–û–ø–∏—Å–∞–Ω–∏–µ (RU)'}</label>
                    <textarea id="moduleDescRu" rows="3" placeholder="${store.getState().language === 'uz' ? 'Modul tavsifi ruscha' : '–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è –Ω–∞ —Ä—É—Å—Å–∫–æ–º'}" required></textarea>
                </div>
                <div class="form-group">
                    <label>${store.getState().language === 'uz' ? 'Tavsif (UZ)' : '–û–ø–∏—Å–∞–Ω–∏–µ (UZ)'}</label>
                    <textarea id="moduleDescUz" rows="3" placeholder="${store.getState().language === 'uz' ? 'Modul tavsifi o\'zbekcha' : '–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥—É–ª—è –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º'}" required></textarea>
                </div>
                <button type="submit" class="button button-primary">
                    ${t('create')}
                </button>
            </form>
            <div id="moduleMessage" style="margin-top: 1rem;"></div>
        </div>
        
        <div class="card">
            <h3>${store.getState().language === 'uz' ? 'Mavjud modullar' : '–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–æ–¥—É–ª–∏'}</h3>
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label>${store.getState().language === 'uz' ? 'Fanni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç'}</label>
                <select id="filterSubject">
                    <option value="">${store.getState().language === 'uz' ? 'Barcha fanlar' : '–í—Å–µ –ø—Ä–µ–¥–º–µ—Ç—ã'}</option>
                </select>
            </div>
            <div id="modulesList">
                <p style="text-align: center; color: var(--text-muted);">${store.getState().language === 'uz' ? 'Fanni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç'}</p>
            </div>
        </div>
    `;
    
    renderLayout(content, 'teacher');
    
    // Load subjects for dropdowns
    const subjectsResult = await apiRequest('/api/subjects');
    
    if (subjectsResult.success && subjectsResult.data && subjectsResult.data.length > 0) {
        const subjects = subjectsResult.data;
        const moduleSubjectSelect = document.getElementById('moduleSubject');
        const filterSubjectSelect = document.getElementById('filterSubject');
        
        subjects.forEach(subject => {
            const option1 = document.createElement('option');
            option1.value = subject._id;
            option1.textContent = store.getState().language === 'uz' ? subject.nameUz : subject.nameRu;
            moduleSubjectSelect.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = subject._id;
            option2.textContent = store.getState().language === 'uz' ? subject.nameUz : subject.nameRu;
            filterSubjectSelect.appendChild(option2);
        });
        
        // Load modules when subject is selected
        filterSubjectSelect.addEventListener('change', async (e) => {
            if (e.target.value) {
                await loadModules(e.target.value);
            } else {
                document.getElementById('modulesList').innerHTML = `<p style="text-align: center; color: var(--text-muted);">${store.getState().language === 'uz' ? 'Fanni tanlang' : '–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç'}</p>`;
            }
        });
        
        // Automatically load modules for the first subject
        if (subjects.length > 0) {
            filterSubjectSelect.value = subjects[0]._id;
            await loadModules(subjects[0]._id);
        }
    } else {
        document.getElementById('modulesList').innerHTML = `<p style="text-align: center; color: var(--error);">${store.getState().language === 'uz' ? 'Fanlar topilmadi' : '–ü—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</p>`;
    }
    
    // Handle create module form
    document.getElementById('createModuleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const subjectId = document.getElementById('moduleSubject').value;
        const nameRu = document.getElementById('moduleNameRu').value;
        const nameUz = document.getElementById('moduleNameUz').value;
        const descriptionRu = document.getElementById('moduleDescRu').value;
        const descriptionUz = document.getElementById('moduleDescUz').value;
        
        const result = await apiRequest(`/api/subjects/${subjectId}/modules`, {
            method: 'POST',
            body: JSON.stringify({ nameRu, nameUz, descriptionRu, descriptionUz })
        });
        
        const messageDiv = document.getElementById('moduleMessage');
        
        if (result.success) {
            messageDiv.innerHTML = `<div class="alert alert-success">${store.getState().language === 'uz' ? 'Modul muvaffaqiyatli yaratildi!' : '–ú–æ–¥—É–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!'}</div>`;
            document.getElementById('createModuleForm').reset();
            
            // Reload modules if filter is set
            const filterSubject = document.getElementById('filterSubject').value;
            if (filterSubject === subjectId) {
                await loadModules(subjectId);
            }
        } else {
            messageDiv.innerHTML = `<div class="alert alert-error">${result.error || t('error')}</div>`;
        }
    });
}

// Load modules for a subject
async function loadModules(subjectId) {
    const modulesList = document.getElementById('modulesList');
    modulesList.innerHTML = `<p style="text-align: center; color: var(--text-muted);">${store.getState().language === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</p>`;
    
    const result = await apiRequest(`/api/subjects/${subjectId}/modules`);
    
    if (result.success && result.data.length > 0) {
        modulesList.innerHTML = result.data.map(module => `
            <div class="card" style="margin-bottom: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <h4 style="margin-bottom: 0.5rem;">${store.getState().language === 'uz' ? module.nameUz : module.nameRu}</h4>
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">${store.getState().language === 'uz' ? module.descriptionUz : module.descriptionRu}</p>
                        <small style="color: var(--text-muted);">${store.getState().language === 'uz' ? 'Yaratildi' : '–°–æ–∑–¥–∞–Ω'}: ${new Date(module.createdAt).toLocaleDateString()}</small>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="button button-secondary" onclick="viewModuleTests('${module._id}')">${store.getState().language === 'uz' ? 'Testlar' : '–¢–µ—Å—Ç—ã'}</button>
                        <button class="button button-danger" onclick="deleteModule('${module._id}', '${subjectId}')">${t('delete')}</button>
                    </div>
                </div>
            </div>
        `).join('');
    } else if (result.success) {
        modulesList.innerHTML = `<p style="text-align: center; color: var(--text-muted);">${store.getState().language === 'uz' ? 'Modullar topilmadi' : '–ú–æ–¥—É–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'}</p>`;
    } else {
        modulesList.innerHTML = `<p style="text-align: center; color: var(--error);">${result.error || t('error')}</p>`;
    }
}

// Delete module
async function deleteModule(moduleId, subjectId) {
    if (!confirm(store.getState().language === 'uz' ? 'Modulni o\'chirishga ishonchingiz komilmi?' : '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –º–æ–¥—É–ª—å?')) {
        return;
    }
    
    // Note: This endpoint doesn't exist in the backend yet, but the structure is ready
    const result = await apiRequest(`/api/modules/${moduleId}`, {
        method: 'DELETE'
    });
    
    if (result.success) {
        await loadModules(subjectId);
    } else {
        alert(result.error || t('error'));
    }
}


// ========================================
// TEACHER: MODULE TESTS MANAGEMENT
// ========================================

async function renderModuleTests() {
    // Extract moduleId from URL pattern /teacher/module/:moduleId/tests
    const pathParts = window.location.pathname.split('/');
    const moduleId = pathParts[pathParts.length - 2]; // Get the part before 'tests'
    const lang = store.getState().language;
    console.log('üîç renderModuleTests called');
    console.log('üìç moduleId extracted:', moduleId);
    console.log('üìç Full path:', window.location.pathname);
    
    const content = `
        <div class="page-header" style="margin-bottom: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 id="moduleName" style="background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 0.5rem;">${lang === 'uz' ? 'Yuklanmoqda...' : '–ó–∞–≥—Ä—É–∑–∫–∞...'}</h1>
                    <p style="color: var(--text-muted); margin: 0;">${lang === 'uz' ? 'Testlarni yarating va tahrirlang' : '–°–æ–∑–¥–∞–Ω–∏–µ –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤'}</p>
                </div>
                <button class="button button-secondary" id="btnBackToSubject" style="display: flex; align-items: center; gap: 0.5rem; padding: 12px 20px; border-radius: 10px; transition: all 0.3s ease;">
                    <span>‚Üê</span>
                    <span>${lang === 'uz' ? 'Modulga qaytish' : '–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –º–æ–¥—É–ª—é'}</span>
                </button>
            </div>
        </div>
        
        <!-- Create Test Section -->
        <div class="card test-create">
            <div class="test-create__header">
                <div class="test-create__icon">üß©</div>
                <div>
                    <h3>${lang === 'uz' ? 'Yangi test' : '–ù–æ–≤—ã–π —Ç–µ—Å—Ç'}</h3>
                    <p>${lang === 'uz' ? 'Test darhol e‚Äôlon qilinadi' : '–¢–µ—Å—Ç —Å—Ä–∞–∑—É –ø—É–±–ª–∏–∫—É–µ—Ç—Å—è'}</p>
                </div>
            </div>

            <form id="createTestForm" class="test-create__form">
                <div class="test-create__grid">
                    <div class="form-group">
                        <label class="form-label">
                            <span>üá∑üá∫</span>
                            ${lang === 'uz' ? 'Test nomi (Ruscha)' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ (RU)'}
                        </label>
                        <input type="text" class="form-input" id="testNameRu" placeholder="${lang === 'uz' ? 'Masalan: Algebra testi' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Å—Ç –ø–æ –∞–ª–≥–µ–±—Ä–µ'}" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span>üá∫üáø</span>
                            ${lang === 'uz' ? 'Test nomi (O\'zbekcha)' : '–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞ (UZ)'}
                        </label>
                        <input type="text" class="form-input" id="testNameUz" placeholder="${lang === 'uz' ? 'Masalan: Algebra testi' : '–ù–∞–ø—Ä–∏–º–µ—Ä: –¢–µ—Å—Ç –ø–æ –∞–ª–≥–µ–±—Ä–µ'}" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span>‚è±Ô∏è</span>
                            ${lang === 'uz' ? 'Vaqt (daqiqa)' : '–í—Ä–µ–º—è (–º–∏–Ω)'}
                        </label>
                        <input type="number" class="form-input" id="testDuration" value="30" min="5" max="180" required />
                    </div>
                    <div class="form-group">
                        <label class="form-label">
                            <span>üéØ</span>
                            ${lang === 'uz' ? 'Maks. ball' : '–ú–∞–∫—Å. –±–∞–ª–ª–æ–≤'}
                        </label>
                        <input type="number" class="form-input" id="testMaxScore" value="100" min="10" max="1000" required />
                    </div>
                </div>

                <div class="test-create__actions">
                    <div class="test-create__note">
                        ${lang === 'uz' ? '‚ö° Test avtomatik nashr qilinadi' : '‚ö° –¢–µ—Å—Ç –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'}
                    </div>
                    <button type="submit" class="button button-primary test-create__submit">
                        <span>‚úÖ</span>
                        <span>${lang === 'uz' ? 'Testni yaratish' : '–°–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç'}</span>
                    </button>
                </div>
            </form>
            <div id="createTestMessage" style="margin-top: 1rem;"></div>
        </div>
        
        <!-- Questions Builder -->
        <div id="questionsBuilder" style="display: none;">
            <!-- Dynamically populated -->
        </div>
        
        <!-- Tests List -->
        <div class="card" style="border: 1px solid var(--border-color); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);">
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 1px solid var(--border-color);">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--accent), #06b6d4); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                    üìã
                </div>
                <div>
                    <h3 style="margin: 0; font-size: 1.25rem;">${lang === 'uz' ? 'Mavjud testlar' : '–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã'}</h3>
                    <p style="margin: 0.25rem 0 0 0; color: var(--text-muted); font-size: 0.875rem;">${lang === 'uz' ? 'Modulning barcha testlari' : '–í—Å–µ —Ç–µ—Å—Ç—ã –º–æ–¥—É–ª—è'}</p>
                </div>
            </div>
            <div id="testsList">
                <div class="loading">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    `;
    
    renderLayout(content, 'teacher');
    
    // Handle back button
    document.getElementById('btnBackToSubject').addEventListener('click', () => {
        router.navigate('/teacher/subjects');
    });
    
    // Load module name
    const result = await apiRequest(`/api/modules/${moduleId}`);
    console.log('üì¶ Module API response:', result);
    if (result.success) {
        const module = result.data;
        document.getElementById('moduleName').textContent = lang === 'uz' ? module.nameUz : module.nameRu;
        window.currentModule = module;
        console.log('‚úÖ Module loaded:', module);
    } else {
        console.error('‚ùå Failed to load module:', result.error);
    }
    
    // Load existing tests
    console.log('‚è≥ Loading tests for module:', moduleId);
    await loadModuleTests(moduleId);
    
    // Handle create test form
    const createForm = document.getElementById('createTestForm');
    console.log('üìã Create test form found:', !!createForm);
    
    if (createForm) {
        createForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            console.log('üìù Create test form submitted!');
            
            const nameRu = document.getElementById('testNameRu').value;
            const nameUz = document.getElementById('testNameUz').value;
            const duration = parseInt(document.getElementById('testDuration').value);
            const maxScore = parseInt(document.getElementById('testMaxScore').value);
            const status = 'published';
            
            console.log('üìã Test data:', { nameRu, nameUz, duration, maxScore, status });
            
            const result = await apiRequest(`/api/modules/${moduleId}/tests`, {
                method: 'POST',
                body: JSON.stringify({ 
                    nameRu, 
                    nameUz, 
                    duration, 
                    maxScore, 
                    status,
                    questions: []
                })
            });
            
            console.log('üì¶ Create test result:', result);
            
            const messageDiv = document.getElementById('createTestMessage');
            
            if (result.success) {
                messageDiv.innerHTML = `<div class="success-message">${lang === 'uz' ? '‚úì Test muvaffaqiyatli yaratildi!' : '‚úì –¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!'}</div>`;
                document.getElementById('createTestForm').reset();
                await loadModuleTests(moduleId);
                setTimeout(() => messageDiv.innerHTML = '', 3000);
            } else {
                messageDiv.innerHTML = `<div class="error-message">${result.error || t('error')}</div>`;
            }
        });
    } else {
        console.error('‚ùå Create test form not found!');
    }
}

async function loadModuleTests(moduleId) {
    const lang = store.getState().language;
    const testsList = document.getElementById('testsList');
    
    console.log('üîç loadModuleTests called for moduleId:', moduleId);
    
    testsList.innerHTML = `<div class="loading"><div class="spinner"></div></div>`;
    
    const result = await apiRequest(`/api/modules/${moduleId}/tests`);
    console.log('üì¶ Tests API response:', result);
    console.log('üìä result.success:', result.success);
    console.log('üìä result.data:', result.data);
    
    const testsData = result.data?.data || result.data || [];
    console.log('üìä testsData:', testsData);
    console.log('üìä testsData type:', typeof testsData);
    console.log('üìä Is array?', Array.isArray(testsData));
    console.log('üìä testsData length:', testsData.length);
    
    if (result.success && Array.isArray(testsData) && testsData.length > 0) {
        const createCard = document.querySelector('#createTestForm')?.closest('.card');
        if (createCard) createCard.style.display = 'none';
        console.log('‚úÖ Found', testsData.length, 'tests');
        testsData.forEach(test => {
            console.log(`  Test "${test.nameRu}" (ID: ${test._id}): ${test.questionsCount || 0} questions`);
        });
        testsList.innerHTML = testsData.map(test => `
            <div class="card test-card" data-test-id="${test._id}" style="margin-bottom: 1.5rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 1px solid var(--border-color); border-left: 4px solid var(--primary); transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 2rem;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: flex-start; gap: 1rem; margin-bottom: 1rem;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">
                                üìù
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.5rem 0; font-size: 1.1rem; font-weight: 600;">${lang === 'uz' ? test.nameUz : test.nameRu}</h4>
                                <p style="color: var(--text-muted); margin: 0; font-size: 0.9rem;">
                                    <span style="display: inline-block; margin-right: 1.5rem;">üìù ${test.questionsCount || 0} ${lang === 'uz' ? 'savol' : '–≤–æ–ø—Ä–æ—Å–æ–≤'}</span>
                                    <span style="display: inline-block; margin-right: 1.5rem;">‚è±Ô∏è ${test.duration} –º–∏–Ω</span>
                                    <span style="display: inline-block;">üéØ ${test.maxScore} –±–∞–ª–ª–æ–≤</span>
                                </p>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                            <span style="display: inline-block; padding: 6px 12px; background: ${test.status === 'published' ? 'rgba(16, 185, 129, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; color: ${test.status === 'published' ? 'var(--success)' : 'var(--warning)'}; border-radius: 6px; font-size: 0.8rem; font-weight: 600;">
                                ${test.status === 'published' ? '‚úì ' : '‚óâ '}${lang === 'uz' ? (test.status === 'published' ? 'Nashr qilingan' : 'Qoralama') : (test.status === 'published' ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫')}
                            </span>
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.75rem; min-width: 140px;">
                        <button class="btn-edit-test button button-primary" data-test-id="${test._id}" style="width: 100%; padding: 12px 18px; font-size: 0.9rem; font-weight: 600; background: linear-gradient(135deg, var(--primary), var(--accent)); border: none; border-radius: 10px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; color: white; cursor: pointer;">
                            <span>‚úèÔ∏è</span>
                            <span>${lang === 'uz' ? 'Tahrirlash' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'}</span>
                        </button>
                        <button class="btn-delete-test button button-danger" data-test-id="${test._id}" data-module-id="${moduleId}" style="width: 100%; padding: 12px 18px; font-size: 0.9rem; font-weight: 600; border: none; border-radius: 10px; background: rgba(239, 68, 68, 0.2); color: var(--danger); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 0.5rem; cursor: pointer;">
                            <span>üóëÔ∏è</span>
                            <span>${lang === 'uz' ? 'O\'chirish' : '–£–¥–∞–ª–∏—Ç—å'}</span>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Add event listeners
        document.querySelectorAll('.btn-edit-test').forEach(btn => {
            btn.addEventListener('click', async () => {
                const testId = btn.getAttribute('data-test-id');
                console.log('üñ±Ô∏è Edit button clicked for test:', testId);
                await renderTestEditor(testId, moduleId);
            });
        });
        
        document.querySelectorAll('.btn-delete-test').forEach(btn => {
            btn.addEventListener('click', async () => {
                const testId = btn.getAttribute('data-test-id');
                const moduleId = btn.getAttribute('data-module-id');
                if (confirm(lang === 'uz' ? 'Testni o\'chirishga ishonchingiz komilmi?' : '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–µ—Å—Ç?')) {
                    const result = await apiRequest(`/api/tests/${testId}`, { method: 'DELETE' });
                    if (result.success) {
                        await loadModuleTests(moduleId);
                    }
                }
            });
        });
    } else {
        const createCard = document.querySelector('#createTestForm')?.closest('.card');
        if (createCard) createCard.style.display = 'block';
        console.log('‚ùå No tests found or empty result. Success:', result.success, 'Array?', Array.isArray(testsData), 'Length:', testsData.length);
        testsList.innerHTML = `
            <div class="card" style="text-align: center; padding: 4rem 2rem; background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--bg-tertiary) 100%); border: 2px dashed var(--border-color); border-radius: 12px;">
                <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.5;">üìù</div>
                <p style="color: var(--text-muted); font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">
                    ${lang === 'uz' ? 'Hali testlar yaratilmagan' : '–¢–µ—Å—Ç—ã –µ—â–µ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã'}
                </p>
            </div>
        `;
    }
}

async function renderTestEditor(testId, moduleId) {
    const lang = store.getState().language;
    const app = document.getElementById('app');
    
    console.log('üîç renderTestEditor called with testId:', testId, 'moduleId:', moduleId);
    
    // Store testId and moduleId in window for access in saveTestEditor
    window.currentTestId = testId;
    window.currentModuleId = moduleId;
    
    // Fetch test data
    const result = await apiRequest(`/api/tests/${testId}`);
    console.log('üì¶ Test fetch result:', result);
    const test = result.data;
    console.log('üìù Test data:', test);
    console.log('‚ùì Test questions:', test?.questions);
    
    app.innerHTML = `
        <div class="layout">
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h2>üéì</h2>
                </div>
                <ul class="nav-menu">
                    <li class="nav-item" onclick="history.back()">
                        <span>‚Üê</span>
                        <span>${lang === 'uz' ? 'Orqaga' : '–ù–∞–∑–∞–¥'}</span>
                    </li>
                </ul>
            </aside>
            
            <main class="main-content">
                <div class="page-header" style="margin-bottom: 2rem;">
                    <h1>${lang === 'uz' ? 'Savollarni tahrirlash' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–æ–≤'}</h1>
                    <p>${lang === 'uz' ? test.nameUz : test.nameRu}</p>
                </div>
                
                <div id="editorContainer" style="display: grid; gap: 2rem;">
                    <!-- Questions will be populated here -->
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button id="addQuestionBtn" class="button button-secondary" style="padding: 16px 24px; font-size: 16px; font-weight: 600; border: 2px solid var(--border-color); border-radius: 12px; display: flex; align-items: center; gap: 0.5rem;">
                        <span>‚ûï</span>
                        <span>${lang === 'uz' ? 'Savol qo\'shish' : '–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å'}</span>
                    </button>
                    <button id="saveTestBtn" class="button button-primary" style="padding: 16px 24px; font-size: 16px; font-weight: 600; background: linear-gradient(135deg, var(--success), #059669); border: none; border-radius: 12px; display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                        <span>üíæ</span>
                        <span>${lang === 'uz' ? 'Saqlash' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'}</span>
                    </button>
                </div>
            </main>
        </div>
    `;
    
    // Render questions
    const container = document.getElementById('editorContainer');
    
    if (test.questions && test.questions.length > 0) {
        container.innerHTML = test.questions.map((q, idx) => `
            <div class="card question-editor" data-question-index="${idx}" style="border-left: 4px solid var(--primary);">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
                    <h3 style="margin: 0; color: var(--text-primary);">
                        ${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å'} ${idx + 1}
                    </h3>
                    <button class="button button-danger" onclick="deleteQuestion(this, ${idx})" style="padding: 8px 16px; font-size: 0.9rem;">
                        ${lang === 'uz' ? 'O\'chirish' : '–£–¥–∞–ª–∏—Ç—å'}
                    </button>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600;">
                        <span>üá∑üá∫</span>
                        ${lang === 'uz' ? 'Savol matni (Ruscha)' : '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ (RU)'}
                    </label>
                    <textarea class="question-text-ru" rows="3" style="width: 100%; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 10px; padding: 14px; color: var(--text-primary); font-size: 0.95rem; resize: vertical; font-family: inherit;">${q.questionRu || ''}</textarea>
                </div>
                
                <div class="form-group" style="margin-bottom: 1.5rem;">
                    <label style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600;">
                        <span>üá∫üáø</span>
                        ${lang === 'uz' ? 'Savol matni (O\'zbekcha)' : '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ (UZ)'}
                    </label>
                    <textarea class="question-text-uz" rows="3" style="width: 100%; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 10px; padding: 14px; color: var(--text-primary); font-size: 0.95rem; resize: vertical; font-family: inherit;">${q.questionUz || ''}</textarea>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                        <h4 style="margin: 0; color: var(--text-primary);">
                            ${lang === 'uz' ? 'Javob variantlari' : '–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤'} 
                            <span style="color: var(--text-muted); font-size: 0.8rem;">(–º–∏–Ω–∏–º—É–º 2)</span>
                        </h4>
                        <button class="button button-secondary add-answer-btn" data-question-index="${idx}" style="padding: 8px 16px; font-size: 0.9rem; display: flex; gap: 0.5rem;">
                            <span>‚ûï</span>
                            <span>${lang === 'uz' ? 'Variant' : '–í–∞—Ä–∏–∞–Ω—Ç'}</span>
                        </button>
                    </div>
                    
                    <div class="answers-container" style="display: grid; gap: 1rem;">
                        ${(q.answers || []).map((answer, ansIdx) => `
                            <div class="answer-item" style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 1rem; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 10px; transition: all 0.3s ease;">
                                <div style="display: grid; gap: 0.75rem;">
                                    <textarea class="answer-text-ru" rows="2" placeholder="${lang === 'uz' ? 'Javob (Ruscha)' : '–û—Ç–≤–µ—Ç (RU)'}" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;">${answer.textRu || ''}</textarea>
                                    <textarea class="answer-text-uz" rows="2" placeholder="${lang === 'uz' ? 'Javob (O\'zbekcha)' : '–û—Ç–≤–µ—Ç (UZ)'}" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;">${answer.textUz || ''}</textarea>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 8px 12px; background: ${answer.isCorrect ? 'rgba(16, 185, 129, 0.2)' : 'transparent'}; border-radius: 8px; transition: all 0.3s ease;">
                                        <input type="radio" name="correct-${idx}" class="is-correct" ${answer.isCorrect ? 'checked' : ''} style="cursor: pointer;" />
                                        <span style="color: ${answer.isCorrect ? 'var(--success)' : 'var(--text-muted)'}; font-size: 0.85rem; font-weight: 500;">
                                            ${lang === 'uz' ? '‚úì To\'g\'ri' : '‚úì –í–µ—Ä–Ω–æ'}
                                        </span>
                                    </label>
                                    <button type="button" class="button button-danger delete-answer-btn" data-answer-index="${ansIdx}" style="padding: 6px 12px; font-size: 0.8rem;">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    // Add event listeners for answer buttons
    document.querySelectorAll('.add-answer-btn').forEach(btn => {
        btn.addEventListener('click', () => addAnswerField(btn.getAttribute('data-question-index')));
    });
    
    document.querySelectorAll('.delete-answer-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            this.closest('.answer-item').remove();
        });
    });
    
    // Add question button
    document.getElementById('addQuestionBtn').addEventListener('click', () => {
        addNewQuestion(container);
    });
    
    // Save button click handler
    document.getElementById('saveTestBtn').addEventListener('click', window.saveTestEditor = async () => {
        console.log('üíæ Save button clicked');
        const questions = [];
        
        document.querySelectorAll('.question-editor').forEach((qEl, idx) => {
            const questionRu = qEl.querySelector('.question-text-ru').value;
            const questionUz = qEl.querySelector('.question-text-uz').value;
            const answers = [];
            
            qEl.querySelectorAll('.answer-item').forEach((ansEl) => {
                const textRu = ansEl.querySelector('.answer-text-ru').value;
                const textUz = ansEl.querySelector('.answer-text-uz').value;
                const isCorrect = ansEl.querySelector('.is-correct').checked;
                
                if (textRu && textUz) {
                    answers.push({ textRu, textUz, isCorrect });
                }
            });
            
            if (questionRu && questionUz && answers.length >= 2) {
                questions.push({ questionRu, questionUz, answers });
            }
        });
        
        console.log('üìù Collected questions:', questions);
        console.log('üî¢ Questions count:', questions.length);
        
        if (questions.length === 0) {
            alert(lang === 'uz' ? 'Kamida bitta to\'g\'ri savolni kiriting' : '–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å');
            return;
        }
        
        console.log('üì§ Sending PUT request to /api/tests/' + window.currentTestId);
        const updateResult = await apiRequest(`/api/tests/${window.currentTestId}`, {
            method: 'PUT',
            body: JSON.stringify({ questions })
        });
        
        console.log('üì• Update result:', updateResult);
        
        if (updateResult.success) {
            console.log('‚úÖ Test saved successfully');
            alert(lang === 'uz' ? 'Test muvaffaqiyatli saqlandi!' : '–¢–µ—Å—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!');
            console.log('üîÑ Navigating to /teacher/module/' + window.currentModuleId + '/tests');
            router.navigate(`/teacher/module/${window.currentModuleId}/tests`);
        } else {
            alert(lang === 'uz' ? 'Xato: ' + updateResult.error : '–û—à–∏–±–∫–∞: ' + updateResult.error);
        }
    });
}

function addAnswerField(questionIndex) {
    const container = document.querySelectorAll('.question-editor')[questionIndex].querySelector('.answers-container');
    const lang = store.getState().language;
    
    const newAnswer = document.createElement('div');
    newAnswer.className = 'answer-item';
    newAnswer.style.cssText = 'display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: center; padding: 1rem; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 10px; transition: all 0.3s ease;';
    
    newAnswer.innerHTML = `
        <div style="display: grid; gap: 0.75rem;">
            <textarea class="answer-text-ru" rows="2" placeholder="${lang === 'uz' ? 'Javob (Ruscha)' : '–û—Ç–≤–µ—Ç (RU)'}" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;"></textarea>
            <textarea class="answer-text-uz" rows="2" placeholder="${lang === 'uz' ? 'Javob (O\'zbekcha)' : '–û—Ç–≤–µ—Ç (UZ)'}" style="width: 100%; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; color: var(--text-primary); font-size: 0.9rem; resize: vertical; font-family: inherit;"></textarea>
        </div>
        <div style="display: flex; flex-direction: column; gap: 0.5rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 8px 12px; background: transparent; border-radius: 8px; transition: all 0.3s ease;">
                <input type="radio" name="correct-${questionIndex}" class="is-correct" style="cursor: pointer;" />
                <span style="color: var(--text-muted); font-size: 0.85rem; font-weight: 500;">
                    ${lang === 'uz' ? '‚úì To\'g\'ri' : '‚úì –í–µ—Ä–Ω–æ'}
                </span>
            </label>
            <button type="button" class="button button-danger delete-answer-btn" style="padding: 6px 12px; font-size: 0.8rem;">
                üóëÔ∏è
            </button>
        </div>
    `;
    
    container.appendChild(newAnswer);
    
    newAnswer.querySelector('.delete-answer-btn').addEventListener('click', function() {
        this.closest('.answer-item').remove();
    });
}

function addNewQuestion(container) {
    const lang = store.getState().language;
    const questionIndex = document.querySelectorAll('.question-editor').length;
    
    const newQuestion = document.createElement('div');
    newQuestion.className = 'card question-editor';
    newQuestion.setAttribute('data-question-index', questionIndex);
    newQuestion.style.cssText = 'border-left: 4px solid var(--primary);';
    
    newQuestion.innerHTML = `
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem;">
            <h3 style="margin: 0; color: var(--text-primary);">
                ${lang === 'uz' ? 'Savol' : '–í–æ–ø—Ä–æ—Å'} ${questionIndex + 1}
            </h3>
            <button class="button button-danger" onclick="this.closest('.question-editor').remove()" style="padding: 8px 16px; font-size: 0.9rem;">
                ${lang === 'uz' ? 'O\'chirish' : '–£–¥–∞–ª–∏—Ç—å'}
            </button>
        </div>
        
        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600;">
                <span>üá∑üá∫</span>
                ${lang === 'uz' ? 'Savol matni (Ruscha)' : '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ (RU)'}
            </label>
            <textarea class="question-text-ru" rows="3" style="width: 100%; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 10px; padding: 14px; color: var(--text-primary); font-size: 0.95rem; resize: vertical; font-family: inherit;"></textarea>
        </div>
        
        <div class="form-group" style="margin-bottom: 1.5rem;">
            <label style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem; font-weight: 600;">
                <span>üá∫üáø</span>
                ${lang === 'uz' ? 'Savol matni (O\'zbekcha)' : '–¢–µ–∫—Å—Ç –≤–æ–ø—Ä–æ—Å–∞ (UZ)'}
            </label>
            <textarea class="question-text-uz" rows="3" style="width: 100%; background: var(--bg-primary); border: 2px solid var(--border-color); border-radius: 10px; padding: 14px; color: var(--text-primary); font-size: 0.95rem; resize: vertical; font-family: inherit;"></textarea>
        </div>
        
        <div style="margin-bottom: 1.5rem;">
            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
                <h4 style="margin: 0; color: var(--text-primary);">
                    ${lang === 'uz' ? 'Javob variantlari' : '–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤'} 
                    <span style="color: var(--text-muted); font-size: 0.8rem;">(–º–∏–Ω–∏–º—É–º 2)</span>
                </h4>
                <button class="button button-secondary add-answer-btn" data-question-index="${questionIndex}" style="padding: 8px 16px; font-size: 0.9rem; display: flex; gap: 0.5rem;">
                    <span>‚ûï</span>
                    <span>${lang === 'uz' ? 'Variant' : '–í–∞—Ä–∏–∞–Ω—Ç'}</span>
                </button>
            </div>
            
            <div class="answers-container" style="display: grid; gap: 1rem;">
                <!-- Answers will be added here -->
            </div>
        </div>
    `;
    
    container.appendChild(newQuestion);
    
    // Add first two empty answer fields
    const addAnswerBtn = newQuestion.querySelector('.add-answer-btn');
    addAnswerBtn.addEventListener('click', () => {
        addAnswerField(questionIndex);
    });
    
    addAnswerField(questionIndex);
    addAnswerField(questionIndex);
}

window.deleteQuestion = function(btn, index) {
    btn.closest('.question-editor').remove();
};

// Initialize the app
const router = new Router();
window.router = router; // Make router globally accessible

// Register all routes
router.register('/', () => {
    const state = store.getState();
    if (state.isAuthenticated) {
        if (state.user?.role === 'student') {
            renderStudentDashboard();
        } else if (state.user?.role === 'teacher') {
            renderTeacherDashboard();
        } else if (state.user?.role === 'admin') {
            renderAdminDashboard?.() || renderTeacherDashboard();
        }
    } else {
        renderLoginPage();
    }
});

// Admin Analytics Dashboard
// ===========================================
async function renderAdminAnalytics() {
    const state = store.getState();
    const lang = state.language;
    const token = state.token;
    
    // Check authentication
    if (!state.isAuthenticated || !state.user || state.user.role !== 'admin') {
        console.log('‚ùå Unauthorized access to analytics');
        router.navigate('/login');
        return;
    }

    try {
        const [usersRes, classesRes, testsRes] = await Promise.all([
            fetch(`${API_BASE_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`${API_BASE_URL}/api/classes`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`${API_BASE_URL}/api/tests`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);

        const usersData = await usersRes.json();
        const classesData = await classesRes.json();
        const testsData = await testsRes.json();

        const users = usersData.data || [];
        const classes = classesData.data || [];
        const tests = testsData.data || [];

        const students = users.filter(u => u.role === 'student') || [];
        const teachers = users.filter(u => u.role === 'teacher') || [];

        const totalStudents = students.length;
        const totalTeachers = teachers.length;
        const totalClasses = classes.length;
        const totalTests = tests.length;
        const avgStudentsPerClass = totalClasses > 0 ? Math.round(totalStudents / totalClasses) : 0;
        const ratio = totalTeachers > 0 ? (totalStudents / totalTeachers).toFixed(1) : 0;
        const maxTableRows = 4;
        
        let studentsHTML = '';
        let teachersHTML = '';
        let classesHTML = '';
        
        
        const content = `
            <style>
                .analytics-hero {
                    background: linear-gradient(135deg, rgba(59, 130, 246, 0.16) 0%, rgba(14, 116, 144, 0.12) 100%);
                    border: 1px solid rgba(59, 130, 246, 0.28);
                    border-radius: 18px;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 1rem;
                    flex-wrap: wrap;
                }
                .analytics-hero__title {
                    margin: 0;
                    font-size: 2.1rem;
                    font-weight: 800;
                    color: var(--text-primary);
                }
                .analytics-hero__desc {
                    margin: 0.5rem 0 0 0;
                    color: var(--text-secondary);
                    font-size: 0.95rem;
                }
                .analytics-hero__meta {
                    display: flex;
                    gap: 0.75rem;
                    flex-wrap: wrap;
                    align-items: center;
                }
                .analytics-pill {
                    padding: 0.45rem 0.9rem;
                    border-radius: 999px;
                    background: rgba(59, 130, 246, 0.16);
                    color: #bfdbfe;
                    border: 1px solid rgba(59, 130, 246, 0.4);
                    font-weight: 600;
                    font-size: 0.8rem;
                }
                @media (max-width: 768px) {
                    .analytics-hero { padding: 1.25rem; }
                    .analytics-hero__title { font-size: 1.75rem; }
                    .stats-grid { grid-template-columns: 1fr 1fr !important; }
                    .analytics-container { grid-template-columns: 1fr !important; }
                    .stat-metric { padding: 1.25rem !important; }
                    .stat-number { font-size: 1.75rem !important; }
                }
                @media (max-width: 420px) {
                    .analytics-hero { padding: 1rem; border-radius: 14px; }
                    .analytics-hero__title { font-size: 1.5rem; }
                    .analytics-hero__desc { font-size: 0.85rem; }
                    .stats-grid { grid-template-columns: 1fr !important; gap: 0.5rem !important; }
                    .analytics-container { grid-template-columns: 1fr !important; gap: 1rem !important; }
                    .stat-metric { padding: 0.75rem !important; margin-bottom: 0; }
                    .stat-number { font-size: 1.4rem !important; margin-bottom: 0.25rem !important; }
                    .data-table { font-size: 0.75rem; }
                    .data-table th, .data-table td { padding: 0.5rem !important; font-size: 0.7rem !important; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1400px; margin: 0 auto;">
                    <div class="analytics-hero">
                        <div>
                            <h1 class="analytics-hero__title">${lang === 'uz' ? 'Analitika' : '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞'}</h1>
                            <p class="analytics-hero__desc">${lang === 'uz' ? 'Tizim ko\'rsatkichlari va metrikalari' : '–°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π –∏ –º–µ—Ç—Ä–∏–∫'}</p>
                        </div>
                        <div class="analytics-hero__meta">
                            <button onclick="window.router.navigate('/admin/dashboard')" class="btn-secondary" style="padding: 0.7rem 1.2rem; font-size: 0.9rem; border: 1px solid var(--border-color);">‚Üê ${t('back')}</button>
                            <span class="analytics-pill">${totalStudents} ${lang === 'uz' ? 'o\'quvchi' : '—É—á–µ–Ω–∏–∫–æ–≤'}</span>
                        </div>
                    </div>

                    <!-- Key Metrics Grid -->
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.2rem; margin-bottom: 2.5rem;">
                        <div class="stat-metric" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">–£—á–µ–Ω–∏–∫–æ–≤</p>
                                </div>
                                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #3B82F6; font-size: 1.3rem;">üë§</div>
                            </div>
                            <div class="stat-number" style="font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">${totalStudents}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">–∞–∫—Ç–∏–≤–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                        </div>

                        <div class="stat-metric" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">–£—á–∏—Ç–µ–ª–µ–π</p>
                                </div>
                                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #10b981; font-size: 1.3rem;">üë•</div>
                            </div>
                            <div class="stat-number" style="font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">${totalTeachers}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">–ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π</div>
                        </div>

                        <div class="stat-metric" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">–ö–ª–∞—Å—Å–æ–≤</p>
                                </div>
                                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #f59e0b; font-size: 1.3rem;">üìã</div>
                            </div>
                            <div class="stat-number" style="font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">${totalClasses}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">–≤—Å–µ–≥–æ –≤ —Å–∏—Å—Ç–µ–º–µ</div>
                        </div>

                        <div class="stat-metric" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">–¢–µ—Å—Ç–æ–≤</p>
                                </div>
                                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #8b5cf6; font-size: 1.3rem;">‚úì</div>
                            </div>
                            <div class="stat-number" style="font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">${totalTests}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">–¥–æ—Å—Ç—É–ø–Ω–æ</div>
                        </div>

                        <div class="stat-metric" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">–°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ</p>
                                </div>
                                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #ec4899; font-size: 1.3rem;">‚âà</div>
                            </div>
                            <div class="stat-number" style="font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">${ratio}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">—É—á. –Ω–∞ –æ–¥–Ω–æ–≥–æ —É—á–∏—Ç.</div>
                        </div>

                        <div class="stat-metric" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 1.5rem; transition: all 0.3s;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div>
                                    <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;">–°—Ä–µ–¥–Ω–µ–µ</p>
                                </div>
                                <div style="width: 40px; height: 40px; background: var(--bg-tertiary); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: #06b6d4; font-size: 1.3rem;">‚àÖ</div>
                            </div>
                            <div class="stat-number" style="font-size: 2rem; font-weight: 800; color: var(--text-primary); margin-bottom: 0.5rem;">${avgStudentsPerClass}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">—É—á–µ–Ω–∏–∫–æ–≤ –≤ –∫–ª–∞—Å—Å–µ</div>
                        </div>
                    </div>

                    <!-- Detailed Tables -->
                    <div class="analytics-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(580px, 1fr)); gap: 1.5rem;">
                        <!-- Classes Table -->
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-primary);">–ö–ª–∞—Å—Å—ã</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                ${totalClasses === 0 ? '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>' : `
                                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: var(--bg-tertiary);">
                                                <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                                <th style="padding: 0.8rem; text-align: right; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–£—á.</th>
                                                <th style="padding: 0.8rem; text-align: right; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">%</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${classes.slice(0, maxTableRows).map((c, i) => {
                                                const count = c.studentCount ?? c.students?.length ?? 0;
                                                const classLabel = c.name
                                                    ? `${c.grade || ''}${c.name}`
                                                    : (c.sections?.length ? `${c.grade || ''} (${c.sections.join(', ')})` : (c.grade || '‚Äî'));
                                                const pct = totalStudents > 0 ? Math.round(count / totalStudents * 100) : 0;
                                                return `<tr style="border-bottom: 1px solid var(--border-color);">
                                                    <td style="padding: 0.8rem; color: var(--text-primary); font-weight: 500;">${classLabel}</td>
                                                    <td style="padding: 0.8rem; text-align: right; color: #3B82F6; font-weight: 600;">${count}</td>
                                                    <td style="padding: 0.8rem; text-align: right; color: var(--text-secondary);">${pct}%</td>
                                                </tr>`;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                    ${classes.length > maxTableRows ? `<div style="text-align: center; padding: 1rem 0; border-top: 1px solid var(--border-color);">
                                        <button class="button button-secondary" data-expand-table="classes">${lang === 'uz' ? 'Ko\'proq ko\'rsatish' : '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë'}</button>
                                    </div>` : ''}
                                `}
                            </div>
                        </div>

                        <!-- Teachers Table -->
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-primary);">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–∏</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                ${totalTeachers === 0 ? '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>' : `
                                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: var(--bg-tertiary);">
                                                <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–§–ò–û</th>
                                                <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–õ–æ–≥–∏–Ω</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${teachers.slice(0, maxTableRows).map(t => `<tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 0.8rem; color: var(--text-primary); font-weight: 500;">${t.firstName} ${t.lastName}</td>
                                                <td style="padding: 0.8rem; color: var(--text-secondary); font-family: monospace; font-size: 0.85rem;">@${t.username}</td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                    ${teachers.length > maxTableRows ? `<div style="text-align: center; padding: 1rem 0; border-top: 1px solid var(--border-color);">
                                        <button class="button button-secondary" data-expand-table="teachers">${lang === 'uz' ? 'Ko\'proq ko\'rsatish' : '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë'}</button>
                                    </div>` : ''}
                                `}
                            </div>
                        </div>

                        <!-- Students Table -->
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-primary);">–£—á–µ–Ω–∏–∫–∏</h3>
                            </div>
                            <div style="padding: 1.5rem;">
                                ${totalStudents === 0 ? '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>' : `
                                    <table class="data-table" style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: var(--bg-tertiary);">
                                                <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–§–ò–û</th>
                                                <th style="padding: 0.8rem; text-align: left; font-weight: 600; font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–ö–ª–∞—Å—Å</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${students.slice(0, maxTableRows).map(s => `<tr style="border-bottom: 1px solid var(--border-color);">
                                                <td style="padding: 0.8rem; color: var(--text-primary); font-weight: 500;">${s.firstName} ${s.lastName}</td>
                                                <td style="padding: 0.8rem; color: var(--text-secondary);">${s.grade || '‚Äî'}</td>
                                            </tr>`).join('')}
                                        </tbody>
                                    </table>
                                    ${students.length > maxTableRows ? `<div style="text-align: center; padding: 1rem 0; border-top: 1px solid var(--border-color);">
                                        <button class="button button-secondary" data-expand-table="students">${lang === 'uz' ? 'Ko\'proq ko\'rsatish' : '–ü–æ–∫–∞–∑–∞—Ç—å –µ—â—ë'}</button>
                                    </div>` : ''}
                                `}
                            </div>
                        </div>

                        <!-- System Summary -->
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; overflow: hidden;">
                            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border-color);">
                                <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-primary);">–°–≤–æ–¥–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                            </div>
                            <div style="padding: 1.5rem; display: grid; gap: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid #3B82F6;">
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</span>
                                    <span style="font-weight: 700; color: #3B82F6; font-size: 1.1rem;">${users.length}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid #10b981;">
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">–£—á–µ–Ω–∏–∫–æ–≤</span>
                                    <span style="font-weight: 700; color: #10b981; font-size: 1.1rem;">${users.length > 0 ? Math.round(totalStudents / users.length * 100) : 0}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid #f59e0b;">
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">–£—á–∏—Ç–µ–ª–µ–π</span>
                                    <span style="font-weight: 700; color: #f59e0b; font-size: 1.1rem;">${users.length > 0 ? Math.round(totalTeachers / users.length * 100) : 0}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid #8b5cf6;">
                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">–¢–µ—Å—Ç—ã –Ω–∞ —É—á–∏—Ç–µ–ª—è</span>
                                    <span style="font-weight: 700; color: #8b5cf6; font-size: 1.1rem;">${totalTeachers > 0 ? Math.round(totalTests / totalTeachers) : 0}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;

        renderLayout(content, 'admin');

        const expandTableRows = (tableName) => {
            if (tableName === 'classes') {
                const tbody = document.querySelector('[data-expand-table="classes"]')?.closest('div')?.previousElementSibling?.querySelector('tbody');
                if (!tbody) return;
                tbody.innerHTML = classes.map((c) => {
                    const count = c.studentCount ?? c.students?.length ?? 0;
                    const classLabel = c.name
                        ? `${c.grade || ''}${c.name}`
                        : (c.sections?.length ? `${c.grade || ''} (${c.sections.join(', ')})` : (c.grade || '‚Äî'));
                    const pct = totalStudents > 0 ? Math.round(count / totalStudents * 100) : 0;
                    return `<tr style="border-bottom: 1px solid var(--border-color);">
                        <td style="padding: 0.8rem; color: var(--text-primary); font-weight: 500;">${classLabel}</td>
                        <td style="padding: 0.8rem; text-align: right; color: #3B82F6; font-weight: 600;">${count}</td>
                        <td style="padding: 0.8rem; text-align: right; color: var(--text-secondary);">${pct}%</td>
                    </tr>`;
                }).join('');
            }

            if (tableName === 'teachers') {
                const tbody = document.querySelector('[data-expand-table="teachers"]')?.closest('div')?.previousElementSibling?.querySelector('tbody');
                if (!tbody) return;
                tbody.innerHTML = teachers.map(t => `<tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.8rem; color: var(--text-primary); font-weight: 500;">${t.firstName} ${t.lastName}</td>
                    <td style="padding: 0.8rem; color: var(--text-secondary); font-family: monospace; font-size: 0.85rem;">@${t.username}</td>
                </tr>`).join('');
            }

            if (tableName === 'students') {
                const tbody = document.querySelector('[data-expand-table="students"]')?.closest('div')?.previousElementSibling?.querySelector('tbody');
                if (!tbody) return;
                tbody.innerHTML = students.map(s => `<tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 0.8rem; color: var(--text-primary); font-weight: 500;">${s.firstName} ${s.lastName}</td>
                    <td style="padding: 0.8rem; color: var(--text-secondary);">${s.grade || '‚Äî'}</td>
                </tr>`).join('');
            }

            const button = document.querySelector(`[data-expand-table="${tableName}"]`);
            button?.closest('div')?.remove();
        };

        document.querySelectorAll('[data-expand-table]').forEach(btn => {
            btn.addEventListener('click', () => {
                const tableName = btn.getAttribute('data-expand-table');
                expandTableRows(tableName);
            });
        });

    } catch (error) {
        console.error('Error loading analytics:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏', 'error');
        router.navigate('/admin/dashboard');
    }
}

// ====== CLASS MANAGEMENT FUNCTIONS ======
async function viewClassStudents(classId) {
    console.log('üëÅÔ∏è viewClassStudents called with ID:', classId);
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        console.log('üëÅÔ∏è Fetching class details for:', classId);
        const response = await fetch(`${API_BASE_URL}/api/classes/${classId}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        console.log('üëÅÔ∏è Response status:', response.status);
        if (!response.ok) throw new Error('Failed to fetch class');

        const result = await response.json();
        console.log('üëÅÔ∏è Class data received:', result);
        const classData = result.data || result;
        const classLabel = classData.name
            ? `${classData.grade || ''}${classData.name}`
            : (classData.sections?.length ? `${classData.grade || ''} (${classData.sections.join(', ')})` : (classData.grade || '–ö–ª–∞—Å—Å'));
        const students = classData.students || [];

        console.log('üëÅÔ∏è Students count:', students.length);

        const content = `
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2.5rem;">
                        <div>
                            <h1 style="margin: 0; font-size: 2.25rem; font-weight: 700; color: var(--text-primary);">${classLabel}</h1>
                            <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.95rem;">
                                ${students.length} —É—á–µ–Ω${students.length === 1 ? '–∏–∫' : '–∏–∫–æ–≤'} –≤ –∫–ª–∞—Å—Å–µ
                            </p>
                        </div>
                        <button onclick="window.router.navigate('/admin/classes')" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">‚Üê –ù–∞–∑–∞–¥</button>
                    </div>

                    ${students.length === 0 ? `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 3rem; text-align: center;">
                            <p style="color: var(--text-secondary); font-size: 1rem; margin: 0;">–í —ç—Ç–æ–º –∫–ª–∞—Å—Å–µ –ø–æ–∫–∞ –Ω–µ—Ç —É—á–µ–Ω–∏–∫–æ–≤</p>
                        </div>
                    ` : `
                        <div style="background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-tertiary);">
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–§–ò–û</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Email</th>
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–õ–æ–≥–∏–Ω</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${students.map(student => `
                                        <tr style="border-bottom: 1px solid var(--border-color);">
                                            <td style="padding: 1rem; font-weight: 600; color: var(--text-primary);">${student.firstName} ${student.lastName}</td>
                                            <td style="padding: 1rem; color: var(--text-secondary); font-size: 0.9rem;">${student.email || '‚Äî'}</td>
                                            <td style="padding: 1rem; color: var(--text-secondary); font-family: monospace; font-size: 0.85rem;">@${student.username || '‚Äî'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </div>
        `;

        renderLayout(content, 'admin');
    } catch (error) {
        console.error('Error loading class:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Å–∞', 'error');
    }
}

async function editClass(classId) {
    console.log('‚úèÔ∏è editClass called with ID:', classId);
    const lang = store.getState().language;
    const token = store.getState().token;

    try {
        console.log('‚úèÔ∏è Fetching class details for:', classId);
        const [response, teachersRes, studentsRes] = await Promise.all([
            fetch(`${API_BASE_URL}/api/classes/${classId}`, {
                headers: { 'Authorization': `Bearer ${token}` }
            }),
            apiRequest('/api/users?role=teacher'),
            apiRequest('/api/users?role=student')
        ]);

        console.log('‚úèÔ∏è Response status:', response.status);
        if (!response.ok) throw new Error('Failed to fetch class');

        const result = await response.json();
        console.log('‚úèÔ∏è Class data received:', result);
        const classData = result.data || result;
        const teachers = teachersRes.success ? teachersRes.data : [];
        const students = studentsRes.success ? studentsRes.data : [];
        const hasSections = Array.isArray(classData.sections) && classData.sections.length > 0 && !classData.name;
        const defaultSection = classData.name || (hasSections ? classData.sections[0] : '');

        const content = `
            <div class="admin-modal-overlay">
                <div class="admin-modal-content" style="background: var(--bg-primary); border-radius: 14px; padding: 2rem; max-width: 720px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,0.2); border: 1px solid var(--border-color);">
                    <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å</h2>
                    <p style="margin: 0 0 1.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–ª–∞—Å—Å–∞, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—è –∏ —Å–æ—Å—Ç–∞–≤ —É—á–µ–Ω–∏–∫–æ–≤</p>
                    <input type="hidden" id="editClassGrade" value="${classData.grade || ''}">
                    <input type="hidden" id="editClassOriginalName" value="${classData.name || ''}">

                    ${hasSections ? `
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">–°–µ–∫—Ü–∏—è</label>
                            <select id="editClassSection">
                                ${classData.sections.map(section => `
                                    <option value="${section}" ${section === defaultSection ? 'selected' : ''}>${classData.grade}${section}</option>
                                `).join('')}
                            </select>
                        </div>
                    ` : `
                        <div style="margin-bottom: 1.5rem;">
                            <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                            <input type="text" id="editClassName" value="${classData.name || ''}" style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.95rem; box-sizing: border-box; transition: all 0.2s;" onfocus="this.style.borderColor='#3B82F6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)';" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';">
                        </div>
                    `}

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">–ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</label>
                        <select id="editClassTeacher">
                            <option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>
                            ${teachers.map(t => `<option value="${t._id}" ${classData.teacherId === t._id ? 'selected' : ''}>${t.firstName} ${t.lastName}</option>`).join('')}
                        </select>
                    </div>

                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">–£—á–µ–Ω–∏–∫–∏ –∫–ª–∞—Å—Å–∞</label>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.75rem;">–í—ã–±–µ—Ä–∏—Ç–µ —É—á–µ–Ω–∏–∫–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –±—É–¥—É—Ç –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ —ç—Ç–æ–º—É –∫–ª–∞—Å—Å—É</div>
                        <div id="editClassStudents" style="max-height: 280px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; padding: 0.75rem; background: var(--bg-secondary);"></div>
                    </div>

                    <div style="display: flex; gap: 0.8rem; justify-content: flex-end;">
                        <button onclick="closeModal()" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;">–û—Ç–º–µ–Ω–∞</button>
                        <button onclick="saveClassEdit('${classId}')" style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', content);

        const sectionSelect = document.getElementById('editClassSection');
        const studentsContainer = document.getElementById('editClassStudents');
        const currentSection = () => sectionSelect?.value || classData.name || '';

        const renderStudents = () => {
            const sectionValue = currentSection();
            const classLabel = `${classData.grade || ''}${sectionValue || classData.name || ''}`.trim();
            studentsContainer.innerHTML = students.map(student => {
                const isInClass = student.grade === classData.grade && (sectionValue ? student.gradeSection === sectionValue : true);
                const currentClass = student.grade ? `${student.grade}${student.gradeSection || ''}` : '‚Äî';
                return `
                    <label style="display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.6rem 0.5rem; border-radius: 8px; cursor: pointer; transition: background 0.2s;">
                        <input type="checkbox" name="editClassStudent" value="${student._id}" ${isInClass ? 'checked' : ''} style="width: 18px; height: 18px; accent-color: var(--primary); margin-top: 0.15rem;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--text-primary);">${student.firstName} ${student.lastName}</div>
                            <div style="font-size: 0.8rem; color: var(--text-muted);">@${student.username} ‚Ä¢ —Ç–µ–∫—É—â–∏–π –∫–ª–∞—Å—Å: ${currentClass}</div>
                        </div>
                        <span style="font-size: 0.75rem; color: var(--text-secondary);">${classLabel ? `‚Üí ${classLabel}` : ''}</span>
                    </label>
                `;
            }).join('');
        };

        renderStudents();
        sectionSelect?.addEventListener('change', renderStudents);
    } catch (error) {
        console.error('Error loading class:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Å–∞', 'error');
    }
}

async function saveClassEdit(classId) {
    const token = store.getState().token;
    const classNameInput = document.getElementById('editClassName');
    const className = classNameInput ? classNameInput.value.trim() : '';
    const teacherId = document.getElementById('editClassTeacher')?.value || null;
    const sectionValue = document.getElementById('editClassSection')?.value || document.getElementById('editClassOriginalName')?.value || '';
    const selectedStudentIds = Array.from(document.querySelectorAll('input[name="editClassStudent"]:checked')).map(el => el.value);

    try {
        const body = {};
        if (className) {
            body.name = className;
        }
        if (teacherId !== null) {
            body.teacherId = teacherId || null;
        }

        const response = await fetch(`${API_BASE_URL}/api/classes/${classId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
        });

        if (!response.ok) throw new Error('Failed to update class');

        const assignResponse = await fetch(`${API_BASE_URL}/api/classes/${classId}/students`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ studentIds: selectedStudentIds, section: sectionValue })
        });

        if (!assignResponse.ok) {
            const assignError = await assignResponse.json();
            throw new Error(assignError.error || 'Failed to update class students');
        }

        showAlert('–ö–ª–∞—Å—Å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
        closeModal();
        renderAdminClasses();
    } catch (error) {
        console.error('Error updating class:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞', 'error');
    }
}

async function deleteClass(classId) {
    console.log('üìö deleteClass called with ID:', classId, 'Type:', typeof classId);
    const token = store.getState().token;

    const confirm = await showConfirm(
        '–£–¥–∞–ª–∏—Ç—å –∫–ª–∞—Å—Å?',
        '–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ'
    );

    if (!confirm) return;

    try {
        const url = `${API_BASE_URL}/api/classes/${classId}`;
        console.log('üìö DELETE request to:', url);
        const response = await fetch(url, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to delete class');

        showAlert('–ö–ª–∞—Å—Å —É–¥–∞–ª–µ–Ω', 'success');
        renderAdminClasses();
    } catch (error) {
        console.error('Error deleting class:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª–∞—Å—Å–∞', 'error');
    }
}

async function renderAdminClasses() {
    const state = store.getState();
    const lang = state.language;
    const token = state.token;
    
    // Check authentication
    if (!state.isAuthenticated || !state.user || state.user.role !== 'admin') {
        console.log('‚ùå Unauthorized access to classes');
        router.navigate('/login');
        return;
    }

    try {
        const response = await fetch(`${API_BASE_URL}/api/classes`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) throw new Error('Failed to fetch classes');

        const classesData = await response.json();
        const classes = classesData.data || [];
        console.log('üìö Classes from API:', classes);
        if (classes.length > 0) {
            console.log('üìö First class structure:', classes[0]);
        }

        const content = `
            <style>
                .classes-hero {
                    background: linear-gradient(135deg, rgba(16, 185, 129, 0.16) 0%, rgba(59, 130, 246, 0.12) 100%);
                    border: 1px solid rgba(16, 185, 129, 0.28);
                    border-radius: 18px;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 1rem;
                    flex-wrap: wrap;
                }
                .classes-hero__title {
                    margin: 0;
                    font-size: 2.1rem;
                    font-weight: 800;
                    color: var(--text-primary);
                }
                .classes-hero__desc {
                    margin: 0.5rem 0 0 0;
                    color: var(--text-secondary);
                    font-size: 0.95rem;
                }
                .classes-hero__meta {
                    display: flex;
                    gap: 0.75rem;
                    flex-wrap: wrap;
                    align-items: center;
                }
                .classes-pill {
                    padding: 0.45rem 0.9rem;
                    border-radius: 999px;
                    background: rgba(16, 185, 129, 0.16);
                    color: #a7f3d0;
                    border: 1px solid rgba(16, 185, 129, 0.4);
                    font-weight: 600;
                    font-size: 0.8rem;
                }
                @media (max-width: 768px) {
                    .classes-hero { padding: 1.25rem; }
                    .classes-hero__title { font-size: 1.75rem; }
                    #classesTable th, #classesTable td { padding: 0.6rem 0.4rem !important; }
                    .class-actions { flex-direction: column; gap: 0.3rem; }
                    .class-actions button { width: 100%; font-size: 0.7rem; padding: 0.35rem 0.5rem !important; }
                }
                @media (max-width: 420px) {
                    .classes-hero { padding: 1rem; border-radius: 14px; }
                    .classes-hero__title { font-size: 1.5rem; }
                    .classes-hero__desc { font-size: 0.85rem; }
                    #classesTable { font-size: 0.7rem; }
                    #classesTable th, #classesTable td { padding: 0.4rem 0.25rem !important; font-size: 0.65rem !important; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1200px; margin: 0 auto; display: grid; gap: 1.5rem;">
                    <div class="classes-hero">
                        <div>
                            <h1 class="classes-hero__title">${lang === 'uz' ? 'Sinflarni boshqarish' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞–º–∏'}</h1>
                            <p class="classes-hero__desc">${classes.length} ${lang === 'uz' ? 'sinf' : '–∫–ª–∞—Å—Å'}${classes.length === 1 ? '' : lang === 'uz' ? '' : '–æ–≤'} ${lang === 'uz' ? 'tizimda' : '–≤ —Å–∏—Å—Ç–µ–º–µ'}</p>
                        </div>
                        <div class="classes-hero__meta">
                            <button onclick="window.router.navigate('/admin/dashboard')" class="btn-secondary" style="padding: 0.7rem 1.2rem; font-size: 0.9rem; border: 1px solid var(--border-color);">‚Üê ${t('back')}</button>
                            <span class="classes-pill">${classes.length}</span>
                            <button id="btnAddClass" class="btn-primary" style="padding: 0.75rem 1.5rem; font-size: 0.9rem; white-space: nowrap;">+ ${lang === 'uz' ? 'Yangi sinf' : '–ù–æ–≤—ã–π –∫–ª–∞—Å—Å'}</button>
                        </div>
                    </div>

                    <!-- Classes Table -->
                    ${classes.length === 0 ? `
                        <div style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; padding: 3rem; text-align: center;">
                            <p style="color: var(--text-secondary); font-size: 1rem; margin: 0;">–ö–ª–∞—Å—Å–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π –∫–ª–∞—Å—Å.</p>
                        </div>
                    ` : `
                        <div style="background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color); overflow: hidden;">
                            <table id="classesTable" style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: var(--bg-tertiary);">
                                        <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–ö–ª–∞—Å—Å</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–£—á–µ–Ω–∏–∫–æ–≤</th>
                                        <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–°–æ–∑–¥–∞–Ω–æ</th>
                                        <th style="padding: 1rem; text-align: right; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${classes.map(classItem => {
                                        const studentCount = classItem.studentCount ?? classItem.students?.length ?? 0;
                                        const createdDate = classItem.createdAt
                                            ? new Date(classItem.createdAt).toLocaleDateString('ru-RU', { year: 'numeric', month: 'short', day: 'numeric' })
                                            : '‚Äî';
                                        const classId = classItem._id || classItem.id;
                                        const classLabel = classItem.name
                                            ? `${classItem.grade || ''}${classItem.name}`
                                            : (classItem.sections?.length ? `${classItem.grade || ''} (${classItem.sections.join(', ')})` : (classItem.grade || '‚Äî'));
                                        return `
                                        <tr style="border-bottom: 1px solid var(--border-color); transition: background 0.2s;">
                                            <td style="padding: 1rem; font-weight: 600; color: var(--text-primary);">${classLabel}</td>
                                            <td style="padding: 1rem; text-align: center; color: #3B82F6; font-weight: 600;">${studentCount}</td>
                                            <td style="padding: 1rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">${createdDate}</td>
                                            <td style="padding: 1rem; text-align: right;">
                                                <div class="class-actions" style="display: flex; gap: 0.4rem; justify-content: flex-end;">
                                                    <button onclick="viewClassStudents('${classId}')" style="padding: 0.5rem 0.9rem; font-size: 0.8rem; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; font-weight: 500;">–ü—Ä–æ—Å–º–æ—Ç—Ä</button>
                                                    <button onclick="editClass('${classId}')" style="padding: 0.5rem 0.9rem; font-size: 0.8rem; background: transparent; border: 1px solid var(--border-color); border-radius: 6px; color: var(--text-primary); cursor: pointer; transition: all 0.2s; font-weight: 500;">–†–µ–¥–∞–∫—Ç.</button>
                                                    <button onclick="deleteClass('${classId}')" style="padding: 0.5rem 0.9rem; font-size: 0.8rem; background: transparent; border: 1px solid #ef4444; border-radius: 6px; color: #ef4444; cursor: pointer; transition: all 0.2s; font-weight: 500;">–£–¥–∞–ª–∏—Ç—å</button>
                                                </div>
                                            </td>
                                        </tr>
                                        `;
                                    }).join('')}
                                </tbody>
                            </table>
                        </div>
                    `}
                </div>
            </div>
        `;

        renderLayout(content, 'admin');

        // Add button event listener
        document.getElementById('btnAddClass')?.addEventListener('click', showCreateClassModal);

    } catch (error) {
        console.error('Error loading classes:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–ª–∞—Å—Å–æ–≤', 'error');
        router.navigate('/admin/dashboard');
    }
}

function showCreateClassModal() {
    const lang = store.getState().language;
    const token = store.getState().token;
    const modal = document.createElement('div');
    modal.className = 'admin-modal-overlay';
    modal.innerHTML = `
        <div class="admin-modal-content" style="background: var(--bg-primary); border-radius: 14px; padding: 2rem; max-width: 500px; width: 100%; box-shadow: 0 25px 50px rgba(0,0,0,0.2); border: 1px solid var(--border-color);">
            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700; color: var(--text-primary);">–ù–æ–≤—ã–π –∫–ª–∞—Å—Å</h2>
            <p style="margin: 0 0 1.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∫–ª–∞—Å—Å –≤ —Å–∏—Å—Ç–µ–º–µ</p>
            
            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">üìö –ù–æ–º–µ—Ä –∫–ª–∞—Å—Å–∞</label>
                <input type="text" id="newClassGrade" placeholder="1, 2, 3, 4..." style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.95rem; box-sizing: border-box; transition: all 0.2s;" onfocus="this.style.borderColor='#3B82F6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)';" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">üî§ –ë—É–∫–≤–∞ –∫–ª–∞—Å—Å–∞</label>
                <input type="text" id="newClassName" placeholder="–ê, –ë, –í, –ì..." style="width: 100%; padding: 0.8rem; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); color: var(--text-primary); font-size: 0.95rem; box-sizing: border-box; transition: all 0.2s;" onfocus="this.style.borderColor='#3B82F6'; this.style.boxShadow='0 0 0 3px rgba(59,130,246,0.1)';" onblur="this.style.borderColor='var(--border-color)'; this.style.boxShadow='none';">
            </div>

            <div style="margin-bottom: 1.5rem;">
                <label style="display: block; font-weight: 600; margin-bottom: 0.6rem; color: var(--text-primary); font-size: 0.9rem;">üë®‚Äçüè´ –ö–ª–∞—Å—Å–Ω—ã–π —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                <select id="newClassTeacher">
                    <option value="">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —É—á–∏—Ç–µ–ª–µ–π...</option>
                </select>
            </div>

            <div style="display: flex; gap: 0.8rem; justify-content: flex-end;">
                <button onclick="closeModal()" style="padding: 0.75rem 1.5rem; border: 1px solid var(--border-color); background: transparent; color: var(--text-primary); border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;">–û—Ç–º–µ–Ω–∞</button>
                <button id="createClassBtn" onclick="createClass()" style="padding: 0.75rem 1.5rem; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: all 0.2s;">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    `;
    modal.addEventListener('click', (e) => {
        if (e.target === modal) closeModal();
    });
    document.body.appendChild(modal);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —É—á–∏—Ç–µ–ª–µ–π –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ—Å–ª–µ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏
    loadTeachersForModal(token);
}

async function loadTeachersForModal(token) {
    try {
        console.log('üìö Loading teachers for modal...');
        const response = await fetch(`${API_BASE_URL}/api/users?role=teacher`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        let teachers = [];
        if (response.ok) {
            const data = await response.json();
            teachers = data.data || [];
            console.log('üìö Teachers loaded:', teachers.length);
        } else {
            console.error('Failed to load teachers:', response.status);
        }
        
        const select = document.getElementById('newClassTeacher');
        if (select) {
            select.innerHTML = '<option value="">-- –ù–µ –≤—ã–±—Ä–∞–Ω --</option>';
            teachers.forEach(t => {
                const option = document.createElement('option');
                option.value = t._id;
                option.textContent = `${t.firstName} ${t.lastName}`;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading teachers:', error);
        const select = document.getElementById('newClassTeacher');
        if (select) {
            select.innerHTML = '<option value="">-- –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ --</option>';
        }
    }
}

async function createClass() {
    console.log('üìö Creating class...');
    const token = store.getState().token;
    const gradeInput = document.getElementById('newClassGrade').value.trim();
    const nameInput = document.getElementById('newClassName').value.trim();
    let grade = gradeInput;
    let name = nameInput;
    const teacherId = document.getElementById('newClassTeacher').value.trim();
    
    const btn = document.getElementById('createClassBtn');
    if (btn) btn.disabled = true;

    const combinedMatch = !name && gradeInput.match(/^(\d+)\s*([A-Za-z–ê-–Ø–∞-—è])$/);
    if (combinedMatch) {
        grade = combinedMatch[1];
        name = combinedMatch[2];
    }

    grade = grade.replace(/[^0-9]/g, '');
    name = name.replace(/\s+/g, '').toUpperCase();

    if (!grade || !name) {
        showAlert('–£–∫–∞–∂–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–ª–∞—Å—Å–∞ –∏ –±—É–∫–≤—É', 'error');
        if (btn) btn.disabled = false;
        return;
    }

    try {
        const body = { grade, name };
        if (teacherId) {
            body.teacherId = teacherId;
        }
        
        console.log('üìö Sending class data:', body);

        const response = await fetch(`${API_BASE_URL}/api/classes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify(body)
        });

        console.log('üìö Response status:', response.status);
        const responseData = await response.json();
        console.log('üìö Response data:', responseData);

        if (!response.ok) {
            throw new Error(responseData.error || 'Failed to create class');
        }

        console.log('‚úÖ Class created successfully, closing modal...');
        showAlert('–ö–ª–∞—Å—Å —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
        closeModal();
        console.log('‚úÖ Modal closed, refreshing class list...');
        renderAdminClasses();
    } catch (error) {
        console.error('‚ùå Error creating class:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–ª–∞—Å—Å–∞: ' + error.message, 'error');
    } finally {
        if (btn) btn.disabled = false;
    }
}

function closeModal() {
    console.log('üö™ closeModal called');
    const modals = document.querySelectorAll('.admin-modal-overlay, .custom-modal-overlay, .modal');
    console.log('üö™ Modal elements found:', modals.length);
    modals.forEach(modal => modal.remove());
}

async function renderAdminPasswords() {
    const state = store.getState();
    const token = state.token;
    const lang = state.language;
    
    // Check authentication
    if (!state.isAuthenticated || !state.user || state.user.role !== 'admin') {
        console.log('‚ùå Unauthorized access to passwords');
        router.navigate('/login');
        return;
    }
    
    try {
        const [usersRes, classesRes] = await Promise.all([
            fetch(`${API_BASE_URL}/api/users`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`${API_BASE_URL}/api/classes`, { headers: { 'Authorization': `Bearer ${token}` } })
        ]);

        const usersData = await usersRes.json();
        const classesData = await classesRes.json();

        const users = usersData.data || [];
        const classes = classesData.data || [];
        
        // Build class options
        let classOptions = `<option value="">${t('allClasses')}</option>`;
        classes.forEach(c => {
            const classLabel = c.name
                ? `${c.grade || ''}${c.name}`
                : (c.sections?.length ? `${c.grade || ''} (${c.sections.join(', ')})` : (c.grade || '‚Äî'));
            classOptions += `<option value="${c._id || c.id || classLabel}">${classLabel}</option>`;
        });
        
        const escapeAttr = (value) => String(value ?? '')
            .replace(/&/g, '&amp;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');

        // Build user rows & cards
        let userRows = '';
        let userCards = '';
        users.forEach(user => {
            const userId = user.id || user._id;
            const userName = user.name || `${user.firstName} ${user.lastName}`;
            const userClassLabel = user.role === 'student'
                ? `${user.grade || ''}${user.gradeSection || ''}`.trim() || '‚Äî'
                : '‚Äî';
            const roleLabel = user.role === 'student' ? t('student') : user.role === 'teacher' ? t('teacher') : t('admin');
            const roleBadge = user.role === 'student' ? `<span style="background: #dbeafe; color: #1e40af; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">${t('student')}</span>` : 
                             user.role === 'teacher' ? `<span style="background: #fef3c7; color: #92400e; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">${t('teacher')}</span>` : 
                             `<span style="background: #f3e8ff; color: #6b21a8; padding: 0.25rem 0.75rem; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">${t('admin')}</span>`;
            const searchIndex = `${userName} ${user.username}`.toLowerCase();
            
            userRows += `
            <tr style="border-top: 1px solid var(--border-color);" data-role="${user.role}" data-class="${userClassLabel}" data-search="${escapeAttr(searchIndex)}">
                <td data-label="" style="padding: 1rem; color: var(--text-primary); font-size: 0.9rem;">
                    <div style="font-weight: 600;">${userName}</div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem; font-family: monospace;">${user.username}</div>
                </td>
                <td data-label="" style="padding: 1rem; text-align: center; color: var(--text-primary); font-size: 0.9rem; font-weight: 500;">
                    ${roleBadge}
                </td>
                <td data-label="" style="padding: 1rem; text-align: center; color: var(--text-primary); font-size: 0.9rem;">
                    ${userClassLabel}
                </td>
                <td data-label="" style="padding: 1rem; text-align: center;">
                    <button class="btn-primary reset-user-btn" data-user-id="${escapeAttr(userId)}" data-user-name="${escapeAttr(userName)}" data-username="${escapeAttr(user.username)}" style="padding: 0.5rem 1rem; font-size: 0.85rem; white-space: nowrap;">–°–±—Ä–æ—Å–∏—Ç—å</button>
                </td>
            </tr>
            `;

            userCards += `
                <div class="passwords-card" data-role="${user.role}" data-class="${userClassLabel}" data-search="${escapeAttr(searchIndex)}">
                    <div class="passwords-card__header">
                        <div>
                            <div class="passwords-card__name">${userName}</div>
                            <div class="passwords-card__username">@${user.username}</div>
                        </div>
                        ${roleBadge}
                    </div>
                    <div class="passwords-card__meta">
                        <span>${lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å'}:</span>
                        <strong>${userClassLabel}</strong>
                    </div>
                    <button class="btn-primary reset-user-btn" data-user-id="${escapeAttr(userId)}" data-user-name="${escapeAttr(userName)}" data-username="${escapeAttr(user.username)}" style="padding: 0.6rem 1rem; font-size: 0.85rem;">${lang === 'uz' ? 'Parolni tiklash' : '–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å'}</button>
                </div>
            `;
        });
        
        const content = `
            <style>
                .passwords-hero {
                    background: linear-gradient(135deg, rgba(239, 68, 68, 0.14) 0%, rgba(59, 130, 246, 0.12) 100%);
                    border: 1px solid rgba(239, 68, 68, 0.25);
                    border-radius: 18px;
                    padding: 1.5rem;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 1rem;
                    flex-wrap: wrap;
                }
                .passwords-hero__title {
                    margin: 0;
                    font-size: 2.1rem;
                    font-weight: 800;
                    color: var(--text-primary);
                }
                .passwords-hero__desc {
                    margin: 0.5rem 0 0 0;
                    color: var(--text-secondary);
                    font-size: 0.95rem;
                }
                .passwords-hero__meta {
                    display: flex;
                    gap: 0.75rem;
                    flex-wrap: wrap;
                    align-items: center;
                }
                .passwords-pill {
                    padding: 0.45rem 0.9rem;
                    border-radius: 999px;
                    background: rgba(239, 68, 68, 0.16);
                    color: #fecaca;
                    border: 1px solid rgba(239, 68, 68, 0.4);
                    font-weight: 600;
                    font-size: 0.8rem;
                }
                .passwords-panel {
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 1.25rem;
                    display: grid;
                    gap: 1rem;
                }
                .passwords-toolbar {
                    display: grid;
                    grid-template-columns: 1fr auto;
                    gap: 1rem;
                    align-items: center;
                }
                .passwords-search {
                    display: flex;
                    align-items: center;
                    gap: 0.6rem;
                    padding: 0.65rem 0.9rem;
                    background: var(--bg-tertiary);
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                }
                .passwords-search input {
                    background: transparent;
                    border: none;
                    outline: none;
                    color: var(--text-primary);
                    width: 100%;
                    font-size: 0.95rem;
                }
                .passwords-filters {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                    gap: 1rem;
                }
                .passwords-table-wrap {
                    background: var(--bg-secondary);
                    border-radius: 12px;
                    border: 1px solid var(--border-color);
                    overflow: hidden;
                }
                .passwords-cards {
                    display: none;
                    gap: 0.8rem;
                }
                .passwords-card {
                    background: var(--bg-primary);
                    border: 1px solid var(--border-color);
                    border-radius: 16px;
                    padding: 1rem;
                    display: grid;
                    gap: 0.75rem;
                }
                .passwords-card__header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    gap: 0.75rem;
                    flex-wrap: wrap;
                }
                .passwords-card__name {
                    font-weight: 700;
                    color: var(--text-primary);
                }
                .passwords-card__username {
                    color: var(--text-secondary);
                    font-size: 0.8rem;
                    font-family: monospace;
                }
                .passwords-card__meta {
                    color: var(--text-secondary);
                    font-size: 0.85rem;
                    display: flex;
                    gap: 0.4rem;
                    align-items: center;
                }
                @media (max-width: 768px) {
                    .passwords-hero { padding: 1.25rem; }
                    .passwords-hero__title { font-size: 1.75rem; }
                    .passwords-toolbar { grid-template-columns: 1fr; }
                }
                @media (max-width: 420px) {
                    .passwords-hero { padding: 1rem; border-radius: 14px; }
                    .passwords-hero__title { font-size: 1.5rem; }
                    .passwords-hero__desc { font-size: 0.85rem; }
                    .passwords-panel { padding: 1rem; }
                    .passwords-table-wrap { display: none; }
                    .passwords-cards { display: grid; }
                    .passwords-card button { width: 100%; }
                }
            </style>
            <div style="background: var(--bg-primary); min-height: 100vh; padding: 2rem 1.5rem;">
                <div style="max-width: 1200px; margin: 0 auto; display: grid; gap: 1.5rem;">
                    <div class="passwords-hero">
                        <div>
                            <h1 class="passwords-hero__title">${lang === 'uz' ? 'Parollarni tiklash' : '–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª–µ–π'}</h1>
                            <p class="passwords-hero__desc">${lang === 'uz' ? 'Foydalanuvchi parollarini boshqarish va tiklash' : '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'}</p>
                        </div>
                        <div class="passwords-hero__meta">
                            <button id="btnPasswordsBack" class="btn-secondary" style="padding: 0.7rem 1.2rem; font-size: 0.9rem; border: 1px solid var(--border-color);">‚Üê ${t('back')}</button>
                            <span class="passwords-pill">${users.length} ${lang === 'uz' ? 'foydalanuvchi' : '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π'}</span>
                        </div>
                    </div>

                    <div class="passwords-panel">
                        <div class="passwords-toolbar">
                            <div class="passwords-search">
                                <i class="fas fa-search" style="color: var(--text-muted);"></i>
                                <input id="passwordsSearch" type="text" placeholder="${lang === 'uz' ? 'Foydalanuvchini qidiring...' : '–ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...'}">
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center; color: var(--text-secondary); font-size: 0.85rem;">
                                <i class="fas fa-filter"></i>
                                <span>${lang === 'uz' ? 'Filtrlar' : '–§–∏–ª—å—Ç—Ä—ã'}</span>
                            </div>
                        </div>

                        <div class="passwords-filters">
                            <div>
                                <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å'}</label>
                                <select id="passwordClassFilter">
                                    ${classOptions}
                                </select>
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Rol' : '–†–æ–ª—å'}</label>
                                <select id="passwordRoleFilter">
                                    <option value="">${lang === 'uz' ? 'Barcha rollar' : '–í—Å–µ —Ä–æ–ª–∏'}</option>
                                    <option value="student">${t('student')}</option>
                                    <option value="teacher">${t('teacher')}</option>
                                    <option value="admin">${t('admin')}</option>
                                </select>
                            </div>
                        </div>

                        ${users.length === 0 ? `
                            <div style="background: var(--bg-tertiary); border: 1px dashed var(--border-color); border-radius: 12px; padding: 2.5rem; text-align: center; color: var(--text-secondary);">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîê</div>
                                <div style="font-weight: 600; margin-bottom: 0.35rem;">${lang === 'uz' ? 'Foydalanuvchilar topilmadi' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}</div>
                                <div style="font-size: 0.9rem;">${lang === 'uz' ? 'Filtrlarni tozalang' : '–°–±—Ä–æ—Å—å—Ç–µ —Ñ–∏–ª—å—Ç—Ä—ã'}</div>
                            </div>
                        ` : `
                            <div class="passwords-table-wrap">
                                <table id="passwordTable" style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr style="background: var(--bg-tertiary);">
                                            <th style="padding: 1rem; text-align: left; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Foydalanuvchi' : '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Rol' : '–†–æ–ª—å'}</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">${lang === 'uz' ? 'Sinf' : '–ö–ª–∞—Å—Å'}</th>
                                            <th style="padding: 1rem; text-align: center; font-weight: 600; font-size: 0.85rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="passwordTableBody">
                                        ${userRows}
                                    </tbody>
                                </table>
                            </div>
                            <div class="passwords-cards">
                                ${userCards}
                            </div>
                        `}
                    </div>
                </div>
            </div>
        `;

        renderLayout(content, 'admin');

        const classFilter = document.getElementById('passwordClassFilter');
        const roleFilter = document.getElementById('passwordRoleFilter');
        const searchInput = document.getElementById('passwordsSearch');
        const tableBody = document.getElementById('passwordTableBody');

        const applyPasswordFilters = () => {
            if (!tableBody) return;
            const classValue = classFilter?.value || '';
            const roleValue = roleFilter?.value || '';
            const searchValue = (searchInput?.value || '').trim().toLowerCase();

            const rows = tableBody ? Array.from(tableBody.querySelectorAll('tr')) : [];
            rows.forEach(row => {
                const rowRole = row.getAttribute('data-role') || '';
                const rowClass = row.getAttribute('data-class') || '';
                const rowSearch = row.getAttribute('data-search') || '';
                const matchRole = !roleValue || rowRole === roleValue;
                const matchClass = !classValue || rowClass === classValue;
                const matchSearch = !searchValue || rowSearch.includes(searchValue);
                row.style.display = matchRole && matchClass && matchSearch ? '' : 'none';
            });

            document.querySelectorAll('.passwords-card').forEach(card => {
                const cardRole = card.getAttribute('data-role') || '';
                const cardClass = card.getAttribute('data-class') || '';
                const cardSearch = card.getAttribute('data-search') || '';
                const matchRole = !roleValue || cardRole === roleValue;
                const matchClass = !classValue || cardClass === classValue;
                const matchSearch = !searchValue || cardSearch.includes(searchValue);
                card.style.display = matchRole && matchClass && matchSearch ? 'grid' : 'none';
            });
        };

        classFilter?.addEventListener('change', applyPasswordFilters);
        roleFilter?.addEventListener('change', applyPasswordFilters);
        searchInput?.addEventListener('input', applyPasswordFilters);
        applyPasswordFilters();

        document.getElementById('btnPasswordsBack')?.addEventListener('click', () => {
            router.navigate('/admin/dashboard');
        });

        document.querySelectorAll('.reset-user-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const { userId, userName, username } = btn.dataset;
                showResetPasswordModal(userId, userName, username);
            });
        });
    } catch (error) {
        console.error('Error loading passwords page:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã', 'error');
    }
}

function showResetPasswordModal(userId, userName, username) {
    const content = `
        <div class="admin-modal-overlay">
            <div class="admin-modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; width: 90%; max-width: 450px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                <h2 style="margin: 0 0 1rem 0; font-size: 1.5rem; color: var(--text-primary);">–°–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è</h2>
                <p style="color: var(--text-secondary); margin: 0 0 1.5rem 0; font-size: 0.95rem;">
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è –¥–ª—è <strong>${userName}</strong> (${username})
                </p>
                
                <div style="background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.25rem; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –ü–∞—Ä–æ–ª—å –±—É–¥–µ—Ç —Å–±—Ä–æ—à–µ–Ω –Ω–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–º–æ–∂–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –ø—Ä–∏ –≤—Ö–æ–¥–µ.
                    </p>
                </div>

                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeModal()" class="btn-secondary" style="padding: 0.75rem 1.5rem; font-size: 0.9rem; border: 1px solid var(--border-color); flex: 1; min-width: 140px;">–û—Ç–º–µ–Ω–∞</button>
                    <button onclick="resetUserPassword('${userId}')" class="btn-primary" style="padding: 0.75rem 1.5rem; font-size: 0.9rem; flex: 1; min-width: 140px;">–°–±—Ä–æ—Å–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', content);
}

async function resetUserPassword(userId) {
    const token = store.getState().token;

    try {
        const response = await fetch(`${API_BASE_URL}/api/users/${userId}/reset-password`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        });

        if (!response.ok) {
            throw new Error('Failed to reset password');
        }

        const result = await response.json();
        
        // Close the reset modal first
        closeModal();
        
        // Show OTP modal with the new temporary password
        if (result.otp) {
            const otpModal = `
                <div class="admin-modal-overlay">
                    <div class="admin-modal-content" style="background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 16px; padding: 2rem; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <div style="text-align: center; margin-bottom: 1.5rem;">
                            <div style="width: 64px; height: 64px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 1rem; color: white; font-size: 2rem;">
                                ‚úì
                            </div>
                            <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; color: var(--text-primary);">–ü–∞—Ä–æ–ª—å —Å–±—Ä–æ—à–µ–Ω!</h2>
                            <p style="margin: 0; color: var(--text-secondary); font-size: 0.95rem;">–í—Ä–µ–º–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –≤—Ö–æ–¥–∞:</p>
                        </div>
                        
                        <div style="background: var(--bg-primary); border: 2px dashed #10b981; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; text-align: center;">
                            <div style="font-family: 'Courier New', monospace; font-size: 1.75rem; font-weight: 700; color: #10b981; letter-spacing: 0.25rem; margin-bottom: 0.5rem;">${result.otp}</div>
                            <button onclick="navigator.clipboard.writeText('${result.otp}'); this.innerHTML='<span style=\\'color: #10b981;\\'>‚úì –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!</span>'" style="padding: 0.5rem 1rem; font-size: 0.85rem; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; cursor: pointer; color: var(--text-primary); transition: all 0.2s;">
                                üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                            <p style="margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6;">
                                <strong style="color: var(--text-primary);">üîê –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:</strong> –û–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π<br>
                                <strong style="color: var(--text-primary);">üìù –ü—Ä–∏ –≤—Ö–æ–¥–µ:</strong> –ü–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
                            </p>
                        </div>
                        
                        <button onclick="window.closeModal(); window.renderAdminPasswords()" class="btn-primary" style="width: 100%; padding: 0.875rem; font-size: 0.95rem; font-weight: 600;">
                            –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', otpModal);
        } else {
            showAlert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ —Å–±—Ä–æ—à–µ–Ω', 'success');
            renderAdminPasswords();
        }
    } catch (error) {
        console.error('Error resetting password:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ –ø–∞—Ä–æ–ª—è', 'error');
    }
}

router.register('/login', renderLoginPage);
router.register('/role-selection', renderRoleSelection);
router.register('/change-password', renderChangePasswordPage);
router.register('/student/dashboard', renderStudentDashboard);
router.register('/student/profile', renderStudentProfile);
router.register('/student/subjects', renderSubjectTests);
router.register('/student/subject-modules/:subjectId', renderStudentSubjectModules);
router.register('/student/take-test/:testId', renderTestTaker);
router.register('/student/test-results/:resultId', renderTestResultsPage);
router.register('/student/test-history', renderTestHistoryPage);
router.register('/student/interest-test', renderInterestTest);
router.register('/student/control-tests', renderControlTests);
router.register('/student/take-control-test/:testId', ({ testId }) => renderControlTestTaker({ testId }));
router.register('/teacher/subjects', renderTeacherSubjects);
router.register('/teacher/control-tests', renderTeacherControlTests);
router.register('/teacher/classes', renderTeacherClasses);
router.register('/teacher/profile', renderTeacherProfile);
router.register('/teacher/subject-analytics', renderTeacherSubjectModuleAnalytics);
router.register('/teacher/tests', renderTeacherMyTests);
router.register('/teacher/test/:id', renderTeacherTestTaking);
router.register('/teacher/student/:studentId', ({ studentId }) => renderTeacherStudentProfile({ studentId }));
router.register('/teacher/subject/:subjectId', renderTeacherSubjectManagement);
router.register('/teacher/module/:moduleId/tests', renderModuleTests);
router.register('/teacher/module/:moduleId/edit-test/:testId', renderTestEditor);
router.register('/admin/dashboard', renderAdminDashboard);
router.register('/admin/analytics', renderAdminAnalytics);
router.register('/admin/classes', renderAdminClasses);
router.register('/admin/subjects', renderAdminSubjects);
router.register('/admin/passwords', renderAdminPasswords);
router.register('/admin/teacher-tests', renderAdminTeacherTests);
router.register('/admin/student/:studentId', ({ studentId }) => renderAdminStudentDetail(studentId));
router.register('/admin/teacher/:teacherId', ({ teacherId }) => renderAdminTeacherDetail(teacherId));

document.addEventListener('DOMContentLoaded', () => {
    // Export functions to global scope for onclick handlers
    window.deleteClass = deleteClass;
    window.editClass = editClass;
    window.viewClassStudents = viewClassStudents;
    window.saveClassEdit = saveClassEdit;
    window.showCreateClassModal = showCreateClassModal;
    window.createClass = createClass;
    window.closeModal = closeModal;
    window.showAddUserModal = showAddUserModal;
    window.showResetPasswordModal = showResetPasswordModal;
    window.resetUserPassword = resetUserPassword;
    window.renderAdminPasswords = renderAdminPasswords;
    
    initThemeToggle();
    renderLanguageSwitch();
    initBottomNav();
    
    const currentPath = window.location.pathname;
    router.navigate(currentPath === '/' ? '/' : currentPath, false);
});